<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Inline.px - Ultra-Compact Pixel Art Editor</title>
    <link rel="icon" type="image/png" href="./favicon-BTGlOP9f.png">

    <!-- Material Symbols Font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <!-- Pixelify Sans Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pixelify+Sans:wght@400..700&display=swap" rel="stylesheet">

  <script type="module" crossorigin>(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function n(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerPolicy&&(i.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?i.credentials="include":r.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(r){if(r.ep)return;r.ep=!0;const i=n(r);fetch(r.href,i)}})();const ae={DEBUG:0,INFO:1,WARN:2,ERROR:3};let cn=ae.INFO,un=!0,we=[];const no=100;function oo(e){ae[e]!==void 0&&(cn=ae[e])}function ro(e){un=e}function Ve(e,t,n,o){if(e<cn)return;const r=new Date().toISOString(),i={timestamp:r,level:t,message:n,data:o};if(we.push(i),we.length>no&&we.shift(),un){const a=`[${r}] [${t}] ${n}`,l=t.toLowerCase();console[l]?console[l](a,o||""):console.log(a,o||"")}}const s={LOG_LEVELS:ae,setLevel:oo,setConsoleEnabled:ro,debug:(e,t=null)=>Ve(ae.DEBUG,"DEBUG",e,t),info:(e,t=null)=>Ve(ae.INFO,"INFO",e,t),warn:(e,t=null)=>Ve(ae.WARN,"WARN",e,t),error:(e,t=null)=>Ve(ae.ERROR,"ERROR",e,t),getHistory:()=>[...we],clearHistory:()=>{we=[]},exportLogs:()=>we.map(e=>{let t=`[${e.timestamp}] [${e.level}] ${e.message}`;return e.data&&(t+=` | ${JSON.stringify(e.data)}`),t}).join(`
`)},F={};function dn(e,t){return F[e]||(F[e]=[]),F[e].push(t),s.debug?.(`EventBus: subscribed to "${e}"`),()=>Ot(e,t)}function io(e,t){const n=(...o)=>{t(...o),Ot(e,n)};return dn(e,n)}function Ot(e,t){if(!F[e])return;const n=F[e].indexOf(t);n>-1&&(F[e].splice(n,1),s.debug?.(`EventBus: unsubscribed from "${e}"`)),F[e].length===0&&delete F[e]}function ao(e,t=null){if(!F[e]){s.debug?.(`EventBus: no listeners for "${e}"`);return}s.debug?.(`EventBus: emitting "${e}"`,t),[...F[e]].forEach(o=>{try{o(t,e)}catch(r){s.error?.(`EventBus: error in listener for "${e}"`,r)}})}const so={TOOL_CHANGED:"tool:changed",TOOL_OPTION_CHANGED:"tool:optionChanged",CANVAS_CHANGED:"canvas:changed",CANVAS_RESIZED:"canvas:resized",CANVAS_CLEARED:"canvas:cleared",SELECTION_CHANGED:"selection:changed",SELECTION_CLEARED:"selection:cleared",COLOR_CHANGED:"color:changed",HISTORY_STATE_ADDED:"history:stateAdded",UNDO_PERFORMED:"history:undo",REDO_PERFORMED:"history:redo",FILE_LOADED:"file:loaded",FILE_SAVED:"file:saved",FILE_EXPORTED:"file:exported",MODAL_OPENED:"ui:modalOpened",MODAL_CLOSED:"ui:modalClosed",APP_READY:"app:ready",APP_ERROR:"app:error"},C={on:dn,once:io,off:Ot,emit:ao,listenerCount:e=>F[e]?F[e].length:0,getEvents:()=>Object.keys(F),clear:(e=null)=>{e?(delete F[e],s.debug?.(`EventBus: cleared listeners for "${e}"`)):(Object.keys(F).forEach(t=>delete F[t]),s.debug?.("EventBus: cleared all listeners"))},getStats:()=>{const e={totalEvents:Object.keys(F).length,totalListeners:0,events:{}};return Object.keys(F).forEach(t=>{const n=F[t].length;e.totalListeners+=n,e.events[t]=n}),e},Events:so},lo={base64Chars:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz+/",palette:[{index:0,char:"0",color:"transparent",name:"Transparent",category:"special"},{index:1,char:"1",color:"#000000",name:"Black",category:"basic"},{index:2,char:"2",color:"#FFFFFF",name:"White",category:"basic"},{index:3,char:"3",color:"#FF0000",name:"Red",category:"basic"},{index:4,char:"4",color:"#00FF00",name:"Green",category:"basic"},{index:5,char:"5",color:"#0000FF",name:"Blue",category:"basic"},{index:6,char:"6",color:"#FFFF00",name:"Yellow",category:"basic"},{index:7,char:"7",color:"#FF00FF",name:"Magenta",category:"basic"},{index:8,char:"8",color:"#00FFFF",name:"Cyan",category:"basic"},{index:9,char:"9",color:"#1A1A1A",name:"Dark Gray 1",category:"grayscale"},{index:10,char:"A",color:"#333333",name:"Dark Gray 2",category:"grayscale"},{index:11,char:"B",color:"#4D4D4D",name:"Dark Gray 3",category:"grayscale"},{index:12,char:"C",color:"#666666",name:"Gray 1",category:"grayscale"},{index:13,char:"D",color:"#808080",name:"Gray 2",category:"grayscale"},{index:14,char:"E",color:"#999999",name:"Gray 3",category:"grayscale"},{index:15,char:"F",color:"#B3B3B3",name:"Light Gray 1",category:"grayscale"},{index:16,char:"G",color:"#CCCCCC",name:"Light Gray 2",category:"grayscale"},{index:17,char:"H",color:"#8B0000",name:"Dark Red",category:"reds"},{index:18,char:"I",color:"#B22222",name:"Firebrick",category:"reds"},{index:19,char:"J",color:"#DC143C",name:"Crimson",category:"reds"},{index:20,char:"K",color:"#FF4500",name:"Orange Red",category:"reds"},{index:21,char:"L",color:"#FF6347",name:"Tomato",category:"reds"},{index:22,char:"M",color:"#FF7F50",name:"Coral",category:"reds"},{index:23,char:"N",color:"#FFA500",name:"Orange",category:"reds"},{index:24,char:"O",color:"#FFD700",name:"Gold",category:"reds"},{index:25,char:"P",color:"#006400",name:"Dark Green",category:"greens"},{index:26,char:"Q",color:"#008000",name:"Green",category:"greens"},{index:27,char:"R",color:"#228B22",name:"Forest Green",category:"greens"},{index:28,char:"S",color:"#32CD32",name:"Lime Green",category:"greens"},{index:29,char:"T",color:"#7FFF00",name:"Chartreuse",category:"greens"},{index:30,char:"U",color:"#90EE90",name:"Light Green",category:"greens"},{index:31,char:"V",color:"#98FB98",name:"Pale Green",category:"greens"},{index:32,char:"W",color:"#ADFF2F",name:"Yellow Green",category:"greens"},{index:33,char:"X",color:"#00008B",name:"Dark Blue",category:"blues"},{index:34,char:"Y",color:"#0000CD",name:"Medium Blue",category:"blues"},{index:35,char:"Z",color:"#1E90FF",name:"Dodger Blue",category:"blues"},{index:36,char:"a",color:"#4169E1",name:"Royal Blue",category:"blues"},{index:37,char:"b",color:"#6495ED",name:"Steel Blue",category:"blues"},{index:38,char:"c",color:"#87CEEB",name:"Sky Blue",category:"blues"},{index:39,char:"d",color:"#87CEFA",name:"Light Sky Blue",category:"blues"},{index:40,char:"e",color:"#B0E0E6",name:"Powder Blue",category:"blues"},{index:41,char:"f",color:"#4B0082",name:"Indigo",category:"purples"},{index:42,char:"g",color:"#6A5ACD",name:"Slate Blue",category:"purples"},{index:43,char:"h",color:"#7B68EE",name:"Medium Slate Blue",category:"purples"},{index:44,char:"i",color:"#9370DB",name:"Medium Purple",category:"purples"},{index:45,char:"j",color:"#BA55D3",name:"Orchid",category:"purples"},{index:46,char:"k",color:"#DA70D6",name:"Violet",category:"purples"},{index:47,char:"l",color:"#DDA0DD",name:"Plum",category:"purples"},{index:48,char:"m",color:"#EE82EE",name:"Pink Violet",category:"purples"},{index:49,char:"n",color:"#8B4513",name:"Saddle Brown",category:"browns"},{index:50,char:"o",color:"#A0522D",name:"Sienna",category:"browns"},{index:51,char:"p",color:"#D2691E",name:"Chocolate",category:"browns"},{index:52,char:"q",color:"#CD853F",name:"Peru",category:"browns"},{index:53,char:"r",color:"#F4A460",name:"Sandy Brown",category:"browns"},{index:54,char:"s",color:"#DEB887",name:"Burlywood",category:"browns"},{index:55,char:"t",color:"#D2B48C",name:"Tan",category:"browns"},{index:56,char:"u",color:"#BC8F8F",name:"Rosy Brown",category:"browns"},{index:57,char:"v",color:"#FFB6C1",name:"Light Pink",category:"pastels"},{index:58,char:"w",color:"#FFC0CB",name:"Pink",category:"pastels"},{index:59,char:"x",color:"#FFE4E1",name:"Misty Rose",category:"pastels"},{index:60,char:"y",color:"#F0E68C",name:"Khaki",category:"pastels"},{index:61,char:"z",color:"#E6E6FA",name:"Lavender",category:"pastels"},{index:62,char:"+",color:"#D8BFD8",name:"Thistle",category:"pastels"},{index:63,char:"/",color:"#FFDAB9",name:"Peach",category:"pastels"}]},co={canvas:{minSize:2,maxSize:128,defaultWidth:8,defaultHeight:8,minPixelSize:8,maxPixelSize:50,defaultPixelSize:30},history:{maxStates:50,debounceTime:500},autosave:{interval:3e4,debounceTime:1e3},tools:{brushSizes:[1,2,3,5],defaultBrushSize:1,maxBrushSize:5,shapeModes:["fill","stroke"],defaultShapeMode:"fill"},rle:{maxRunLength:99,countDigits:2},ui:{copyFeedbackDuration:1e3,windowResizeDebounce:250,animationDuration:200},validation:{fileNameMaxLength:100,fileNamePattern:"^[a-zA-Z0-9_\\-\\.]+$"}};function fn(e){const t=[];return!e.base64Chars||typeof e.base64Chars!="string"?t.push("Missing or invalid base64Chars"):e.base64Chars.length!==64&&t.push(`base64Chars must be 64 characters, got ${e.base64Chars.length}`),Array.isArray(e.palette)?e.palette.length!==64?t.push(`palette must have 64 colors, got ${e.palette.length}`):e.palette.forEach((n,o)=>{(typeof n.index!="number"||n.index!==o)&&t.push(`palette[${o}]: invalid or mismatched index`),(!n.char||typeof n.char!="string"||n.char.length!==1)&&t.push(`palette[${o}]: invalid char`),(!n.color||typeof n.color!="string")&&t.push(`palette[${o}]: invalid color`),(!n.name||typeof n.name!="string")&&t.push(`palette[${o}]: invalid name`),(!n.category||typeof n.category!="string")&&t.push(`palette[${o}]: invalid category`)}):t.push("palette must be an array"),t.length>0&&s.error?.("Colors config validation failed:",t),{valid:t.length===0,errors:t}}function hn(e){const t=[];if(!e.canvas||typeof e.canvas!="object")t.push("Missing or invalid canvas config");else{const n=e.canvas;(typeof n.minSize!="number"||n.minSize<1)&&t.push("canvas.minSize must be a positive number"),(typeof n.maxSize!="number"||n.maxSize<n.minSize)&&t.push("canvas.maxSize must be >= canvas.minSize"),typeof n.defaultWidth!="number"&&t.push("canvas.defaultWidth must be a number"),typeof n.defaultHeight!="number"&&t.push("canvas.defaultHeight must be a number"),(typeof n.minPixelSize!="number"||n.minPixelSize<1)&&t.push("canvas.minPixelSize must be a positive number"),(typeof n.maxPixelSize!="number"||n.maxPixelSize<n.minPixelSize)&&t.push("canvas.maxPixelSize must be >= canvas.minPixelSize"),typeof n.defaultPixelSize!="number"&&t.push("canvas.defaultPixelSize must be a number")}if(!e.history||typeof e.history!="object")t.push("Missing or invalid history config");else{const n=e.history;(typeof n.maxStates!="number"||n.maxStates<1)&&t.push("history.maxStates must be a positive number"),(typeof n.debounceTime!="number"||n.debounceTime<0)&&t.push("history.debounceTime must be a non-negative number")}if(!e.autosave||typeof e.autosave!="object")t.push("Missing or invalid autosave config");else{const n=e.autosave;(typeof n.interval!="number"||n.interval<1e3)&&t.push("autosave.interval must be >= 1000ms"),(typeof n.debounceTime!="number"||n.debounceTime<0)&&t.push("autosave.debounceTime must be a non-negative number")}return t.length>0&&s.error?.("Constants config validation failed:",t),{valid:t.length===0,errors:t}}function uo(e,t){if(!e||typeof e!="object")return{valid:!1,errors:["Config is null or not an object"]};switch(t){case"colors":return fn(e);case"constants":return hn(e);default:return{valid:!1,errors:[`Unknown config type: ${t}`]}}}const mn={validateConfig:uo,validateColorsConfig:fn,validateConstantsConfig:hn},he={},Qt=lo,en=co;async function gn(e){if(he[e])return s.debug?.(`Config loaded from cache: ${e}`),he[e];try{const t=await fetch(e);if(!t.ok)throw new Error(`HTTP error ${t.status}: ${t.statusText}`);const n=await t.json();return he[e]=n,s.info?.(`Config loaded: ${e}`),n}catch(t){throw s.error?.(`Failed to load config: ${e}`,t),t}}async function fo(){s.debug?.("Colors loaded from ES module (static)");const e=mn.validateColorsConfig(Qt);if(!e.valid)throw s.error?.("Colors config validation failed:",e.errors),new Error(`Invalid colors config: ${e.errors.join(", ")}`);return Qt}async function ho(){s.debug?.("Constants loaded from ES module (static)");const e=mn.validateConstantsConfig(en);if(!e.valid)throw s.error?.("Constants config validation failed:",e.errors),new Error(`Invalid constants config: ${e.errors.join(", ")}`);return en}function mo(e){return he[e]||null}function pn(e=null){e?delete he[e]:Object.keys(he).forEach(t=>delete he[t])}async function go(e){return pn(e),gn(e)}const zt={load:gn,loadColors:fo,loadConstants:ho,getCache:mo,clearCache:pn,reload:go};let xe=null;function po(e=null){xe=e}function vn(e,t){const n=xe?.canvas?.minSize||2,o=xe?.canvas?.maxSize||128;return isNaN(e)||isNaN(t)?{valid:!1,error:"Width and height must be numbers"}:e<n||e>o?{valid:!1,error:`Width must be between ${n} and ${o}`}:t<n||t>o?{valid:!1,error:`Height must be between ${n} and ${o}`}:{valid:!0,error:null}}function vo(e){if(!e||e.trim().length===0)return{valid:!1,error:"File name cannot be empty"};const t=xe?.validation?.fileNameMaxLength||100;if(e.length>t)return{valid:!1,error:`File name too long (max ${t} characters)`};const n=xe?.validation?.fileNamePattern||"^[a-zA-Z0-9_\\-\\.]+$";return new RegExp(n).test(e)?{valid:!0,error:null}:{valid:!1,error:"File name contains invalid characters"}}function yo(e){if(!e||typeof e!="string")return{valid:!1,error:"Data string must be a non-empty string",info:null};const t=e.split(":");if(t.length<2)return{valid:!1,error:'Invalid format: must be "WxH:DATA" or "WxH:RLE:DATA"',info:null};const n=t[0].split("x");if(n.length!==2)return{valid:!1,error:'Invalid dimensions format: must be "WIDTHxHEIGHT"',info:null};const o=parseInt(n[0]),r=parseInt(n[1]),i=vn(o,r);if(!i.valid)return{valid:!1,error:i.error,info:null};const a=t.length===3&&t[1]==="RLE",c=t[a?2:1];if(!c||c.length===0)return{valid:!1,error:"Data section is empty",info:null};if(!a){const u=o*r;if(c.length!==u)return{valid:!1,error:`Data length mismatch: expected ${u}, got ${c.length}`,info:null}}return{valid:!0,error:null,info:{width:o,height:r,isCompressed:a,dataLength:c.length}}}function Co(e){return e==="transparent"?!0:/^#[0-9A-Fa-f]{6}$/.test(e)}function wo(e){return Number.isInteger(e)&&e>=0&&e<=63}function So(e){return typeof e=="string"&&e.length===1&&"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz+/".includes(e)}function bo(e){return e.replace(/[^a-zA-Z0-9_\-\.]/g,"_").replace(/_{2,}/g,"_").substring(0,xe?.validation?.fileNameMaxLength||100)}function xo(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}const Ge={init:po,validateCanvasDimensions:vn,validateFileName:vo,validateDataString:yo,validateHexColor:Co,validateColorIndex:wo,validateBase64Char:So,sanitizeFileName:bo,sanitizeInput:xo};function Eo(e,t=1){if(e===0)return"0 Bytes";if(e===1)return"1 Byte";const n=1024,o=["Bytes","KB","MB","GB"],r=Math.floor(Math.log(e)/Math.log(n));return parseFloat((e/Math.pow(n,r)).toFixed(t))+" "+o[r]}function Do(e){return e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}function Io(e,t=1){return e.toFixed(t)+"%"}function yn(e,t=!0){const n=e instanceof Date?e:new Date(e),o=n.getFullYear(),r=String(n.getMonth()+1).padStart(2,"0"),i=String(n.getDate()).padStart(2,"0");let a=`${o}-${r}-${i}`;if(t){const l=String(n.getHours()).padStart(2,"0"),c=String(n.getMinutes()).padStart(2,"0"),u=String(n.getSeconds()).padStart(2,"0");a+=` ${l}:${c}:${u}`}return a}function To(e){const t=e instanceof Date?e:new Date(e),o=new Date-t,r=Math.floor(o/1e3),i=Math.floor(r/60),a=Math.floor(i/60),l=Math.floor(a/24);return r<60?"just now":i<60?`${i} minute${i!==1?"s":""} ago`:a<24?`${a} hour${a!==1?"s":""} ago`:l<7?`${l} day${l!==1?"s":""} ago`:yn(t,!1)}function Cn(e,t,n="..."){return e.length<=t?e:e.substring(0,t-n.length)+n}function $o(e,t=50){if(!e)return"";const n=e.split(":");if(n.length<2)return Cn(e,t);const o=n[0],r=n.length===3&&n[1]==="RLE",a=n[r?2:1],l=r?`${o}:RLE:`:`${o}:`,c=t-l.length-3;return a.length<=c?e:`${l}${a.substring(0,c)}...`}function Lo(e,t,n=null){return n=n||t+"s",e===1?t:n}function Fo(e,t){return`${e}×${t}`}function Bo(e,t=2){return String(e).padStart(t,"0")}function Oo(e,t="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz+/"){return e<0||e>=t.length?"?":t[e]}const St={formatFileSize:Eo,formatNumber:Do,formatPercentage:Io,formatTimestamp:yn,formatRelativeTime:To,truncate:Cn,formatDataString:$o,pluralize:Lo,formatDimensions:Fo,padZero:Bo,formatColorCode:Oo};async function wn(e){if(navigator.clipboard&&navigator.clipboard.writeText)try{return await navigator.clipboard.writeText(e),s.info?.("Text copied to clipboard (modern API)"),!0}catch(t){return s.warn?.("Modern clipboard API failed, trying fallback",t),tn(e)}return tn(e)}function tn(e){const t=document.createElement("textarea");t.value=e,t.style.position="fixed",t.style.left="-9999px",t.style.opacity="0",document.body.appendChild(t),t.select();let n=!1;try{n=document.execCommand("copy"),n&&s.info?.("Text copied to clipboard (fallback)")}catch(o){s.error?.("Fallback copy failed",o)}return document.body.removeChild(t),n}async function zo(){if(navigator.clipboard&&navigator.clipboard.readText)try{const e=await navigator.clipboard.readText();return s.info?.("Text pasted from clipboard"),e}catch(e){return s.warn?.("Clipboard read failed",e),null}return s.warn?.("Clipboard API not available"),null}function Sn(e,t=1e3){if(!e)return;const n=e.style.background,o=e.querySelector(".material-symbols-outlined"),r=o?o.textContent:null;e.style.background="var(--success-color, #4CAF50)",o&&(o.textContent="check"),setTimeout(()=>{e.style.background=n,o&&r&&(o.textContent=r)},t)}function Mo(){return!!(navigator.clipboard&&navigator.clipboard.writeText)}async function Po(e,t=null){const n=await wn(e);return n&&t&&Sn(t),n}const bn={copyText:wn,pasteText:zo,showCopyFeedback:Sn,isAvailable:Mo,copyWithFeedback:Po};function tt(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function xn(e){const t={info:"info",success:"check_circle",warning:"warning",error:"error"};return t[e]||t.info}let Y=null,Be=null;function No(){Ao()}function Ao(){Y=document.createElement("div"),Y.id="dialogContainer",Y.className="dialog-overlay",Y.style.display="none",document.body.appendChild(Y),Y.addEventListener("click",e=>{e.target===Y&&ne()}),document.addEventListener("keydown",e=>{e.key==="Escape"&&Be&&ne()})}function lt(e){const t=document.createElement("div");t.className=`dialog-content dialog-${e.type}`;const n=document.createElement("div");n.className="dialog-header",n.innerHTML=`
        <span class="material-symbols-outlined dialog-icon">${e.icon}</span>
        <h2 class="dialog-title">${tt(e.title)}</h2>
    `,t.appendChild(n);const o=document.createElement("div");if(o.className="dialog-body",e.message){const i=document.createElement("p");i.className="dialog-message",i.textContent=e.message,o.appendChild(i)}if(e.customContent){const i=document.createElement("div");i.innerHTML=e.customContent,o.appendChild(i)}if(e.input){const i=document.createElement("input");i.type=e.input.type,i.value=e.input.value,i.placeholder=e.input.placeholder,i.className="dialog-input",o.appendChild(i)}t.appendChild(o);const r=document.createElement("div");return r.className="dialog-footer",e.buttons.forEach(i=>{const a=document.createElement("button");a.className=`dialog-btn dialog-btn-${i.type}`,a.textContent=i.text,a.addEventListener("click",i.action),r.appendChild(a)}),t.appendChild(r),t}function ct(e){Y.innerHTML="",Y.appendChild(e),Y.style.display="flex",Be=e,setTimeout(()=>{e.classList.add("dialog-show")},10);const t=e.querySelector(".dialog-btn");t&&t.focus()}function ne(){Be&&(Be.classList.remove("dialog-show"),setTimeout(()=>{Y.style.display="none",Y.innerHTML="",Be=null},200))}function Mt(e){const[t,n]=e.split(":");if(!n||n.length===0)return{compressed:e,original:e,savings:0,compressionRatio:1};let o="",r=1,i=n[0];for(let d=1;d<=n.length;d++)if(d<n.length&&n[d]===i&&r<99)r++;else{const h=r.toString().padStart(2,"0");o+=`${h}${i}`,d<n.length&&(i=n[d],r=1)}const a=`${t}:RLE:${o}`,l=e.length,c=a.length,u=((l-c)/l*100).toFixed(1),f=(c/l).toFixed(2);return{compressed:a,original:e,savings:parseFloat(u),compressionRatio:parseFloat(f),originalSize:l,compressedSize:c}}function ko(e){const t=e.split(":");if(t.length===2)return e;if(t.length===3&&t[1]==="RLE"){const n=t[0],o=t[2];let r="",i=0;for(;i<o.length&&i+2<o.length;){const a=o.substring(i,i+2),l=parseInt(a),c=o[i+2];r+=c.repeat(l),i+=3}return`${n}:${r}`}return e}function Ro(e){const t=e.split(":");return t.length===3&&t[1]==="RLE"}function En(e){const t=Mt(e);return t.compressedSize<t.originalSize?{data:t.compressed,wasCompressed:!0,savings:t.savings,compressionRatio:t.compressionRatio,originalSize:t.originalSize,compressedSize:t.compressedSize}:{data:e,wasCompressed:!1,savings:0,compressionRatio:1,originalSize:e.length,compressedSize:e.length}}function Ho(e){return Mt(e)}function _o(e){return e.map(t=>En(t))}const k={compress:Mt,decompress:ko,isCompressed:Ro,smartCompress:En,getStats:Ho,compressBatch:_o};function Go(e){return new Promise(t=>{const n=k?k.getStats(e):null,r=lt({title:"Export Pixel Art",message:"Choose how you want to export your pixel art:",icon:"download",type:"info",customContent:Uo(e,n,n!==null),buttons:[{text:"Cancel",type:"secondary",action:()=>{ne(),t(null)}}]});ct(r),Vo(r,t)})}function Uo(e,t,n){const o=qo(e),r=n?Wo(e,t):"",i=Xo(),a=jo();return`
        <div class="export-options">
            ${o}
            ${r}
            ${i}
            ${a}
        </div>
    `}function qo(e){return`
        <div class="export-preview">
            <div class="export-preview-header">
                <strong>Text Format Preview:</strong>
                <span class="export-preview-size">${e.length} chars</span>
            </div>
            <code class="export-code-preview">${tt(e.substring(0,100))}${e.length>100?"...":""}</code>
        </div>
    `}function Wo(e,t){const n=t.savings>0?"":"export-warning",o=t.savings>0?"Save":"Adds",r=t.savings>0?"Compresses repeated pixels for smaller file size. Recommended for sprites with large solid areas.":"Note: This sprite has few repeated pixels, so compression increases file size. Use only if needed for compatibility.";return`
        <div class="export-option-group">
            <label class="export-checkbox-label">
                <input type="checkbox" id="exportCompress" class="export-checkbox" ${t.savings>0?"checked":""} />
                <span>Use RLE Compression</span>
                <span class="export-savings ${n}">${o} ${Math.abs(t.savings)}% (${t.originalSize} → ${t.compressedSize} chars)</span>
            </label>
            <div class="export-option-info">
                ${r}
            </div>
            ${Yo(e,t)}
        </div>
    `}function Yo(e,t){return`
        <div class="compression-preview">
            <div class="compression-preview-section">
                <div class="compression-preview-label">
                    <strong>Before:</strong>
                    <span class="compression-preview-size">${t.originalSize} chars</span>
                </div>
                <code class="compression-preview-code">${tt(e.substring(0,80))}${e.length>80?"...":""}</code>
            </div>
            <div class="compression-preview-arrow">→</div>
            <div class="compression-preview-section">
                <div class="compression-preview-label">
                    <strong>After:</strong>
                    <span class="compression-preview-size compression-highlight">${t.compressedSize} chars</span>
                </div>
                <code class="compression-preview-code">${tt(t.compressed.substring(0,80))}${t.compressed.length>80?"...":""}</code>
            </div>
        </div>
    `}function Xo(){return`
        <div class="export-format-section">
            <strong>Export as:</strong>
            <div class="export-format-buttons">
                <button class="export-format-btn" data-format="copy-string">
                    <span class="material-symbols-outlined export-format-icon">content_copy</span>
                    <span class="export-format-label">Copy String</span>
                    <span class="export-format-desc">Copy to clipboard</span>
                </button>
                <button class="export-format-btn" data-format="download-txt">
                    <span class="material-symbols-outlined export-format-icon">description</span>
                    <span class="export-format-label">Download TXT</span>
                    <span class="export-format-desc">Save as text file</span>
                </button>
                <button class="export-format-btn" data-format="download-png">
                    <span class="material-symbols-outlined export-format-icon">image</span>
                    <span class="export-format-label">Download PNG</span>
                    <span class="export-format-desc">Save as image</span>
                </button>
            </div>
        </div>
    `}function jo(){return`
        <div id="pngScaleOptions" class="png-scale-options" style="display: none;">
            <strong>PNG Scale:</strong>
            <div class="png-scale-buttons">
                <button class="png-scale-btn active" data-scale="1">1×</button>
                <button class="png-scale-btn" data-scale="2">2×</button>
                <button class="png-scale-btn" data-scale="4">4×</button>
                <button class="png-scale-btn" data-scale="8">8×</button>
            </div>
        </div>
    `}function Vo(e,t){let n=null,o=1;e.querySelectorAll(".export-format-btn").forEach(r=>{r.addEventListener("click",()=>{e.querySelectorAll(".export-format-btn").forEach(a=>a.classList.remove("selected")),r.classList.add("selected"),n=r.dataset.format;const i=e.querySelector("#pngScaleOptions");n==="download-png"?i.style.display="block":i.style.display="none",setTimeout(()=>{const a=e.querySelector("#exportCompress")?.checked||!1;ne(),t({format:n,compress:a,scale:o})},150)})}),e.querySelectorAll(".png-scale-btn").forEach(r=>{r.addEventListener("click",i=>{i.stopPropagation(),e.querySelectorAll(".png-scale-btn").forEach(a=>a.classList.remove("active")),r.classList.add("active"),o=parseInt(r.dataset.scale)})})}function Ko(){No(),s.info?.("Dialog system initialized")}function Zo(e,t,n="info"){return new Promise(o=>{const r=lt({title:e,message:t,icon:xn(n),type:n,buttons:[{text:"OK",type:"primary",action:()=>{ne(),o(!0)}}]});ct(r)})}function Jo(e,t,n={}){return new Promise(o=>{const r=n.confirmText||"Confirm",i=n.cancelText||"Cancel",a=n.type||"warning",l=n.dangerous||!1,c=lt({title:e,message:t,icon:xn(a),type:a,buttons:[{text:i,type:"secondary",action:()=>{ne(),o(!1)}},{text:r,type:l?"danger":"primary",action:()=>{ne(),o(!0)}}]});ct(c)})}function Qo(e,t,n="",o={}){return new Promise(r=>{const i=o.placeholder||"",a=o.inputType||"text",l=lt({title:e,message:t,icon:"edit_note",type:"info",input:{type:a,value:n,placeholder:i},buttons:[{text:"Cancel",type:"secondary",action:()=>{ne(),r(null)}},{text:"OK",type:"primary",action:()=>{const c=l.querySelector(".dialog-input"),u=c?c.value:null;ne(),r(u)}}]});ct(l),setTimeout(()=>{const c=l.querySelector(".dialog-input");c&&(c.focus(),c.select(),c.addEventListener("keydown",u=>{if(u.key==="Enter"){const f=c.value;ne(),r(f)}}))},100)})}function er(e){return Go(e)}const O={init:Ko,alert:Zo,confirm:Jo,prompt:Qo,exportDialog:er};function Ke(e,t,n){if(!n||n.length===0)return!1;const o=n.length,r=n[0].length;return e>=0&&e<r&&t>=0&&t<o}function tr(e,t,n,o){const r=n.length,i=n[0].length;return e>=0&&e<i&&t>=0&&t<r&&n[t][e]!==o?(n[t][e]=o,!0):!1}function nr(e,t,n){const o=n.length,r=n[0].length;return e>=0&&e<r&&t>=0&&t<o?n[t][e]:null}function nn(e){return e.map(t=>[...t])}function or(e,t){if(t)for(let n=0;n<e.length;n++)for(let o=0;o<e[n].length;o++)e[n][o]=t[n][o]}function rr(e=16){const t={lastTime:0,delay:e};return{shouldThrottle(){const n=Date.now();return n-t.lastTime<t.delay?!0:(t.lastTime=n,!1)},reset(){t.lastTime=0}}}function ir(e){return class extends e{constructor(...t){super(...t),this.selectionActive=!1,this.selectionBounds=null}respectsSelection(){return!0}isInSelection(t,n){if(!this.selectionActive||!this.selectionBounds)return!0;const{x1:o,y1:r,x2:i,y2:a}=this.selectionBounds;return t>=o&&t<=i&&n>=r&&n<=a}setSelection(t){this.selectionActive=!0,this.selectionBounds=t}clearSelection(){this.selectionActive=!1,this.selectionBounds=null}}}function ar(e){return class extends e{constructor(...t){super(...t),this.boundHandlers={}}addEventListener(t,n,o){const r=o.bind(this);t.addEventListener(n,r);const i=`${n}_${Date.now()}`;this.boundHandlers[i]={target:t,event:n,handler:r}}removeAllEventListeners(){Object.values(this.boundHandlers).forEach(({target:t,event:n,handler:o})=>{t.removeEventListener(n,o)}),this.boundHandlers={}}}}class Pt{static CONFIG={id:"base-tool",name:"Base Tool",icon:"tool",shortcut:"",cursor:"default",hasSizeOption:!1,hasShapeOption:!1,description:"Base tool class",category:"other"};static DEFAULT_OPTIONS={brushSize:1,shapeMode:"fill",opacity:1,antiAlias:!1,snapToGrid:!1,constrainProportions:!1};constructor(){if(new.target===Pt)throw new Error("BaseTool is abstract and cannot be instantiated directly");const t=this.constructor.CONFIG;if(!t||t.id==="base-tool")throw new Error(`${this.constructor.name} must override static CONFIG property`);this.isActive=!1,this.isDrawing=!1,this.options={...this.constructor.DEFAULT_OPTIONS},this.startX=0,this.startY=0,this.lastX=0,this.lastY=0,this.previewData=null,this.throttle=rr(16),this.onChangeCallback=null,this.onOptionChangeCallback=null,this.actionHistory=[],this.logger=s,this.logger.debug?.(`${this.constructor.CONFIG.name} tool created`)}init(){this.logger.debug?.(`${this.getName()} tool initialized`)}activate(){this.isActive=!0,this.logger.info?.(`${this.getName()} tool activated`)}deactivate(){this.isActive=!1,this.cancelDrawing(),this.logger.info?.(`${this.getName()} tool deactivated`)}destroy(){this.removeAllEventListeners(),this.previewData=null,this.logger.debug?.(`${this.getName()} tool destroyed`)}startDrawing(t,n,o,r={}){return this.isActive?Ke(t,n,o)?(this.isDrawing=!0,this.startX=t,this.startY=n,this.lastX=t,this.lastY=n,this.needsPreview()&&(this.previewData=nn(o)),this.onDrawStart(t,n,o,r)):(this.logger.warn?.(`Invalid coordinates: (${t}, ${n})`),!1):(this.logger.warn?.(`Cannot start drawing: ${this.getName()} is not active`),!1)}continueDrawing(t,n,o,r={}){return!this.isDrawing||!Ke(t,n,o)||this.throttle.shouldThrottle()?!1:(this.lastX=t,this.lastY=n,this.onDrawContinue(t,n,o,r))}endDrawing(t,n,o,r={}){if(!this.isDrawing)return!1;this.isDrawing=!1,Ke(t,n,o)||(t=this.lastX,n=this.lastY);const i=this.onDrawEnd(t,n,o,r);return this.previewData=null,this.throttle.reset(),i}cancelDrawing(){this.isDrawing&&(this.isDrawing=!1,this.previewData=null,this.onDrawCancel(),this.logger.debug?.(`${this.getName()} drawing cancelled`))}onDrawStart(t,n,o,r){throw new Error(`${this.constructor.name} must implement onDrawStart()`)}onDrawContinue(t,n,o,r){throw new Error(`${this.constructor.name} must implement onDrawContinue()`)}onDrawEnd(t,n,o,r){throw new Error(`${this.constructor.name} must implement onDrawEnd()`)}onDrawCancel(){}setOption(t,n){if(this.options.hasOwnProperty(t)){const o=this.options[t];this.options[t]=n,this.onOptionChanged(t,n,o),this.onOptionChangeCallback&&this.onOptionChangeCallback(t,n,o)}else this.logger.warn?.(`Unknown option: ${t}`)}getOption(t){return this.options[t]}getAllOptions(){return{...this.options}}resetOptions(){this.options={...this.constructor.DEFAULT_OPTIONS},this.onOptionsReset()}onOptionChanged(t,n,o){this.logger.debug?.(`${this.getName()} option changed: ${t} = ${n}`)}onOptionsReset(){}needsPreview(){return!1}validateCoordinates(t,n,o){return Ke(t,n,o)}clonePixelData(t){return nn(t)}restorePreviewData(t){or(t,this.previewData)}setPixel(t,n,o,r){return tr(t,n,o,r)}getPixel(t,n,o){return nr(t,n,o)}getId(){return this.constructor.CONFIG.id}getName(){return this.constructor.CONFIG.name}getConfig(){return{...this.constructor.CONFIG}}getCursor(){return this.constructor.CONFIG.cursor}hasSizeOption(){return this.constructor.CONFIG.hasSizeOption}hasShapeOption(){return this.constructor.CONFIG.hasShapeOption}setChangeCallback(t){this.onChangeCallback=t}setOptionChangeCallback(t){this.onOptionChangeCallback=t}triggerChange(){this.onChangeCallback&&this.onChangeCallback()}}const te=ar(ir(Pt));let Q={brushSize:1,shapeMode:"fill",colorCode:1},Me=null;function sr(e={},t=null){Q={...Q,...e},Me=t,s.debug?.("ToolStateManager initialized")}function lr(e,t){if(!Q.hasOwnProperty(e)){s.warn?.(`Unknown tool option: ${e}`);return}const n=Q[e];Q[e]=t,s.debug?.(`Tool option changed: ${e} = ${t}`),Me&&Me(e,t,n)}function cr(e){return Q[e]}function ur(){return{...Q}}function dr(e){Object.keys(Q).forEach(t=>{e.setOption(t,Q[t])})}function fr(e,t,n){Q.hasOwnProperty(e)&&(Q[e]=t),Me&&Me(e,t,n)}let M=null;function Dn(e){M=e}function hr(e,t,n,o={}){if(!M)return s.warn?.("No tool selected for drawing"),!1;try{return M.startDrawing(e,t,n,o)}catch(r){return s.error?.("Error starting drawing",r),!1}}function mr(e,t,n,o={}){if(!M)return!1;try{return M.continueDrawing(e,t,n,o)}catch(r){return s.error?.("Error continuing drawing",r),!1}}function gr(e,t,n,o={}){if(!M)return!1;try{return M.endDrawing(e,t,n,o)}catch(r){return s.error?.("Error ending drawing",r),!1}}function pr(){if(M)try{M.cancelDrawing()}catch(e){s.error?.("Error canceling drawing",e)}}function vr(e){M&&M.setSelection&&M.setSelection(e)}function yr(){M&&M.clearSelection&&M.clearSelection()}function Cr(){return!M||!M.respectsSelection?!0:M.respectsSelection()}const W=new Map,Ee=[];let X=null,De=null,bt=null;function wr(e={}){s.info?.("ToolRegistry initializing..."),e.onToolChange&&(bt=e.onToolChange),sr(e.sharedOptions,e.onToolOptionChange),s.info?.("ToolRegistry initialized")}function In(e){try{if(!e||!e.CONFIG)return s.error?.("Invalid tool class: missing CONFIG",e),!1;const t=e.CONFIG,n=t.id;if(!n)return s.error?.("Tool class missing id in CONFIG",e),!1;if(W.has(n))return s.warn?.(`Tool "${n}" already registered, skipping`),!1;const o=new e;return o.setChangeCallback(()=>{s.debug?.(`Tool ${n} triggered change`)}),o.setOptionChangeCallback((r,i,a)=>{fr(r,i,a)}),o.init(),W.set(n,o),Ee.push(n),s.info?.(`Tool registered: ${t.name} (${n})`),!0}catch(t){return s.error?.("Failed to register tool",t),!1}}function Sr(e){let t=0;return e.forEach(n=>{In(n)&&t++}),s.info?.(`Registered ${t} tools`),t}function br(e){const t=W.get(e);if(!t)return s.warn?.(`Tool "${e}" not found`),!1;De===e&&(t.deactivate(),X=null,De=null,Dn(null)),t.destroy(),W.delete(e);const n=Ee.indexOf(e);return n>-1&&Ee.splice(n,1),s.info?.(`Tool unregistered: ${e}`),!0}function xr(e){const t=W.get(e);return t?(X&&X!==t&&X.deactivate(),X=t,De=e,X.activate(),dr(X),Dn(X),bt&&bt(e,t),s.info?.(`Current tool set: ${e}`),!0):(s.warn?.(`Tool "${e}" not found`),!1)}function Er(){return X}function Dr(){return De}function Ir(e){return W.get(e)||null}function Tr(){return Ee.map(e=>{const t=W.get(e);return t?t.getConfig():null}).filter(e=>e!==null)}function $r(e){const t=e.toUpperCase();for(const[n,o]of W)if(o.getConfig().shortcut===t)return o;return null}function Lr(e){return W.has(e)}function Fr(){return W.size}function Br(){X&&X.deactivate(),W.forEach(e=>e.destroy()),W.clear(),Ee.length=0,X=null,De=null,s.info?.("All tools cleared")}function Or(){return{totalTools:W.size,currentToolId:De,toolIds:[...Ee]}}const b={init:wr,registerTool:In,registerTools:Sr,unregisterTool:br,setCurrentTool:xr,getCurrentTool:Er,getCurrentToolId:Dr,getTool:Ir,getAllTools:Tr,getToolByShortcut:$r,hasTool:Lr,getToolCount:Fr,clearAll:Br,getStats:Or,setToolOption:lr,getToolOption:cr,getSharedOptions:ur,startDrawing:hr,continueDrawing:mr,endDrawing:gr,cancelDrawing:pr,setSelection:vr,clearSelection:yr,respectsSelection:Cr};let Pe=null,ve="",oe=[],_=[],xt={},Ne=[],me=1,Et=null,Se=null;async function zr(e,t=null){try{s.info?.("ColorPalette initializing..."),Et=t,Pe=await zt.loadColors(),Nt();const n=document.getElementById(e);n?(At(n),$n()):s.warn?.(`Container "${e}" not found`),s.info?.("ColorPalette initialized successfully")}catch(n){throw s.error?.("ColorPalette initialization failed",n),n}}function Nt(){ve=Pe.base64Chars,oe=Pe.palette,_=[],xt={},Ne=[],oe.forEach(e=>{_[e.index]=e.color,xt[e.char]=e.color,Ne[e.index]=e.name}),s.debug?.(`Parsed ${oe.length} colors from configuration`)}function At(e){e.innerHTML="",oe.forEach(t=>{const n=document.createElement("button");n.className="color-swatch",n.dataset.code=t.char,n.dataset.index=t.index,n.dataset.category=t.category,n.style.backgroundColor=t.color,n.title=`${t.name} (${t.char})`,t.index===me&&n.classList.add("active"),n.addEventListener("click",()=>Tn(t.index)),e.appendChild(n)}),s.debug?.(`Rendered ${oe.length} color swatches`)}function Tn(e){if(!Ge.validateColorIndex(e)){s.error?.(`Invalid color index: ${e}`);return}const t=me;me=e,document.querySelectorAll(".color-swatch").forEach(n=>{n.classList.toggle("active",parseInt(n.dataset.index)===e)}),$n(),Et&&Et(e,_[e]),C&&C.emit(C.Events.COLOR_CHANGED,{index:e,color:_[e],char:ve[e],name:Ne[e],oldIndex:t}),b&&b.setToolOption("colorCode",e),s.debug?.(`Color selected: ${Ne[e]} (${e})`)}function $n(){const e=document.getElementById("currentColorDisplay"),t=document.getElementById("currentColorCode");e&&(e.style.backgroundColor=_[me]),t&&(t.textContent=ve[me])}function Mr(e){return _[e]||_[0]}function Pr(e){return xt[e]||_[0]}function Nr(){return me}function Ar(){return _[me]}function kr(e){return ve[e]||"0"}function Rr(e){return ve.indexOf(e)}function Hr(){return[...oe]}function _r(e){return oe.filter(t=>t.category===e)}function Gr(){const e=new Set;return oe.forEach(t=>e.add(t.category)),Array.from(e)}function Ur(e){const t=_[e];if(t==="transparent")return{r:0,g:0,b:0,a:0};const n=t.replace("#",""),o=parseInt(n.substring(0,2),16),r=parseInt(n.substring(2,4),16),i=parseInt(n.substring(4,6),16);return{r:o,g:r,b:i,a:255}}function qr(e){return Ne[e]||"Unknown"}function Wr(e){return oe.find(t=>t.index===e)||null}function Yr(e,t){if(e>=0&&e<_.length){Se||(Se=[..._]),Se[e]=t,_[e]=t;const n=document.querySelector(`.color-swatch[data-index="${e}"]`);n&&(n.style.backgroundColor=t),s.info?.(`Custom color set at index ${e}: ${t}`)}}function Xr(){if(Pe){Nt();const e=document.querySelector(".color-grid");e&&At(e),Se=null,s.info?.("Palette reset to default")}}function jr(){return{base64Chars:ve,palette:oe.map((e,t)=>({...e,color:Se?Se[t]:e.color}))}}function Vr(e){try{Pe=e,Nt();const t=document.querySelector(".color-grid");t&&At(t),s.info?.("Custom palette imported")}catch(t){s.error?.("Failed to import custom palette",t)}}const K={init:zr,selectColor:Tn,getColor:Mr,getColorByChar:Pr,getCurrentColorIndex:Nr,getCurrentColor:Ar,getBase64Char:kr,getIndexFromChar:Rr,getAllColors:Hr,getColorsByCategory:_r,getCategories:Gr,indexToRGBA:Ur,getColorName:qr,getColorInfo:Wr,setCustomColor:Yr,resetToDefault:Xr,exportCustomPalette:jr,importCustomPalette:Vr,get BASE64_CHARS(){return ve},get COLORS(){return _}};let $=16,L=16,G=[];function Kr(e,t){$=e,L=t,ut(),s.debug?.(`PixelData initialized: ${$}×${L}`)}function ut(){G=[];for(let e=0;e<L;e++){G[e]=[];for(let t=0;t<$;t++)G[e][t]=0}}function Zr(){return G}function Jr(e){return!e||e.length===0?(s.error?.("Invalid pixel data"),!1):(L=e.length,$=e[0].length,G=e.map(t=>[...t]),!0)}function Qr(){return{width:$,height:L}}function ei(e,t){return e>=0&&e<$&&t>=0&&t<L?G[t][e]:null}function ti(e,t,n){return e>=0&&e<$&&t>=0&&t<L?(G[t][e]=n,!0):!1}function ni(e,t){const n=Ge.validateCanvasDimensions(e,t);if(!n.valid)return s.error?.("Invalid dimensions:",n.error),!1;const o=G,r=$,i=L;$=e,L=t,ut();for(let a=0;a<Math.min(i,L);a++)for(let l=0;l<Math.min(r,$);l++)G[a][l]=o[a][l];return s.info?.(`Pixel data resized: ${r}×${i} → ${$}×${L}`),!0}function oi(e=!1){let t="";for(let o=0;o<L;o++)for(let r=0;r<$;r++)t+=K.getBase64Char(G[o][r]);const n=`${$}x${L}:${t}`;return e&&k?k.smartCompress(n).data:n}function ri(e){try{const t=Ge.validateDataString(e);if(!t.valid)return{success:!1,error:t.error};let n=e;k&&k.isCompressed(e)&&(n=k.decompress(e),s.debug?.("Data decompressed"));const o=n.split(":"),r=o[0].split("x"),i=parseInt(r[0]),a=parseInt(r[1]),l=o[1];$=i,L=a,ut();let c=0;for(let u=0;u<L;u++)for(let f=0;f<$;f++){const d=l[c],h=K.getIndexFromChar(d);if(h===-1)return{success:!1,error:`Invalid character: ${d}`};G[u][f]=h,c++}return s.info?.(`Data imported: ${$}×${L}`),{success:!0,error:null}}catch(t){return s.error?.("Import failed",t),{success:!1,error:t.message}}}function ii(){return G.map(e=>[...e])}function ai(){for(let e=0;e<L;e++)for(let t=0;t<$;t++)if(G[e][t]!==0)return!0;return!1}function si(){const e={};let t=0;for(let r=0;r<L;r++)for(let i=0;i<$;i++){const a=G[r][i];a===0?t++:e[a]=(e[a]||0)+1}const n=$*L,o=Object.keys(e).length;return{width:$,height:L,totalPixels:n,transparentPixels:t,usedColors:o,colorCounts:e,fillPercentage:((n-t)/n*100).toFixed(1)}}const x={init:Kr,clear:ut,getData:Zr,setData:Jr,getDimensions:Qr,getPixel:ei,setPixel:ti,resize:ni,exportToString:oi,importFromString:ri,clone:ii,hasContent:ai,getStats:si};let U=null,I=null,S=30,Ln=!0,Je=null;function li(e,t=null){U=e,I=U.getContext("2d"),I.imageSmoothingEnabled=!1,Je=t,s.debug?.("CanvasRenderer initialized")}function Fn(e,t){const n=U.parentElement;if(!n)return Je?.canvas?.defaultPixelSize||30;const o=Math.min(n.clientWidth-40,800),r=Math.min(window.innerHeight*.5,800),i=Math.floor(o/e),a=Math.floor(r/t),l=Je?.canvas?.minPixelSize||8,c=Je?.canvas?.maxPixelSize||50;return Math.max(l,Math.min(i,a,c))}function ci(e,t,n=null){n!==null?S=n:S=Fn(e,t),U.width=e*S,U.height=t*S,I.imageSmoothingEnabled=!1,s.debug?.(`Canvas size updated: ${U.width}×${U.height} (pixel size: ${S})`)}function ui(e){if(!e||e.length===0){s.warn?.("No pixel data to render");return}const t=e.length,n=e[0].length;I.clearRect(0,0,U.width,U.height);for(let o=0;o<t;o++)for(let r=0;r<n;r++){const i=e[o][r];if(i===0)di(r,o);else{const a=K.getColor(i);I.fillStyle=a,I.fillRect(r*S,o*S,S,S)}}Ln&&fi(n,t)}function di(e,t){const n=Math.max(2,Math.floor(S/4));for(let o=0;o<S;o+=n)for(let r=0;r<S;r+=n){const i=(Math.floor(r/n)+Math.floor(o/n))%2===0;I.fillStyle=i?"#2a2a2a":"#1a1a1a",I.fillRect(e*S+r,t*S+o,n,n)}}function fi(e,t){I.strokeStyle="#404040",I.lineWidth=1;for(let n=0;n<=e;n++)I.beginPath(),I.moveTo(n*S,0),I.lineTo(n*S,t*S),I.stroke();for(let n=0;n<=t;n++)I.beginPath(),I.moveTo(0,n*S),I.lineTo(e*S,n*S),I.stroke()}function hi(){I.clearRect(0,0,U.width,U.height)}function mi(e){Ln=e}function gi(){return S}function pi(){return U}function vi(){return I}function yi(e,t,n,o,r=1){const i=U.getBoundingClientRect(),a=Math.floor((e-i.left)/(S*r)),l=Math.floor((t-i.top)/(S*r));return a>=0&&a<n&&l>=0&&l<o?{x:a,y:l}:null}function Ci(e,t,n=1){return{x:e*S*n,y:t*S*n}}const H={init:li,calculatePixelSize:Fn,updateCanvasSize:ci,render:ui,clear:hi,setGridVisible:mi,getPixelSize:gi,getCanvas:pi,getContext:vi,screenToPixelCoords:yi,pixelToScreenCoords:Ci};let z=null,B=null,fe=null,Ie=null;function wi(e,t={}){fe=e,Ie=t.renderer||H,Si(),s.debug?.("SelectionOverlay initialized (stateless)")}function Si(){z&&z.remove(),z=document.createElement("canvas"),z.className="selection-overlay",Object.assign(z.style,{position:"absolute",top:"0",left:"0",pointerEvents:"none",zIndex:"10"}),B=z.getContext("2d"),fe.parentElement.appendChild(z),Bn()}function Bn(){!z||!fe||(z.width=fe.width,z.height=fe.height,Object.assign(z.style,{width:fe.style.width,height:fe.style.height}))}function bi(e,t=0){if(!z||!B||!Ie)return;On();const{bounds:n,previewBounds:o,movePreview:r}=e;if(r&&r.pixelData){xi(r);const i={x1:r.x,y1:r.y,x2:r.x+r.pixelData[0].length-1,y2:r.y+r.pixelData.length-1};on(i,t)}else n?on(n,t):o&&Ei(o)}function xi(e){const{pixelData:t,x:n,y:o}=e,r=Ie.getPixelSize(),i=Ie.getColors();for(let a=0;a<t.length;a++)for(let l=0;l<t[a].length;l++){const c=t[a][l];c!==0&&(B.fillStyle=i[c],B.fillRect(Math.floor((n+l)*r),Math.floor((o+a)*r),r,r))}}function on(e,t){const n=Ie.getPixelSize(),o={x:Math.floor(e.x1*n),y:Math.floor(e.y1*n),w:Math.floor((e.x2-e.x1+1)*n),h:Math.floor((e.y2-e.y1+1)*n)};B.strokeStyle="#FFFFFF",B.lineWidth=1,B.setLineDash([4,4]),B.lineDashOffset=t,B.strokeRect(o.x-1,o.y-1,o.w+2,o.h+2),B.strokeStyle="#000000",B.lineDashOffset=t+4,B.strokeRect(o.x-1,o.y-1,o.w+2,o.h+2)}function Ei(e){const t=Ie.getPixelSize(),n={x:Math.floor(e.x1*t),y:Math.floor(e.y1*t),w:Math.floor((e.x2-e.x1+1)*t),h:Math.floor((e.y2-e.y1+1)*t)};B.strokeStyle="rgba(0, 191, 255, 0.8)",B.lineWidth=1,B.setLineDash([3,3]),B.strokeRect(n.x,n.y,n.w,n.h)}function On(){z&&B&&B.clearRect(0,0,z.width,z.height)}function Di(){z&&(z.remove(),z=null,B=null),s.debug?.("SelectionOverlay destroyed")}const P={init:wi,updateSize:Bn,render:bi,clear:On,destroy:Di};let j=1,Ue=0,qe=0,Te=!1,Dt=0,It=0,E=null;const kt=.1,Rt=10,nt=.1;function Ii(){E=document.querySelector(".canvas-container"),E&&(Ti(),$i(),Ye(),s.info("Viewport initialized"))}function Ti(){const e=document.querySelector(".info-bar");if(!e)return;const t=document.createElement("div");t.className="zoom-controls",t.innerHTML=`
        <div class="info-group">
            <button class="zoom-btn" id="zoomOutBtn" title="Zoom Out (-)">−</button>
            <select class="zoom-select" id="zoomSelect">
                <option value="0.25">25%</option>
                <option value="0.5">50%</option>
                <option value="1" selected>100%</option>
                <option value="2">200%</option>
                <option value="4">400%</option>
                <option value="fit">Fit</option>
            </select>
            <button class="zoom-btn" id="zoomInBtn" title="Zoom In (+)">+</button>
            <button class="zoom-btn" id="zoomResetBtn" title="Reset View (Ctrl+0)">⟲</button>
        </div>
    `;const n=e.querySelector(".info-spacer");n?e.insertBefore(t,n):e.appendChild(t),document.getElementById("zoomInBtn").addEventListener("click",Ht),document.getElementById("zoomOutBtn").addEventListener("click",_t),document.getElementById("zoomResetBtn").addEventListener("click",Gt),document.getElementById("zoomSelect").addEventListener("change",o=>{const r=o.target.value;r==="fit"?Ut():We(parseFloat(r))})}function $i(){E&&(E.addEventListener("wheel",Li,{passive:!1}),E.addEventListener("mousedown",Fi),E.addEventListener("mousemove",Bi),E.addEventListener("mouseup",rn),E.addEventListener("mouseleave",rn),document.addEventListener("keydown",Oi))}function Li(e){if(!(e.ctrlKey||e.metaKey))return;e.preventDefault();const n=e.deltaY>0?-nt:nt,o=Math.max(kt,Math.min(Rt,j+n));We(o)}function Fi(e){const t=b&&b.getCurrentToolId()==="hand",n=e.buttons===1&&Ae,o=e.button===1;(t||n||o)&&(e.preventDefault(),Te=!0,Dt=e.clientX,It=e.clientY,E.classList.add("cursor-grabbing"))}function Bi(e){if(!Te)return;e.preventDefault();const t=e.clientX-Dt,n=e.clientY-It;Ue+=t,qe+=n,Dt=e.clientX,It=e.clientY,Ye()}function rn(e){Te&&(Te=!1,E.classList.remove("cursor-grabbing"),b&&b.getCurrentToolId()==="hand"?E.classList.add("cursor-grab"):E.classList.remove("cursor-grab"))}let Ae=!1;function Oi(e){if(e.code==="Space"&&!e.repeat&&e.target.tagName!=="INPUT"&&e.target.tagName!=="TEXTAREA"&&(Ae=!0,E&&E.classList.add("cursor-grab")),!(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA")&&(e.ctrlKey||e.metaKey))switch(e.key){case"+":case"=":e.preventDefault(),Ht();break;case"-":case"_":e.preventDefault(),_t();break;case"0":e.preventDefault(),Gt();break}}document.addEventListener("keyup",e=>{e.code==="Space"&&(Ae=!1,E&&!Te&&(b&&b.getCurrentToolId()==="hand"||E.classList.remove("cursor-grab")))});window.addEventListener("blur",()=>{Ae&&(Ae=!1,E&&!Te&&(b&&b.getCurrentToolId()==="hand"||E.classList.remove("cursor-grab")),s.debug?.("Space key state reset due to window blur"))});function Ht(){const e=Math.min(Rt,j+nt);We(e)}function _t(){const e=Math.max(kt,j-nt);We(e)}function We(e){j=Math.max(kt,Math.min(Rt,e)),Ye(),qt()}function Gt(){j=1,Ue=0,qe=0,Ye(),qt()}function Ut(){if(!E)return;const e=document.getElementById("pixelCanvas");if(!e)return;const t=E.clientWidth-100,n=E.clientHeight-100,o=e.width,r=e.height,i=t/o,a=n/r;j=Math.min(i,a,1),Ue=0,qe=0,Ye(),qt()}function Ye(){const e=document.querySelector(".canvas-wrapper");e&&(e.style.transform=`translate(${Ue}px, ${qe}px) scale(${j})`,e.style.transformOrigin="center center")}function qt(){const e=document.getElementById("zoomSelect");if(!e)return;const t=Math.round(j*100),n=Array.from(e.options).find(o=>o.value!=="fit"&&Math.abs(parseFloat(o.value)-j)<.01);if(n)e.value=n.value;else{let o=e.querySelector('option[data-custom="true"]');o||(o=document.createElement("option"),o.dataset.custom="true",e.insertBefore(o,e.options[e.options.length-1])),o.value=j,o.textContent=`${t}%`,e.value=j}}function zi(){return j}function Mi(){return{x:Ue,y:qe}}function Pi(){const e=document.getElementById("zoomSelect");e&&e.value==="fit"&&Ut()}const ot={init:Ii,zoomIn:Ht,zoomOut:_t,setZoom:We,resetView:Gt,fitToScreen:Ut,getZoom:zi,getPan:Mi,updateCanvasSize:Pi};let T=null,ke=null,ee=null,V=null,ge=null,Tt=null,rt=null,Qe=!1;function Ni(e,t={}){T=e,ke=t.renderer||H,ee=t.pixelData||x,V=t.toolRegistry||b,ge=t.colorPalette||K,Tt=t.viewport||ot,rt=t.onChange||null,Ai(),s.debug?.("CanvasEvents initialized")}function Ai(){T.addEventListener("mousedown",Wt),T.addEventListener("mousemove",Yt),T.addEventListener("mouseup",Re),T.addEventListener("mouseleave",Re),T.addEventListener("touchstart",zn,{passive:!1}),T.addEventListener("touchmove",Mn,{passive:!1}),T.addEventListener("touchend",it),T.addEventListener("touchcancel",it),T.addEventListener("contextmenu",e=>e.preventDefault()),s.debug?.("Canvas event listeners registered")}function Wt(e){if(!V||!ee)return;const t=Xt(e);if(!t)return;const n=ee.getData(),r={colorCode:ge?ge.getCurrentColorIndex():1,event:e};Qe=!0,V.startDrawing(t.x,t.y,n,r);const i=V.getCurrentToolId();["brush","pencil","eraser"].includes(i)&&V.continueDrawing(t.x,t.y,n,r)&&(jt(),Vt())}function Yt(e){if(!V||!ee)return;const t=Xt(e);if(!t)return;const n=ee.getData(),r={colorCode:ge?ge.getCurrentColorIndex():1,event:e,onSelectionChange:Pn};V.continueDrawing(t.x,t.y,n,r)&&(jt(),Vt()),V.getCurrentToolId()==="select"&&P&&P.renderPreview(t.x,t.y)}function Re(e){if(!Qe||!V||!ee){Qe=!1;return}Qe=!1;const t=Xt(e),n=ee.getData(),r={colorCode:ge?ge.getCurrentColorIndex():1,event:e,onSelectionChange:Pn};let i=!1;t?i=V.endDrawing(t.x,t.y,n,r):i=V.endDrawing(-1,-1,n,r),i&&(jt(),Vt()),V.getCurrentToolId()==="select"&&P&&P.renderPreview()}function zn(e){if(e.preventDefault(),e.touches.length===0)return;const t=e.touches[0],n=new MouseEvent("mousedown",{clientX:t.clientX,clientY:t.clientY,bubbles:!0});Wt(n)}function Mn(e){if(e.preventDefault(),e.touches.length===0)return;const t=e.touches[0],n=new MouseEvent("mousemove",{clientX:t.clientX,clientY:t.clientY,bubbles:!0});Yt(n)}function it(e){e.preventDefault();const t=new MouseEvent("mouseup",{bubbles:!0});Re(t)}function Xt(e){if(!ke||!ee)return null;const t=ee.getDimensions(),n=Tt?Tt.getZoom():1;return ke.screenToPixelCoords(e.clientX,e.clientY,t.width,t.height,n)}function Pn(e){P&&(P.setSelection(e),P.renderPreview()),C&&C.emit(C.Events.SELECTION_CHANGED,e)}function jt(){ke&&ee&&ke.render(ee.getData())}function Vt(){rt&&rt(),C&&C.emit(C.Events.CANVAS_CHANGED)}function ki(e){rt=e}function Ri(){T&&(T.removeEventListener("mousedown",Wt),T.removeEventListener("mousemove",Yt),T.removeEventListener("mouseup",Re),T.removeEventListener("mouseleave",Re),T.removeEventListener("touchstart",zn),T.removeEventListener("touchmove",Mn),T.removeEventListener("touchend",it),T.removeEventListener("touchcancel",it),T.removeEventListener("contextmenu",e=>e.preventDefault()),s.debug?.("CanvasEvents destroyed"))}const at={init:Ni,setChangeCallback:ki,destroy:Ri};let Fe=null,st=null,an=null,$e=null,Oe=null,yt=0;async function Hi(e,t=16,n=16,o=null){try{if(s.info?.("PixelCanvas initializing..."),st=o,Fe=document.getElementById(e),$e=b,!Fe)throw new Error(`Canvas element "${e}" not found`);if(an=await zt.loadConstants(),!x)throw new Error("PixelData module not available");if(x.init(t,n),!H)throw new Error("CanvasRenderer module not available");if(H.init(Fe,an),H.updateCanvasSize(t,n),P&&P.init(Fe,{renderer:H}),!at)throw new Error("CanvasEvents module not available");at.init(Fe,{renderer:H,pixelData:x,toolRegistry:$e,onChange:ft}),dt(),_i(),s.info?.(`PixelCanvas initialized: ${t}×${n}`),C&&C.emit(C.Events.CANVAS_RESIZED,{width:t,height:n})}catch(r){throw s.error?.("PixelCanvas initialization failed",r),r}}function _i(){if(Oe)return;function e(){if(H.render(x.getData()),P&&$e){yt=(yt+.25)%16;const t=$e.getCurrentTool(),n={bounds:null,previewBounds:null,movePreview:null};t&&(n.bounds=t.selectionActive?t.selectionBounds:null,t.constructor.CONFIG.id==="select"&&t.isDrawing&&(n.bounds=null,n.previewBounds={x1:Math.min(t.startX,t.lastX),y1:Math.min(t.startY,t.lastY),x2:Math.max(t.startX,t.lastX),y2:Math.max(t.startY,t.lastY)}),t.constructor.CONFIG.id==="move"&&t.isMoving&&(n.movePreview=t.getPreviewData(),n.bounds=null)),P.render(n,yt)}Oe=requestAnimationFrame(e)}e(),s.info?.("PixelCanvas render loop started.")}function Gi(){Oe&&(cancelAnimationFrame(Oe),Oe=null,s.info?.("PixelCanvas render loop stopped."))}function Ui(){x&&(x.clear(),ft(),C&&C.emit(C.Events.CANVAS_CLEARED))}function qi(){return x?x.getData().some(t=>t.some(n=>n!==0)):!1}function Wi(e,t){if(!x||!H)return!1;if(x.resize(e,t)){const n=H.getPixelSize();return H.updateCanvasSize(e,t,n),P&&P.updateSize(),dt(),ft(),C&&C.emit(C.Events.CANVAS_RESIZED,{width:e,height:t}),!0}return!1}function Yi(e=!1){return x?x.exportToString(e):""}function Xi(e){if(!x||!H)return!1;const t=x.importFromString(e);if(t.success){const n=x.getDimensions(),o=H.getPixelSize();if(H.updateCanvasSize(n.width,n.height,o),P&&P.updateSize(),$e){const r=$e.getCurrentTool();r&&r.clearSelection()}return dt(),ft(),C&&C.emit(C.Events.FILE_LOADED,{width:n.width,height:n.height}),!0}else return window.Dialogs?window.Dialogs.alert("Import Failed",t.error,"error"):alert("Import failed: "+t.error),!1}function dt(){if(!x)return;const e=x.getDimensions(),t=document.getElementById("canvasSizeDisplay");t&&St?t.textContent=St.formatDimensions(e.width,e.height):t&&(t.textContent=`${e.width}×${e.height}`)}function ft(){st&&st(),dt()}function ji(){Gi(),at&&at.destroy(),P&&P.destroy(),s.info?.("PixelCanvas destroyed")}function Vi(){return x?x.getData():[]}function Ki(){return x?x.getDimensions():{width:0,height:0}}function Zi(){return x?x.getStats():{}}function Ji(e){st=e,events&&events.setChangeCallback(e)}const w={init:Hi,clear:Ui,hasContent:qi,resize:Wi,exportToString:Yi,importFromString:Xi,getPixelData:Vi,getDimensions:Ki,getStats:Zi,setChangeCallback:Ji,destroy:ji};let Ze=null,$t=!1;function ye(){if(Ze!==null)return Ze;try{const e="__storage_test__";return localStorage.setItem(e,e),localStorage.removeItem(e),Ze=!0,!0}catch(e){return Ze=!1,s.warn?.("localStorage is not available",e),!1}}function Kt(e){if(!ye())return null;try{return localStorage.getItem(e)}catch(t){return s.error?.("localStorage.getItem failed",t),null}}function Nn(e,t){if(!ye())return!1;try{return localStorage.setItem(e,t),$t=!1,!0}catch(n){return n.name==="QuotaExceededError"||n.code===22?($t=!0,s.error?.("localStorage quota exceeded",n)):s.error?.("localStorage.setItem failed",n),!1}}function Qi(e){if(!ye())return!1;try{return localStorage.removeItem(e),!0}catch(t){return s.error?.("localStorage.removeItem failed",t),!1}}function ea(){if(!ye())return!1;try{return localStorage.clear(),!0}catch(e){return s.error?.("localStorage.clear failed",e),!1}}function ta(){if(!ye())return[];try{const e=[];for(let t=0;t<localStorage.length;t++){const n=localStorage.key(t);n&&e.push(n)}return e}catch(e){return s.error?.("localStorage.keys failed",e),[]}}function na(){return $t}function oa(){if(!ye())return null;try{let e=0;for(let n=0;n<localStorage.length;n++){const o=localStorage.key(n);if(o){const r=localStorage.getItem(o);r&&(e+=o.length+r.length)}}const t=5*1024*1024;return{used:e,total:t,percentage:(e/t*100).toFixed(2),usedKB:(e/1024).toFixed(2),totalMB:(t/1024/1024).toFixed(2),available:t-e}}catch(e){return s.error?.("getStorageStats failed",e),null}}function ra(e,t=null){const n=Kt(e);if(!n)return t;try{return JSON.parse(n)}catch(o){return s.error?.("JSON parse failed",o),t}}function ia(e,t){try{const n=JSON.stringify(t);return Nn(e,n)}catch(n){return s.error?.("JSON stringify failed",n),!1}}function aa(e){return Kt(e)!==null}const q={isStorageAvailable:ye,getItem:Kt,setItem:Nn,removeItem:Qi,clear:ea,keys:ta,isQuotaExceeded:na,getStorageStats:oa,getJSON:ra,setJSON:ia,hasKey:aa};let be=null,Ct=null,He=null,_e=!1,ht=!0;const sa=3e4,la=2e3;function ca(){ua(),An(),s.info("Autosave initialized")}function ua(){const e=document.querySelector(".menu-bar");if(!e)return;const t=document.createElement("div");t.id="autosaveIndicator",t.className="autosave-indicator",t.innerHTML=`
        <span class="autosave-status">
            <span class="autosave-icon">💾</span>
            <span class="autosave-text">Saved</span>
        </span>
        <span class="autosave-time"></span>
    `,e.appendChild(t)}function An(){be&&clearInterval(be),be=setInterval(()=>{_e&&ht&&Zt()},sa)}function da(){be&&(clearInterval(be),be=null)}function fa(){_e=!0,et("unsaved"),Ct&&clearTimeout(Ct),Ct=setTimeout(()=>{_e&&ht&&Zt()},la)}function Zt(){if(!ht)return;et("saving");const e=Z?Z.getCurrentTab():null;if(!e)return;const t=w.exportToString();try{const n=`autosave_${e.id}`;q.setItem(n,t),q.setItem(`${n}_timestamp`,Date.now().toString()),_e=!1,He=Date.now(),setTimeout(()=>{et("saved")},500),s.info("Autosaved:",e.name)}catch(n){s.error("Autosave failed:",n),et("error")}}function et(e){const t=document.getElementById("autosaveIndicator");if(!t)return;const n=t.querySelector(".autosave-icon"),o=t.querySelector(".autosave-text"),r=t.querySelector(".autosave-time");switch(t.classList.remove("status-saved","status-saving","status-unsaved","status-error"),e){case"saved":t.classList.add("status-saved"),n.textContent="✓",o.textContent="Saved",He&&(r.textContent=kn(He));break;case"saving":t.classList.add("status-saving"),n.textContent="⏳",o.textContent="Saving...";break;case"unsaved":t.classList.add("status-unsaved"),n.textContent="●",o.textContent="Unsaved";break;case"error":t.classList.add("status-error"),n.textContent="⚠️",o.textContent="Error";break}}function kn(e){const t=Math.floor((Date.now()-e)/1e3);return t<60?"just now":t<3600?`${Math.floor(t/60)}m ago`:t<86400?`${Math.floor(t/3600)}h ago`:`${Math.floor(t/86400)}d ago`}function ha(){setInterval(()=>{const t=document.getElementById("autosaveIndicator")?.querySelector(".autosave-time");t&&He&&!_e&&(t.textContent=kn(He))},3e4)}function ma(e){try{const t=`autosave_${e}`,n=q.getItem(t),o=q.getItem(`${t}_timestamp`);if(n&&o)return{data:n,timestamp:parseInt(o)}}catch(t){s.error("Failed to load autosave:",t)}return null}function ga(e){try{const t=`autosave_${e}`;q.removeItem(t),q.removeItem(`${t}_timestamp`)}catch(t){s.error("Failed to clear autosave:",t)}}function pa(e){ht=e,e?An():da()}function va(){Zt()}ha();const se={init:ca,markDirty:fa,forceSave:va,loadAutosave:ma,clearAutosave:ga,setEnabled:pa};let A=[],ie=null,ze=0;function ya(e=!0){Ca(),e&&Ia().length===0&&Jt("Untitled-1",8,8),s.info("Tab Manager initialized")}function Ca(){const e=document.querySelector(".workspace");if(!e)return;const t=e.querySelector(".menu-bar"),n=document.createElement("div");n.className="tab-bar",n.id="tabBar",n.innerHTML=`
        <div class="tab-list" id="tabList"></div>
        <button class="tab-new-btn" id="newTabBtn" title="New Document (Ctrl+N)">+</button>
    `,e.insertBefore(n,t.nextSibling),document.getElementById("newTabBtn").addEventListener("click",()=>{Jt()})}function Jt(e=null,t=16,n=16,o=null){ze++;const r=`tab_${Date.now()}_${ze}`,i=e||`Untitled-${ze}`,a={id:r,name:i,width:t,height:n,data:o||wa(t,n),isDirty:!1,created:Date.now(),modified:Date.now()};return A.push(a),Rn(a),Xe(r),a}function wa(e,t){const n="0".repeat(e*t);return`${e}x${t}:${n}`}function Rn(e){const t=document.getElementById("tabList");if(!t)return;const n=document.createElement("div");n.className="tab",n.dataset.tabId=e.id,n.innerHTML=`
        <span class="tab-name">${e.name}</span>
        <span class="tab-dirty" style="display: none;">●</span>
        <button class="tab-close" title="Close">×</button>
    `,n.addEventListener("click",o=>{o.target.classList.contains("tab-close")||Xe(e.id)}),n.querySelector(".tab-close").addEventListener("click",o=>{o.stopPropagation(),Hn(e.id)}),n.querySelector(".tab-name").addEventListener("dblclick",o=>{o.stopPropagation(),_n(e.id)}),t.appendChild(n)}function Xe(e){const t=A.find(n=>n.id===e);t&&(ie&&Sa(),ie=e,document.querySelectorAll(".tab").forEach(n=>{n.classList.toggle("active",n.dataset.tabId===e)}),w&&w.importFromString(t.data),document.title=`${t.name} - Inline.px`,s.info("Switched to tab:",t.name))}function Sa(){const e=A.find(t=>t.id===ie);!e||!w||(e.data=w.exportToString(),e.modified=Date.now())}async function Hn(e){const t=A.find(o=>o.id===e);if(!t)return;if(A.length===1){if(t.isDirty&&!await O.confirm("Unsaved Changes",`"${t.name}" has unsaved changes. Close anyway?`,{confirmText:"Close",cancelText:"Cancel",type:"warning",dangerous:!0}))return;A=[],ie=null;const o=document.querySelector(`.tab[data-tab-id="${e}"]`);if(o&&o.remove(),typeof showWelcomeScreen=="function")showWelcomeScreen();else{const r=document.getElementById("welcomeScreen"),i=document.getElementById("canvasContainer");r&&(r.style.display="flex"),i&&(i.style.display="none")}s.info("Last tab closed, returning to welcome screen");return}if(t.isDirty&&!await O.confirm("Unsaved Changes",`"${t.name}" has unsaved changes. Close anyway?`,{confirmText:"Close",cancelText:"Cancel",type:"warning",dangerous:!0}))return;A=A.filter(o=>o.id!==e);const n=document.querySelector(`.tab[data-tab-id="${e}"]`);if(n&&n.remove(),ie===e){const o=A[A.length-1];o&&Xe(o.id)}se&&se.clearAutosave(e),s.info("Closed tab:",t.name)}async function _n(e){const t=A.find(o=>o.id===e);if(!t)return;const n=await O.prompt("Rename Document","Enter a new name for this document:",t.name,{placeholder:"Document name"});n&&n.trim()&&(t.name=n.trim(),mt(t),ie===e&&(document.title=`${t.name} - Inline.px`))}function mt(e){const t=document.querySelector(`.tab[data-tab-id="${e.id}"]`);if(!t)return;const n=t.querySelector(".tab-name"),o=t.querySelector(".tab-dirty");n&&(n.textContent=e.name),o&&(o.style.display=e.isDirty?"inline":"none")}function ba(){const e=A.find(t=>t.id===ie);e&&(e.isDirty=!0,e.modified=Date.now(),mt(e),se&&se.markDirty())}function xa(){const e=A.find(t=>t.id===ie);e&&(e.isDirty=!1,mt(e))}function Gn(){return A.find(e=>e.id===ie)||null}function Ea(){return A}function Da(e){const t=Gn();t&&(t.name=e,mt(t),document.title=`${t.name} - Inline.px`)}function Ia(){const e=[];try{if(!q.isStorageAvailable())return s.warn?.("localStorage not available, cannot restore tabs"),e;const t=q.keys();for(const n of t)if(n&&n.startsWith("autosave_tab_")&&!n.endsWith("_timestamp"))try{const o=n.replace("autosave_",""),r=se?se.loadAutosave(o):null;if(r&&r.data){const i=r.data.split(":");let a,l;i[1]==="RLE"?(a=i[0].split("x"),l=k.decompress(r.data)):(a=i[0].split("x"),l=r.data);const c=parseInt(a[0]),u=parseInt(a[1]);if(isNaN(c)||isNaN(u)||c<=0||u<=0){s.warn?.(`Invalid dimensions in autosave ${o}, skipping`);continue}ze++;const f={id:o,name:`Restored-${ze}`,width:c,height:u,data:l,isDirty:!1,created:r.timestamp,modified:r.timestamp};A.push(f),Rn(f),e.push(f)}}catch(o){s.warn?.("Failed to restore individual tab, skipping",o);continue}e.length>0&&(Xe(e[0].id),s.info?.(`Restored ${e.length} autosaved tab(s)`))}catch(t){s.error?.("Failed to restore autosaved tabs:",t)}return e}const Z={init:ya,createNewTab:Jt,switchToTab:Xe,closeTab:Hn,renameTab:_n,markCurrentTabDirty:ba,markCurrentTabClean:xa,getCurrentTab:Gn,getAllTabs:Ea,setCurrentTabName:Da},Un="pixelart_files";let pe=null,de=null,Ce=null;function je(){return q.getJSON(Un,[])}async function qn(e){const t=q.setJSON(Un,e);return t||(s.error?.("Error saving to LocalStorage"),q.isQuotaExceeded()?await O.alert("Storage Full","Storage quota exceeded. Please delete some files to free up space.","error"):q.isStorageAvailable()?await O.alert("Save Failed","Failed to save file. Please try again.","error"):await O.alert("Storage Unavailable","LocalStorage is not available. Your browser may be in private mode.","error")),t}async function Ta(e,t=null){if(!t&&(t=await O.prompt("Save Pixel Art","Enter a name for your pixel art:",pe||"untitled",{placeholder:"File name"}),!t))return!1;const n=e.split(":");if(n.length!==2)return await O.alert("Invalid Format","Invalid data format.","error"),!1;const o=n[0].split("x"),r=parseInt(o[0]),i=parseInt(o[1]),a=je(),l=a.findIndex(u=>u.name===t);if(l>=0&&!await O.confirm("Overwrite File",`A file named "${t}" already exists. Overwrite it?`,{confirmText:"Overwrite",cancelText:"Cancel",type:"warning"}))return!1;const c={id:l>=0?a[l].id:Fa(),name:t,data:e,timestamp:Date.now(),width:r,height:i};return l>=0?a[l]=c:a.push(c),qn(a)?(pe=t,await O.alert("Saved!",`Saved as "${t}"`,"success"),!0):!1}function $a(e){const n=je().find(o=>o.id===e);return n?(pe=n.name,n):null}function Wn(e){const t=je(),n=t.filter(o=>o.id!==e);return n.length<t.length?qn(n):!1}function La(e,t=null){t||(t=pe||"pixelart"),t.endsWith(".txt")||(t+=".txt");const n=new Blob([e],{type:"text/plain"}),o=URL.createObjectURL(n),r=document.createElement("a");r.href=o,r.download=t,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(o)}function Fa(){return"file_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}function Ba(){return pe}function Oa(e){pe=e}function za(){pe=null}function Yn(e){return new Date(e).toLocaleString()}function Ma(){return q.getStorageStats()}function Pa(e){const t=document.getElementById("fileModal"),n=document.getElementById("fileList"),o=document.getElementById("noFilesMessage"),r=document.getElementById("closeModal");if(!t||!n){s.error?.("Modal elements not found");return}de&&r.removeEventListener("click",de),Ce&&t.removeEventListener("click",Ce);const i=je();n.innerHTML="",i.length===0?o.classList.remove("hidden"):(o.classList.add("hidden"),i.sort((a,l)=>l.timestamp-a.timestamp),i.forEach(a=>{const l=Na(a,e);n.appendChild(l)})),t.classList.add("flex"),t.classList.remove("hidden"),de=()=>{t.classList.add("hidden"),t.classList.remove("flex"),r.removeEventListener("click",de),t.removeEventListener("click",Ce),de=null,Ce=null},Ce=a=>{a.target===t&&de()},r.addEventListener("click",de),t.addEventListener("click",Ce)}function Na(e,t){const n=document.createElement("div");n.className="file-item";const o=document.createElement("div");o.className="file-item-info";const r=document.createElement("div");r.className="file-item-name",r.textContent=e.name;const i=document.createElement("div");i.className="file-item-meta",i.textContent=`${e.width}x${e.height} • ${Yn(e.timestamp)}`,o.appendChild(r),o.appendChild(i);const a=document.createElement("div");a.className="file-item-actions";const l=document.createElement("button");l.className="btn btn-success",l.textContent="Load",l.addEventListener("click",()=>{const u=document.getElementById("fileModal");u.classList.add("hidden"),u.classList.remove("flex"),t(e)});const c=document.createElement("button");return c.className="btn btn-danger",c.textContent="Delete",c.addEventListener("click",async()=>{if(await O.confirm("Delete File",`Delete "${e.name}"? This cannot be undone.`,{confirmText:"Delete",cancelText:"Cancel",type:"error",dangerous:!0})&&Wn(e.id)){n.remove();const f=document.getElementById("fileList");if(f&&f.children.length===0){const d=document.getElementById("noFilesMessage");d&&d.classList.remove("hidden")}}}),a.appendChild(l),a.appendChild(c),n.appendChild(o),n.appendChild(a),n}const le={save:Ta,load:$a,deleteFile:Wn,getAllFiles:je,exportAsFile:La,getCurrentFileName:Ba,setCurrentFileName:Oa,clearCurrentFileName:za,formatDate:Yn,getStorageStats:Ma,showLoadDialog:Pa};let re=[],ce=[];const Xn=50;let Lt=null;function Aa(e={}){e.onHistoryChange&&(Lt=e.onHistoryChange),s.info("History system initialized")}function ka(e,t="Change"){e&&(re.push({data:e,action:t,timestamp:Date.now()}),re.length>Xn&&re.shift(),ce=[],gt())}function Ra(e){if(re.length===0)return s.debug("Nothing to undo"),null;e&&ce.push({data:e,action:"Redo point",timestamp:Date.now()});const t=re.pop();return gt(),s.info("Undo:",t.action),t.data}function Ha(e){if(ce.length===0)return s.debug("Nothing to redo"),null;e&&re.push({data:e,action:"Undo point",timestamp:Date.now()});const t=ce.pop();return gt(),s.info("Redo:",t.action),t.data}function _a(){re=[],ce=[],gt(),s.info("History cleared")}function jn(){return re.length>0}function Vn(){return ce.length>0}function Ga(){return{undoCount:re.length,redoCount:ce.length,maxHistory:Xn}}function gt(){Lt&&Lt({canUndo:jn(),canRedo:Vn(),undoCount:re.length,redoCount:ce.length})}const Le={init:Aa,pushState:ka,undo:Ra,redo:Ha,clear:_a,canUndo:jn,canRedo:Vn,getStats:Ga};function Ua(e=1,t="pixelart.png"){if(!document.getElementById("pixelCanvas")){s.error("Canvas not found");return}const o=w.getDimensions(),r=w.getPixelData(),i=document.createElement("canvas");i.width=o.width*e,i.height=o.height*e;const a=i.getContext("2d");a.imageSmoothingEnabled=!1,a.imageSmoothingQuality="high";for(let l=0;l<o.height;l++)for(let c=0;c<o.width;c++){const u=r[l][c];if(u===0)continue;const f=K.getColor(u);a.fillStyle=f,a.fillRect(c*e,l*e,e,e)}i.toBlob(l=>{Kn(l,t)},"image/png")}function qa(e,t=1,n="pixelart.png"){let o=e;k&&k.isCompressed(e)&&(o=k.decompress(e));const[r,i]=o.split(":"),[a,l]=r.split("x").map(Number),c=document.createElement("canvas");c.width=a*t,c.height=l*t;const u=c.getContext("2d");u.imageSmoothingEnabled=!1;for(let f=0;f<l;f++)for(let d=0;d<a;d++){const h=f*a+d,g=i[h],p=K.getIndexFromChar(g);if(p===0)continue;const y=K.getColor(p);u.fillStyle=y,u.fillRect(d*t,f*t,t,t)}c.toBlob(f=>{Kn(f,n)},"image/png")}function Wa(e=1){const t=w.getDimensions(),n=w.getPixelData(),o=document.createElement("canvas");o.width=t.width*e,o.height=t.height*e;const r=o.getContext("2d");r.imageSmoothingEnabled=!1;for(let i=0;i<t.height;i++)for(let a=0;a<t.width;a++){const l=n[i][a];if(l===0)continue;const c=K.getColor(l);r.fillStyle=c,r.fillRect(a*e,i*e,e,e)}return o.toDataURL("image/png")}function Kn(e,t){const n=URL.createObjectURL(e),o=document.createElement("a");o.href=n,o.download=t,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(n)}async function Ya(e=1){try{const t=w.getDimensions(),n=w.getPixelData(),o=document.createElement("canvas");o.width=t.width*e,o.height=t.height*e;const r=o.getContext("2d");r.imageSmoothingEnabled=!1;for(let a=0;a<t.height;a++)for(let l=0;l<t.width;l++){const c=n[a][l];if(c===0)continue;const u=K.getColor(c);r.fillStyle=u,r.fillRect(l*e,a*e,e,e)}const i=await new Promise(a=>{o.toBlob(a,"image/png")});if(navigator.clipboard&&navigator.clipboard.write)return await navigator.clipboard.write([new ClipboardItem({"image/png":i})]),!0;throw new Error("Clipboard API not supported")}catch(t){return s.error("Failed to copy PNG to clipboard:",t),!1}}function Xa(){const e=w.getDimensions(),t=Math.max(e.width,e.height);return[{value:1,label:"1× (Original)",size:`${e.width}×${e.height}`},{value:2,label:"2× (Small)",size:`${e.width*2}×${e.height*2}`},{value:4,label:"4× (Medium)",size:`${e.width*4}×${e.height*4}`},{value:8,label:"8× (Large)",size:`${e.width*8}×${e.height*8}`}].filter(o=>t*o.value<=2048)}const ja={exportToPNG:Ua,exportDataStringToPNG:qa,getDataURL:Wa,copyToClipboard:Ya,getScaleOptions:Xa};class Va extends te{static CONFIG={id:"brush",name:"Brush",icon:"brush",shortcut:"B",cursor:"crosshair",hasSizeOption:!0,hasShapeOption:!1,description:"Variable size painting brush",category:"drawing"};onDrawStart(t,n,o,r){return this.drawBrush(t,n,o,r)}onDrawContinue(t,n,o,r){return this.drawBrush(t,n,o,r)}onDrawEnd(t,n,o,r){return this.drawBrush(t,n,o,r)}drawBrush(t,n,o,r){const i=o.length,a=o[0].length,l=r.brushSize||this.getOption("brushSize")||1,c=r.colorCode||0;let u=!1;const f=Math.floor(l/2);for(let d=-f;d<=f;d++)for(let h=-f;h<=f;h++){const g=t+h,p=n+d,y=h*h+d*d,m=f*f+f;if(y<=m&&g>=0&&g<a&&p>=0&&p<i){if(this.respectsSelection()&&!this.isInSelection(g,p))continue;o[p][g]!==c&&(o[p][g]=c,u=!0)}}return u}}class Ka extends te{static CONFIG={id:"pencil",name:"Pencil",icon:"edit",shortcut:"P",cursor:"crosshair",hasSizeOption:!1,hasShapeOption:!1,description:"1px precise drawing",category:"drawing"};onDrawStart(t,n,o,r){return this.setPixelIfValid(t,n,o,r.colorCode)}onDrawContinue(t,n,o,r){return this.setPixelIfValid(t,n,o,r.colorCode)}onDrawEnd(t,n,o,r){return this.setPixelIfValid(t,n,o,r.colorCode)}setPixelIfValid(t,n,o,r){return this.respectsSelection()&&!this.isInSelection(t,n)?!1:this.setPixel(t,n,o,r)}}class Za extends te{static CONFIG={id:"eraser",name:"Eraser",icon:"ink_eraser",shortcut:"E",cursor:"crosshair",hasSizeOption:!0,hasShapeOption:!1,description:"Erase to transparent",category:"drawing"};onDrawStart(t,n,o,r){return this.erase(t,n,o,r)}onDrawContinue(t,n,o,r){return this.erase(t,n,o,r)}onDrawEnd(t,n,o,r){return this.erase(t,n,o,r)}erase(t,n,o,r){const i=o.length,a=o[0].length,l=r.brushSize||this.getOption("brushSize")||1;let c=!1;const u=Math.floor(l/2);for(let f=-u;f<=u;f++)for(let d=-u;d<=u;d++){const h=t+d,g=n+f,p=d*d+f*f,y=u*u+u;if(p<=y&&h>=0&&h<a&&g>=0&&g<i){if(this.respectsSelection()&&!this.isInSelection(h,g))continue;o[g][h]!==0&&(o[g][h]=0,c=!0)}}return c}}class Ja extends te{static CONFIG={id:"line",name:"Line",icon:"show_chart",shortcut:"L",cursor:"crosshair",hasSizeOption:!0,hasShapeOption:!1,description:"Draw straight lines",category:"shape"};needsPreview(){return!0}onDrawStart(t,n,o,r){return!1}onDrawContinue(t,n,o,r){return this.restorePreviewData(o),this.drawLine(this.startX,this.startY,t,n,o,r)}onDrawEnd(t,n,o,r){return this.restorePreviewData(o),this.drawLine(this.startX,this.startY,t,n,o,r)}drawLine(t,n,o,r,i,a){const l=i.length,c=i[0].length,u=a.colorCode||0,f=a.brushSize||1;let d=!1;const h=Math.abs(o-t),g=Math.abs(r-n),p=t<o?1:-1,y=n<r?1:-1;let m=h-g,v=t,D=n;for(;f>1?d=this.drawBrushAt(v,D,i,u,f)||d:v>=0&&v<c&&D>=0&&D<l&&(this.respectsSelection()&&!this.isInSelection(v,D)||i[D][v]!==u&&(i[D][v]=u,d=!0)),!(v===o&&D===r);){const J=2*m;J>-g&&(m-=g,v+=p),J<h&&(m+=h,D+=y)}return d}drawBrushAt(t,n,o,r,i){const a=o.length,l=o[0].length;let c=!1;const u=Math.floor(i/2);for(let f=-u;f<=u;f++)for(let d=-u;d<=u;d++){const h=t+d,g=n+f,p=d*d+f*f,y=u*u+u;if(p<=y&&h>=0&&h<l&&g>=0&&g<a){if(this.respectsSelection()&&!this.isInSelection(h,g))continue;o[g][h]!==r&&(o[g][h]=r,c=!0)}}return c}}class Qa extends te{static CONFIG={id:"rectangle",name:"Rectangle",icon:"rectangle",shortcut:"R",cursor:"crosshair",hasSizeOption:!1,hasShapeOption:!0,description:"Draw rectangles",category:"shape"};needsPreview(){return!0}onDrawStart(t,n,o,r){return!1}onDrawContinue(t,n,o,r){return this.restorePreviewData(o),this.drawRectangle(this.startX,this.startY,t,n,o,r)}onDrawEnd(t,n,o,r){return this.restorePreviewData(o),this.drawRectangle(this.startX,this.startY,t,n,o,r)}drawRectangle(t,n,o,r,i,a){const l=i.length,c=i[0].length,u=a.colorCode||0,f=a.shapeMode||this.getOption("shapeMode")||"fill";let d=!1;const h=Math.max(0,Math.min(t,o)),g=Math.min(c-1,Math.max(t,o)),p=Math.max(0,Math.min(n,r)),y=Math.min(l-1,Math.max(n,r));if(f==="fill")for(let m=p;m<=y;m++)for(let v=h;v<=g;v++)this.respectsSelection()&&!this.isInSelection(v,m)||i[m][v]!==u&&(i[m][v]=u,d=!0);else{for(let m=h;m<=g;m++)this.isInSelection(m,p)&&i[p][m]!==u&&(i[p][m]=u,d=!0),this.isInSelection(m,y)&&i[y][m]!==u&&(i[y][m]=u,d=!0);for(let m=p;m<=y;m++)this.isInSelection(h,m)&&i[m][h]!==u&&(i[m][h]=u,d=!0),this.isInSelection(g,m)&&i[m][g]!==u&&(i[m][g]=u,d=!0)}return d}}class es extends te{static CONFIG={id:"ellipse",name:"Ellipse",icon:"circle",shortcut:"O",cursor:"crosshair",hasSizeOption:!1,hasShapeOption:!0,description:"Draw circles/ellipses",category:"shape"};needsPreview(){return!0}onDrawStart(t,n,o,r){return!1}onDrawContinue(t,n,o,r){return this.restorePreviewData(o),this.drawEllipse(this.startX,this.startY,t,n,o,r)}onDrawEnd(t,n,o,r){return this.restorePreviewData(o),this.drawEllipse(this.startX,this.startY,t,n,o,r)}drawEllipse(t,n,o,r,i,a){const l=i.length,c=i[0].length,u=a.colorCode||0,f=a.shapeMode||this.getOption("shapeMode")||"fill";let d=!1;const h=Math.floor((t+o)/2),g=Math.floor((n+r)/2),p=Math.abs(o-t)/2,y=Math.abs(r-n)/2;if(f==="fill")for(let m=Math.floor(g-y);m<=Math.ceil(g+y);m++)for(let v=Math.floor(h-p);v<=Math.ceil(h+p);v++){if(v<0||v>=c||m<0||m>=l)continue;const D=(v-h)/p,J=(m-g)/y;if(D*D+J*J<=1){if(this.respectsSelection()&&!this.isInSelection(v,m))continue;i[m][v]!==u&&(i[m][v]=u,d=!0)}}else for(let m=0;m<360;m+=1){const v=m*Math.PI/180,D=Math.round(h+p*Math.cos(v)),J=Math.round(g+y*Math.sin(v));if(D>=0&&D<c&&J>=0&&J<l){if(this.respectsSelection()&&!this.isInSelection(D,J))continue;i[J][D]!==u&&(i[J][D]=u,d=!0)}}return d}}class ts extends te{static CONFIG={id:"fill",name:"Fill",icon:"format_color_fill",shortcut:"F",cursor:"crosshair",hasSizeOption:!1,hasShapeOption:!1,description:"Flood fill",category:"drawing"};onDrawStart(t,n,o,r){return!1}onDrawContinue(t,n,o,r){return!1}onDrawEnd(t,n,o,r){return this.floodFill(t,n,o,r)}floodFill(t,n,o,r){const i=o.length,a=o[0].length,l=r.colorCode||0;if(t<0||t>=a||n<0||n>=i)return!1;if(this.respectsSelection()&&!this.isInSelection(t,n))return this.logger.warn?.("Fill tool: clicked outside selection"),!1;const c=o[n][t];if(c===l)return!1;const u=[[t,n]],f=new Set;let d=!1,h=0;const g=a*i;for(;u.length>0&&h<g;){h++;const[p,y]=u.pop(),m=`${p},${y}`;f.has(m)||p<0||p>=a||y<0||y>=i||o[y][p]===c&&(this.respectsSelection()&&!this.isInSelection(p,y)||(o[y][p]=l,f.add(m),d=!0,u.push([p+1,y]),u.push([p-1,y]),u.push([p,y+1]),u.push([p,y-1])))}return h>=g&&this.logger.warn?.("Flood fill reached iteration limit"),d}}class ns extends te{static CONFIG={id:"select",name:"Select",icon:"select_all",shortcut:"M",cursor:"crosshair",hasSizeOption:!1,hasShapeOption:!1,description:"Rectangular selection",category:"selection"};constructor(){super(),this.tempSelection=null}respectsSelection(){return!1}onDrawStart(t,n,o,r){return this.tempSelection={x1:t,y1:n,x2:t,y2:n},!1}onDrawContinue(t,n,o,r){return this.tempSelection&&(this.tempSelection.x2=t,this.tempSelection.y2=n),!1}onDrawEnd(t,n,o,r){if(this.tempSelection){const i={x1:Math.min(this.tempSelection.x1,t),y1:Math.min(this.tempSelection.y1,n),x2:Math.max(this.tempSelection.x1,t),y2:Math.max(this.tempSelection.y1,n)};this.setSelection(i),this.tempSelection=null,r.onSelectionChange&&r.onSelectionChange(i)}return!1}onDrawCancel(){this.tempSelection=null}getSelectionData(){if(this.tempSelection){const t=Math.min(this.tempSelection.x1,this.tempSelection.x2),n=Math.min(this.tempSelection.y1,this.tempSelection.y2),o=Math.max(this.tempSelection.x1,this.tempSelection.x2),r=Math.max(this.tempSelection.y1,this.tempSelection.y2);return{active:!0,isDrawing:!0,x1:t,y1:n,x2:o,y2:r}}else if(this.selectionActive&&this.selectionBounds)return{active:!0,isDrawing:!1,...this.selectionBounds};return null}getSelectedPixels(t){if(!this.selectionActive||!this.selectionBounds)return null;const{x1:n,y1:o,x2:r,y2:i}=this.selectionBounds,a=[];for(let l=o;l<=i;l++){const c=[];for(let u=n;u<=r;u++)l>=0&&l<t.length&&u>=0&&u<t[0].length?c.push(t[l][u]):c.push(0);a.push(c)}return a}}class os extends te{static CONFIG={id:"magicWand",name:"Magic Wand",icon:"auto_fix_high",shortcut:"W",cursor:"crosshair",hasSizeOption:!1,hasShapeOption:!1,description:"Select by color",category:"selection"};respectsSelection(){return!1}onDrawStart(t,n,o,r){return!1}onDrawContinue(t,n,o,r){return!1}onDrawEnd(t,n,o,r){return this.selectByColor(t,n,o,r)}selectByColor(t,n,o,r){const i=o.length,a=o[0].length;if(t<0||t>=a||n<0||n>=i)return!1;const l=o[n][t],c=[],u=[[t,n]],f=new Set;for(;u.length>0;){const[m,v]=u.pop(),D=`${m},${v}`;f.has(D)||m<0||m>=a||v<0||v>=i||o[v][m]===l&&(f.add(D),c.push([m,v]),u.push([m+1,v]),u.push([m-1,v]),u.push([m,v+1]),u.push([m,v-1]))}if(c.length===0)return this.clearSelection(),!1;let d=a,h=i,g=0,p=0;c.forEach(([m,v])=>{d=Math.min(d,m),h=Math.min(h,v),g=Math.max(g,m),p=Math.max(p,v)});const y={x1:d,y1:h,x2:g,y2:p};return this.setSelection(y),r.onSelectionChange&&r.onSelectionChange(y),this.logger.info?.(`Magic wand selected ${c.length} pixels`),!1}}class rs extends te{static CONFIG={id:"move",name:"Move",icon:"open_with",shortcut:"V",cursor:"move",hasSizeOption:!1,hasShapeOption:!1,description:"Move selected content",category:"navigation"};constructor(){super(),this.isMoving=!1,this.selectionData=null,this.originalSelectionBounds=null,this.currentOffset={x:0,y:0}}needsPreview(){return!0}getPreviewData(){return!this.isMoving||!this.selectionData?null:{pixelData:this.selectionData,x:this.originalSelectionBounds.x1+this.currentOffset.x,y:this.originalSelectionBounds.y1+this.currentOffset.y}}onDrawStart(t,n,o,r){if(!this.selectionActive||!this.selectionBounds)return this.logger.info?.("MoveTool: No selection active, nothing to move."),!1;this.isMoving=!0,this.originalSelectionBounds={...this.selectionBounds},this.currentOffset={x:0,y:0};const{x1:i,y1:a,x2:l,y2:c}=this.originalSelectionBounds,u=l-i+1,f=c-a+1;this.selectionData=[];for(let d=0;d<f;d++){this.selectionData[d]=[];for(let h=0;h<u;h++)this.selectionData[d][h]=o[a+d][i+h]}for(let d=a;d<=c;d++)for(let h=i;h<=l;h++)o[d][h]=0;return!0}onDrawContinue(t,n,o,r){return this.isMoving&&(this.currentOffset.x=t-this.startX,this.currentOffset.y=n-this.startY),!1}onDrawEnd(t,n,o,r){if(!this.isMoving)return!1;const i=this.originalSelectionBounds.x1+this.currentOffset.x,a=this.originalSelectionBounds.y1+this.currentOffset.y,l=this.selectionData.length,c=this.selectionData[0].length,u=o.length,f=o[0].length;for(let h=0;h<l;h++)for(let g=0;g<c;g++){const p=i+g,y=a+h;p>=0&&p<f&&y>=0&&y<u&&this.selectionData[h][g]!==0&&(o[y][p]=this.selectionData[h][g])}const d={x1:i,y1:a,x2:i+c-1,y2:a+l-1};return this.setSelection(d),C.emit(C.Events.SELECTION_CHANGED,{bounds:d}),this.resetState(),!0}onDrawCancel(){if(this.isMoving){const{x1:t,y1:n}=this.originalSelectionBounds,o=this.selectionData.length,r=this.selectionData[0].length;for(let i=0;i<o;i++)for(let a=0;a<r;a++)n+i>=0&&n+i<this.pixelData.length&&t+a>=0&&t+a<this.pixelData[0].length&&(this.pixelData[n+i][t+a]=this.selectionData[i][a])}this.resetState()}resetState(){this.isMoving=!1,this.selectionData=null,this.originalSelectionBounds=null,this.currentOffset={x:0,y:0}}}class is extends te{static CONFIG={id:"hand",name:"Hand",icon:"pan_tool",shortcut:"H",cursor:"grab",hasSizeOption:!1,hasShapeOption:!1,description:"Pan canvas",category:"navigation"};constructor(){super(),this.viewportModule=null}init(){super.init()}activate(){super.activate(),this.updateCursor("grab")}respectsSelection(){return!1}onDrawStart(t,n,o,r){return this.updateCursor("grabbing"),this.viewportModule&&this.viewportModule.startPan&&this.viewportModule.startPan(t,n),!1}onDrawContinue(t,n,o,r){return this.viewportModule&&this.viewportModule.continuePan&&this.viewportModule.continuePan(t,n),!1}onDrawEnd(t,n,o,r){return this.updateCursor("grab"),this.viewportModule&&this.viewportModule.endPan&&this.viewportModule.endPan(),!1}onDrawCancel(){this.updateCursor("grab")}updateCursor(t){const n=document.querySelector(".canvas-container");n&&(n.style.cursor=t)}getCursor(){return this.isDrawing?"grabbing":"grab"}}let sn=!1,R=null,ln=null;async function as(){if(sn){s.warn("Application already initialized.");return}try{s.info("Inline.px initializing..."),R=await zt.loadConstants(),Ge.init(R),await ss(),cs(),ms(),gs(),sn=!0,s.info("Inline.px ready!"),C.emit("app:ready")}catch(e){s.error("Application initialization failed",e),C.emit("app:error",e),alert(`Critical error during initialization: ${e.message}. The app may not function correctly.`)}}async function ss(){O.init(),await K.init("colorPalette",ys);const{defaultWidth:e,defaultHeight:t}=R.canvas;await w.init("pixelCanvas",e,t,Cs),await ls(),Z.init(!1),se.init(),ot.init(),Le.init({onHistoryChange:ws}),s.info("Core systems initialized")}async function ls(){const e=[Va,Ka,Za,Ja,Qa,es,ts,ns,os,rs,is];b.init({onToolChange:ps,onToolOptionChange:vs,sharedOptions:{brushSize:R.tools.defaultBrushSize,shapeMode:R.tools.defaultShapeMode,colorCode:1}});const t=b.registerTools(e);s.info(`Registered ${t} tools`),b.setCurrentTool("brush")}function cs(){us(),ds(),fs(),hs(),ue(),pt()}function us(){const e=document.getElementById("toolbox");if(!e)return;e.innerHTML="",b.getAllTools().forEach(n=>{const o=document.createElement("button");o.className="tool-btn",o.dataset.tool=n.id,o.title=`${n.name} (${n.shortcut})`,n.id===b.getCurrentToolId()&&o.classList.add("active"),o.innerHTML=`<span class="material-symbols-outlined tool-icon">${n.icon}</span><span class="tool-label">${n.name}</span><span class="tool-shortcut">${n.shortcut}</span>`,o.addEventListener("click",()=>b.setCurrentTool(n.id)),e.appendChild(o)}),s.debug("Toolbox setup complete")}function ds(){N("newBtn",Jn),N("saveBtn",Qn),N("loadBtn",eo),N("undoBtn",to),N("redoBtn",Bt),N("exportFileBtn",$s),N("importStringBtn",Ls),N("clearBtn",Fs),N("copyLiveStringBtn",Bs)}function fs(){document.querySelectorAll(".tool-size-btn").forEach(e=>{e.addEventListener("click",()=>{const t=parseInt(e.dataset.size);b.setToolOption("brushSize",t),document.querySelectorAll(".tool-size-btn").forEach(n=>n.classList.remove("active")),e.classList.add("active")})}),document.querySelectorAll(".tool-mode-btn").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.mode;b.setToolOption("shapeMode",t),document.querySelectorAll(".tool-mode-btn").forEach(n=>n.classList.remove("active")),e.classList.add("active")})}),document.querySelectorAll(".preset-btn").forEach(e=>{e.addEventListener("click",()=>{const t=parseInt(e.dataset.size);document.getElementById("canvasWidth").value=t,document.getElementById("canvasHeight").value=t,wt()})}),N("resizeBtn",wt),["canvasWidth","canvasHeight"].forEach(e=>{const t=document.getElementById(e);t&&(t.addEventListener("keypress",n=>n.key==="Enter"&&wt()),t.addEventListener("input",pt))})}function hs(){N("welcomeNewBtn",bs),N("welcomeLoadBtn",Es),N("closeNewFileModal",Ft),N("cancelNewFileBtn",Ft),N("confirmNewFileBtn",xs),N("closeModal",()=>{document.getElementById("fileModal").style.display="none"}),document.querySelectorAll(".preset-btn-modal").forEach(e=>{e.addEventListener("click",()=>{const t=parseInt(e.dataset.size);document.getElementById("newFileWidth").value=t,document.getElementById("newFileHeight").value=t,document.querySelectorAll(".preset-btn-modal").forEach(n=>n.classList.remove("active")),e.classList.add("active")})}),["newFileWidth","newFileHeight"].forEach(e=>{const t=document.getElementById(e);t&&t.addEventListener("input",()=>{const n=parseInt(document.getElementById("newFileWidth").value),o=parseInt(document.getElementById("newFileHeight").value);document.querySelectorAll(".preset-btn-modal").forEach(r=>{const i=parseInt(r.dataset.size);r.classList.toggle("active",n===i&&o===i)})})}),s.debug("Welcome screen setup complete")}function ms(){document.addEventListener("keydown",e=>{if(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA")return;const t=e.key.toLowerCase();if(e.key==="Escape"){e.preventDefault(),b.clearSelection();return}if(b&&/^[a-z]$/.test(t)){const n=b.getToolByShortcut(t.toUpperCase());if(n){e.preventDefault(),b.setCurrentTool(n.getId());return}}if(e.ctrlKey||e.metaKey){const n={z:to,y:Bt,n:Jn,s:Qn,o:eo};n[t]&&(e.preventDefault(),t==="z"&&e.shiftKey?Bt():n[t]())}})}function gs(){C.on(C.Events.FILE_LOADED,()=>{vt(),ue()})}function ps(e,t){document.querySelectorAll(".tool-btn").forEach(r=>r.classList.toggle("active",r.dataset.tool===e)),document.getElementById("currentToolName").textContent=t.name,document.querySelector(".canvas-container").style.cursor=t.cursor;const n=document.getElementById("brushSizeOption"),o=document.getElementById("shapeModeOption");n.classList.toggle("hidden",!t.hasSizeOption),o.classList.toggle("hidden",!t.hasShapeOption),s.debug(`Tool changed to: ${t.name}`)}function vs(e,t){s.debug(`Tool option changed: ${e} = ${t}`)}function ys(e,t){document.getElementById("currentColorDisplay").style.backgroundColor=t,b.setToolOption("colorCode",e)}function Cs(){ue(),Z.markCurrentTabDirty(),clearTimeout(ln),ln=setTimeout(()=>{const e=w.exportToString();Le.pushState(e,"Paint")},R.history.debounceTime)}function ws({canUndo:e,canRedo:t,undoCount:n,redoCount:o}){const r=document.getElementById("undoBtn"),i=document.getElementById("redoBtn");r.disabled=!e,r.title=e?`Undo (${n} available)`:"Undo",i.disabled=!t,i.title=t?`Redo (${o} available)`:"Redo"}function ue(){const e=w.exportToString();document.getElementById("liveExportString").textContent=St.formatDataString(e,50),document.getElementById("stringLength").textContent=e.length}function pt(){const e=parseInt(document.getElementById("canvasWidth")?.value),t=parseInt(document.getElementById("canvasHeight")?.value);document.querySelectorAll(".preset-btn").forEach(n=>{n.classList.toggle("active",e===parseInt(n.dataset.size)&&t===parseInt(n.dataset.size))})}function Ss(){document.getElementById("welcomeScreen").style.display="flex",document.getElementById("canvasContainer").style.display="none"}window.showWelcomeScreen=Ss;function Zn(){document.getElementById("welcomeScreen").style.display="none",document.getElementById("canvasContainer").style.display="flex"}function bs(){const e=document.getElementById("newFileModal");e.style.display="flex",document.getElementById("newFileName").value="",document.getElementById("newFileWidth").value="8",document.getElementById("newFileHeight").value="8",document.querySelectorAll(".preset-btn-modal").forEach(t=>{t.classList.toggle("active",t.dataset.size==="8")}),setTimeout(()=>document.getElementById("newFileName").focus(),100)}function Ft(){document.getElementById("newFileModal").style.display="none"}function xs(){const e=document.getElementById("newFileName").value.trim()||"Untitled",t=parseInt(document.getElementById("newFileWidth").value),n=parseInt(document.getElementById("newFileHeight").value);if(t<R.canvas.minSize||t>R.canvas.maxSize||n<R.canvas.minSize||n>R.canvas.maxSize){alert(`Canvas size must be between ${R.canvas.minSize}×${R.canvas.minSize} and ${R.canvas.maxSize}×${R.canvas.maxSize}`);return}Ft(),Zn(),Z.createNewTab(e,t,n),s.info(`Created new file: ${e} (${t}×${n})`)}async function Es(){const e=le.getAllFiles();if(e.length===0){await O.alert("No Files","No saved files found. Create a new file to get started.","info");return}const t=document.getElementById("fileModal"),n=document.getElementById("fileList"),o=document.getElementById("noFilesMessage");n.innerHTML="",e.forEach(r=>{const i=Ds(r);i.addEventListener("click",()=>{Ts(r),t.style.display="none"}),n.appendChild(i)}),o.style.display=e.length===0?"block":"none",t.style.display="flex"}function Ds(e){const t=document.createElement("div");t.className="file-grid-item";const n=Is(e.data),r=new Date(e.timestamp).toLocaleDateString(),i=e.width&&e.height?`${e.width}×${e.height}`:"Unknown";return t.innerHTML=`
        <div class="file-grid-preview">
            ${n.outerHTML}
        </div>
        <div class="file-grid-details">
            <div class="file-grid-name">${e.name}</div>
            <div class="file-grid-meta">
                <span class="file-grid-info">${i}</span>
                <span class="file-grid-date">${r}</span>
            </div>
        </div>
    `,t}function Is(e){const t=document.createElement("canvas"),n=t.getContext("2d");let o=e;k&&k.isCompressed(e)&&(o=k.decompress(e));const r=o.match(/^(\d+)x(\d+):(.+)$/);if(!r)return t.width=64,t.height=64,n.fillStyle="#333",n.fillRect(0,0,64,64),t;const i=parseInt(r[1]),a=parseInt(r[2]),l=r[3],c=Math.min(64/i,64/a);t.width=Math.floor(i*c),t.height=Math.floor(a*c),n.imageSmoothingEnabled=!1;for(let u=0;u<a;u++)for(let f=0;f<i;f++){const d=u*i+f;if(d<l.length){const h=l[d],g=K.getIndexFromChar(h);if(g===0)continue;const p=K.getColor(g);p&&(n.fillStyle=p,n.fillRect(f*c,u*c,c,c))}}return t}function Ts(e){Zn();const t=e.data.match(/^(\d+)x(\d+):/),n=t?parseInt(t[1]):16,o=t?parseInt(t[2]):16;Z.createNewTab(e.name,n,o,e.data),le.setCurrentFileName(e.name),Z.markCurrentTabClean(),s.info(`Loaded file: ${e.name}`)}function Jn(){Z.createNewTab()}async function Qn(){let e=Z.getCurrentTab()?.name||le.getCurrentFileName();const t=w.exportToString();await le.save(t,e)&&(s.info("Saved successfully"),Z.markCurrentTabClean(),se.forceSave())}function eo(){le.showLoadDialog(e=>{w.importFromString(e.data)&&(Z.setCurrentTabName(e.name),le.setCurrentFileName(e.name),Z.markCurrentTabClean(),vt(),ue())})}async function $s(){let e=w.exportToString();const t=le.getCurrentFileName()||"pixelart",n=await O.exportDialog(e);if(n)switch(n.compress&&(e=k.smartCompress(e).data),n.format){case"copy-string":await bn.copyWithFeedback(e),await O.alert("Copied!","Pixel art string copied to clipboard.","success");break;case"download-txt":le.exportAsFile(e,t);break;case"download-png":{const o=t.replace(/\.txt$/,"")+".png";ja.exportToPNG(n.scale,o),await O.alert("PNG Exported!",`Exported as ${o} at ${n.scale}× scale.`,"success");break}}}function Ls(){const e=document.getElementById("importModal"),t=document.getElementById("importTextarea");e&&t&&(t.value="",e.classList.add("flex"),e.classList.remove("hidden"),t.focus())}async function Fs(){await O.confirm("Clear Canvas","Are you sure you want to clear the canvas? This cannot be undone.",{confirmText:"Clear",type:"warning",dangerous:!0})&&(w.clear(),ue())}async function Bs(){const e=w.exportToString(),t=document.getElementById("copyLiveStringBtn");await bn.copyWithFeedback(e,t)}async function wt(){const e=parseInt(document.getElementById("canvasWidth")?.value),t=parseInt(document.getElementById("canvasHeight")?.value),n=Ge.validateCanvasDimensions(e,t);if(!n.valid){await O.alert("Invalid Size",n.error,"warning");return}w.hasContent()&&!await O.confirm("Resize Canvas","Resizing may crop or add empty space to your artwork. Continue?",{confirmText:"Resize",type:"warning"})||w.resize(e,t)&&(ue(),pt(),ot&&ot.updateCanvasSize())}function to(){if(!Le.canUndo())return s.debug("Nothing to undo");const e=w.exportToString(),t=Le.undo(e);t&&(w.importFromString(t),vt(),ue(),s.info("Undo performed"))}function Bt(){if(!Le.canRedo())return s.debug("Nothing to redo");const e=w.exportToString(),t=Le.redo(e);t&&(w.importFromString(t),vt(),ue(),s.info("Redo performed"))}function vt(){const{width:e,height:t}=w.getDimensions();document.getElementById("canvasWidth").value=e,document.getElementById("canvasHeight").value=t,pt()}function N(e,t){const n=document.getElementById(e);n&&n.addEventListener("click",t)}as();</script>
  <style rel="stylesheet" crossorigin>:root{--primary-color: #4CAF50;--primary-hover: #45a049;--primary-active: #3d8b40;--secondary-color: #2196F3;--secondary-hover: #1976D2;--danger-color: #f44336;--danger-hover: #da190b;--success-color: #4CAF50;--warning-color: #FFC107;--info-color: #2196F3;--app-bg: #0d0d0d;--workspace-bg: #1a1a1a;--panel-bg: #252525;--surface-bg: #2a2a2a;--elevated-bg: #333333;--hover-bg: #3a3a3a;--border-color: #404040;--border-light: #4a4a4a;--border-dark: #2a2a2a;--border-accent: #555555;--text-primary: #ffffff;--text-secondary: #b0b0b0;--text-muted: #808080;--text-disabled: #606060;--shadow-sm: 0 1px 3px rgba(0, 0, 0, .5);--shadow-md: 0 2px 6px rgba(0, 0, 0, .6);--shadow-lg: 0 4px 12px rgba(0, 0, 0, .7);--shadow-xl: 0 8px 24px rgba(0, 0, 0, .8);--spacing-xs: 4px;--spacing-sm: 8px;--spacing-md: 12px;--spacing-lg: 16px;--spacing-xl: 24px;--spacing-2xl: 32px;--spacing-3xl: 48px;--radius-sm: 3px;--radius-md: 4px;--radius-lg: 6px;--radius-xl: 8px;--toolbox-width: 80px;--properties-width: 280px;--menu-bar-height: 48px;--info-bar-height: 36px;--font-family: "Pixelify Sans", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Inter", sans-serif;--font-mono: "SF Mono", "Monaco", "Cascadia Code", "Courier New", monospace;--font-size-xs: 10px;--font-size-sm: 11px;--font-size-base: 12px;--font-size-md: 13px;--font-size-lg: 14px;--font-size-xl: 16px;--font-size-2xl: 18px;--transition-fast: .1s ease;--transition-normal: .2s ease;--transition-slow: .3s ease;--z-base: 1;--z-dropdown: 100;--z-sticky: 200;--z-modal-backdrop: 900;--z-modal: 1000;--z-tooltip: 1100}*{margin:0;padding:0;box-sizing:border-box}html{font-size:16px}body{font-family:var(--font-family);font-size:var(--font-size-base);background:var(--app-bg);color:var(--text-primary);line-height:1.5;overflow:hidden;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}button{font-family:inherit;cursor:pointer;border:none;background:none;color:inherit;font-size:inherit}input,textarea,select{font-family:inherit;font-size:inherit;color:inherit}h1,h2,h3,h4,h5,h6{font-weight:600;line-height:1.2}code{font-family:var(--font-mono)}::-webkit-scrollbar{width:10px;height:10px}::-webkit-scrollbar-track{background:var(--surface-bg)}::-webkit-scrollbar-thumb{background:var(--border-color);border-radius:var(--radius-sm)}::-webkit-scrollbar-thumb:hover{background:var(--border-light)}::selection{background:var(--primary-color);color:#fff}.hidden{display:none!important}.visible{display:block!important}.flex{display:flex!important}.inline{display:inline!important}.inline-block{display:inline-block!important}.cursor-default{cursor:default!important}.cursor-pointer{cursor:pointer!important}.cursor-grab{cursor:grab!important}.cursor-grabbing{cursor:grabbing!important}.cursor-move{cursor:move!important}.cursor-crosshair{cursor:crosshair!important}.cursor-text{cursor:text!important}.cursor-not-allowed{cursor:not-allowed!important}.opacity-0{opacity:0!important}.opacity-50{opacity:.5!important}.opacity-100{opacity:1!important}.transform-none{transform:none!important}.pointer-events-none{pointer-events:none!important}.pointer-events-auto{pointer-events:auto!important}.overflow-hidden{overflow:hidden!important}.overflow-auto{overflow:auto!important}.overflow-scroll{overflow:scroll!important}.relative{position:relative!important}.absolute{position:absolute!important}.fixed{position:fixed!important}.sticky{position:sticky!important}.z-0{z-index:0!important}.z-10{z-index:10!important}.z-20{z-index:20!important}.z-30{z-index:30!important}.z-40{z-index:40!important}.z-50{z-index:50!important}.w-full{width:100%!important}.h-full{height:100%!important}.w-auto{width:auto!important}.h-auto{height:auto!important}.text-left{text-align:left!important}.text-center{text-align:center!important}.text-right{text-align:right!important}.visible{visibility:visible!important}.invisible{visibility:hidden!important}.material-symbols-outlined{font-family:Material Symbols Outlined;font-weight:400;font-style:normal;font-size:24px;line-height:1;letter-spacing:normal;text-transform:none;display:inline-block;white-space:nowrap;word-wrap:normal;direction:ltr;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;text-rendering:optimizeLegibility;font-feature-settings:"liga"}.tool-icon.material-symbols-outlined{font-size:28px}.menu-btn .material-symbols-outlined{font-size:20px;vertical-align:middle}.dialog-icon.material-symbols-outlined,.export-format-icon.material-symbols-outlined{font-size:32px}.icon-btn .material-symbols-outlined{font-size:18px}.material-symbols-outlined.icon-primary{color:var(--primary-color)}.material-symbols-outlined.icon-success{color:var(--success-color)}.material-symbols-outlined.icon-warning{color:var(--warning-color)}.material-symbols-outlined.icon-danger{color:var(--danger-color)}.material-symbols-outlined.icon-muted{color:var(--text-muted)}.app-container{display:flex;height:100vh;width:100vw;background:var(--app-bg)}.workspace{flex:1;display:flex;flex-direction:column;background:var(--workspace-bg);overflow:hidden}.menu-bar{height:var(--menu-bar-height);background:var(--panel-bg);border-bottom:1px solid var(--border-color);display:flex;align-items:center;padding:0 var(--spacing-md);gap:var(--spacing-md)}.menu-section{display:flex;gap:var(--spacing-xs);align-items:center}.menu-section:not(:last-child):after{content:"";width:1px;height:20px;background:var(--border-color);margin-left:var(--spacing-md)}.info-bar{min-height:var(--info-bar-height);background:var(--surface-bg);border-bottom:1px solid var(--border-color);display:flex;align-items:center;padding:var(--spacing-sm) var(--spacing-md);gap:var(--spacing-lg);font-size:var(--font-size-sm);flex-wrap:wrap}.info-group{display:flex;align-items:center;gap:var(--spacing-sm)}.info-spacer{flex:1;min-width:20px}.info-label{color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px;font-size:var(--font-size-xs);font-weight:600}.info-value{color:var(--text-primary);font-weight:500}.info-value-small{color:var(--text-secondary);font-size:var(--font-size-xs)}.color-indicator{width:20px;height:20px;border:2px solid var(--border-color);border-radius:var(--radius-sm)}.tool-size-buttons,.tool-mode-buttons{display:flex;gap:4px}.tool-size-btn,.tool-mode-btn{padding:3px 8px;background:var(--panel-bg);border:1px solid var(--border-color);border-radius:var(--radius-sm);font-size:var(--font-size-xs);font-weight:600;color:var(--text-secondary);cursor:pointer;transition:all var(--transition-fast);min-width:24px;text-align:center}.tool-size-btn:hover,.tool-mode-btn:hover{background:var(--elevated-bg);border-color:var(--border-light);color:var(--text-primary)}.tool-size-btn.active,.tool-mode-btn.active{background:var(--primary-color);border-color:var(--primary-color);color:#fff}.tool-mode-btn{padding:3px 12px}.canvas-container{flex:1;display:flex;align-items:center;justify-content:center;overflow:auto;padding:var(--spacing-xl);background:var(--workspace-bg)}.canvas-wrapper{display:inline-block;background:var(--surface-bg);padding:var(--spacing-lg);border-radius:var(--radius-lg);box-shadow:var(--shadow-xl);border:1px solid var(--border-color)}#pixelCanvas{display:block;border:2px solid var(--border-light);cursor:crosshair;image-rendering:pixelated;image-rendering:crisp-edges}.export-panel{background:var(--panel-bg);border-top:1px solid var(--border-color);padding:var(--spacing-md)}.export-panel-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--spacing-sm)}.export-panel-header h3{font-size:var(--font-size-md);font-weight:600;color:var(--text-secondary)}.export-content{background:var(--surface-bg);border:1px solid var(--border-color);border-radius:var(--radius-md);padding:var(--spacing-md);margin-bottom:var(--spacing-sm);overflow-x:auto;max-height:80px}.export-code{font-family:var(--font-mono);font-size:var(--font-size-sm);color:var(--primary-color);word-break:break-all;display:block;line-height:1.6}.export-info{display:flex;gap:var(--spacing-xl);font-size:var(--font-size-xs);color:var(--text-muted)}.export-info strong{color:var(--text-secondary)}.toolbox{width:var(--toolbox-width);background:var(--panel-bg);border-right:1px solid var(--border-color);display:flex;flex-direction:column;overflow-y:auto;flex-shrink:0}.toolbox-header{padding:var(--spacing-md);border-bottom:1px solid var(--border-color);background:var(--elevated-bg);flex-shrink:0}.toolbox-header h2{font-size:var(--font-size-sm);font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--text-muted);text-align:center}.toolbox-content{padding:var(--spacing-sm);display:flex;flex-direction:column;gap:var(--spacing-xs);flex:1}.tool-btn{width:100%;aspect-ratio:1;background:var(--surface-bg);border:1px solid var(--border-color);border-radius:var(--radius-md);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;cursor:pointer;transition:all var(--transition-fast);position:relative;padding:var(--spacing-xs)}.tool-btn:hover{background:var(--hover-bg);border-color:var(--border-light);transform:translateY(-1px)}.tool-btn:active{transform:translateY(0)}.tool-btn.active{background:var(--primary-color);border-color:var(--primary-color);color:#fff}.tool-btn.active:hover{background:var(--primary-hover)}.tool-icon{font-size:clamp(20px,4vw,28px);line-height:1;display:block;flex-shrink:0}.tool-label{font-size:clamp(8px,1.2vw,11px);font-weight:600;text-align:center;line-height:1.1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;width:100%}.tool-shortcut{position:absolute;bottom:3%;right:5%;font-size:clamp(7px,1vw,9px);opacity:.5;font-weight:700;line-height:1}.tool-btn.active .tool-shortcut{opacity:.9}.properties-panel{width:var(--properties-width);background:var(--panel-bg);border-left:1px solid var(--border-color);display:flex;flex-direction:column;overflow-y:auto}.panel-section{border-bottom:1px solid var(--border-color);padding:var(--spacing-md)}.panel-title{font-size:var(--font-size-sm);font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--text-muted);margin-bottom:var(--spacing-md)}.tool-options{display:flex;flex-direction:column;gap:var(--spacing-lg)}.option-group{display:flex;flex-direction:column;gap:var(--spacing-sm)}.option-group label{font-size:var(--font-size-sm);color:var(--text-secondary);font-weight:500}.size-buttons{display:grid;grid-template-columns:repeat(4,1fr);gap:var(--spacing-xs)}.size-btn{padding:var(--spacing-sm);background:var(--surface-bg);border:1px solid var(--border-color);border-radius:var(--radius-md);font-size:var(--font-size-xs);font-weight:600;transition:all var(--transition-fast)}.size-btn:hover{background:var(--hover-bg);border-color:var(--border-light)}.size-btn.active{background:var(--primary-color);border-color:var(--primary-color);color:#fff}.mode-buttons{display:grid;grid-template-columns:1fr 1fr;gap:var(--spacing-xs)}.mode-btn{padding:var(--spacing-sm);background:var(--surface-bg);border:1px solid var(--border-color);border-radius:var(--radius-md);font-size:var(--font-size-sm);font-weight:500;transition:all var(--transition-fast)}.mode-btn:hover{background:var(--hover-bg);border-color:var(--border-light)}.mode-btn.active{background:var(--primary-color);border-color:var(--primary-color);color:#fff}.size-presets{display:grid;grid-template-columns:repeat(2,1fr);gap:var(--spacing-xs);margin-bottom:var(--spacing-md)}.preset-btn{padding:var(--spacing-sm);background:var(--surface-bg);border:1px solid var(--border-color);border-radius:var(--radius-md);font-size:var(--font-size-sm);font-weight:600;transition:all var(--transition-fast)}.preset-btn:hover{background:var(--hover-bg);border-color:var(--border-light)}.preset-btn.active{background:var(--primary-color);border-color:var(--primary-color);color:#fff}.custom-size{display:flex;flex-direction:column;gap:var(--spacing-sm)}.size-input-row{display:flex;align-items:center;gap:var(--spacing-xs)}.size-input-row input{flex:1;padding:var(--spacing-sm);background:var(--surface-bg);border:1px solid var(--border-color);border-radius:var(--radius-md);text-align:center;font-weight:600}.size-input-row input:focus{outline:none;border-color:var(--primary-color)}.size-input-row span{color:var(--text-muted);font-weight:600}.color-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:3px}.color-swatch{aspect-ratio:1;border:2px solid var(--border-color);border-radius:var(--radius-sm);cursor:pointer;transition:all var(--transition-fast);position:relative}.color-swatch:hover{transform:scale(1.15);border-color:var(--border-light);box-shadow:var(--shadow-md);z-index:10}.color-swatch.active{border-color:gold;box-shadow:0 0 8px #ffd70099;transform:scale(1.1);z-index:10}.color-swatch[data-code="0"]{background:repeating-conic-gradient(#666 0% 25%,#444 0% 50%) 50% / 6px 6px}.menu-btn{padding:var(--spacing-sm) var(--spacing-md);background:var(--surface-bg);border:1px solid transparent;border-radius:var(--radius-md);font-size:var(--font-size-sm);font-weight:500;display:flex;align-items:center;gap:var(--spacing-xs);transition:all var(--transition-fast)}.menu-btn:hover{background:var(--hover-bg);border-color:var(--border-color)}.menu-btn:active{transform:scale(.98)}.menu-btn span{font-size:16px}.menu-btn-danger{color:var(--danger-color)}.menu-btn-danger:hover{background:#f443361a;border-color:var(--danger-color)}.btn-primary{width:100%;padding:var(--spacing-sm) var(--spacing-md);background:var(--primary-color);border:1px solid var(--primary-color);border-radius:var(--radius-md);font-size:var(--font-size-sm);font-weight:600;color:#fff;transition:all var(--transition-fast)}.btn-primary:hover{background:var(--primary-hover);border-color:var(--primary-hover)}.btn-primary:active{transform:scale(.98)}.btn-secondary{padding:var(--spacing-sm) var(--spacing-lg);background:var(--surface-bg);border:1px solid var(--border-color);border-radius:var(--radius-md);font-size:var(--font-size-sm);font-weight:500;transition:all var(--transition-fast)}.btn-secondary:hover{background:var(--hover-bg);border-color:var(--border-light)}.icon-btn{padding:var(--spacing-xs);background:var(--surface-bg);border:1px solid var(--border-color);border-radius:var(--radius-md);font-size:16px;transition:all var(--transition-fast)}.icon-btn:hover{background:var(--hover-bg);border-color:var(--primary-color);transform:scale(1.05)}.btn-close{width:32px;height:32px;background:transparent;border:none;border-radius:var(--radius-md);font-size:24px;color:var(--text-secondary);display:flex;align-items:center;justify-content:center;transition:all var(--transition-fast)}.btn-close:hover{background:var(--surface-bg);color:var(--text-primary)}.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:#000000d9;display:flex;justify-content:center;align-items:center;z-index:var(--z-modal);-webkit-backdrop-filter:blur(4px);backdrop-filter:blur(4px)}.modal-content{background:var(--panel-bg);border:1px solid var(--border-color);border-radius:var(--radius-xl);max-width:600px;width:90%;max-height:80vh;display:flex;flex-direction:column;box-shadow:var(--shadow-xl)}.modal-header{display:flex;justify-content:space-between;align-items:center;padding:var(--spacing-lg);border-bottom:1px solid var(--border-color)}.modal-header h2{font-size:var(--font-size-xl);font-weight:600}.modal-body{padding:var(--spacing-lg);overflow-y:auto;flex:1}.modal-body p{margin-bottom:var(--spacing-md);color:var(--text-secondary);font-size:var(--font-size-sm)}.modal-body textarea{width:100%;padding:var(--spacing-md);background:var(--surface-bg);border:1px solid var(--border-color);border-radius:var(--radius-md);font-family:var(--font-mono);font-size:var(--font-size-sm);resize:vertical;min-height:120px}.modal-body textarea:focus{outline:none;border-color:var(--primary-color)}.modal-footer{padding:var(--spacing-lg);border-top:1px solid var(--border-color);display:flex;justify-content:flex-end;gap:var(--spacing-sm)}#fileList{display:flex;flex-direction:column;gap:var(--spacing-sm)}.file-item{display:flex;justify-content:space-between;align-items:center;padding:var(--spacing-md);background:var(--surface-bg);border:1px solid var(--border-color);border-radius:var(--radius-md);transition:all var(--transition-fast)}.file-item:hover{border-color:var(--primary-color);background:var(--hover-bg)}.file-item-info{flex:1}.file-item-name{font-weight:600;margin-bottom:var(--spacing-xs)}.file-item-meta{font-size:var(--font-size-xs);color:var(--text-secondary)}.file-item-actions{display:flex;gap:var(--spacing-xs)}.file-item-actions .btn-secondary,.file-item-actions .btn-primary{padding:var(--spacing-xs) var(--spacing-md);font-size:var(--font-size-xs)}.dialog-overlay{position:fixed;inset:0;background:#000000bf;-webkit-backdrop-filter:blur(4px);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;z-index:var(--z-modal);animation:fadeIn .2s ease}.dialog-content{background:var(--panel-bg);border:1px solid var(--border-color);border-radius:var(--radius-lg);box-shadow:var(--shadow-xl);min-width:400px;max-width:600px;max-height:80vh;overflow:hidden;display:flex;flex-direction:column;opacity:0;transform:scale(.9) translateY(-20px);transition:all .2s ease}.dialog-content.dialog-show{opacity:1;transform:scale(1) translateY(0)}.dialog-content.dialog-info .dialog-icon{color:var(--info-color)}.dialog-content.dialog-success .dialog-icon{color:var(--success-color)}.dialog-content.dialog-warning .dialog-icon{color:var(--warning-color)}.dialog-content.dialog-error .dialog-icon{color:var(--danger-color)}.dialog-header{display:flex;align-items:center;gap:var(--spacing-md);padding:var(--spacing-lg);border-bottom:1px solid var(--border-color)}.dialog-icon{font-size:32px;line-height:1}.dialog-title{font-size:var(--font-size-xl);font-weight:600;color:var(--text-primary);margin:0}.dialog-body{padding:var(--spacing-xl);overflow-y:auto}.dialog-message{color:var(--text-secondary);font-size:var(--font-size-md);line-height:1.6;margin:0 0 var(--spacing-md) 0}.dialog-input{width:100%;padding:var(--spacing-md);background:var(--surface-bg);border:1px solid var(--border-color);border-radius:var(--radius-md);color:var(--text-primary);font-size:var(--font-size-md);font-family:var(--font-family);margin-top:var(--spacing-md);transition:all var(--transition-fast)}.dialog-input:focus{outline:none;border-color:var(--primary-color);background:var(--elevated-bg)}.export-options{display:flex;flex-direction:column;gap:var(--spacing-lg)}.export-preview{background:var(--surface-bg);border:1px solid var(--border-color);border-radius:var(--radius-md);padding:var(--spacing-md)}.export-preview-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--spacing-sm);font-size:var(--font-size-sm)}.export-preview-size{color:var(--text-muted);font-weight:400}.export-code-preview{display:block;font-family:var(--font-mono);font-size:var(--font-size-sm);color:var(--primary-color);word-break:break-all;line-height:1.6;max-height:60px;overflow-y:auto}.export-option-group{background:var(--surface-bg);border:1px solid var(--border-color);border-radius:var(--radius-md);padding:var(--spacing-md)}.export-checkbox-label{display:flex;align-items:center;gap:var(--spacing-sm);cursor:pointer;font-size:var(--font-size-md);color:var(--text-primary)}.export-checkbox{width:18px;height:18px;cursor:pointer}.export-savings{margin-left:auto;color:var(--success-color);font-weight:600;font-size:var(--font-size-sm)}.export-savings.export-warning{color:#e2a04a}.export-option-info{margin-top:var(--spacing-sm);margin-left:26px;font-size:var(--font-size-xs);color:var(--text-muted);line-height:1.5}.compression-preview{display:grid;grid-template-columns:1fr auto 1fr;gap:var(--spacing-md);margin-top:var(--spacing-md);padding-top:var(--spacing-md);border-top:1px solid var(--border-color)}.compression-preview-section{display:flex;flex-direction:column;gap:var(--spacing-xs);min-width:0}.compression-preview-label{display:flex;justify-content:space-between;align-items:center;font-size:var(--font-size-xs)}.compression-preview-size{color:var(--text-muted);font-weight:400}.compression-highlight{color:var(--success-color);font-weight:600}.compression-preview-code{display:block;font-family:var(--font-mono);font-size:var(--font-size-xs);color:var(--text-secondary);background:var(--panel-bg);padding:var(--spacing-xs) var(--spacing-sm);border-radius:var(--radius-sm);word-break:break-all;line-height:1.5;max-height:60px;overflow-y:auto}.compression-preview-arrow{display:flex;align-items:center;justify-content:center;font-size:var(--font-size-xl);color:var(--success-color);font-weight:700}.export-format-section{display:flex;flex-direction:column;gap:var(--spacing-sm)}.export-format-buttons{display:grid;grid-template-columns:repeat(3,1fr);gap:var(--spacing-sm)}.export-format-btn{display:flex;flex-direction:column;align-items:center;gap:var(--spacing-xs);padding:var(--spacing-md);background:var(--surface-bg);border:2px solid var(--border-color);border-radius:var(--radius-md);cursor:pointer;transition:all var(--transition-fast);min-height:90px}.export-format-btn:hover{background:var(--elevated-bg);border-color:var(--border-light)}.export-format-btn.selected{background:var(--primary-color);border-color:var(--primary-color)}.export-format-btn.selected .export-format-label,.export-format-btn.selected .export-format-desc{color:#fff}.export-format-icon{font-size:32px;line-height:1}.export-format-label{font-weight:600;font-size:var(--font-size-md);color:var(--text-primary)}.export-format-desc{font-size:var(--font-size-xs);color:var(--text-muted)}.png-scale-options{display:flex;flex-direction:column;gap:var(--spacing-sm);padding:var(--spacing-md);background:var(--surface-bg);border:1px solid var(--border-color);border-radius:var(--radius-md)}.png-scale-buttons{display:flex;gap:var(--spacing-xs)}.png-scale-btn{flex:1;padding:var(--spacing-sm) var(--spacing-md);background:var(--panel-bg);border:1px solid var(--border-color);border-radius:var(--radius-sm);color:var(--text-secondary);font-weight:600;cursor:pointer;transition:all var(--transition-fast)}.png-scale-btn:hover{background:var(--elevated-bg);color:var(--text-primary)}.png-scale-btn.active{background:var(--primary-color);border-color:var(--primary-color);color:#fff}.export-info-small{font-size:var(--font-size-xs);color:var(--text-muted)}.export-info-small strong{color:var(--text-secondary)}.dialog-footer{display:flex;gap:var(--spacing-sm);padding:var(--spacing-lg);border-top:1px solid var(--border-color);background:var(--surface-bg);justify-content:flex-end}.dialog-btn{padding:var(--spacing-sm) var(--spacing-lg);border-radius:var(--radius-md);font-size:var(--font-size-md);font-weight:600;cursor:pointer;transition:all var(--transition-fast);border:none;min-width:80px}.dialog-btn-primary{background:var(--primary-color);color:#fff}.dialog-btn-primary:hover{background:var(--primary-hover);transform:translateY(-1px)}.dialog-btn-primary:active{background:var(--primary-active);transform:translateY(0)}.dialog-btn-secondary{background:var(--elevated-bg);color:var(--text-secondary);border:1px solid var(--border-color)}.dialog-btn-secondary:hover{background:var(--hover-bg);color:var(--text-primary)}.dialog-btn-secondary:active{background:var(--surface-bg)}.dialog-btn-danger{background:var(--danger-color);color:#fff}.dialog-btn-danger:hover{background:var(--danger-hover);transform:translateY(-1px)}.dialog-btn-danger:active{background:#c62828;transform:translateY(0)}@media(max-width:600px){.dialog-content{min-width:90vw;max-width:90vw}.dialog-footer{flex-direction:column-reverse}.dialog-btn{width:100%}}.tab-bar{background:var(--panel-bg);border-bottom:1px solid var(--border-color);display:flex;align-items:center;height:36px;overflow-x:auto;overflow-y:hidden}.tab-list{display:flex;flex:1;align-items:center;height:100%;overflow-x:auto;overflow-y:hidden;scrollbar-width:thin}.tab-list::-webkit-scrollbar{height:4px}.tab-list::-webkit-scrollbar-thumb{background:var(--border-color);border-radius:2px}.tab{display:flex;align-items:center;gap:8px;padding:8px 16px;background:var(--surface-bg);border-right:1px solid var(--border-color);cursor:pointer;-webkit-user-select:none;user-select:none;transition:background var(--transition-fast);min-width:120px;max-width:200px;height:100%;position:relative}.tab:hover{background:var(--elevated-bg)}.tab.active{background:var(--workspace-bg);border-bottom:2px solid var(--primary-color)}.tab-name{flex:1;font-size:var(--font-size-sm);font-weight:500;color:var(--text-secondary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.tab.active .tab-name{color:var(--text-primary)}.tab-dirty{color:var(--primary-color);font-size:14px;line-height:1}.tab-close{display:flex;align-items:center;justify-content:center;width:20px;height:20px;background:transparent;border:none;border-radius:var(--radius-sm);color:var(--text-muted);font-size:18px;line-height:1;cursor:pointer;padding:0;opacity:0;transition:all var(--transition-fast)}.tab:hover .tab-close{opacity:1}.tab-close:hover{background:var(--danger-color);color:#fff}.tab-new-btn{display:flex;align-items:center;justify-content:center;width:36px;height:36px;background:transparent;border:none;border-left:1px solid var(--border-color);color:var(--text-secondary);font-size:20px;cursor:pointer;transition:all var(--transition-fast);flex-shrink:0}.tab-new-btn:hover{background:var(--elevated-bg);color:var(--text-primary)}.tab-new-btn:active{background:var(--surface-bg)}.autosave-indicator{display:flex;align-items:center;gap:var(--spacing-sm);padding:4px 12px;background:var(--surface-bg);border:1px solid var(--border-color);border-radius:var(--radius-md);font-size:var(--font-size-xs);margin-left:auto;transition:all var(--transition-normal)}.autosave-status{display:flex;align-items:center;gap:6px;font-weight:600}.autosave-icon{font-size:14px;display:inline-block;transition:all var(--transition-fast)}.autosave-text{color:var(--text-secondary)}.autosave-time{color:var(--text-muted);font-size:var(--font-size-xs);margin-left:4px}.autosave-indicator.status-saved{border-color:var(--success-color)}.autosave-indicator.status-saved .autosave-icon,.autosave-indicator.status-saved .autosave-text{color:var(--success-color)}.autosave-indicator.status-saving{border-color:var(--primary-color)}.autosave-indicator.status-saving .autosave-icon{color:var(--primary-color);animation:spin 1s linear infinite}.autosave-indicator.status-saving .autosave-text{color:var(--primary-color)}.autosave-indicator.status-unsaved{border-color:var(--warning-color)}.autosave-indicator.status-unsaved .autosave-icon,.autosave-indicator.status-unsaved .autosave-text{color:var(--warning-color)}.autosave-indicator.status-error{border-color:var(--danger-color)}.autosave-indicator.status-error .autosave-icon,.autosave-indicator.status-error .autosave-text{color:var(--danger-color)}@keyframes spin{0%{transform:rotate(0)}to{transform:rotate(360deg)}}.zoom-controls{display:flex;align-items:center;gap:var(--spacing-xs)}.zoom-btn{display:flex;align-items:center;justify-content:center;width:28px;height:28px;background:var(--panel-bg);border:1px solid var(--border-color);border-radius:var(--radius-sm);color:var(--text-secondary);font-size:16px;font-weight:600;cursor:pointer;transition:all var(--transition-fast);line-height:1;padding:0}.zoom-btn:hover{background:var(--elevated-bg);border-color:var(--border-light);color:var(--text-primary)}.zoom-btn:active{background:var(--surface-bg);transform:scale(.95)}.zoom-select{min-width:80px;padding:4px 8px;background:var(--panel-bg);border:1px solid var(--border-color);border-radius:var(--radius-sm);color:var(--text-secondary);font-size:var(--font-size-sm);font-weight:600;cursor:pointer;transition:all var(--transition-fast)}.zoom-select:hover{background:var(--elevated-bg);border-color:var(--border-light)}.zoom-select:focus{outline:none;border-color:var(--primary-color)}.canvas-wrapper{transition:transform .2s ease-out;will-change:transform}.canvas-container{position:relative;overflow:hidden}.canvas-container.panning{cursor:grabbing!important}.welcome-screen{display:flex;align-items:center;justify-content:center;width:100%;height:100%;background:linear-gradient(135deg,#1a1a1a,#2d2d2d);animation:fadeIn .3s ease-in}@keyframes fadeIn{0%{opacity:0}to{opacity:1}}.welcome-content{max-width:600px;width:90%;text-align:center}.welcome-header{margin-bottom:60px}.welcome-title{font-family:Pixelify Sans,monospace;font-size:56px;font-weight:700;color:#fff;margin:0 0 10px;text-shadow:0 2px 10px rgba(0,0,0,.3)}.welcome-subtitle{font-size:16px;color:#aaa;margin:0;font-weight:400}.welcome-actions{display:flex;flex-direction:column;gap:20px;margin-bottom:50px}.welcome-section{width:100%}.welcome-divider{position:relative;text-align:center;color:#666;font-size:14px;margin:10px 0}.welcome-divider:before,.welcome-divider:after{content:"";position:absolute;top:50%;width:40%;height:1px;background:#444}.welcome-divider:before{left:0}.welcome-divider:after{right:0}.welcome-divider span{background:linear-gradient(135deg,#1a1a1a,#2d2d2d);padding:0 15px}.welcome-btn{display:flex;flex-direction:column;align-items:center;justify-content:center;width:100%;padding:30px 40px;border:2px solid transparent;border-radius:12px;background:#2a2a2a;color:#fff;font-family:inherit;cursor:pointer;transition:all .2s ease}.welcome-btn:hover{background:#333;border-color:#4a9eff;transform:translateY(-2px);box-shadow:0 4px 12px #4a9eff33}.welcome-btn-primary{background:linear-gradient(135deg,#4a9eff,#357abd);border-color:#4a9eff}.welcome-btn-primary:hover{background:linear-gradient(135deg,#5aadff,#4589cd);border-color:#5aadff;box-shadow:0 6px 20px #4a9eff66}.welcome-btn-icon{font-size:48px;margin-bottom:10px}.welcome-btn-label{font-size:20px;font-weight:600;margin-bottom:5px}.welcome-btn-desc{font-size:14px;color:#aaa}.welcome-btn-primary .welcome-btn-desc{color:#fffc}.welcome-recent{margin-top:40px;padding-top:30px;border-top:1px solid #444}.welcome-recent-title{font-size:14px;font-weight:600;color:#888;text-transform:uppercase;letter-spacing:1px;margin:0 0 20px}.welcome-recent-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:15px}.welcome-recent-item{display:flex;flex-direction:column;align-items:center;padding:15px;background:#2a2a2a;border:1px solid #333;border-radius:8px;cursor:pointer;transition:all .2s ease}.welcome-recent-item:hover{background:#333;border-color:#4a9eff;transform:translateY(-2px)}.welcome-recent-preview{width:80px;height:80px;background:#1a1a1a;border:1px solid #444;border-radius:4px;margin-bottom:10px;display:flex;align-items:center;justify-content:center;overflow:hidden}.welcome-recent-preview canvas{image-rendering:pixelated;image-rendering:-moz-crisp-edges;image-rendering:crisp-edges}.welcome-recent-name{font-size:12px;color:#fff;font-weight:500;margin-bottom:4px;text-overflow:ellipsis;overflow:hidden;white-space:nowrap;max-width:100%}.welcome-recent-info{font-size:11px;color:#888}.new-file-form{display:flex;flex-direction:column;gap:20px}.form-group{display:flex;flex-direction:column;gap:8px}.form-group label{font-size:14px;font-weight:600;color:#fff}.form-input{padding:10px 12px;background:#2a2a2a;border:1px solid #444;border-radius:6px;color:#fff;font-family:inherit;font-size:14px;transition:border-color .2s ease}.form-input:focus{outline:none;border-color:#4a9eff}.form-row{display:grid;grid-template-columns:1fr 1fr;gap:15px}.size-presets-modal{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}.preset-btn-modal{padding:10px;background:#2a2a2a;border:1px solid #444;border-radius:6px;color:#fff;font-family:inherit;font-size:14px;font-weight:500;cursor:pointer;transition:all .2s ease}.preset-btn-modal:hover{background:#333;border-color:#4a9eff}.preset-btn-modal.active{background:#4a9eff;border-color:#4a9eff;color:#fff}.file-grid{display:flex;flex-direction:column;gap:8px;max-height:500px;overflow-y:auto}.file-grid-item{display:flex;flex-direction:row;align-items:center;gap:15px;padding:12px 15px;background:#2a2a2a;border:2px solid #333;border-radius:8px;cursor:pointer;transition:all .2s ease}.file-grid-item:hover{background:#333;border-color:#4a9eff}.file-grid-preview{width:64px;height:64px;min-width:64px;background:#1a1a1a;border:1px solid #444;border-radius:4px;display:flex;align-items:center;justify-content:center;overflow:hidden}.file-grid-preview canvas{image-rendering:pixelated;image-rendering:-moz-crisp-edges;image-rendering:crisp-edges;max-width:100%;max-height:100%}.file-grid-details{flex:1;min-width:0;display:flex;flex-direction:column;gap:4px}.file-grid-name{font-size:15px;font-weight:600;color:#fff;text-overflow:ellipsis;overflow:hidden;white-space:nowrap}.file-grid-meta{display:flex;gap:15px;font-size:13px;color:#888}.file-grid-info{font-size:13px;color:#888}.file-grid-date{font-size:13px;color:#666}.modal-content-large{max-width:700px;width:90%}@media(max-width:768px){.welcome-title{font-size:40px}.welcome-btn{padding:25px 30px}.welcome-btn-icon{font-size:40px}.welcome-btn-label{font-size:18px}.file-grid{grid-template-columns:repeat(auto-fill,minmax(150px,1fr))}.size-presets-modal{grid-template-columns:repeat(2,1fr)}.form-row{grid-template-columns:1fr}}@media(max-width:1024px){:root{--toolbox-width: 70px;--properties-width: 240px}.color-grid{grid-template-columns:repeat(6,1fr)}}@media(max-width:768px){.app-container{flex-direction:column}.toolbox{width:100%;height:auto;border-right:none;border-bottom:1px solid var(--border-color)}.toolbox-content{display:flex;overflow-x:auto;padding:var(--spacing-sm)}.tool-btn{min-width:60px;flex-shrink:0}.properties-panel{width:100%;max-height:40vh;border-left:none;border-top:1px solid var(--border-color)}.menu-bar{flex-wrap:wrap;height:auto;min-height:var(--menu-bar-height)}.menu-section:after{display:none}.info-bar{flex-wrap:wrap;height:auto;min-height:var(--info-bar-height);gap:var(--spacing-md)}.canvas-container{padding:var(--spacing-md)}.export-panel{padding:var(--spacing-sm)}.color-grid{grid-template-columns:repeat(8,1fr)}}@media(max-width:480px){.menu-btn span{display:none}.menu-btn{padding:var(--spacing-sm)}.info-bar{font-size:var(--font-size-xs)}.info-value-small{display:none}.size-presets{grid-template-columns:repeat(4,1fr)}.color-grid{grid-template-columns:repeat(6,1fr);gap:2px}.export-content{max-height:60px}.export-code{font-size:10px}}@media(hover:none)and (pointer:coarse){.menu-btn,.tool-btn,.size-btn,.mode-btn,.preset-btn{min-height:44px;min-width:44px}.color-swatch{min-height:32px;min-width:32px}}</style>
</head>
<body>
    <div class="app-container">
        <!-- Left Toolbox -->
        <aside class="toolbox">
            <div class="toolbox-header">
                <h2>Tools</h2>
            </div>
            <div class="toolbox-content" id="toolbox">
                <!-- Tools generated dynamically -->
            </div>
        </aside>

        <!-- Center Canvas Area -->
        <main class="workspace">
            <!-- Top Menu Bar -->
            <div class="menu-bar">
                <div class="menu-section">
                    <button id="newBtn" class="menu-btn" title="New (Ctrl+N)">
                        <span class="material-symbols-outlined">description</span> New
                    </button>
                    <button id="saveBtn" class="menu-btn" title="Save (Ctrl+S)">
                        <span class="material-symbols-outlined">save</span> Save
                    </button>
                    <button id="loadBtn" class="menu-btn" title="Load (Ctrl+O)">
                        <span class="material-symbols-outlined">folder_open</span> Load
                    </button>
                </div>
                <div class="menu-section">
                    <button id="undoBtn" class="menu-btn" title="Undo (Ctrl+Z)" disabled>
                        <span class="material-symbols-outlined">undo</span> Undo
                    </button>
                    <button id="redoBtn" class="menu-btn" title="Redo (Ctrl+Y)" disabled>
                        <span class="material-symbols-outlined">redo</span> Redo
                    </button>
                </div>
                <div class="menu-section">
                    <button id="exportFileBtn" class="menu-btn" title="Export">
                        <span class="material-symbols-outlined">download</span> Export
                    </button>
                    <button id="importStringBtn" class="menu-btn" title="Import">
                        <span class="material-symbols-outlined">upload</span> Import
                    </button>
                </div>
                <div class="menu-section">
                    <button id="clearBtn" class="menu-btn menu-btn-danger" title="Clear">
                        <span class="material-symbols-outlined">delete</span> Clear
                    </button>
                </div>
            </div>

            <!-- Canvas Info Bar with Tool Options -->
            <div class="info-bar">
                <div class="info-group">
                    <span class="info-label">Tool:</span>
                    <span id="currentToolName" class="info-value">Brush</span>
                </div>

                <!-- Tool Options (shown dynamically) -->
                <div class="info-group" id="brushSizeOption" style="display: none;">
                    <span class="info-label">Size:</span>
                    <div class="tool-size-buttons">
                        <button class="tool-size-btn active" data-size="1">1</button>
                        <button class="tool-size-btn" data-size="2">2</button>
                        <button class="tool-size-btn" data-size="3">3</button>
                        <button class="tool-size-btn" data-size="5">5</button>
                    </div>
                </div>

                <div class="info-group" id="shapeModeOption" style="display: none;">
                    <span class="info-label">Mode:</span>
                    <div class="tool-mode-buttons">
                        <button class="tool-mode-btn active" data-mode="fill">Fill</button>
                        <button class="tool-mode-btn" data-mode="stroke">Stroke</button>
                    </div>
                </div>

                <div class="info-spacer"></div>

                <div class="info-group">
                    <span class="info-label">Size:</span>
                    <span id="canvasSizeDisplay" class="info-value">16×16</span>
                </div>
                <div class="info-group">
                    <span class="info-label">Color:</span>
                    <div id="currentColorDisplay" class="color-indicator"></div>
                    <span id="currentColorCode" class="info-value">1</span>
                </div>
            </div>

            <!-- Welcome Screen (shown on startup) -->
            <div id="welcomeScreen" class="welcome-screen">
                <div class="welcome-content">
                    <div class="welcome-header">
                        <h1 class="welcome-title">Inline.px</h1>
                        <p class="welcome-subtitle">Ultra-Compact Pixel Art Editor</p>
                    </div>

                    <div class="welcome-actions">
                        <div class="welcome-section">
                            <button id="welcomeNewBtn" class="welcome-btn welcome-btn-primary">
                                <span class="material-symbols-outlined welcome-btn-icon">add_circle</span>
                                <span class="welcome-btn-label">Create New</span>
                                <span class="welcome-btn-desc">Start with a blank canvas</span>
                            </button>
                        </div>

                        <div class="welcome-divider">
                            <span>or</span>
                        </div>

                        <div class="welcome-section">
                            <button id="welcomeLoadBtn" class="welcome-btn welcome-btn-secondary">
                                <span class="material-symbols-outlined welcome-btn-icon">folder_open</span>
                                <span class="welcome-btn-label">Open File</span>
                                <span class="welcome-btn-desc">Load from saved files</span>
                            </button>
                        </div>
                    </div>

                    <div class="welcome-recent" id="welcomeRecentFiles" style="display: none;">
                        <h3 class="welcome-recent-title">Recent Files</h3>
                        <div class="welcome-recent-list" id="welcomeRecentList">
                            <!-- Recent files populated dynamically -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Canvas Container -->
            <div class="canvas-container" id="canvasContainer" style="display: none;">
                <div class="canvas-wrapper">
                    <canvas id="pixelCanvas"></canvas>
                </div>
            </div>

            <!-- Live Export Preview -->
            <div class="export-panel">
                <div class="export-panel-header">
                    <h3>Export String</h3>
                    <button id="copyLiveStringBtn" class="icon-btn" title="Copy">
                        <span class="material-symbols-outlined">content_copy</span>
                    </button>
                </div>
                <div class="export-content">
                    <code id="liveExportString" class="export-code">16x16:0000...</code>
                </div>
                <div class="export-info">
                    <span><strong>Format:</strong> Base64 (64 colors)</span>
                    <span><strong>Length:</strong> <span id="stringLength">0</span> chars</span>
                </div>
            </div>
        </main>

        <!-- Right Properties Panel -->
        <aside class="properties-panel">
            <!-- Canvas Size -->
            <div class="panel-section">
                <h3 class="panel-title">Canvas Size</h3>
                <div class="size-presets">
                    <button class="preset-btn active" data-size="8">8×8</button>
                    <button class="preset-btn" data-size="16">16×16</button>
                    <button class="preset-btn" data-size="32">32×32</button>
                    <button class="preset-btn" data-size="64">64×64</button>
                </div>
                <div class="custom-size">
                    <div class="size-input-row">
                        <input type="number" id="canvasWidth" min="2" max="128" value="8" placeholder="W">
                        <span>×</span>
                        <input type="number" id="canvasHeight" min="2" max="128" value="8" placeholder="H">
                    </div>
                    <button id="resizeBtn" class="btn-primary">Apply</button>
                </div>
            </div>

            <!-- Color Palette -->
            <div class="panel-section">
                <h3 class="panel-title">Color Palette</h3>
                <div id="colorPalette" class="color-grid">
                    <!-- Generated dynamically -->
                </div>
            </div>
        </aside>
    </div>

    <!-- Import Modal -->
    <div class="modal" id="importModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Import from String</h2>
                <button id="closeImportModal" class="btn-close">&times;</button>
            </div>
            <div class="modal-body">
                <p>Paste your Base64 pixel art string (format: WxH:DATA)</p>
                <textarea id="importTextarea" rows="8" placeholder="16x16:123ABC..."></textarea>
            </div>
            <div class="modal-footer">
                <button id="cancelImportBtn" class="btn-secondary">Cancel</button>
                <button id="confirmImportBtn" class="btn-primary">Import</button>
            </div>
        </div>
    </div>

    <!-- New File Modal -->
    <div class="modal" id="newFileModal" style="display: none;">
        <div class="modal-content modal-content-large">
            <div class="modal-header">
                <h2>Create New File</h2>
                <button id="closeNewFileModal" class="btn-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="new-file-form">
                    <div class="form-group">
                        <label for="newFileName">Name</label>
                        <input type="text" id="newFileName" placeholder="Untitled" class="form-input">
                    </div>

                    <div class="form-group">
                        <label>Canvas Size</label>
                        <div class="size-presets-modal">
                            <button class="preset-btn-modal active" data-size="8">8×8</button>
                            <button class="preset-btn-modal" data-size="16">16×16</button>
                            <button class="preset-btn-modal" data-size="32">32×32</button>
                            <button class="preset-btn-modal" data-size="64">64×64</button>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="newFileWidth">Width</label>
                            <input type="number" id="newFileWidth" min="2" max="128" value="8" class="form-input">
                        </div>
                        <div class="form-group">
                            <label for="newFileHeight">Height</label>
                            <input type="number" id="newFileHeight" min="2" max="128" value="8" class="form-input">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancelNewFileBtn" class="btn-secondary">Cancel</button>
                <button id="confirmNewFileBtn" class="btn-primary">Create</button>
            </div>
        </div>
    </div>

    <!-- File Selection Modal -->
    <div class="modal" id="fileModal" style="display: none;">
        <div class="modal-content modal-content-large">
            <div class="modal-header">
                <h2>Open File</h2>
                <button id="closeModal" class="btn-close">&times;</button>
            </div>
            <div class="modal-body">
                <div id="fileList" class="file-grid"></div>
                <p id="noFilesMessage" style="display: none; text-align: center; color: #666; padding: 40px;">
                    No saved files found.
                </p>
            </div>
        </div>
    </div>

    <!-- Main Application Entry Point (Bundled by Vite) -->
</body>
</html>
