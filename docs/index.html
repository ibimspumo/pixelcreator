<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Inline.px - Ultra-Compact Pixel Art Editor</title>
    <link rel="icon" type="image/png" href="./favicon-BTGlOP9f.png">

    <!-- Material Symbols Font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <!-- Pixelify Sans Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pixelify+Sans:wght@400..700&display=swap" rel="stylesheet">

  <script type="module" crossorigin>(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function n(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerPolicy&&(i.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?i.credentials="include":r.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(r){if(r.ep)return;r.ep=!0;const i=n(r);fetch(r.href,i)}})();const re={DEBUG:0,INFO:1,WARN:2,ERROR:3};let ln=re.INFO,cn=!0,ye=[];const to=100;function no(e){re[e]!==void 0&&(ln=re[e])}function oo(e){cn=e}function Ke(e,t,n,o){if(e<ln)return;const r=new Date().toISOString(),i={timestamp:r,level:t,message:n,data:o};if(ye.push(i),ye.length>to&&ye.shift(),cn){const a=`[${r}] [${t}] ${n}`,l=t.toLowerCase();console[l]?console[l](a,o||""):console.log(a,o||"")}}const s={LOG_LEVELS:re,setLevel:no,setConsoleEnabled:oo,debug:(e,t=null)=>Ke(re.DEBUG,"DEBUG",e,t),info:(e,t=null)=>Ke(re.INFO,"INFO",e,t),warn:(e,t=null)=>Ke(re.WARN,"WARN",e,t),error:(e,t=null)=>Ke(re.ERROR,"ERROR",e,t),getHistory:()=>[...ye],clearHistory:()=>{ye=[]},exportLogs:()=>ye.map(e=>{let t=`[${e.timestamp}] [${e.level}] ${e.message}`;return e.data&&(t+=` | ${JSON.stringify(e.data)}`),t}).join(`
`)},L={};function un(e,t){return L[e]||(L[e]=[]),L[e].push(t),s.debug?.(`EventBus: subscribed to "${e}"`),()=>Lt(e,t)}function ro(e,t){const n=(...o)=>{t(...o),Lt(e,n)};return un(e,n)}function Lt(e,t){if(!L[e])return;const n=L[e].indexOf(t);n>-1&&(L[e].splice(n,1),s.debug?.(`EventBus: unsubscribed from "${e}"`)),L[e].length===0&&delete L[e]}function io(e,t=null){if(!L[e]){s.debug?.(`EventBus: no listeners for "${e}"`);return}s.debug?.(`EventBus: emitting "${e}"`,t),[...L[e]].forEach(o=>{try{o(t,e)}catch(r){s.error?.(`EventBus: error in listener for "${e}"`,r)}})}const ao={TOOL_CHANGED:"tool:changed",TOOL_OPTION_CHANGED:"tool:optionChanged",CANVAS_CHANGED:"canvas:changed",CANVAS_RESIZED:"canvas:resized",CANVAS_CLEARED:"canvas:cleared",SELECTION_CHANGED:"selection:changed",SELECTION_CLEARED:"selection:cleared",COLOR_CHANGED:"color:changed",HISTORY_STATE_ADDED:"history:stateAdded",UNDO_PERFORMED:"history:undo",REDO_PERFORMED:"history:redo",FILE_LOADED:"file:loaded",FILE_SAVED:"file:saved",FILE_EXPORTED:"file:exported",MODAL_OPENED:"ui:modalOpened",MODAL_CLOSED:"ui:modalClosed",APP_READY:"app:ready",APP_ERROR:"app:error"},x={on:un,once:ro,off:Lt,emit:io,listenerCount:e=>L[e]?L[e].length:0,getEvents:()=>Object.keys(L),clear:(e=null)=>{e?(delete L[e],s.debug?.(`EventBus: cleared listeners for "${e}"`)):(Object.keys(L).forEach(t=>delete L[t]),s.debug?.("EventBus: cleared all listeners"))},getStats:()=>{const e={totalEvents:Object.keys(L).length,totalListeners:0,events:{}};return Object.keys(L).forEach(t=>{const n=L[t].length;e.totalListeners+=n,e.events[t]=n}),e},Events:ao},so={base64Chars:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz+/",palette:[{index:0,char:"0",color:"transparent",name:"Transparent",category:"special"},{index:1,char:"1",color:"#000000",name:"Black",category:"basic"},{index:2,char:"2",color:"#FFFFFF",name:"White",category:"basic"},{index:3,char:"3",color:"#FF0000",name:"Red",category:"basic"},{index:4,char:"4",color:"#00FF00",name:"Green",category:"basic"},{index:5,char:"5",color:"#0000FF",name:"Blue",category:"basic"},{index:6,char:"6",color:"#FFFF00",name:"Yellow",category:"basic"},{index:7,char:"7",color:"#FF00FF",name:"Magenta",category:"basic"},{index:8,char:"8",color:"#00FFFF",name:"Cyan",category:"basic"},{index:9,char:"9",color:"#1A1A1A",name:"Dark Gray 1",category:"grayscale"},{index:10,char:"A",color:"#333333",name:"Dark Gray 2",category:"grayscale"},{index:11,char:"B",color:"#4D4D4D",name:"Dark Gray 3",category:"grayscale"},{index:12,char:"C",color:"#666666",name:"Gray 1",category:"grayscale"},{index:13,char:"D",color:"#808080",name:"Gray 2",category:"grayscale"},{index:14,char:"E",color:"#999999",name:"Gray 3",category:"grayscale"},{index:15,char:"F",color:"#B3B3B3",name:"Light Gray 1",category:"grayscale"},{index:16,char:"G",color:"#CCCCCC",name:"Light Gray 2",category:"grayscale"},{index:17,char:"H",color:"#8B0000",name:"Dark Red",category:"reds"},{index:18,char:"I",color:"#B22222",name:"Firebrick",category:"reds"},{index:19,char:"J",color:"#DC143C",name:"Crimson",category:"reds"},{index:20,char:"K",color:"#FF4500",name:"Orange Red",category:"reds"},{index:21,char:"L",color:"#FF6347",name:"Tomato",category:"reds"},{index:22,char:"M",color:"#FF7F50",name:"Coral",category:"reds"},{index:23,char:"N",color:"#FFA500",name:"Orange",category:"reds"},{index:24,char:"O",color:"#FFD700",name:"Gold",category:"reds"},{index:25,char:"P",color:"#006400",name:"Dark Green",category:"greens"},{index:26,char:"Q",color:"#008000",name:"Green",category:"greens"},{index:27,char:"R",color:"#228B22",name:"Forest Green",category:"greens"},{index:28,char:"S",color:"#32CD32",name:"Lime Green",category:"greens"},{index:29,char:"T",color:"#7FFF00",name:"Chartreuse",category:"greens"},{index:30,char:"U",color:"#90EE90",name:"Light Green",category:"greens"},{index:31,char:"V",color:"#98FB98",name:"Pale Green",category:"greens"},{index:32,char:"W",color:"#ADFF2F",name:"Yellow Green",category:"greens"},{index:33,char:"X",color:"#00008B",name:"Dark Blue",category:"blues"},{index:34,char:"Y",color:"#0000CD",name:"Medium Blue",category:"blues"},{index:35,char:"Z",color:"#1E90FF",name:"Dodger Blue",category:"blues"},{index:36,char:"a",color:"#4169E1",name:"Royal Blue",category:"blues"},{index:37,char:"b",color:"#6495ED",name:"Steel Blue",category:"blues"},{index:38,char:"c",color:"#87CEEB",name:"Sky Blue",category:"blues"},{index:39,char:"d",color:"#87CEFA",name:"Light Sky Blue",category:"blues"},{index:40,char:"e",color:"#B0E0E6",name:"Powder Blue",category:"blues"},{index:41,char:"f",color:"#4B0082",name:"Indigo",category:"purples"},{index:42,char:"g",color:"#6A5ACD",name:"Slate Blue",category:"purples"},{index:43,char:"h",color:"#7B68EE",name:"Medium Slate Blue",category:"purples"},{index:44,char:"i",color:"#9370DB",name:"Medium Purple",category:"purples"},{index:45,char:"j",color:"#BA55D3",name:"Orchid",category:"purples"},{index:46,char:"k",color:"#DA70D6",name:"Violet",category:"purples"},{index:47,char:"l",color:"#DDA0DD",name:"Plum",category:"purples"},{index:48,char:"m",color:"#EE82EE",name:"Pink Violet",category:"purples"},{index:49,char:"n",color:"#8B4513",name:"Saddle Brown",category:"browns"},{index:50,char:"o",color:"#A0522D",name:"Sienna",category:"browns"},{index:51,char:"p",color:"#D2691E",name:"Chocolate",category:"browns"},{index:52,char:"q",color:"#CD853F",name:"Peru",category:"browns"},{index:53,char:"r",color:"#F4A460",name:"Sandy Brown",category:"browns"},{index:54,char:"s",color:"#DEB887",name:"Burlywood",category:"browns"},{index:55,char:"t",color:"#D2B48C",name:"Tan",category:"browns"},{index:56,char:"u",color:"#BC8F8F",name:"Rosy Brown",category:"browns"},{index:57,char:"v",color:"#FFB6C1",name:"Light Pink",category:"pastels"},{index:58,char:"w",color:"#FFC0CB",name:"Pink",category:"pastels"},{index:59,char:"x",color:"#FFE4E1",name:"Misty Rose",category:"pastels"},{index:60,char:"y",color:"#F0E68C",name:"Khaki",category:"pastels"},{index:61,char:"z",color:"#E6E6FA",name:"Lavender",category:"pastels"},{index:62,char:"+",color:"#D8BFD8",name:"Thistle",category:"pastels"},{index:63,char:"/",color:"#FFDAB9",name:"Peach",category:"pastels"}]},lo={canvas:{minSize:2,maxSize:128,defaultWidth:8,defaultHeight:8,minPixelSize:8,maxPixelSize:50,defaultPixelSize:30},history:{maxStates:50,debounceTime:500},autosave:{interval:3e4,debounceTime:1e3},tools:{brushSizes:[1,2,3,5],defaultBrushSize:1,maxBrushSize:5,shapeModes:["fill","stroke"],defaultShapeMode:"fill"},rle:{maxRunLength:99,countDigits:2},ui:{copyFeedbackDuration:1e3,windowResizeDebounce:250,animationDuration:200},validation:{fileNameMaxLength:100,fileNamePattern:"^[a-zA-Z0-9_\\-\\.]+$"}};function dn(e){const t=[];return!e.base64Chars||typeof e.base64Chars!="string"?t.push("Missing or invalid base64Chars"):e.base64Chars.length!==64&&t.push(`base64Chars must be 64 characters, got ${e.base64Chars.length}`),Array.isArray(e.palette)?e.palette.length!==64?t.push(`palette must have 64 colors, got ${e.palette.length}`):e.palette.forEach((n,o)=>{(typeof n.index!="number"||n.index!==o)&&t.push(`palette[${o}]: invalid or mismatched index`),(!n.char||typeof n.char!="string"||n.char.length!==1)&&t.push(`palette[${o}]: invalid char`),(!n.color||typeof n.color!="string")&&t.push(`palette[${o}]: invalid color`),(!n.name||typeof n.name!="string")&&t.push(`palette[${o}]: invalid name`),(!n.category||typeof n.category!="string")&&t.push(`palette[${o}]: invalid category`)}):t.push("palette must be an array"),t.length>0&&s.error?.("Colors config validation failed:",t),{valid:t.length===0,errors:t}}function fn(e){const t=[];if(!e.canvas||typeof e.canvas!="object")t.push("Missing or invalid canvas config");else{const n=e.canvas;(typeof n.minSize!="number"||n.minSize<1)&&t.push("canvas.minSize must be a positive number"),(typeof n.maxSize!="number"||n.maxSize<n.minSize)&&t.push("canvas.maxSize must be >= canvas.minSize"),typeof n.defaultWidth!="number"&&t.push("canvas.defaultWidth must be a number"),typeof n.defaultHeight!="number"&&t.push("canvas.defaultHeight must be a number"),(typeof n.minPixelSize!="number"||n.minPixelSize<1)&&t.push("canvas.minPixelSize must be a positive number"),(typeof n.maxPixelSize!="number"||n.maxPixelSize<n.minPixelSize)&&t.push("canvas.maxPixelSize must be >= canvas.minPixelSize"),typeof n.defaultPixelSize!="number"&&t.push("canvas.defaultPixelSize must be a number")}if(!e.history||typeof e.history!="object")t.push("Missing or invalid history config");else{const n=e.history;(typeof n.maxStates!="number"||n.maxStates<1)&&t.push("history.maxStates must be a positive number"),(typeof n.debounceTime!="number"||n.debounceTime<0)&&t.push("history.debounceTime must be a non-negative number")}if(!e.autosave||typeof e.autosave!="object")t.push("Missing or invalid autosave config");else{const n=e.autosave;(typeof n.interval!="number"||n.interval<1e3)&&t.push("autosave.interval must be >= 1000ms"),(typeof n.debounceTime!="number"||n.debounceTime<0)&&t.push("autosave.debounceTime must be a non-negative number")}return t.length>0&&s.error?.("Constants config validation failed:",t),{valid:t.length===0,errors:t}}function co(e,t){if(!e||typeof e!="object")return{valid:!1,errors:["Config is null or not an object"]};switch(t){case"colors":return dn(e);case"constants":return fn(e);default:return{valid:!1,errors:[`Unknown config type: ${t}`]}}}const hn={validateConfig:co,validateColorsConfig:dn,validateConstantsConfig:fn},ue={},Jt=so,Qt=lo;async function gn(e){if(ue[e])return s.debug?.(`Config loaded from cache: ${e}`),ue[e];try{const t=await fetch(e);if(!t.ok)throw new Error(`HTTP error ${t.status}: ${t.statusText}`);const n=await t.json();return ue[e]=n,s.info?.(`Config loaded: ${e}`),n}catch(t){throw s.error?.(`Failed to load config: ${e}`,t),t}}async function uo(){s.debug?.("Colors loaded from ES module (static)");const e=hn.validateColorsConfig(Jt);if(!e.valid)throw s.error?.("Colors config validation failed:",e.errors),new Error(`Invalid colors config: ${e.errors.join(", ")}`);return Jt}async function fo(){s.debug?.("Constants loaded from ES module (static)");const e=hn.validateConstantsConfig(Qt);if(!e.valid)throw s.error?.("Constants config validation failed:",e.errors),new Error(`Invalid constants config: ${e.errors.join(", ")}`);return Qt}function ho(e){return ue[e]||null}function mn(e=null){e?delete ue[e]:Object.keys(ue).forEach(t=>delete ue[t])}async function go(e){return mn(e),gn(e)}const Mt={load:gn,loadColors:uo,loadConstants:fo,getCache:ho,clearCache:mn,reload:go};let Se=null;function mo(e=null){Se=e}function pn(e,t){const n=Se?.canvas?.minSize||2,o=Se?.canvas?.maxSize||128;return isNaN(e)||isNaN(t)?{valid:!1,error:"Width and height must be numbers"}:e<n||e>o?{valid:!1,error:`Width must be between ${n} and ${o}`}:t<n||t>o?{valid:!1,error:`Height must be between ${n} and ${o}`}:{valid:!0,error:null}}function po(e){if(!e||e.trim().length===0)return{valid:!1,error:"File name cannot be empty"};const t=Se?.validation?.fileNameMaxLength||100;if(e.length>t)return{valid:!1,error:`File name too long (max ${t} characters)`};const n=Se?.validation?.fileNamePattern||"^[a-zA-Z0-9_\\-\\.]+$";return new RegExp(n).test(e)?{valid:!0,error:null}:{valid:!1,error:"File name contains invalid characters"}}function vo(e){if(!e||typeof e!="string")return{valid:!1,error:"Data string must be a non-empty string",info:null};const t=e.split(":");if(t.length<2)return{valid:!1,error:'Invalid format: must be "WxH:DATA" or "WxH:RLE:DATA"',info:null};const n=t[0].split("x");if(n.length!==2)return{valid:!1,error:'Invalid dimensions format: must be "WIDTHxHEIGHT"',info:null};const o=parseInt(n[0]),r=parseInt(n[1]),i=pn(o,r);if(!i.valid)return{valid:!1,error:i.error,info:null};const a=t.length===3&&t[1]==="RLE",u=t[a?2:1];if(!u||u.length===0)return{valid:!1,error:"Data section is empty",info:null};if(!a){const c=o*r;if(u.length!==c)return{valid:!1,error:`Data length mismatch: expected ${c}, got ${u.length}`,info:null}}return{valid:!0,error:null,info:{width:o,height:r,isCompressed:a,dataLength:u.length}}}function yo(e){return e==="transparent"?!0:/^#[0-9A-Fa-f]{6}$/.test(e)}function Co(e){return Number.isInteger(e)&&e>=0&&e<=63}function bo(e){return typeof e=="string"&&e.length===1&&"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz+/".includes(e)}function So(e){return e.replace(/[^a-zA-Z0-9_\-\.]/g,"_").replace(/_{2,}/g,"_").substring(0,Se?.validation?.fileNameMaxLength||100)}function xo(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}const Ue={init:mo,validateCanvasDimensions:pn,validateFileName:po,validateDataString:vo,validateHexColor:yo,validateColorIndex:Co,validateBase64Char:bo,sanitizeFileName:So,sanitizeInput:xo};function wo(e,t=1){if(e===0)return"0 Bytes";if(e===1)return"1 Byte";const n=1024,o=["Bytes","KB","MB","GB"],r=Math.floor(Math.log(e)/Math.log(n));return parseFloat((e/Math.pow(n,r)).toFixed(t))+" "+o[r]}function Eo(e){return e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}function Do(e,t=1){return e.toFixed(t)+"%"}function vn(e,t=!0){const n=e instanceof Date?e:new Date(e),o=n.getFullYear(),r=String(n.getMonth()+1).padStart(2,"0"),i=String(n.getDate()).padStart(2,"0");let a=`${o}-${r}-${i}`;if(t){const l=String(n.getHours()).padStart(2,"0"),u=String(n.getMinutes()).padStart(2,"0"),c=String(n.getSeconds()).padStart(2,"0");a+=` ${l}:${u}:${c}`}return a}function To(e){const t=e instanceof Date?e:new Date(e),o=new Date-t,r=Math.floor(o/1e3),i=Math.floor(r/60),a=Math.floor(i/60),l=Math.floor(a/24);return r<60?"just now":i<60?`${i} minute${i!==1?"s":""} ago`:a<24?`${a} hour${a!==1?"s":""} ago`:l<7?`${l} day${l!==1?"s":""} ago`:vn(t,!1)}function yn(e,t,n="..."){return e.length<=t?e:e.substring(0,t-n.length)+n}function Io(e,t=50){if(!e)return"";const n=e.split(":");if(n.length<2)return yn(e,t);const o=n[0],r=n.length===3&&n[1]==="RLE",a=n[r?2:1],l=r?`${o}:RLE:`:`${o}:`,u=t-l.length-3;return a.length<=u?e:`${l}${a.substring(0,u)}...`}function $o(e,t,n=null){return n=n||t+"s",e===1?t:n}function Oo(e,t){return`${e}×${t}`}function Lo(e,t=2){return String(e).padStart(t,"0")}function Mo(e,t="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz+/"){return e<0||e>=t.length?"?":t[e]}const bt={formatFileSize:wo,formatNumber:Eo,formatPercentage:Do,formatTimestamp:vn,formatRelativeTime:To,truncate:yn,formatDataString:Io,pluralize:$o,formatDimensions:Oo,padZero:Lo,formatColorCode:Mo};async function Cn(e){if(navigator.clipboard&&navigator.clipboard.writeText)try{return await navigator.clipboard.writeText(e),s.info?.("Text copied to clipboard (modern API)"),!0}catch(t){return s.warn?.("Modern clipboard API failed, trying fallback",t),en(e)}return en(e)}function en(e){const t=document.createElement("textarea");t.value=e,t.style.position="fixed",t.style.left="-9999px",t.style.opacity="0",document.body.appendChild(t),t.select();let n=!1;try{n=document.execCommand("copy"),n&&s.info?.("Text copied to clipboard (fallback)")}catch(o){s.error?.("Fallback copy failed",o)}return document.body.removeChild(t),n}async function zo(){if(navigator.clipboard&&navigator.clipboard.readText)try{const e=await navigator.clipboard.readText();return s.info?.("Text pasted from clipboard"),e}catch(e){return s.warn?.("Clipboard read failed",e),null}return s.warn?.("Clipboard API not available"),null}function bn(e,t=1e3){if(!e)return;const n=e.style.background,o=e.querySelector(".material-symbols-outlined"),r=o?o.textContent:null;e.style.background="var(--success-color, #4CAF50)",o&&(o.textContent="check"),setTimeout(()=>{e.style.background=n,o&&r&&(o.textContent=r)},t)}function Bo(){return!!(navigator.clipboard&&navigator.clipboard.writeText)}async function Fo(e,t=null){const n=await Cn(e);return n&&t&&bn(t),n}const Sn={copyText:Cn,pasteText:zo,showCopyFeedback:bn,isAvailable:Bo,copyWithFeedback:Fo};function nt(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function xn(e){const t={info:"info",success:"check_circle",warning:"warning",error:"error"};return t[e]||t.info}let G=null,ze=null;function Po(){Ao()}function Ao(){G=document.createElement("div"),G.id="dialogContainer",G.className="dialog-overlay",G.style.display="none",document.body.appendChild(G),G.addEventListener("click",e=>{e.target===G&&Q()}),document.addEventListener("keydown",e=>{e.key==="Escape"&&ze&&Q()})}function ct(e){const t=document.createElement("div");t.className=`dialog-content dialog-${e.type}`;const n=document.createElement("div");n.className="dialog-header",n.innerHTML=`
        <span class="material-symbols-outlined dialog-icon">${e.icon}</span>
        <h2 class="dialog-title">${nt(e.title)}</h2>
    `,t.appendChild(n);const o=document.createElement("div");if(o.className="dialog-body",e.message){const i=document.createElement("p");i.className="dialog-message",i.textContent=e.message,o.appendChild(i)}if(e.customContent){const i=document.createElement("div");i.innerHTML=e.customContent,o.appendChild(i)}if(e.input){const i=document.createElement("input");i.type=e.input.type,i.value=e.input.value,i.placeholder=e.input.placeholder,i.className="dialog-input",o.appendChild(i)}t.appendChild(o);const r=document.createElement("div");return r.className="dialog-footer",e.buttons.forEach(i=>{const a=document.createElement("button");a.className=`dialog-btn dialog-btn-${i.type}`,a.textContent=i.text,a.addEventListener("click",i.action),r.appendChild(a)}),t.appendChild(r),t}function ut(e){G.innerHTML="",G.appendChild(e),G.style.display="flex",ze=e,setTimeout(()=>{e.classList.add("dialog-show")},10);const t=e.querySelector(".dialog-btn");t&&t.focus()}function Q(){ze&&(ze.classList.remove("dialog-show"),setTimeout(()=>{G.style.display="none",G.innerHTML="",ze=null},200))}function zt(e){const[t,n]=e.split(":");if(!n||n.length===0)return{compressed:e,original:e,savings:0,compressionRatio:1};let o="",r=1,i=n[0];for(let d=1;d<=n.length;d++)if(d<n.length&&n[d]===i&&r<99)r++;else{const f=r.toString().padStart(2,"0");o+=`${f}${i}`,d<n.length&&(i=n[d],r=1)}const a=`${t}:RLE:${o}`,l=e.length,u=a.length,c=((l-u)/l*100).toFixed(1),h=(u/l).toFixed(2);return{compressed:a,original:e,savings:parseFloat(c),compressionRatio:parseFloat(h),originalSize:l,compressedSize:u}}function No(e){const t=e.split(":");if(t.length===2)return e;if(t.length===3&&t[1]==="RLE"){const n=t[0],o=t[2];let r="",i=0;for(;i<o.length&&i+2<o.length;){const a=o.substring(i,i+2),l=parseInt(a),u=o[i+2];r+=u.repeat(l),i+=3}return`${n}:${r}`}return e}function ko(e){const t=e.split(":");return t.length===3&&t[1]==="RLE"}function wn(e){const t=zt(e);return t.compressedSize<t.originalSize?{data:t.compressed,wasCompressed:!0,savings:t.savings,compressionRatio:t.compressionRatio,originalSize:t.originalSize,compressedSize:t.compressedSize}:{data:e,wasCompressed:!1,savings:0,compressionRatio:1,originalSize:e.length,compressedSize:e.length}}function Ro(e){return zt(e)}function Ho(e){return e.map(t=>wn(t))}const W={compress:zt,decompress:No,isCompressed:ko,smartCompress:wn,getStats:Ro,compressBatch:Ho};function _o(e){return new Promise(t=>{const n=W?W.getStats(e):null,r=ct({title:"Export Pixel Art",message:"Choose how you want to export your pixel art:",icon:"download",type:"info",customContent:Go(e,n,n!==null),buttons:[{text:"Cancel",type:"secondary",action:()=>{Q(),t(null)}}]});ut(r),jo(r,t)})}function Go(e,t,n){const o=Uo(e),r=n?Yo(e,t):"",i=Xo(),a=Wo();return`
        <div class="export-options">
            ${o}
            ${r}
            ${i}
            ${a}
        </div>
    `}function Uo(e){return`
        <div class="export-preview">
            <div class="export-preview-header">
                <strong>Text Format Preview:</strong>
                <span class="export-preview-size">${e.length} chars</span>
            </div>
            <code class="export-code-preview">${nt(e.substring(0,100))}${e.length>100?"...":""}</code>
        </div>
    `}function Yo(e,t){const n=t.savings>0?"":"export-warning",o=t.savings>0?"Save":"Adds",r=t.savings>0?"Compresses repeated pixels for smaller file size. Recommended for sprites with large solid areas.":"Note: This sprite has few repeated pixels, so compression increases file size. Use only if needed for compatibility.";return`
        <div class="export-option-group">
            <label class="export-checkbox-label">
                <input type="checkbox" id="exportCompress" class="export-checkbox" ${t.savings>0?"checked":""} />
                <span>Use RLE Compression</span>
                <span class="export-savings ${n}">${o} ${Math.abs(t.savings)}% (${t.originalSize} → ${t.compressedSize} chars)</span>
            </label>
            <div class="export-option-info">
                ${r}
            </div>
            ${qo(e,t)}
        </div>
    `}function qo(e,t){return`
        <div class="compression-preview">
            <div class="compression-preview-section">
                <div class="compression-preview-label">
                    <strong>Before:</strong>
                    <span class="compression-preview-size">${t.originalSize} chars</span>
                </div>
                <code class="compression-preview-code">${nt(e.substring(0,80))}${e.length>80?"...":""}</code>
            </div>
            <div class="compression-preview-arrow">→</div>
            <div class="compression-preview-section">
                <div class="compression-preview-label">
                    <strong>After:</strong>
                    <span class="compression-preview-size compression-highlight">${t.compressedSize} chars</span>
                </div>
                <code class="compression-preview-code">${nt(t.compressed.substring(0,80))}${t.compressed.length>80?"...":""}</code>
            </div>
        </div>
    `}function Xo(){return`
        <div class="export-format-section">
            <strong>Export as:</strong>
            <div class="export-format-buttons">
                <button class="export-format-btn" data-format="copy-string">
                    <span class="material-symbols-outlined export-format-icon">content_copy</span>
                    <span class="export-format-label">Copy String</span>
                    <span class="export-format-desc">Copy to clipboard</span>
                </button>
                <button class="export-format-btn" data-format="download-txt">
                    <span class="material-symbols-outlined export-format-icon">description</span>
                    <span class="export-format-label">Download TXT</span>
                    <span class="export-format-desc">Save as text file</span>
                </button>
                <button class="export-format-btn" data-format="download-png">
                    <span class="material-symbols-outlined export-format-icon">image</span>
                    <span class="export-format-label">Download PNG</span>
                    <span class="export-format-desc">Save as image</span>
                </button>
            </div>
        </div>
    `}function Wo(){return`
        <div id="pngScaleOptions" class="png-scale-options" style="display: none;">
            <strong>PNG Scale:</strong>
            <div class="png-scale-buttons">
                <button class="png-scale-btn active" data-scale="1">1×</button>
                <button class="png-scale-btn" data-scale="2">2×</button>
                <button class="png-scale-btn" data-scale="4">4×</button>
                <button class="png-scale-btn" data-scale="8">8×</button>
            </div>
        </div>
    `}function jo(e,t){let n=null,o=1;e.querySelectorAll(".export-format-btn").forEach(r=>{r.addEventListener("click",()=>{e.querySelectorAll(".export-format-btn").forEach(a=>a.classList.remove("selected")),r.classList.add("selected"),n=r.dataset.format;const i=e.querySelector("#pngScaleOptions");n==="download-png"?i.style.display="block":i.style.display="none",setTimeout(()=>{const a=e.querySelector("#exportCompress")?.checked||!1;Q(),t({format:n,compress:a,scale:o})},150)})}),e.querySelectorAll(".png-scale-btn").forEach(r=>{r.addEventListener("click",i=>{i.stopPropagation(),e.querySelectorAll(".png-scale-btn").forEach(a=>a.classList.remove("active")),r.classList.add("active"),o=parseInt(r.dataset.scale)})})}function Vo(){Po(),s.info?.("Dialog system initialized")}function Ko(e,t,n="info"){return new Promise(o=>{const r=ct({title:e,message:t,icon:xn(n),type:n,buttons:[{text:"OK",type:"primary",action:()=>{Q(),o(!0)}}]});ut(r)})}function Zo(e,t,n={}){return new Promise(o=>{const r=n.confirmText||"Confirm",i=n.cancelText||"Cancel",a=n.type||"warning",l=n.dangerous||!1,u=ct({title:e,message:t,icon:xn(a),type:a,buttons:[{text:i,type:"secondary",action:()=>{Q(),o(!1)}},{text:r,type:l?"danger":"primary",action:()=>{Q(),o(!0)}}]});ut(u)})}function Jo(e,t,n="",o={}){return new Promise(r=>{const i=o.placeholder||"",a=o.inputType||"text",l=ct({title:e,message:t,icon:"edit_note",type:"info",input:{type:a,value:n,placeholder:i},buttons:[{text:"Cancel",type:"secondary",action:()=>{Q(),r(null)}},{text:"OK",type:"primary",action:()=>{const u=l.querySelector(".dialog-input"),c=u?u.value:null;Q(),r(c)}}]});ut(l),setTimeout(()=>{const u=l.querySelector(".dialog-input");u&&(u.focus(),u.select(),u.addEventListener("keydown",c=>{if(c.key==="Enter"){const h=u.value;Q(),r(h)}}))},100)})}function Qo(e){return _o(e)}const B={init:Vo,alert:Ko,confirm:Zo,prompt:Jo,exportDialog:Qo};function Ze(e,t,n){if(!n||n.length===0)return!1;const o=n.length,r=n[0].length;return e>=0&&e<r&&t>=0&&t<o}function er(e,t,n,o){const r=n.length,i=n[0].length;return e>=0&&e<i&&t>=0&&t<r&&n[t][e]!==o?(n[t][e]=o,!0):!1}function tr(e,t,n){const o=n.length,r=n[0].length;return e>=0&&e<r&&t>=0&&t<o?n[t][e]:null}function tn(e){return e.map(t=>[...t])}function nr(e,t){if(t)for(let n=0;n<e.length;n++)for(let o=0;o<e[n].length;o++)e[n][o]=t[n][o]}function or(e=16){const t={lastTime:0,delay:e};return{shouldThrottle(){const n=Date.now();return n-t.lastTime<t.delay?!0:(t.lastTime=n,!1)},reset(){t.lastTime=0}}}function rr(e){return class extends e{constructor(...t){super(...t),this.selectionActive=!1,this.selectionBounds=null}respectsSelection(){return!0}isInSelection(t,n){if(!this.selectionActive||!this.selectionBounds)return!0;const{x1:o,y1:r,x2:i,y2:a}=this.selectionBounds;return t>=o&&t<=i&&n>=r&&n<=a}setSelection(t){this.selectionActive=!0,this.selectionBounds=t}clearSelection(){this.selectionActive=!1,this.selectionBounds=null}}}function ir(e){return class extends e{constructor(...t){super(...t),this.boundHandlers={}}addEventListener(t,n,o){const r=o.bind(this);t.addEventListener(n,r);const i=`${n}_${Date.now()}`;this.boundHandlers[i]={target:t,event:n,handler:r}}removeAllEventListeners(){Object.values(this.boundHandlers).forEach(({target:t,event:n,handler:o})=>{t.removeEventListener(n,o)}),this.boundHandlers={}}}}class Bt{static CONFIG={id:"base-tool",name:"Base Tool",icon:"tool",shortcut:"",cursor:"default",hasSizeOption:!1,hasShapeOption:!1,description:"Base tool class",category:"other"};static DEFAULT_OPTIONS={brushSize:1,shapeMode:"fill",opacity:1,antiAlias:!1,snapToGrid:!1,constrainProportions:!1};constructor(){if(new.target===Bt)throw new Error("BaseTool is abstract and cannot be instantiated directly");const t=this.constructor.CONFIG;if(!t||t.id==="base-tool")throw new Error(`${this.constructor.name} must override static CONFIG property`);this.isActive=!1,this.isDrawing=!1,this.options={...this.constructor.DEFAULT_OPTIONS},this.startX=0,this.startY=0,this.lastX=0,this.lastY=0,this.previewData=null,this.throttle=or(16),this.onChangeCallback=null,this.onOptionChangeCallback=null,this.actionHistory=[],this.logger=s,this.logger.debug?.(`${this.constructor.CONFIG.name} tool created`)}init(){this.logger.debug?.(`${this.getName()} tool initialized`)}activate(){this.isActive=!0,this.logger.info?.(`${this.getName()} tool activated`)}deactivate(){this.isActive=!1,this.cancelDrawing(),this.logger.info?.(`${this.getName()} tool deactivated`)}destroy(){this.removeAllEventListeners(),this.previewData=null,this.logger.debug?.(`${this.getName()} tool destroyed`)}startDrawing(t,n,o,r={}){return this.isActive?Ze(t,n,o)?(this.isDrawing=!0,this.startX=t,this.startY=n,this.lastX=t,this.lastY=n,this.needsPreview()&&(this.previewData=tn(o)),this.onDrawStart(t,n,o,r)):(this.logger.warn?.(`Invalid coordinates: (${t}, ${n})`),!1):(this.logger.warn?.(`Cannot start drawing: ${this.getName()} is not active`),!1)}continueDrawing(t,n,o,r={}){return!this.isDrawing||!Ze(t,n,o)||this.throttle.shouldThrottle()?!1:(this.lastX=t,this.lastY=n,this.onDrawContinue(t,n,o,r))}endDrawing(t,n,o,r={}){if(!this.isDrawing)return!1;this.isDrawing=!1,Ze(t,n,o)||(t=this.lastX,n=this.lastY);const i=this.onDrawEnd(t,n,o,r);return this.previewData=null,this.throttle.reset(),i}cancelDrawing(){this.isDrawing&&(this.isDrawing=!1,this.previewData=null,this.onDrawCancel(),this.logger.debug?.(`${this.getName()} drawing cancelled`))}onDrawStart(t,n,o,r){throw new Error(`${this.constructor.name} must implement onDrawStart()`)}onDrawContinue(t,n,o,r){throw new Error(`${this.constructor.name} must implement onDrawContinue()`)}onDrawEnd(t,n,o,r){throw new Error(`${this.constructor.name} must implement onDrawEnd()`)}onDrawCancel(){}setOption(t,n){if(this.options.hasOwnProperty(t)){const o=this.options[t];this.options[t]=n,this.onOptionChanged(t,n,o),this.onOptionChangeCallback&&this.onOptionChangeCallback(t,n,o)}else this.logger.warn?.(`Unknown option: ${t}`)}getOption(t){return this.options[t]}getAllOptions(){return{...this.options}}resetOptions(){this.options={...this.constructor.DEFAULT_OPTIONS},this.onOptionsReset()}onOptionChanged(t,n,o){this.logger.debug?.(`${this.getName()} option changed: ${t} = ${n}`)}onOptionsReset(){}needsPreview(){return!1}validateCoordinates(t,n,o){return Ze(t,n,o)}clonePixelData(t){return tn(t)}restorePreviewData(t){nr(t,this.previewData)}setPixel(t,n,o,r){return er(t,n,o,r)}getPixel(t,n,o){return tr(t,n,o)}getId(){return this.constructor.CONFIG.id}getName(){return this.constructor.CONFIG.name}getConfig(){return{...this.constructor.CONFIG}}getCursor(){return this.constructor.CONFIG.cursor}hasSizeOption(){return this.constructor.CONFIG.hasSizeOption}hasShapeOption(){return this.constructor.CONFIG.hasShapeOption}setChangeCallback(t){this.onChangeCallback=t}setOptionChangeCallback(t){this.onOptionChangeCallback=t}triggerChange(){this.onChangeCallback&&this.onChangeCallback()}}const Z=ir(rr(Bt));let V={brushSize:1,shapeMode:"fill",colorCode:1},Pe=null;function ar(e={},t=null){V={...V,...e},Pe=t,s.debug?.("ToolStateManager initialized")}function sr(e,t){if(!V.hasOwnProperty(e)){s.warn?.(`Unknown tool option: ${e}`);return}const n=V[e];V[e]=t,s.debug?.(`Tool option changed: ${e} = ${t}`),Pe&&Pe(e,t,n)}function lr(e){return V[e]}function cr(){return{...V}}function ur(e){Object.keys(V).forEach(t=>{e.setOption(t,V[t])})}function dr(e,t,n){V.hasOwnProperty(e)&&(V[e]=t),Pe&&Pe(e,t,n)}let F=null;function En(e){F=e}function fr(e,t,n,o={}){if(!F)return s.warn?.("No tool selected for drawing"),!1;try{return F.startDrawing(e,t,n,o)}catch(r){return s.error?.("Error starting drawing",r),!1}}function hr(e,t,n,o={}){if(!F)return!1;try{return F.continueDrawing(e,t,n,o)}catch(r){return s.error?.("Error continuing drawing",r),!1}}function gr(e,t,n,o={}){if(!F)return!1;try{return F.endDrawing(e,t,n,o)}catch(r){return s.error?.("Error ending drawing",r),!1}}function mr(){if(F)try{F.cancelDrawing()}catch(e){s.error?.("Error canceling drawing",e)}}function pr(e){F&&F.setSelection&&F.setSelection(e)}function vr(){F&&F.clearSelection&&F.clearSelection()}function yr(){return!F||!F.respectsSelection?!0:F.respectsSelection()}const _=new Map,xe=[];let U=null,we=null,St=null;function Cr(e={}){s.info?.("ToolRegistry initializing..."),e.onToolChange&&(St=e.onToolChange),ar(e.sharedOptions,e.onToolOptionChange),s.info?.("ToolRegistry initialized")}function Dn(e){try{if(!e||!e.CONFIG)return s.error?.("Invalid tool class: missing CONFIG",e),!1;const t=e.CONFIG,n=t.id;if(!n)return s.error?.("Tool class missing id in CONFIG",e),!1;if(_.has(n))return s.warn?.(`Tool "${n}" already registered, skipping`),!1;const o=new e;return o.setChangeCallback(()=>{s.debug?.(`Tool ${n} triggered change`)}),o.setOptionChangeCallback((r,i,a)=>{dr(r,i,a)}),o.init(),_.set(n,o),xe.push(n),s.info?.(`Tool registered: ${t.name} (${n})`),!0}catch(t){return s.error?.("Failed to register tool",t),!1}}function br(e){let t=0;return e.forEach(n=>{Dn(n)&&t++}),s.info?.(`Registered ${t} tools`),t}function Sr(e){const t=_.get(e);if(!t)return s.warn?.(`Tool "${e}" not found`),!1;we===e&&(t.deactivate(),U=null,we=null,En(null)),t.destroy(),_.delete(e);const n=xe.indexOf(e);return n>-1&&xe.splice(n,1),s.info?.(`Tool unregistered: ${e}`),!0}function xr(e){const t=_.get(e);return t?(U&&U!==t&&U.deactivate(),U=t,we=e,U.activate(),ur(U),En(U),St&&St(e,t),s.info?.(`Current tool set: ${e}`),!0):(s.warn?.(`Tool "${e}" not found`),!1)}function wr(){return U}function Er(){return we}function Dr(e){return _.get(e)||null}function Tr(){return xe.map(e=>{const t=_.get(e);return t?t.getConfig():null}).filter(e=>e!==null)}function Ir(e){const t=e.toUpperCase();for(const[n,o]of _)if(o.getConfig().shortcut===t)return o;return null}function $r(e){return _.has(e)}function Or(){return _.size}function Lr(){U&&U.deactivate(),_.forEach(e=>e.destroy()),_.clear(),xe.length=0,U=null,we=null,s.info?.("All tools cleared")}function Mr(){return{totalTools:_.size,currentToolId:we,toolIds:[...xe]}}const S={init:Cr,registerTool:Dn,registerTools:br,unregisterTool:Sr,setCurrentTool:xr,getCurrentTool:wr,getCurrentToolId:Er,getTool:Dr,getAllTools:Tr,getToolByShortcut:Ir,hasTool:$r,getToolCount:Or,clearAll:Lr,getStats:Mr,setToolOption:sr,getToolOption:lr,getSharedOptions:cr,startDrawing:fr,continueDrawing:hr,endDrawing:gr,cancelDrawing:mr,setSelection:pr,clearSelection:vr,respectsSelection:yr};let Ae=null,ge="",ee=[],N=[],xt={},Ne=[],de=1,wt=null,Ce=null;async function zr(e,t=null){try{s.info?.("ColorPalette initializing..."),wt=t,Ae=await Mt.loadColors(),Ft();const n=document.getElementById(e);n?(Pt(n),In()):s.warn?.(`Container "${e}" not found`),s.info?.("ColorPalette initialized successfully")}catch(n){throw s.error?.("ColorPalette initialization failed",n),n}}function Ft(){ge=Ae.base64Chars,ee=Ae.palette,N=[],xt={},Ne=[],ee.forEach(e=>{N[e.index]=e.color,xt[e.char]=e.color,Ne[e.index]=e.name}),s.debug?.(`Parsed ${ee.length} colors from configuration`)}function Pt(e){e.innerHTML="",ee.forEach(t=>{const n=document.createElement("button");n.className="color-swatch",n.dataset.code=t.char,n.dataset.index=t.index,n.dataset.category=t.category,n.style.backgroundColor=t.color,n.title=`${t.name} (${t.char})`,t.index===de&&n.classList.add("active"),n.addEventListener("click",()=>Tn(t.index)),e.appendChild(n)}),s.debug?.(`Rendered ${ee.length} color swatches`)}function Tn(e){if(!Ue.validateColorIndex(e)){s.error?.(`Invalid color index: ${e}`);return}const t=de;de=e,document.querySelectorAll(".color-swatch").forEach(n=>{n.classList.toggle("active",parseInt(n.dataset.index)===e)}),In(),wt&&wt(e,N[e]),x&&x.emit(x.Events.COLOR_CHANGED,{index:e,color:N[e],char:ge[e],name:Ne[e],oldIndex:t}),S&&S.setToolOption("colorCode",e),s.debug?.(`Color selected: ${Ne[e]} (${e})`)}function In(){const e=document.getElementById("currentColorDisplay"),t=document.getElementById("currentColorCode");e&&(e.style.backgroundColor=N[de]),t&&(t.textContent=ge[de])}function Br(e){return N[e]||N[0]}function Fr(e){return xt[e]||N[0]}function Pr(){return de}function Ar(){return N[de]}function Nr(e){return ge[e]||"0"}function kr(e){return ge.indexOf(e)}function Rr(){return[...ee]}function Hr(e){return ee.filter(t=>t.category===e)}function _r(){const e=new Set;return ee.forEach(t=>e.add(t.category)),Array.from(e)}function Gr(e){const t=N[e];if(t==="transparent")return{r:0,g:0,b:0,a:0};const n=t.replace("#",""),o=parseInt(n.substring(0,2),16),r=parseInt(n.substring(2,4),16),i=parseInt(n.substring(4,6),16);return{r:o,g:r,b:i,a:255}}function Ur(e){return Ne[e]||"Unknown"}function Yr(e){return ee.find(t=>t.index===e)||null}function qr(e,t){if(e>=0&&e<N.length){Ce||(Ce=[...N]),Ce[e]=t,N[e]=t;const n=document.querySelector(`.color-swatch[data-index="${e}"]`);n&&(n.style.backgroundColor=t),s.info?.(`Custom color set at index ${e}: ${t}`)}}function Xr(){if(Ae){Ft();const e=document.querySelector(".color-grid");e&&Pt(e),Ce=null,s.info?.("Palette reset to default")}}function Wr(){return{base64Chars:ge,palette:ee.map((e,t)=>({...e,color:Ce?Ce[t]:e.color}))}}function jr(e){try{Ae=e,Ft();const t=document.querySelector(".color-grid");t&&Pt(t),s.info?.("Custom palette imported")}catch(t){s.error?.("Failed to import custom palette",t)}}const ne={init:zr,selectColor:Tn,getColor:Br,getColorByChar:Fr,getCurrentColorIndex:Pr,getCurrentColor:Ar,getBase64Char:Nr,getIndexFromChar:kr,getAllColors:Rr,getColorsByCategory:Hr,getCategories:_r,indexToRGBA:Gr,getColorName:Ur,getColorInfo:Yr,setCustomColor:qr,resetToDefault:Xr,exportCustomPalette:Wr,importCustomPalette:jr,get BASE64_CHARS(){return ge},get COLORS(){return N}};let $=16,O=16,k=[];function Vr(e,t){$=e,O=t,dt(),s.debug?.(`PixelData initialized: ${$}×${O}`)}function dt(){k=[];for(let e=0;e<O;e++){k[e]=[];for(let t=0;t<$;t++)k[e][t]=0}}function Kr(){return k}function Zr(e){return!e||e.length===0?(s.error?.("Invalid pixel data"),!1):(O=e.length,$=e[0].length,k=e.map(t=>[...t]),!0)}function Jr(){return{width:$,height:O}}function Qr(e,t){return e>=0&&e<$&&t>=0&&t<O?k[t][e]:null}function ei(e,t,n){return e>=0&&e<$&&t>=0&&t<O?(k[t][e]=n,!0):!1}function ti(e,t){const n=Ue.validateCanvasDimensions(e,t);if(!n.valid)return s.error?.("Invalid dimensions:",n.error),!1;const o=k,r=$,i=O;$=e,O=t,dt();for(let a=0;a<Math.min(i,O);a++)for(let l=0;l<Math.min(r,$);l++)k[a][l]=o[a][l];return s.info?.(`Pixel data resized: ${r}×${i} → ${$}×${O}`),!0}function ni(e=!1){let t="";for(let o=0;o<O;o++)for(let r=0;r<$;r++)t+=ne.getBase64Char(k[o][r]);const n=`${$}x${O}:${t}`;return e&&W?W.smartCompress(n).data:n}function oi(e){try{const t=Ue.validateDataString(e);if(!t.valid)return{success:!1,error:t.error};let n=e;W&&W.isCompressed(e)&&(n=W.decompress(e),s.debug?.("Data decompressed"));const o=n.split(":"),r=o[0].split("x"),i=parseInt(r[0]),a=parseInt(r[1]),l=o[1];$=i,O=a,dt();let u=0;for(let c=0;c<O;c++)for(let h=0;h<$;h++){const d=l[u],f=ne.getIndexFromChar(d);if(f===-1)return{success:!1,error:`Invalid character: ${d}`};k[c][h]=f,u++}return s.info?.(`Data imported: ${$}×${O}`),{success:!0,error:null}}catch(t){return s.error?.("Import failed",t),{success:!1,error:t.message}}}function ri(){return k.map(e=>[...e])}function ii(){for(let e=0;e<O;e++)for(let t=0;t<$;t++)if(k[e][t]!==0)return!0;return!1}function ai(){const e={};let t=0;for(let r=0;r<O;r++)for(let i=0;i<$;i++){const a=k[r][i];a===0?t++:e[a]=(e[a]||0)+1}const n=$*O,o=Object.keys(e).length;return{width:$,height:O,totalPixels:n,transparentPixels:t,usedColors:o,colorCounts:e,fillPercentage:((n-t)/n*100).toFixed(1)}}const w={init:Vr,clear:dt,getData:Kr,setData:Zr,getDimensions:Jr,getPixel:Qr,setPixel:ei,resize:ti,exportToString:ni,importFromString:oi,clone:ri,hasContent:ii,getStats:ai};let R=null,T=null,b=30,$n=!0,Qe=null;function si(e,t=null){R=e,T=R.getContext("2d"),T.imageSmoothingEnabled=!1,Qe=t,s.debug?.("CanvasRenderer initialized")}function On(e,t){const n=R.parentElement;if(!n)return Qe?.canvas?.defaultPixelSize||30;const o=Math.min(n.clientWidth-40,800),r=Math.min(window.innerHeight*.5,800),i=Math.floor(o/e),a=Math.floor(r/t),l=Qe?.canvas?.minPixelSize||8,u=Qe?.canvas?.maxPixelSize||50;return Math.max(l,Math.min(i,a,u))}function li(e,t,n=null){n!==null?b=n:b=On(e,t),R.width=e*b,R.height=t*b,T.imageSmoothingEnabled=!1,s.debug?.(`Canvas size updated: ${R.width}×${R.height} (pixel size: ${b})`)}function ci(e){if(!e||e.length===0){s.warn?.("No pixel data to render");return}const t=e.length,n=e[0].length;T.clearRect(0,0,R.width,R.height);for(let o=0;o<t;o++)for(let r=0;r<n;r++){const i=e[o][r];if(i===0)ui(r,o);else{const a=ne.getColor(i);T.fillStyle=a,T.fillRect(r*b,o*b,b,b)}}$n&&di(n,t)}function ui(e,t){const n=Math.max(2,Math.floor(b/4));for(let o=0;o<b;o+=n)for(let r=0;r<b;r+=n){const i=(Math.floor(r/n)+Math.floor(o/n))%2===0;T.fillStyle=i?"#2a2a2a":"#1a1a1a",T.fillRect(e*b+r,t*b+o,n,n)}}function di(e,t){T.strokeStyle="#404040",T.lineWidth=1;for(let n=0;n<=e;n++)T.beginPath(),T.moveTo(n*b,0),T.lineTo(n*b,t*b),T.stroke();for(let n=0;n<=t;n++)T.beginPath(),T.moveTo(0,n*b),T.lineTo(e*b,n*b),T.stroke()}function fi(){T.clearRect(0,0,R.width,R.height)}function hi(e){$n=e}function gi(){return b}function mi(){return R}function pi(){return T}function vi(e,t,n,o,r=1){const i=R.getBoundingClientRect(),a=Math.floor((e-i.left)/(b*r)),l=Math.floor((t-i.top)/(b*r));return a>=0&&a<n&&l>=0&&l<o?{x:a,y:l}:null}function yi(e,t,n=1){return{x:e*b*n,y:t*b*n}}const Y={init:si,calculatePixelSize:On,updateCanvasSize:li,render:ci,clear:fi,setGridVisible:hi,getPixelSize:gi,getCanvas:mi,getContext:pi,screenToPixelCoords:vi,pixelToScreenCoords:yi};let z=null,M=null,ce=null,Ee=null;function Ci(e,t={}){ce=e,Ee=t.renderer||Y,bi(),s.debug?.("SelectionOverlay initialized (stateless)")}function bi(){z&&z.remove(),z=document.createElement("canvas"),z.className="selection-overlay",Object.assign(z.style,{position:"absolute",top:"0",left:"0",pointerEvents:"none",zIndex:"10"}),M=z.getContext("2d"),ce.parentElement.appendChild(z),Ln()}function Ln(){!z||!ce||(z.width=ce.width,z.height=ce.height,Object.assign(z.style,{width:ce.style.width,height:ce.style.height}))}function Si(e,t=0){if(!z||!M||!Ee)return;Mn();const{bounds:n,previewBounds:o,movePreview:r}=e;if(r&&r.pixelData){xi(r);const i={x1:r.x,y1:r.y,x2:r.x+r.pixelData[0].length-1,y2:r.y+r.pixelData.length-1};nn(i,t)}else n?nn(n,t):o&&wi(o)}function xi(e){const{pixelData:t,x:n,y:o}=e,r=Ee.getPixelSize(),i=Ee.getColors();for(let a=0;a<t.length;a++)for(let l=0;l<t[a].length;l++){const u=t[a][l];u!==0&&(M.fillStyle=i[u],M.fillRect(Math.floor((n+l)*r),Math.floor((o+a)*r),r,r))}}function nn(e,t){const n=Ee.getPixelSize(),o={x:Math.floor(e.x1*n),y:Math.floor(e.y1*n),w:Math.floor((e.x2-e.x1+1)*n),h:Math.floor((e.y2-e.y1+1)*n)};M.strokeStyle="#FFFFFF",M.lineWidth=1,M.setLineDash([4,4]),M.lineDashOffset=t,M.strokeRect(o.x-1,o.y-1,o.w+2,o.h+2),M.strokeStyle="#000000",M.lineDashOffset=t+4,M.strokeRect(o.x-1,o.y-1,o.w+2,o.h+2)}function wi(e){const t=Ee.getPixelSize(),n={x:Math.floor(e.x1*t),y:Math.floor(e.y1*t),w:Math.floor((e.x2-e.x1+1)*t),h:Math.floor((e.y2-e.y1+1)*t)};M.strokeStyle="rgba(0, 191, 255, 0.8)",M.lineWidth=1,M.setLineDash([3,3]),M.strokeRect(n.x,n.y,n.w,n.h)}function Mn(){z&&M&&M.clearRect(0,0,z.width,z.height)}function Ei(){z&&(z.remove(),z=null,M=null),s.debug?.("SelectionOverlay destroyed")}const P={init:Ci,updateSize:Ln,render:Si,clear:Mn,destroy:Ei};let q=1,Ye=0,qe=0,De=!1,Et=0,Dt=0,E=null;const At=.1,Nt=10,ot=.1;function Di(){E=document.querySelector(".canvas-container"),E&&(Ti(),Ii(),We(),s.info("Viewport initialized"))}function Ti(){const e=document.querySelector(".info-bar");if(!e)return;const t=document.createElement("div");t.className="zoom-controls",t.innerHTML=`
        <div class="info-group">
            <button class="zoom-btn" id="zoomOutBtn" title="Zoom Out (-)">−</button>
            <select class="zoom-select" id="zoomSelect">
                <option value="0.25">25%</option>
                <option value="0.5">50%</option>
                <option value="1" selected>100%</option>
                <option value="2">200%</option>
                <option value="4">400%</option>
                <option value="fit">Fit</option>
            </select>
            <button class="zoom-btn" id="zoomInBtn" title="Zoom In (+)">+</button>
            <button class="zoom-btn" id="zoomResetBtn" title="Reset View (Ctrl+0)">⟲</button>
        </div>
    `;const n=e.querySelector(".info-spacer");n?e.insertBefore(t,n):e.appendChild(t),document.getElementById("zoomInBtn").addEventListener("click",kt),document.getElementById("zoomOutBtn").addEventListener("click",Rt),document.getElementById("zoomResetBtn").addEventListener("click",Ht),document.getElementById("zoomSelect").addEventListener("change",o=>{const r=o.target.value;r==="fit"?_t():Xe(parseFloat(r))})}function Ii(){E&&(E.addEventListener("wheel",$i,{passive:!1}),E.addEventListener("mousedown",Oi),E.addEventListener("mousemove",Li),E.addEventListener("mouseup",on),E.addEventListener("mouseleave",on),document.addEventListener("keydown",Mi))}function $i(e){if(!(e.ctrlKey||e.metaKey))return;e.preventDefault();const n=e.deltaY>0?-ot:ot,o=Math.max(At,Math.min(Nt,q+n));Xe(o)}function Oi(e){const t=S&&S.getCurrentToolId()==="hand",n=e.buttons===1&&ke,o=e.button===1;(t||n||o)&&(e.preventDefault(),De=!0,Et=e.clientX,Dt=e.clientY,E.classList.add("cursor-grabbing"))}function Li(e){if(!De)return;e.preventDefault();const t=e.clientX-Et,n=e.clientY-Dt;Ye+=t,qe+=n,Et=e.clientX,Dt=e.clientY,We()}function on(e){De&&(De=!1,E.classList.remove("cursor-grabbing"),S&&S.getCurrentToolId()==="hand"?E.classList.add("cursor-grab"):E.classList.remove("cursor-grab"))}let ke=!1;function Mi(e){if(e.code==="Space"&&!e.repeat&&e.target.tagName!=="INPUT"&&e.target.tagName!=="TEXTAREA"&&(ke=!0,E&&E.classList.add("cursor-grab")),!(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA")&&(e.ctrlKey||e.metaKey))switch(e.key){case"+":case"=":e.preventDefault(),kt();break;case"-":case"_":e.preventDefault(),Rt();break;case"0":e.preventDefault(),Ht();break}}document.addEventListener("keyup",e=>{e.code==="Space"&&(ke=!1,E&&!De&&(S&&S.getCurrentToolId()==="hand"||E.classList.remove("cursor-grab")))});window.addEventListener("blur",()=>{ke&&(ke=!1,E&&!De&&(S&&S.getCurrentToolId()==="hand"||E.classList.remove("cursor-grab")),s.debug?.("Space key state reset due to window blur"))});function kt(){const e=Math.min(Nt,q+ot);Xe(e)}function Rt(){const e=Math.max(At,q-ot);Xe(e)}function Xe(e){q=Math.max(At,Math.min(Nt,e)),We(),Gt()}function Ht(){q=1,Ye=0,qe=0,We(),Gt()}function _t(){if(!E)return;const e=document.getElementById("pixelCanvas");if(!e)return;const t=E.clientWidth-100,n=E.clientHeight-100,o=e.width,r=e.height,i=t/o,a=n/r;q=Math.min(i,a,1),Ye=0,qe=0,We(),Gt()}function We(){const e=document.querySelector(".canvas-wrapper");e&&(e.style.transform=`translate(${Ye}px, ${qe}px) scale(${q})`,e.style.transformOrigin="center center")}function Gt(){const e=document.getElementById("zoomSelect");if(!e)return;const t=Math.round(q*100),n=Array.from(e.options).find(o=>o.value!=="fit"&&Math.abs(parseFloat(o.value)-q)<.01);if(n)e.value=n.value;else{let o=e.querySelector('option[data-custom="true"]');o||(o=document.createElement("option"),o.dataset.custom="true",e.insertBefore(o,e.options[e.options.length-1])),o.value=q,o.textContent=`${t}%`,e.value=q}}function zi(){return q}function Bi(){return{x:Ye,y:qe}}function Fi(){const e=document.getElementById("zoomSelect");e&&e.value==="fit"&&_t()}const rt={init:Di,zoomIn:kt,zoomOut:Rt,setZoom:Xe,resetView:Ht,fitToScreen:_t,getZoom:zi,getPan:Bi,updateCanvasSize:Fi};let I=null,Re=null,K=null,X=null,fe=null,Tt=null,it=null,et=!1;function Pi(e,t={}){I=e,Re=t.renderer||Y,K=t.pixelData||w,X=t.toolRegistry||S,fe=t.colorPalette||ne,Tt=t.viewport||rt,it=t.onChange||null,Ai(),s.debug?.("CanvasEvents initialized")}function Ai(){I.addEventListener("mousedown",Ut),I.addEventListener("mousemove",Yt),I.addEventListener("mouseup",He),I.addEventListener("mouseleave",He),I.addEventListener("touchstart",zn,{passive:!1}),I.addEventListener("touchmove",Bn,{passive:!1}),I.addEventListener("touchend",at),I.addEventListener("touchcancel",at),I.addEventListener("contextmenu",e=>e.preventDefault()),s.debug?.("Canvas event listeners registered")}function Ut(e){if(!X||!K)return;const t=qt(e);if(!t)return;const n=K.getData(),r={colorCode:fe?fe.getCurrentColorIndex():1,event:e};et=!0,X.startDrawing(t.x,t.y,n,r);const i=X.getCurrentToolId();["brush","pencil","eraser"].includes(i)&&X.continueDrawing(t.x,t.y,n,r)&&(Xt(),Wt())}function Yt(e){if(!X||!K)return;const t=qt(e);if(!t)return;const n=K.getData(),r={colorCode:fe?fe.getCurrentColorIndex():1,event:e,onSelectionChange:Fn};X.continueDrawing(t.x,t.y,n,r)&&(Xt(),Wt()),X.getCurrentToolId()==="select"&&P&&P.renderPreview(t.x,t.y)}function He(e){if(!et||!X||!K){et=!1;return}et=!1;const t=qt(e),n=K.getData(),r={colorCode:fe?fe.getCurrentColorIndex():1,event:e,onSelectionChange:Fn};let i=!1;t?i=X.endDrawing(t.x,t.y,n,r):i=X.endDrawing(-1,-1,n,r),i&&(Xt(),Wt()),X.getCurrentToolId()==="select"&&P&&P.renderPreview()}function zn(e){if(e.preventDefault(),e.touches.length===0)return;const t=e.touches[0],n=new MouseEvent("mousedown",{clientX:t.clientX,clientY:t.clientY,bubbles:!0});Ut(n)}function Bn(e){if(e.preventDefault(),e.touches.length===0)return;const t=e.touches[0],n=new MouseEvent("mousemove",{clientX:t.clientX,clientY:t.clientY,bubbles:!0});Yt(n)}function at(e){e.preventDefault();const t=new MouseEvent("mouseup",{bubbles:!0});He(t)}function qt(e){if(!Re||!K)return null;const t=K.getDimensions(),n=Tt?Tt.getZoom():1;return Re.screenToPixelCoords(e.clientX,e.clientY,t.width,t.height,n)}function Fn(e){P&&(P.setSelection(e),P.renderPreview()),x&&x.emit(x.Events.SELECTION_CHANGED,e)}function Xt(){Re&&K&&Re.render(K.getData())}function Wt(){it&&it(),x&&x.emit(x.Events.CANVAS_CHANGED)}function Ni(e){it=e}function ki(){I&&(I.removeEventListener("mousedown",Ut),I.removeEventListener("mousemove",Yt),I.removeEventListener("mouseup",He),I.removeEventListener("mouseleave",He),I.removeEventListener("touchstart",zn),I.removeEventListener("touchmove",Bn),I.removeEventListener("touchend",at),I.removeEventListener("touchcancel",at),I.removeEventListener("contextmenu",e=>e.preventDefault()),s.debug?.("CanvasEvents destroyed"))}const st={init:Pi,setChangeCallback:Ni,destroy:ki};let Me=null,lt=null,rn=null,Te=null,Be=null,vt=0;async function Ri(e,t=16,n=16,o=null){try{if(s.info?.("PixelCanvas initializing..."),lt=o,Me=document.getElementById(e),Te=S,!Me)throw new Error(`Canvas element "${e}" not found`);if(rn=await Mt.loadConstants(),!w)throw new Error("PixelData module not available");if(w.init(t,n),!Y)throw new Error("CanvasRenderer module not available");if(Y.init(Me,rn),Y.updateCanvasSize(t,n),P&&P.init(Me,{renderer:Y}),!st)throw new Error("CanvasEvents module not available");st.init(Me,{renderer:Y,pixelData:w,toolRegistry:Te,onChange:ht}),ft(),Hi(),s.info?.(`PixelCanvas initialized: ${t}×${n}`),x&&x.emit(x.Events.CANVAS_RESIZED,{width:t,height:n})}catch(r){throw s.error?.("PixelCanvas initialization failed",r),r}}function Hi(){if(Be)return;function e(){if(Y.render(w.getData()),P&&Te){vt=(vt+.25)%16;const t=Te.getCurrentTool(),n={bounds:null,previewBounds:null,movePreview:null};t&&(n.bounds=t.selectionActive?t.selectionBounds:null,t.constructor.CONFIG.id==="select"&&t.isDrawing&&(n.bounds=null,n.previewBounds={x1:Math.min(t.startX,t.lastX),y1:Math.min(t.startY,t.lastY),x2:Math.max(t.startX,t.lastX),y2:Math.max(t.startY,t.lastY)}),t.constructor.CONFIG.id==="move"&&t.isMoving&&(n.movePreview=t.getPreviewData(),n.bounds=null)),P.render(n,vt)}Be=requestAnimationFrame(e)}e(),s.info?.("PixelCanvas render loop started.")}function _i(){Be&&(cancelAnimationFrame(Be),Be=null,s.info?.("PixelCanvas render loop stopped."))}function Gi(){w&&(w.clear(),ht(),x&&x.emit(x.Events.CANVAS_CLEARED))}function Ui(){return w?w.getData().some(t=>t.some(n=>n!==0)):!1}function Yi(e,t){return!w||!Y?!1:w.resize(e,t)?(Y.updateCanvasSize(e,t),P&&P.updateSize(),ft(),ht(),x&&x.emit(x.Events.CANVAS_RESIZED,{width:e,height:t}),!0):!1}function qi(e=!1){return w?w.exportToString(e):""}function Xi(e){if(!w||!Y)return!1;const t=w.importFromString(e);if(t.success){const n=w.getDimensions();if(Y.updateCanvasSize(n.width,n.height),P&&P.updateSize(),Te){const o=Te.getCurrentTool();o&&o.clearSelection()}return ft(),ht(),x&&x.emit(x.Events.FILE_LOADED,{width:n.width,height:n.height}),!0}else return window.Dialogs?window.Dialogs.alert("Import Failed",t.error,"error"):alert("Import failed: "+t.error),!1}function ft(){if(!w)return;const e=w.getDimensions(),t=document.getElementById("canvasSizeDisplay");t&&bt?t.textContent=bt.formatDimensions(e.width,e.height):t&&(t.textContent=`${e.width}×${e.height}`)}function ht(){lt&&lt(),ft()}function Wi(){_i(),st&&st.destroy(),P&&P.destroy(),s.info?.("PixelCanvas destroyed")}function ji(){return w?w.getData():[]}function Vi(){return w?w.getDimensions():{width:0,height:0}}function Ki(){return w?w.getStats():{}}function Zi(e){lt=e,events&&events.setChangeCallback(e)}const C={init:Ri,clear:Gi,hasContent:Ui,resize:Yi,exportToString:qi,importFromString:Xi,getPixelData:ji,getDimensions:Vi,getStats:Ki,setChangeCallback:Zi,destroy:Wi};let Je=null,It=!1;function me(){if(Je!==null)return Je;try{const e="__storage_test__";return localStorage.setItem(e,e),localStorage.removeItem(e),Je=!0,!0}catch(e){return Je=!1,s.warn?.("localStorage is not available",e),!1}}function jt(e){if(!me())return null;try{return localStorage.getItem(e)}catch(t){return s.error?.("localStorage.getItem failed",t),null}}function Pn(e,t){if(!me())return!1;try{return localStorage.setItem(e,t),It=!1,!0}catch(n){return n.name==="QuotaExceededError"||n.code===22?(It=!0,s.error?.("localStorage quota exceeded",n)):s.error?.("localStorage.setItem failed",n),!1}}function Ji(e){if(!me())return!1;try{return localStorage.removeItem(e),!0}catch(t){return s.error?.("localStorage.removeItem failed",t),!1}}function Qi(){if(!me())return!1;try{return localStorage.clear(),!0}catch(e){return s.error?.("localStorage.clear failed",e),!1}}function ea(){if(!me())return[];try{const e=[];for(let t=0;t<localStorage.length;t++){const n=localStorage.key(t);n&&e.push(n)}return e}catch(e){return s.error?.("localStorage.keys failed",e),[]}}function ta(){return It}function na(){if(!me())return null;try{let e=0;for(let n=0;n<localStorage.length;n++){const o=localStorage.key(n);if(o){const r=localStorage.getItem(o);r&&(e+=o.length+r.length)}}const t=5*1024*1024;return{used:e,total:t,percentage:(e/t*100).toFixed(2),usedKB:(e/1024).toFixed(2),totalMB:(t/1024/1024).toFixed(2),available:t-e}}catch(e){return s.error?.("getStorageStats failed",e),null}}function oa(e,t=null){const n=jt(e);if(!n)return t;try{return JSON.parse(n)}catch(o){return s.error?.("JSON parse failed",o),t}}function ra(e,t){try{const n=JSON.stringify(t);return Pn(e,n)}catch(n){return s.error?.("JSON stringify failed",n),!1}}function ia(e){return jt(e)!==null}const H={isStorageAvailable:me,getItem:jt,setItem:Pn,removeItem:Ji,clear:Qi,keys:ea,isQuotaExceeded:ta,getStorageStats:na,getJSON:oa,setJSON:ra,hasKey:ia};let be=null,yt=null,_e=null,Ge=!1,gt=!0;const aa=3e4,sa=2e3;function la(){ca(),An(),s.info("Autosave initialized")}function ca(){const e=document.querySelector(".menu-bar");if(!e)return;const t=document.createElement("div");t.id="autosaveIndicator",t.className="autosave-indicator",t.innerHTML=`
        <span class="autosave-status">
            <span class="autosave-icon">💾</span>
            <span class="autosave-text">Saved</span>
        </span>
        <span class="autosave-time"></span>
    `,e.appendChild(t)}function An(){be&&clearInterval(be),be=setInterval(()=>{Ge&&gt&&Vt()},aa)}function ua(){be&&(clearInterval(be),be=null)}function da(){Ge=!0,tt("unsaved"),yt&&clearTimeout(yt),yt=setTimeout(()=>{Ge&&gt&&Vt()},sa)}function Vt(){if(!gt)return;tt("saving");const e=oe?oe.getCurrentTab():null;if(!e)return;const t=C.exportToString();try{const n=`autosave_${e.id}`;H.setItem(n,t),H.setItem(`${n}_timestamp`,Date.now().toString()),Ge=!1,_e=Date.now(),setTimeout(()=>{tt("saved")},500),s.info("Autosaved:",e.name)}catch(n){s.error("Autosave failed:",n),tt("error")}}function tt(e){const t=document.getElementById("autosaveIndicator");if(!t)return;const n=t.querySelector(".autosave-icon"),o=t.querySelector(".autosave-text"),r=t.querySelector(".autosave-time");switch(t.classList.remove("status-saved","status-saving","status-unsaved","status-error"),e){case"saved":t.classList.add("status-saved"),n.textContent="✓",o.textContent="Saved",_e&&(r.textContent=Nn(_e));break;case"saving":t.classList.add("status-saving"),n.textContent="⏳",o.textContent="Saving...";break;case"unsaved":t.classList.add("status-unsaved"),n.textContent="●",o.textContent="Unsaved";break;case"error":t.classList.add("status-error"),n.textContent="⚠️",o.textContent="Error";break}}function Nn(e){const t=Math.floor((Date.now()-e)/1e3);return t<60?"just now":t<3600?`${Math.floor(t/60)}m ago`:t<86400?`${Math.floor(t/3600)}h ago`:`${Math.floor(t/86400)}d ago`}function fa(){setInterval(()=>{const t=document.getElementById("autosaveIndicator")?.querySelector(".autosave-time");t&&_e&&!Ge&&(t.textContent=Nn(_e))},3e4)}function ha(e){try{const t=`autosave_${e}`,n=H.getItem(t),o=H.getItem(`${t}_timestamp`);if(n&&o)return{data:n,timestamp:parseInt(o)}}catch(t){s.error("Failed to load autosave:",t)}return null}function ga(e){try{const t=`autosave_${e}`;H.removeItem(t),H.removeItem(`${t}_timestamp`)}catch(t){s.error("Failed to clear autosave:",t)}}function ma(e){gt=e,e?An():ua()}function pa(){Vt()}fa();const ie={init:la,markDirty:da,forceSave:pa,loadAutosave:ha,clearAutosave:ga,setEnabled:ma};let A=[],ae=null,Fe=0;function va(){ya(),Ea().length===0&&Kt("Untitled-1",16,16),s.info("Tab Manager initialized")}function ya(){const e=document.querySelector(".workspace");if(!e)return;const t=e.querySelector(".menu-bar"),n=document.createElement("div");n.className="tab-bar",n.id="tabBar",n.innerHTML=`
        <div class="tab-list" id="tabList"></div>
        <button class="tab-new-btn" id="newTabBtn" title="New Document (Ctrl+N)">+</button>
    `,e.insertBefore(n,t.nextSibling),document.getElementById("newTabBtn").addEventListener("click",()=>{Kt()})}function Kt(e=null,t=16,n=16,o=null){Fe++;const r=`tab_${Date.now()}_${Fe}`,i=e||`Untitled-${Fe}`,a={id:r,name:i,width:t,height:n,data:o||kn(t,n),isDirty:!1,created:Date.now(),modified:Date.now()};return A.push(a),Rn(a),Ie(r),a}function kn(e,t){const n="0".repeat(e*t);return`${e}x${t}:${n}`}function Rn(e){const t=document.getElementById("tabList");if(!t)return;const n=document.createElement("div");n.className="tab",n.dataset.tabId=e.id,n.innerHTML=`
        <span class="tab-name">${e.name}</span>
        <span class="tab-dirty" style="display: none;">●</span>
        <button class="tab-close" title="Close">×</button>
    `,n.addEventListener("click",o=>{o.target.classList.contains("tab-close")||Ie(e.id)}),n.querySelector(".tab-close").addEventListener("click",o=>{o.stopPropagation(),Hn(e.id)}),n.querySelector(".tab-name").addEventListener("dblclick",o=>{o.stopPropagation(),_n(e.id)}),t.appendChild(n)}function Ie(e){const t=A.find(n=>n.id===e);t&&(ae&&Ca(),ae=e,document.querySelectorAll(".tab").forEach(n=>{n.classList.toggle("active",n.dataset.tabId===e)}),C&&C.importFromString(t.data),document.title=`${t.name} - Inline.px`,s.info("Switched to tab:",t.name))}function Ca(){const e=A.find(t=>t.id===ae);!e||!C||(e.data=C.exportToString(),e.modified=Date.now())}async function Hn(e){const t=A.find(o=>o.id===e);if(!t)return;if(A.length===1){await B.confirm("Close Document","Close this document and create a new one?",{confirmText:"Close & New",cancelText:"Cancel",type:"info"})&&(t.data=kn(16,16),t.name="Untitled-1",t.isDirty=!1,je(t),Ie(t.id),C&&C.importFromString(t.data));return}if(t.isDirty&&!await B.confirm("Unsaved Changes",`"${t.name}" has unsaved changes. Close anyway?`,{confirmText:"Close",cancelText:"Cancel",type:"warning",dangerous:!0}))return;A=A.filter(o=>o.id!==e);const n=document.querySelector(`.tab[data-tab-id="${e}"]`);if(n&&n.remove(),ae===e){const o=A[A.length-1];o&&Ie(o.id)}ie&&ie.clearAutosave(e),s.info("Closed tab:",t.name)}async function _n(e){const t=A.find(o=>o.id===e);if(!t)return;const n=await B.prompt("Rename Document","Enter a new name for this document:",t.name,{placeholder:"Document name"});n&&n.trim()&&(t.name=n.trim(),je(t),ae===e&&(document.title=`${t.name} - Inline.px`))}function je(e){const t=document.querySelector(`.tab[data-tab-id="${e.id}"]`);if(!t)return;const n=t.querySelector(".tab-name"),o=t.querySelector(".tab-dirty");n&&(n.textContent=e.name),o&&(o.style.display=e.isDirty?"inline":"none")}function ba(){const e=A.find(t=>t.id===ae);e&&(e.isDirty=!0,e.modified=Date.now(),je(e),ie&&ie.markDirty())}function Sa(){const e=A.find(t=>t.id===ae);e&&(e.isDirty=!1,je(e))}function Gn(){return A.find(e=>e.id===ae)||null}function xa(){return A}function wa(e){const t=Gn();t&&(t.name=e,je(t),document.title=`${t.name} - Inline.px`)}function Ea(){const e=[];try{if(!H.isStorageAvailable())return s.warn?.("localStorage not available, cannot restore tabs"),e;const t=H.keys();for(const n of t)if(n&&n.startsWith("autosave_tab_")&&!n.endsWith("_timestamp"))try{const o=n.replace("autosave_",""),r=ie?ie.loadAutosave(o):null;if(r&&r.data){const i=r.data.split(":");let a,l;i[1]==="RLE"?(a=i[0].split("x"),l=W.decompress(r.data)):(a=i[0].split("x"),l=r.data);const u=parseInt(a[0]),c=parseInt(a[1]);if(isNaN(u)||isNaN(c)||u<=0||c<=0){s.warn?.(`Invalid dimensions in autosave ${o}, skipping`);continue}Fe++;const h={id:o,name:`Restored-${Fe}`,width:u,height:c,data:l,isDirty:!1,created:r.timestamp,modified:r.timestamp};A.push(h),Rn(h),e.push(h)}}catch(o){s.warn?.("Failed to restore individual tab, skipping",o);continue}e.length>0&&(Ie(e[0].id),s.info?.(`Restored ${e.length} autosaved tab(s)`))}catch(t){s.error?.("Failed to restore autosaved tabs:",t)}return e}const oe={init:va,createNewTab:Kt,switchToTab:Ie,closeTab:Hn,renameTab:_n,markCurrentTabDirty:ba,markCurrentTabClean:Sa,getCurrentTab:Gn,getAllTabs:xa,setCurrentTabName:wa},Un="pixelart_files";let he=null,le=null,ve=null;function Ve(){return H.getJSON(Un,[])}async function Yn(e){const t=H.setJSON(Un,e);return t||(s.error?.("Error saving to LocalStorage"),H.isQuotaExceeded()?await B.alert("Storage Full","Storage quota exceeded. Please delete some files to free up space.","error"):H.isStorageAvailable()?await B.alert("Save Failed","Failed to save file. Please try again.","error"):await B.alert("Storage Unavailable","LocalStorage is not available. Your browser may be in private mode.","error")),t}async function Da(e,t=null){if(!t&&(t=await B.prompt("Save Pixel Art","Enter a name for your pixel art:",he||"untitled",{placeholder:"File name"}),!t))return!1;const n=e.split(":");if(n.length!==2)return await B.alert("Invalid Format","Invalid data format.","error"),!1;const o=n[0].split("x"),r=parseInt(o[0]),i=parseInt(o[1]),a=Ve(),l=a.findIndex(c=>c.name===t);if(l>=0&&!await B.confirm("Overwrite File",`A file named "${t}" already exists. Overwrite it?`,{confirmText:"Overwrite",cancelText:"Cancel",type:"warning"}))return!1;const u={id:l>=0?a[l].id:$a(),name:t,data:e,timestamp:Date.now(),width:r,height:i};return l>=0?a[l]=u:a.push(u),Yn(a)?(he=t,await B.alert("Saved!",`Saved as "${t}"`,"success"),!0):!1}function Ta(e){const n=Ve().find(o=>o.id===e);return n?(he=n.name,n):null}function qn(e){const t=Ve(),n=t.filter(o=>o.id!==e);return n.length<t.length?Yn(n):!1}function Ia(e,t=null){t||(t=he||"pixelart"),t.endsWith(".txt")||(t+=".txt");const n=new Blob([e],{type:"text/plain"}),o=URL.createObjectURL(n),r=document.createElement("a");r.href=o,r.download=t,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(o)}function $a(){return"file_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}function Oa(){return he}function La(e){he=e}function Ma(){he=null}function Xn(e){return new Date(e).toLocaleString()}function za(){return H.getStorageStats()}function Ba(e){const t=document.getElementById("fileModal"),n=document.getElementById("fileList"),o=document.getElementById("noFilesMessage"),r=document.getElementById("closeModal");if(!t||!n){s.error?.("Modal elements not found");return}le&&r.removeEventListener("click",le),ve&&t.removeEventListener("click",ve);const i=Ve();n.innerHTML="",i.length===0?o.classList.remove("hidden"):(o.classList.add("hidden"),i.sort((a,l)=>l.timestamp-a.timestamp),i.forEach(a=>{const l=Fa(a,e);n.appendChild(l)})),t.classList.add("flex"),t.classList.remove("hidden"),le=()=>{t.classList.add("hidden"),t.classList.remove("flex"),r.removeEventListener("click",le),t.removeEventListener("click",ve),le=null,ve=null},ve=a=>{a.target===t&&le()},r.addEventListener("click",le),t.addEventListener("click",ve)}function Fa(e,t){const n=document.createElement("div");n.className="file-item";const o=document.createElement("div");o.className="file-item-info";const r=document.createElement("div");r.className="file-item-name",r.textContent=e.name;const i=document.createElement("div");i.className="file-item-meta",i.textContent=`${e.width}x${e.height} • ${Xn(e.timestamp)}`,o.appendChild(r),o.appendChild(i);const a=document.createElement("div");a.className="file-item-actions";const l=document.createElement("button");l.className="btn btn-success",l.textContent="Load",l.addEventListener("click",()=>{const c=document.getElementById("fileModal");c.classList.add("hidden"),c.classList.remove("flex"),t(e)});const u=document.createElement("button");return u.className="btn btn-danger",u.textContent="Delete",u.addEventListener("click",async()=>{if(await B.confirm("Delete File",`Delete "${e.name}"? This cannot be undone.`,{confirmText:"Delete",cancelText:"Cancel",type:"error",dangerous:!0})&&qn(e.id)){n.remove();const h=document.getElementById("fileList");if(h&&h.children.length===0){const d=document.getElementById("noFilesMessage");d&&d.classList.remove("hidden")}}}),a.appendChild(l),a.appendChild(u),n.appendChild(o),n.appendChild(a),n}const $e={save:Da,load:Ta,deleteFile:qn,getAllFiles:Ve,exportAsFile:Ia,getCurrentFileName:Oa,setCurrentFileName:La,clearCurrentFileName:Ma,formatDate:Xn,getStorageStats:za,showLoadDialog:Ba};let te=[],se=[];const Wn=50;let $t=null;function Pa(e={}){e.onHistoryChange&&($t=e.onHistoryChange),s.info("History system initialized")}function Aa(e,t="Change"){e&&(te.push({data:e,action:t,timestamp:Date.now()}),te.length>Wn&&te.shift(),se=[],mt())}function Na(e){if(te.length===0)return s.debug("Nothing to undo"),null;e&&se.push({data:e,action:"Redo point",timestamp:Date.now()});const t=te.pop();return mt(),s.info("Undo:",t.action),t.data}function ka(e){if(se.length===0)return s.debug("Nothing to redo"),null;e&&te.push({data:e,action:"Undo point",timestamp:Date.now()});const t=se.pop();return mt(),s.info("Redo:",t.action),t.data}function Ra(){te=[],se=[],mt(),s.info("History cleared")}function jn(){return te.length>0}function Vn(){return se.length>0}function Ha(){return{undoCount:te.length,redoCount:se.length,maxHistory:Wn}}function mt(){$t&&$t({canUndo:jn(),canRedo:Vn(),undoCount:te.length,redoCount:se.length})}const Oe={init:Pa,pushState:Aa,undo:Na,redo:ka,clear:Ra,canUndo:jn,canRedo:Vn,getStats:Ha};function _a(e=1,t="pixelart.png"){if(!document.getElementById("pixelCanvas")){s.error("Canvas not found");return}const o=C.getDimensions(),r=C.getPixelData(),i=document.createElement("canvas");i.width=o.width*e,i.height=o.height*e;const a=i.getContext("2d");a.imageSmoothingEnabled=!1,a.imageSmoothingQuality="high";for(let l=0;l<o.height;l++)for(let u=0;u<o.width;u++){const c=r[l][u];if(c===0)continue;const h=ne.getColor(c);a.fillStyle=h,a.fillRect(u*e,l*e,e,e)}i.toBlob(l=>{Kn(l,t)},"image/png")}function Ga(e,t=1,n="pixelart.png"){let o=e;W&&W.isCompressed(e)&&(o=W.decompress(e));const[r,i]=o.split(":"),[a,l]=r.split("x").map(Number),u=document.createElement("canvas");u.width=a*t,u.height=l*t;const c=u.getContext("2d");c.imageSmoothingEnabled=!1;for(let h=0;h<l;h++)for(let d=0;d<a;d++){const f=h*a+d,m=i[f],p=ne.getIndexFromChar(m);if(p===0)continue;const y=ne.getColor(p);c.fillStyle=y,c.fillRect(d*t,h*t,t,t)}u.toBlob(h=>{Kn(h,n)},"image/png")}function Ua(e=1){const t=C.getDimensions(),n=C.getPixelData(),o=document.createElement("canvas");o.width=t.width*e,o.height=t.height*e;const r=o.getContext("2d");r.imageSmoothingEnabled=!1;for(let i=0;i<t.height;i++)for(let a=0;a<t.width;a++){const l=n[i][a];if(l===0)continue;const u=ne.getColor(l);r.fillStyle=u,r.fillRect(a*e,i*e,e,e)}return o.toDataURL("image/png")}function Kn(e,t){const n=URL.createObjectURL(e),o=document.createElement("a");o.href=n,o.download=t,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(n)}async function Ya(e=1){try{const t=C.getDimensions(),n=C.getPixelData(),o=document.createElement("canvas");o.width=t.width*e,o.height=t.height*e;const r=o.getContext("2d");r.imageSmoothingEnabled=!1;for(let a=0;a<t.height;a++)for(let l=0;l<t.width;l++){const u=n[a][l];if(u===0)continue;const c=ne.getColor(u);r.fillStyle=c,r.fillRect(l*e,a*e,e,e)}const i=await new Promise(a=>{o.toBlob(a,"image/png")});if(navigator.clipboard&&navigator.clipboard.write)return await navigator.clipboard.write([new ClipboardItem({"image/png":i})]),!0;throw new Error("Clipboard API not supported")}catch(t){return s.error("Failed to copy PNG to clipboard:",t),!1}}function qa(){const e=C.getDimensions(),t=Math.max(e.width,e.height);return[{value:1,label:"1× (Original)",size:`${e.width}×${e.height}`},{value:2,label:"2× (Small)",size:`${e.width*2}×${e.height*2}`},{value:4,label:"4× (Medium)",size:`${e.width*4}×${e.height*4}`},{value:8,label:"8× (Large)",size:`${e.width*8}×${e.height*8}`}].filter(o=>t*o.value<=2048)}const Xa={exportToPNG:_a,exportDataStringToPNG:Ga,getDataURL:Ua,copyToClipboard:Ya,getScaleOptions:qa};class Wa extends Z{static CONFIG={id:"brush",name:"Brush",icon:"brush",shortcut:"B",cursor:"crosshair",hasSizeOption:!0,hasShapeOption:!1,description:"Variable size painting brush",category:"drawing"};onDrawStart(t,n,o,r){return this.drawBrush(t,n,o,r)}onDrawContinue(t,n,o,r){return this.drawBrush(t,n,o,r)}onDrawEnd(t,n,o,r){return this.drawBrush(t,n,o,r)}drawBrush(t,n,o,r){const i=o.length,a=o[0].length,l=r.brushSize||this.getOption("brushSize")||1,u=r.colorCode||0;let c=!1;const h=Math.floor(l/2);for(let d=-h;d<=h;d++)for(let f=-h;f<=h;f++){const m=t+f,p=n+d,y=f*f+d*d,g=h*h+h;if(y<=g&&m>=0&&m<a&&p>=0&&p<i){if(this.respectsSelection()&&!this.isInSelection(m,p))continue;o[p][m]!==u&&(o[p][m]=u,c=!0)}}return c}}class ja extends Z{static CONFIG={id:"pencil",name:"Pencil",icon:"edit",shortcut:"P",cursor:"crosshair",hasSizeOption:!1,hasShapeOption:!1,description:"1px precise drawing",category:"drawing"};onDrawStart(t,n,o,r){return this.setPixelIfValid(t,n,o,r.colorCode)}onDrawContinue(t,n,o,r){return this.setPixelIfValid(t,n,o,r.colorCode)}onDrawEnd(t,n,o,r){return this.setPixelIfValid(t,n,o,r.colorCode)}setPixelIfValid(t,n,o,r){return this.respectsSelection()&&!this.isInSelection(t,n)?!1:this.setPixel(t,n,o,r)}}class Va extends Z{static CONFIG={id:"eraser",name:"Eraser",icon:"ink_eraser",shortcut:"E",cursor:"crosshair",hasSizeOption:!0,hasShapeOption:!1,description:"Erase to transparent",category:"drawing"};onDrawStart(t,n,o,r){return this.erase(t,n,o,r)}onDrawContinue(t,n,o,r){return this.erase(t,n,o,r)}onDrawEnd(t,n,o,r){return this.erase(t,n,o,r)}erase(t,n,o,r){const i=o.length,a=o[0].length,l=r.brushSize||this.getOption("brushSize")||1;let u=!1;const c=Math.floor(l/2);for(let h=-c;h<=c;h++)for(let d=-c;d<=c;d++){const f=t+d,m=n+h,p=d*d+h*h,y=c*c+c;if(p<=y&&f>=0&&f<a&&m>=0&&m<i){if(this.respectsSelection()&&!this.isInSelection(f,m))continue;o[m][f]!==0&&(o[m][f]=0,u=!0)}}return u}}class Ka extends Z{static CONFIG={id:"line",name:"Line",icon:"show_chart",shortcut:"L",cursor:"crosshair",hasSizeOption:!0,hasShapeOption:!1,description:"Draw straight lines",category:"shape"};needsPreview(){return!0}onDrawStart(t,n,o,r){return!1}onDrawContinue(t,n,o,r){return this.restorePreviewData(o),this.drawLine(this.startX,this.startY,t,n,o,r)}onDrawEnd(t,n,o,r){return this.restorePreviewData(o),this.drawLine(this.startX,this.startY,t,n,o,r)}drawLine(t,n,o,r,i,a){const l=i.length,u=i[0].length,c=a.colorCode||0,h=a.brushSize||1;let d=!1;const f=Math.abs(o-t),m=Math.abs(r-n),p=t<o?1:-1,y=n<r?1:-1;let g=f-m,v=t,D=n;for(;h>1?d=this.drawBrushAt(v,D,i,c,h)||d:v>=0&&v<u&&D>=0&&D<l&&(this.respectsSelection()&&!this.isInSelection(v,D)||i[D][v]!==c&&(i[D][v]=c,d=!0)),!(v===o&&D===r);){const j=2*g;j>-m&&(g-=m,v+=p),j<f&&(g+=f,D+=y)}return d}drawBrushAt(t,n,o,r,i){const a=o.length,l=o[0].length;let u=!1;const c=Math.floor(i/2);for(let h=-c;h<=c;h++)for(let d=-c;d<=c;d++){const f=t+d,m=n+h,p=d*d+h*h,y=c*c+c;if(p<=y&&f>=0&&f<l&&m>=0&&m<a){if(this.respectsSelection()&&!this.isInSelection(f,m))continue;o[m][f]!==r&&(o[m][f]=r,u=!0)}}return u}}class Za extends Z{static CONFIG={id:"rectangle",name:"Rectangle",icon:"rectangle",shortcut:"R",cursor:"crosshair",hasSizeOption:!1,hasShapeOption:!0,description:"Draw rectangles",category:"shape"};needsPreview(){return!0}onDrawStart(t,n,o,r){return!1}onDrawContinue(t,n,o,r){return this.restorePreviewData(o),this.drawRectangle(this.startX,this.startY,t,n,o,r)}onDrawEnd(t,n,o,r){return this.restorePreviewData(o),this.drawRectangle(this.startX,this.startY,t,n,o,r)}drawRectangle(t,n,o,r,i,a){const l=i.length,u=i[0].length,c=a.colorCode||0,h=a.shapeMode||this.getOption("shapeMode")||"fill";let d=!1;const f=Math.max(0,Math.min(t,o)),m=Math.min(u-1,Math.max(t,o)),p=Math.max(0,Math.min(n,r)),y=Math.min(l-1,Math.max(n,r));if(h==="fill")for(let g=p;g<=y;g++)for(let v=f;v<=m;v++)this.respectsSelection()&&!this.isInSelection(v,g)||i[g][v]!==c&&(i[g][v]=c,d=!0);else{for(let g=f;g<=m;g++)this.isInSelection(g,p)&&i[p][g]!==c&&(i[p][g]=c,d=!0),this.isInSelection(g,y)&&i[y][g]!==c&&(i[y][g]=c,d=!0);for(let g=p;g<=y;g++)this.isInSelection(f,g)&&i[g][f]!==c&&(i[g][f]=c,d=!0),this.isInSelection(m,g)&&i[g][m]!==c&&(i[g][m]=c,d=!0)}return d}}class Ja extends Z{static CONFIG={id:"ellipse",name:"Ellipse",icon:"circle",shortcut:"O",cursor:"crosshair",hasSizeOption:!1,hasShapeOption:!0,description:"Draw circles/ellipses",category:"shape"};needsPreview(){return!0}onDrawStart(t,n,o,r){return!1}onDrawContinue(t,n,o,r){return this.restorePreviewData(o),this.drawEllipse(this.startX,this.startY,t,n,o,r)}onDrawEnd(t,n,o,r){return this.restorePreviewData(o),this.drawEllipse(this.startX,this.startY,t,n,o,r)}drawEllipse(t,n,o,r,i,a){const l=i.length,u=i[0].length,c=a.colorCode||0,h=a.shapeMode||this.getOption("shapeMode")||"fill";let d=!1;const f=Math.floor((t+o)/2),m=Math.floor((n+r)/2),p=Math.abs(o-t)/2,y=Math.abs(r-n)/2;if(h==="fill")for(let g=Math.floor(m-y);g<=Math.ceil(m+y);g++)for(let v=Math.floor(f-p);v<=Math.ceil(f+p);v++){if(v<0||v>=u||g<0||g>=l)continue;const D=(v-f)/p,j=(g-m)/y;if(D*D+j*j<=1){if(this.respectsSelection()&&!this.isInSelection(v,g))continue;i[g][v]!==c&&(i[g][v]=c,d=!0)}}else for(let g=0;g<360;g+=1){const v=g*Math.PI/180,D=Math.round(f+p*Math.cos(v)),j=Math.round(m+y*Math.sin(v));if(D>=0&&D<u&&j>=0&&j<l){if(this.respectsSelection()&&!this.isInSelection(D,j))continue;i[j][D]!==c&&(i[j][D]=c,d=!0)}}return d}}class Qa extends Z{static CONFIG={id:"fill",name:"Fill",icon:"format_color_fill",shortcut:"F",cursor:"crosshair",hasSizeOption:!1,hasShapeOption:!1,description:"Flood fill",category:"drawing"};onDrawStart(t,n,o,r){return!1}onDrawContinue(t,n,o,r){return!1}onDrawEnd(t,n,o,r){return this.floodFill(t,n,o,r)}floodFill(t,n,o,r){const i=o.length,a=o[0].length,l=r.colorCode||0;if(t<0||t>=a||n<0||n>=i)return!1;if(this.respectsSelection()&&!this.isInSelection(t,n))return this.logger.warn?.("Fill tool: clicked outside selection"),!1;const u=o[n][t];if(u===l)return!1;const c=[[t,n]],h=new Set;let d=!1,f=0;const m=a*i;for(;c.length>0&&f<m;){f++;const[p,y]=c.pop(),g=`${p},${y}`;h.has(g)||p<0||p>=a||y<0||y>=i||o[y][p]===u&&(this.respectsSelection()&&!this.isInSelection(p,y)||(o[y][p]=l,h.add(g),d=!0,c.push([p+1,y]),c.push([p-1,y]),c.push([p,y+1]),c.push([p,y-1])))}return f>=m&&this.logger.warn?.("Flood fill reached iteration limit"),d}}class es extends Z{static CONFIG={id:"select",name:"Select",icon:"select_all",shortcut:"M",cursor:"crosshair",hasSizeOption:!1,hasShapeOption:!1,description:"Rectangular selection",category:"selection"};constructor(){super(),this.tempSelection=null}respectsSelection(){return!1}onDrawStart(t,n,o,r){return this.tempSelection={x1:t,y1:n,x2:t,y2:n},!1}onDrawContinue(t,n,o,r){return this.tempSelection&&(this.tempSelection.x2=t,this.tempSelection.y2=n),!1}onDrawEnd(t,n,o,r){if(this.tempSelection){const i={x1:Math.min(this.tempSelection.x1,t),y1:Math.min(this.tempSelection.y1,n),x2:Math.max(this.tempSelection.x1,t),y2:Math.max(this.tempSelection.y1,n)};this.setSelection(i),this.tempSelection=null,r.onSelectionChange&&r.onSelectionChange(i)}return!1}onDrawCancel(){this.tempSelection=null}getSelectionData(){if(this.tempSelection){const t=Math.min(this.tempSelection.x1,this.tempSelection.x2),n=Math.min(this.tempSelection.y1,this.tempSelection.y2),o=Math.max(this.tempSelection.x1,this.tempSelection.x2),r=Math.max(this.tempSelection.y1,this.tempSelection.y2);return{active:!0,isDrawing:!0,x1:t,y1:n,x2:o,y2:r}}else if(this.selectionActive&&this.selectionBounds)return{active:!0,isDrawing:!1,...this.selectionBounds};return null}getSelectedPixels(t){if(!this.selectionActive||!this.selectionBounds)return null;const{x1:n,y1:o,x2:r,y2:i}=this.selectionBounds,a=[];for(let l=o;l<=i;l++){const u=[];for(let c=n;c<=r;c++)l>=0&&l<t.length&&c>=0&&c<t[0].length?u.push(t[l][c]):u.push(0);a.push(u)}return a}}class ts extends Z{static CONFIG={id:"magicWand",name:"Magic Wand",icon:"auto_fix_high",shortcut:"W",cursor:"crosshair",hasSizeOption:!1,hasShapeOption:!1,description:"Select by color",category:"selection"};respectsSelection(){return!1}onDrawStart(t,n,o,r){return!1}onDrawContinue(t,n,o,r){return!1}onDrawEnd(t,n,o,r){return this.selectByColor(t,n,o,r)}selectByColor(t,n,o,r){const i=o.length,a=o[0].length;if(t<0||t>=a||n<0||n>=i)return!1;const l=o[n][t],u=[],c=[[t,n]],h=new Set;for(;c.length>0;){const[g,v]=c.pop(),D=`${g},${v}`;h.has(D)||g<0||g>=a||v<0||v>=i||o[v][g]===l&&(h.add(D),u.push([g,v]),c.push([g+1,v]),c.push([g-1,v]),c.push([g,v+1]),c.push([g,v-1]))}if(u.length===0)return this.clearSelection(),!1;let d=a,f=i,m=0,p=0;u.forEach(([g,v])=>{d=Math.min(d,g),f=Math.min(f,v),m=Math.max(m,g),p=Math.max(p,v)});const y={x1:d,y1:f,x2:m,y2:p};return this.setSelection(y),r.onSelectionChange&&r.onSelectionChange(y),this.logger.info?.(`Magic wand selected ${u.length} pixels`),!1}}class ns extends Z{static CONFIG={id:"move",name:"Move",icon:"open_with",shortcut:"V",cursor:"move",hasSizeOption:!1,hasShapeOption:!1,description:"Move selected content",category:"navigation"};constructor(){super(),this.isMoving=!1,this.selectionData=null,this.originalSelectionBounds=null,this.currentOffset={x:0,y:0}}needsPreview(){return!0}getPreviewData(){return!this.isMoving||!this.selectionData?null:{pixelData:this.selectionData,x:this.originalSelectionBounds.x1+this.currentOffset.x,y:this.originalSelectionBounds.y1+this.currentOffset.y}}onDrawStart(t,n,o,r){if(!this.selectionActive||!this.selectionBounds)return this.logger.info?.("MoveTool: No selection active, nothing to move."),!1;this.isMoving=!0,this.originalSelectionBounds={...this.selectionBounds},this.currentOffset={x:0,y:0};const{x1:i,y1:a,x2:l,y2:u}=this.originalSelectionBounds,c=l-i+1,h=u-a+1;this.selectionData=[];for(let d=0;d<h;d++){this.selectionData[d]=[];for(let f=0;f<c;f++)this.selectionData[d][f]=o[a+d][i+f]}for(let d=a;d<=u;d++)for(let f=i;f<=l;f++)o[d][f]=0;return!0}onDrawContinue(t,n,o,r){return this.isMoving&&(this.currentOffset.x=t-this.startX,this.currentOffset.y=n-this.startY),!1}onDrawEnd(t,n,o,r){if(!this.isMoving)return!1;const i=this.originalSelectionBounds.x1+this.currentOffset.x,a=this.originalSelectionBounds.y1+this.currentOffset.y,l=this.selectionData.length,u=this.selectionData[0].length,c=o.length,h=o[0].length;for(let f=0;f<l;f++)for(let m=0;m<u;m++){const p=i+m,y=a+f;p>=0&&p<h&&y>=0&&y<c&&this.selectionData[f][m]!==0&&(o[y][p]=this.selectionData[f][m])}const d={x1:i,y1:a,x2:i+u-1,y2:a+l-1};return this.setSelection(d),x.emit(x.Events.SELECTION_CHANGED,{bounds:d}),this.resetState(),!0}onDrawCancel(){if(this.isMoving){const{x1:t,y1:n}=this.originalSelectionBounds,o=this.selectionData.length,r=this.selectionData[0].length;for(let i=0;i<o;i++)for(let a=0;a<r;a++)n+i>=0&&n+i<this.pixelData.length&&t+a>=0&&t+a<this.pixelData[0].length&&(this.pixelData[n+i][t+a]=this.selectionData[i][a])}this.resetState()}resetState(){this.isMoving=!1,this.selectionData=null,this.originalSelectionBounds=null,this.currentOffset={x:0,y:0}}}class os extends Z{static CONFIG={id:"hand",name:"Hand",icon:"pan_tool",shortcut:"H",cursor:"grab",hasSizeOption:!1,hasShapeOption:!1,description:"Pan canvas",category:"navigation"};constructor(){super(),this.viewportModule=null}init(){super.init()}activate(){super.activate(),this.updateCursor("grab")}respectsSelection(){return!1}onDrawStart(t,n,o,r){return this.updateCursor("grabbing"),this.viewportModule&&this.viewportModule.startPan&&this.viewportModule.startPan(t,n),!1}onDrawContinue(t,n,o,r){return this.viewportModule&&this.viewportModule.continuePan&&this.viewportModule.continuePan(t,n),!1}onDrawEnd(t,n,o,r){return this.updateCursor("grab"),this.viewportModule&&this.viewportModule.endPan&&this.viewportModule.endPan(),!1}onDrawCancel(){this.updateCursor("grab")}updateCursor(t){const n=document.querySelector(".canvas-container");n&&(n.style.cursor=t)}getCursor(){return this.isDrawing?"grabbing":"grab"}}let an=!1,Le=null,sn=null;async function rs(){if(an){s.warn("Application already initialized.");return}try{s.info("Inline.px initializing..."),Le=await Mt.loadConstants(),Ue.init(Le),await is(),ss(),ds(),an=!0,s.info("Inline.px ready!"),x.emit("app:ready")}catch(e){s.error("Application initialization failed",e),x.emit("app:error",e),alert(`Critical error during initialization: ${e.message}. The app may not function correctly.`)}}async function is(){B.init(),await ne.init("colorPalette",gs);const{defaultWidth:e,defaultHeight:t}=Le.canvas;await C.init("pixelCanvas",e,t,ms),await as(),oe.init(),ie.init(),rt.init(),Oe.init({onHistoryChange:ps}),s.info("Core systems initialized")}async function as(){const e=[Wa,ja,Va,Ka,Za,Ja,Qa,es,ts,ns,os];S.init({onToolChange:fs,onToolOptionChange:hs,sharedOptions:{brushSize:Le.tools.defaultBrushSize,shapeMode:Le.tools.defaultShapeMode,colorCode:1}});const t=S.registerTools(e);s.info(`Registered ${t} tools`),S.setCurrentTool("brush")}function ss(){ls(),cs(),us(),pe(),pt()}function ls(){const e=document.getElementById("toolbox");if(!e)return;e.innerHTML="",S.getAllTools().forEach(n=>{const o=document.createElement("button");o.className="tool-btn",o.dataset.tool=n.id,o.title=`${n.name} (${n.shortcut})`,n.id===S.getCurrentToolId()&&o.classList.add("active"),o.innerHTML=`<span class="material-symbols-outlined tool-icon">${n.icon}</span><span class="tool-label">${n.name}</span><span class="tool-shortcut">${n.shortcut}</span>`,o.addEventListener("click",()=>S.setCurrentTool(n.id)),e.appendChild(o)}),s.debug("Toolbox setup complete")}function cs(){J("newBtn",Zn),J("saveBtn",Jn),J("loadBtn",Qn),J("undoBtn",eo),J("redoBtn",Ot),J("exportFileBtn",vs),J("importStringBtn",ys),J("clearBtn",Cs),J("copyLiveStringBtn",bs)}function us(){document.querySelectorAll(".tool-size-btn").forEach(e=>{e.addEventListener("click",()=>{const t=parseInt(e.dataset.size);S.setToolOption("brushSize",t),document.querySelectorAll(".tool-size-btn").forEach(n=>n.classList.remove("active")),e.classList.add("active")})}),document.querySelectorAll(".tool-mode-btn").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.mode;S.setToolOption("shapeMode",t),document.querySelectorAll(".tool-mode-btn").forEach(n=>n.classList.remove("active")),e.classList.add("active")})}),document.querySelectorAll(".preset-btn").forEach(e=>{e.addEventListener("click",()=>{const t=parseInt(e.dataset.size);document.getElementById("canvasWidth").value=t,document.getElementById("canvasHeight").value=t,Ct()})}),J("resizeBtn",Ct),["canvasWidth","canvasHeight"].forEach(e=>{const t=document.getElementById(e);t&&(t.addEventListener("keypress",n=>n.key==="Enter"&&Ct()),t.addEventListener("input",pt))})}function ds(){document.addEventListener("keydown",e=>{if(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA")return;const t=e.key.toLowerCase();if(e.key==="Escape"){e.preventDefault(),S.clearSelection();return}if(S&&/^[a-z]$/.test(t)){const n=S.getToolByShortcut(t.toUpperCase());if(n){e.preventDefault(),S.setCurrentTool(n.getId());return}}if(e.ctrlKey||e.metaKey){const n={z:eo,y:Ot,n:Zn,s:Jn,o:Qn};n[t]&&(e.preventDefault(),t==="z"&&e.shiftKey?Ot():n[t]())}})}function fs(e,t){document.querySelectorAll(".tool-btn").forEach(r=>r.classList.toggle("active",r.dataset.tool===e)),document.getElementById("currentToolName").textContent=t.name,document.querySelector(".canvas-container").style.cursor=t.cursor;const n=document.getElementById("brushSizeOption"),o=document.getElementById("shapeModeOption");n.classList.toggle("hidden",!t.hasSizeOption),o.classList.toggle("hidden",!t.hasShapeOption),s.debug(`Tool changed to: ${t.name}`)}function hs(e,t){s.debug(`Tool option changed: ${e} = ${t}`)}function gs(e,t){document.getElementById("currentColorDisplay").style.backgroundColor=t,S.setToolOption("colorCode",e)}function ms(){pe(),oe.markCurrentTabDirty(),clearTimeout(sn),sn=setTimeout(()=>{const e=C.exportToString();Oe.pushState(e,"Paint")},Le.history.debounceTime)}function ps({canUndo:e,canRedo:t,undoCount:n,redoCount:o}){const r=document.getElementById("undoBtn"),i=document.getElementById("redoBtn");r.disabled=!e,r.title=e?`Undo (${n} available)`:"Undo",i.disabled=!t,i.title=t?`Redo (${o} available)`:"Redo"}function pe(){const e=C.exportToString();document.getElementById("liveExportString").textContent=bt.formatDataString(e,50),document.getElementById("stringLength").textContent=e.length}function pt(){const e=parseInt(document.getElementById("canvasWidth")?.value),t=parseInt(document.getElementById("canvasHeight")?.value);document.querySelectorAll(".preset-btn").forEach(n=>{n.classList.toggle("active",e===parseInt(n.dataset.size)&&t===parseInt(n.dataset.size))})}function Zn(){oe.createNewTab()}async function Jn(){let e=oe.getCurrentTab()?.name||$e.getCurrentFileName();const t=C.exportToString();await $e.save(t,e)&&(s.info("Saved successfully"),oe.markCurrentTabClean(),ie.forceSave())}function Qn(){$e.showLoadDialog(e=>{C.importFromString(e.data)&&(oe.setCurrentTabName(e.name),$e.setCurrentFileName(e.name),oe.markCurrentTabClean(),Zt(),pe())})}async function vs(){let e=C.exportToString();const t=$e.getCurrentFileName()||"pixelart",n=await B.exportDialog(e);if(n)switch(n.compress&&(e=W.smartCompress(e).data),n.format){case"copy-string":await Sn.copyWithFeedback(e),await B.alert("Copied!","Pixel art string copied to clipboard.","success");break;case"download-txt":$e.exportAsFile(e,t);break;case"download-png":{const o=t.replace(/\.txt$/,"")+".png";Xa.exportToPNG(n.scale,o),await B.alert("PNG Exported!",`Exported as ${o} at ${n.scale}× scale.`,"success");break}}}function ys(){const e=document.getElementById("importModal"),t=document.getElementById("importTextarea");e&&t&&(t.value="",e.classList.add("flex"),e.classList.remove("hidden"),t.focus())}async function Cs(){await B.confirm("Clear Canvas","Are you sure you want to clear the canvas? This cannot be undone.",{confirmText:"Clear",type:"warning",dangerous:!0})&&(C.clear(),pe())}async function bs(){const e=C.exportToString(),t=document.getElementById("copyLiveStringBtn");await Sn.copyWithFeedback(e,t)}async function Ct(){const e=parseInt(document.getElementById("canvasWidth")?.value),t=parseInt(document.getElementById("canvasHeight")?.value),n=Ue.validateCanvasDimensions(e,t);if(!n.valid){await B.alert("Invalid Size",n.error,"warning");return}C.hasContent()&&!await B.confirm("Resize Canvas","Resizing may crop or add empty space to your artwork. Continue?",{confirmText:"Resize",type:"warning"})||C.resize(e,t)&&(pe(),pt(),rt&&rt.updateCanvasSize())}function eo(){if(!Oe.canUndo())return s.debug("Nothing to undo");const e=C.exportToString(),t=Oe.undo(e);t&&(C.importFromString(t),Zt(),pe(),s.info("Undo performed"))}function Ot(){if(!Oe.canRedo())return s.debug("Nothing to redo");const e=C.exportToString(),t=Oe.redo(e);t&&(C.importFromString(t),Zt(),pe(),s.info("Redo performed"))}function Zt(){const{width:e,height:t}=C.getDimensions();document.getElementById("canvasWidth").value=e,document.getElementById("canvasHeight").value=t,pt()}function J(e,t){const n=document.getElementById(e);n&&n.addEventListener("click",t)}rs();</script>
  <style rel="stylesheet" crossorigin>:root{--primary-color: #4CAF50;--primary-hover: #45a049;--primary-active: #3d8b40;--secondary-color: #2196F3;--secondary-hover: #1976D2;--danger-color: #f44336;--danger-hover: #da190b;--success-color: #4CAF50;--warning-color: #FFC107;--info-color: #2196F3;--app-bg: #0d0d0d;--workspace-bg: #1a1a1a;--panel-bg: #252525;--surface-bg: #2a2a2a;--elevated-bg: #333333;--hover-bg: #3a3a3a;--border-color: #404040;--border-light: #4a4a4a;--border-dark: #2a2a2a;--border-accent: #555555;--text-primary: #ffffff;--text-secondary: #b0b0b0;--text-muted: #808080;--text-disabled: #606060;--shadow-sm: 0 1px 3px rgba(0, 0, 0, .5);--shadow-md: 0 2px 6px rgba(0, 0, 0, .6);--shadow-lg: 0 4px 12px rgba(0, 0, 0, .7);--shadow-xl: 0 8px 24px rgba(0, 0, 0, .8);--spacing-xs: 4px;--spacing-sm: 8px;--spacing-md: 12px;--spacing-lg: 16px;--spacing-xl: 24px;--spacing-2xl: 32px;--spacing-3xl: 48px;--radius-sm: 3px;--radius-md: 4px;--radius-lg: 6px;--radius-xl: 8px;--toolbox-width: 80px;--properties-width: 280px;--menu-bar-height: 48px;--info-bar-height: 36px;--font-family: "Pixelify Sans", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Inter", sans-serif;--font-mono: "SF Mono", "Monaco", "Cascadia Code", "Courier New", monospace;--font-size-xs: 10px;--font-size-sm: 11px;--font-size-base: 12px;--font-size-md: 13px;--font-size-lg: 14px;--font-size-xl: 16px;--font-size-2xl: 18px;--transition-fast: .1s ease;--transition-normal: .2s ease;--transition-slow: .3s ease;--z-base: 1;--z-dropdown: 100;--z-sticky: 200;--z-modal-backdrop: 900;--z-modal: 1000;--z-tooltip: 1100}*{margin:0;padding:0;box-sizing:border-box}html{font-size:16px}body{font-family:var(--font-family);font-size:var(--font-size-base);background:var(--app-bg);color:var(--text-primary);line-height:1.5;overflow:hidden;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}button{font-family:inherit;cursor:pointer;border:none;background:none;color:inherit;font-size:inherit}input,textarea,select{font-family:inherit;font-size:inherit;color:inherit}h1,h2,h3,h4,h5,h6{font-weight:600;line-height:1.2}code{font-family:var(--font-mono)}::-webkit-scrollbar{width:10px;height:10px}::-webkit-scrollbar-track{background:var(--surface-bg)}::-webkit-scrollbar-thumb{background:var(--border-color);border-radius:var(--radius-sm)}::-webkit-scrollbar-thumb:hover{background:var(--border-light)}::selection{background:var(--primary-color);color:#fff}.hidden{display:none!important}.visible{display:block!important}.flex{display:flex!important}.inline{display:inline!important}.inline-block{display:inline-block!important}.cursor-default{cursor:default!important}.cursor-pointer{cursor:pointer!important}.cursor-grab{cursor:grab!important}.cursor-grabbing{cursor:grabbing!important}.cursor-move{cursor:move!important}.cursor-crosshair{cursor:crosshair!important}.cursor-text{cursor:text!important}.cursor-not-allowed{cursor:not-allowed!important}.opacity-0{opacity:0!important}.opacity-50{opacity:.5!important}.opacity-100{opacity:1!important}.transform-none{transform:none!important}.pointer-events-none{pointer-events:none!important}.pointer-events-auto{pointer-events:auto!important}.overflow-hidden{overflow:hidden!important}.overflow-auto{overflow:auto!important}.overflow-scroll{overflow:scroll!important}.relative{position:relative!important}.absolute{position:absolute!important}.fixed{position:fixed!important}.sticky{position:sticky!important}.z-0{z-index:0!important}.z-10{z-index:10!important}.z-20{z-index:20!important}.z-30{z-index:30!important}.z-40{z-index:40!important}.z-50{z-index:50!important}.w-full{width:100%!important}.h-full{height:100%!important}.w-auto{width:auto!important}.h-auto{height:auto!important}.text-left{text-align:left!important}.text-center{text-align:center!important}.text-right{text-align:right!important}.visible{visibility:visible!important}.invisible{visibility:hidden!important}.material-symbols-outlined{font-family:Material Symbols Outlined;font-weight:400;font-style:normal;font-size:24px;line-height:1;letter-spacing:normal;text-transform:none;display:inline-block;white-space:nowrap;word-wrap:normal;direction:ltr;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;text-rendering:optimizeLegibility;font-feature-settings:"liga"}.tool-icon.material-symbols-outlined{font-size:28px}.menu-btn .material-symbols-outlined{font-size:20px;vertical-align:middle}.dialog-icon.material-symbols-outlined,.export-format-icon.material-symbols-outlined{font-size:32px}.icon-btn .material-symbols-outlined{font-size:18px}.material-symbols-outlined.icon-primary{color:var(--primary-color)}.material-symbols-outlined.icon-success{color:var(--success-color)}.material-symbols-outlined.icon-warning{color:var(--warning-color)}.material-symbols-outlined.icon-danger{color:var(--danger-color)}.material-symbols-outlined.icon-muted{color:var(--text-muted)}.app-container{display:flex;height:100vh;width:100vw;background:var(--app-bg)}.workspace{flex:1;display:flex;flex-direction:column;background:var(--workspace-bg);overflow:hidden}.menu-bar{height:var(--menu-bar-height);background:var(--panel-bg);border-bottom:1px solid var(--border-color);display:flex;align-items:center;padding:0 var(--spacing-md);gap:var(--spacing-md)}.menu-section{display:flex;gap:var(--spacing-xs);align-items:center}.menu-section:not(:last-child):after{content:"";width:1px;height:20px;background:var(--border-color);margin-left:var(--spacing-md)}.info-bar{min-height:var(--info-bar-height);background:var(--surface-bg);border-bottom:1px solid var(--border-color);display:flex;align-items:center;padding:var(--spacing-sm) var(--spacing-md);gap:var(--spacing-lg);font-size:var(--font-size-sm);flex-wrap:wrap}.info-group{display:flex;align-items:center;gap:var(--spacing-sm)}.info-spacer{flex:1;min-width:20px}.info-label{color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px;font-size:var(--font-size-xs);font-weight:600}.info-value{color:var(--text-primary);font-weight:500}.info-value-small{color:var(--text-secondary);font-size:var(--font-size-xs)}.color-indicator{width:20px;height:20px;border:2px solid var(--border-color);border-radius:var(--radius-sm)}.tool-size-buttons,.tool-mode-buttons{display:flex;gap:4px}.tool-size-btn,.tool-mode-btn{padding:3px 8px;background:var(--panel-bg);border:1px solid var(--border-color);border-radius:var(--radius-sm);font-size:var(--font-size-xs);font-weight:600;color:var(--text-secondary);cursor:pointer;transition:all var(--transition-fast);min-width:24px;text-align:center}.tool-size-btn:hover,.tool-mode-btn:hover{background:var(--elevated-bg);border-color:var(--border-light);color:var(--text-primary)}.tool-size-btn.active,.tool-mode-btn.active{background:var(--primary-color);border-color:var(--primary-color);color:#fff}.tool-mode-btn{padding:3px 12px}.canvas-container{flex:1;display:flex;align-items:center;justify-content:center;overflow:auto;padding:var(--spacing-xl);background:var(--workspace-bg)}.canvas-wrapper{display:inline-block;background:var(--surface-bg);padding:var(--spacing-lg);border-radius:var(--radius-lg);box-shadow:var(--shadow-xl);border:1px solid var(--border-color)}#pixelCanvas{display:block;border:2px solid var(--border-light);cursor:crosshair;image-rendering:pixelated;image-rendering:crisp-edges}.export-panel{background:var(--panel-bg);border-top:1px solid var(--border-color);padding:var(--spacing-md)}.export-panel-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--spacing-sm)}.export-panel-header h3{font-size:var(--font-size-md);font-weight:600;color:var(--text-secondary)}.export-content{background:var(--surface-bg);border:1px solid var(--border-color);border-radius:var(--radius-md);padding:var(--spacing-md);margin-bottom:var(--spacing-sm);overflow-x:auto;max-height:80px}.export-code{font-family:var(--font-mono);font-size:var(--font-size-sm);color:var(--primary-color);word-break:break-all;display:block;line-height:1.6}.export-info{display:flex;gap:var(--spacing-xl);font-size:var(--font-size-xs);color:var(--text-muted)}.export-info strong{color:var(--text-secondary)}.toolbox{width:var(--toolbox-width);background:var(--panel-bg);border-right:1px solid var(--border-color);display:flex;flex-direction:column;overflow-y:auto;flex-shrink:0}.toolbox-header{padding:var(--spacing-md);border-bottom:1px solid var(--border-color);background:var(--elevated-bg);flex-shrink:0}.toolbox-header h2{font-size:var(--font-size-sm);font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--text-muted);text-align:center}.toolbox-content{padding:var(--spacing-sm);display:flex;flex-direction:column;gap:var(--spacing-xs);flex:1}.tool-btn{width:100%;aspect-ratio:1;background:var(--surface-bg);border:1px solid var(--border-color);border-radius:var(--radius-md);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;cursor:pointer;transition:all var(--transition-fast);position:relative;padding:var(--spacing-xs)}.tool-btn:hover{background:var(--hover-bg);border-color:var(--border-light);transform:translateY(-1px)}.tool-btn:active{transform:translateY(0)}.tool-btn.active{background:var(--primary-color);border-color:var(--primary-color);color:#fff}.tool-btn.active:hover{background:var(--primary-hover)}.tool-icon{font-size:clamp(20px,4vw,28px);line-height:1;display:block;flex-shrink:0}.tool-label{font-size:clamp(8px,1.2vw,11px);font-weight:600;text-align:center;line-height:1.1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;width:100%}.tool-shortcut{position:absolute;bottom:3%;right:5%;font-size:clamp(7px,1vw,9px);opacity:.5;font-weight:700;line-height:1}.tool-btn.active .tool-shortcut{opacity:.9}.properties-panel{width:var(--properties-width);background:var(--panel-bg);border-left:1px solid var(--border-color);display:flex;flex-direction:column;overflow-y:auto}.panel-section{border-bottom:1px solid var(--border-color);padding:var(--spacing-md)}.panel-title{font-size:var(--font-size-sm);font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--text-muted);margin-bottom:var(--spacing-md)}.tool-options{display:flex;flex-direction:column;gap:var(--spacing-lg)}.option-group{display:flex;flex-direction:column;gap:var(--spacing-sm)}.option-group label{font-size:var(--font-size-sm);color:var(--text-secondary);font-weight:500}.size-buttons{display:grid;grid-template-columns:repeat(4,1fr);gap:var(--spacing-xs)}.size-btn{padding:var(--spacing-sm);background:var(--surface-bg);border:1px solid var(--border-color);border-radius:var(--radius-md);font-size:var(--font-size-xs);font-weight:600;transition:all var(--transition-fast)}.size-btn:hover{background:var(--hover-bg);border-color:var(--border-light)}.size-btn.active{background:var(--primary-color);border-color:var(--primary-color);color:#fff}.mode-buttons{display:grid;grid-template-columns:1fr 1fr;gap:var(--spacing-xs)}.mode-btn{padding:var(--spacing-sm);background:var(--surface-bg);border:1px solid var(--border-color);border-radius:var(--radius-md);font-size:var(--font-size-sm);font-weight:500;transition:all var(--transition-fast)}.mode-btn:hover{background:var(--hover-bg);border-color:var(--border-light)}.mode-btn.active{background:var(--primary-color);border-color:var(--primary-color);color:#fff}.size-presets{display:grid;grid-template-columns:repeat(2,1fr);gap:var(--spacing-xs);margin-bottom:var(--spacing-md)}.preset-btn{padding:var(--spacing-sm);background:var(--surface-bg);border:1px solid var(--border-color);border-radius:var(--radius-md);font-size:var(--font-size-sm);font-weight:600;transition:all var(--transition-fast)}.preset-btn:hover{background:var(--hover-bg);border-color:var(--border-light)}.preset-btn.active{background:var(--primary-color);border-color:var(--primary-color);color:#fff}.custom-size{display:flex;flex-direction:column;gap:var(--spacing-sm)}.size-input-row{display:flex;align-items:center;gap:var(--spacing-xs)}.size-input-row input{flex:1;padding:var(--spacing-sm);background:var(--surface-bg);border:1px solid var(--border-color);border-radius:var(--radius-md);text-align:center;font-weight:600}.size-input-row input:focus{outline:none;border-color:var(--primary-color)}.size-input-row span{color:var(--text-muted);font-weight:600}.color-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:3px}.color-swatch{aspect-ratio:1;border:2px solid var(--border-color);border-radius:var(--radius-sm);cursor:pointer;transition:all var(--transition-fast);position:relative}.color-swatch:hover{transform:scale(1.15);border-color:var(--border-light);box-shadow:var(--shadow-md);z-index:10}.color-swatch.active{border-color:gold;box-shadow:0 0 8px #ffd70099;transform:scale(1.1);z-index:10}.color-swatch[data-code="0"]{background:repeating-conic-gradient(#666 0% 25%,#444 0% 50%) 50% / 6px 6px}.menu-btn{padding:var(--spacing-sm) var(--spacing-md);background:var(--surface-bg);border:1px solid transparent;border-radius:var(--radius-md);font-size:var(--font-size-sm);font-weight:500;display:flex;align-items:center;gap:var(--spacing-xs);transition:all var(--transition-fast)}.menu-btn:hover{background:var(--hover-bg);border-color:var(--border-color)}.menu-btn:active{transform:scale(.98)}.menu-btn span{font-size:16px}.menu-btn-danger{color:var(--danger-color)}.menu-btn-danger:hover{background:#f443361a;border-color:var(--danger-color)}.btn-primary{width:100%;padding:var(--spacing-sm) var(--spacing-md);background:var(--primary-color);border:1px solid var(--primary-color);border-radius:var(--radius-md);font-size:var(--font-size-sm);font-weight:600;color:#fff;transition:all var(--transition-fast)}.btn-primary:hover{background:var(--primary-hover);border-color:var(--primary-hover)}.btn-primary:active{transform:scale(.98)}.btn-secondary{padding:var(--spacing-sm) var(--spacing-lg);background:var(--surface-bg);border:1px solid var(--border-color);border-radius:var(--radius-md);font-size:var(--font-size-sm);font-weight:500;transition:all var(--transition-fast)}.btn-secondary:hover{background:var(--hover-bg);border-color:var(--border-light)}.icon-btn{padding:var(--spacing-xs);background:var(--surface-bg);border:1px solid var(--border-color);border-radius:var(--radius-md);font-size:16px;transition:all var(--transition-fast)}.icon-btn:hover{background:var(--hover-bg);border-color:var(--primary-color);transform:scale(1.05)}.btn-close{width:32px;height:32px;background:transparent;border:none;border-radius:var(--radius-md);font-size:24px;color:var(--text-secondary);display:flex;align-items:center;justify-content:center;transition:all var(--transition-fast)}.btn-close:hover{background:var(--surface-bg);color:var(--text-primary)}.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:#000000d9;display:flex;justify-content:center;align-items:center;z-index:var(--z-modal);-webkit-backdrop-filter:blur(4px);backdrop-filter:blur(4px)}.modal-content{background:var(--panel-bg);border:1px solid var(--border-color);border-radius:var(--radius-xl);max-width:600px;width:90%;max-height:80vh;display:flex;flex-direction:column;box-shadow:var(--shadow-xl)}.modal-header{display:flex;justify-content:space-between;align-items:center;padding:var(--spacing-lg);border-bottom:1px solid var(--border-color)}.modal-header h2{font-size:var(--font-size-xl);font-weight:600}.modal-body{padding:var(--spacing-lg);overflow-y:auto;flex:1}.modal-body p{margin-bottom:var(--spacing-md);color:var(--text-secondary);font-size:var(--font-size-sm)}.modal-body textarea{width:100%;padding:var(--spacing-md);background:var(--surface-bg);border:1px solid var(--border-color);border-radius:var(--radius-md);font-family:var(--font-mono);font-size:var(--font-size-sm);resize:vertical;min-height:120px}.modal-body textarea:focus{outline:none;border-color:var(--primary-color)}.modal-footer{padding:var(--spacing-lg);border-top:1px solid var(--border-color);display:flex;justify-content:flex-end;gap:var(--spacing-sm)}#fileList{display:flex;flex-direction:column;gap:var(--spacing-sm)}.file-item{display:flex;justify-content:space-between;align-items:center;padding:var(--spacing-md);background:var(--surface-bg);border:1px solid var(--border-color);border-radius:var(--radius-md);transition:all var(--transition-fast)}.file-item:hover{border-color:var(--primary-color);background:var(--hover-bg)}.file-item-info{flex:1}.file-item-name{font-weight:600;margin-bottom:var(--spacing-xs)}.file-item-meta{font-size:var(--font-size-xs);color:var(--text-secondary)}.file-item-actions{display:flex;gap:var(--spacing-xs)}.file-item-actions .btn-secondary,.file-item-actions .btn-primary{padding:var(--spacing-xs) var(--spacing-md);font-size:var(--font-size-xs)}.dialog-overlay{position:fixed;inset:0;background:#000000bf;-webkit-backdrop-filter:blur(4px);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;z-index:var(--z-modal);animation:fadeIn .2s ease}@keyframes fadeIn{0%{opacity:0}to{opacity:1}}.dialog-content{background:var(--panel-bg);border:1px solid var(--border-color);border-radius:var(--radius-lg);box-shadow:var(--shadow-xl);min-width:400px;max-width:600px;max-height:80vh;overflow:hidden;display:flex;flex-direction:column;opacity:0;transform:scale(.9) translateY(-20px);transition:all .2s ease}.dialog-content.dialog-show{opacity:1;transform:scale(1) translateY(0)}.dialog-content.dialog-info .dialog-icon{color:var(--info-color)}.dialog-content.dialog-success .dialog-icon{color:var(--success-color)}.dialog-content.dialog-warning .dialog-icon{color:var(--warning-color)}.dialog-content.dialog-error .dialog-icon{color:var(--danger-color)}.dialog-header{display:flex;align-items:center;gap:var(--spacing-md);padding:var(--spacing-lg);border-bottom:1px solid var(--border-color)}.dialog-icon{font-size:32px;line-height:1}.dialog-title{font-size:var(--font-size-xl);font-weight:600;color:var(--text-primary);margin:0}.dialog-body{padding:var(--spacing-xl);overflow-y:auto}.dialog-message{color:var(--text-secondary);font-size:var(--font-size-md);line-height:1.6;margin:0 0 var(--spacing-md) 0}.dialog-input{width:100%;padding:var(--spacing-md);background:var(--surface-bg);border:1px solid var(--border-color);border-radius:var(--radius-md);color:var(--text-primary);font-size:var(--font-size-md);font-family:var(--font-family);margin-top:var(--spacing-md);transition:all var(--transition-fast)}.dialog-input:focus{outline:none;border-color:var(--primary-color);background:var(--elevated-bg)}.export-options{display:flex;flex-direction:column;gap:var(--spacing-lg)}.export-preview{background:var(--surface-bg);border:1px solid var(--border-color);border-radius:var(--radius-md);padding:var(--spacing-md)}.export-preview-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--spacing-sm);font-size:var(--font-size-sm)}.export-preview-size{color:var(--text-muted);font-weight:400}.export-code-preview{display:block;font-family:var(--font-mono);font-size:var(--font-size-sm);color:var(--primary-color);word-break:break-all;line-height:1.6;max-height:60px;overflow-y:auto}.export-option-group{background:var(--surface-bg);border:1px solid var(--border-color);border-radius:var(--radius-md);padding:var(--spacing-md)}.export-checkbox-label{display:flex;align-items:center;gap:var(--spacing-sm);cursor:pointer;font-size:var(--font-size-md);color:var(--text-primary)}.export-checkbox{width:18px;height:18px;cursor:pointer}.export-savings{margin-left:auto;color:var(--success-color);font-weight:600;font-size:var(--font-size-sm)}.export-savings.export-warning{color:#e2a04a}.export-option-info{margin-top:var(--spacing-sm);margin-left:26px;font-size:var(--font-size-xs);color:var(--text-muted);line-height:1.5}.compression-preview{display:grid;grid-template-columns:1fr auto 1fr;gap:var(--spacing-md);margin-top:var(--spacing-md);padding-top:var(--spacing-md);border-top:1px solid var(--border-color)}.compression-preview-section{display:flex;flex-direction:column;gap:var(--spacing-xs);min-width:0}.compression-preview-label{display:flex;justify-content:space-between;align-items:center;font-size:var(--font-size-xs)}.compression-preview-size{color:var(--text-muted);font-weight:400}.compression-highlight{color:var(--success-color);font-weight:600}.compression-preview-code{display:block;font-family:var(--font-mono);font-size:var(--font-size-xs);color:var(--text-secondary);background:var(--panel-bg);padding:var(--spacing-xs) var(--spacing-sm);border-radius:var(--radius-sm);word-break:break-all;line-height:1.5;max-height:60px;overflow-y:auto}.compression-preview-arrow{display:flex;align-items:center;justify-content:center;font-size:var(--font-size-xl);color:var(--success-color);font-weight:700}.export-format-section{display:flex;flex-direction:column;gap:var(--spacing-sm)}.export-format-buttons{display:grid;grid-template-columns:repeat(3,1fr);gap:var(--spacing-sm)}.export-format-btn{display:flex;flex-direction:column;align-items:center;gap:var(--spacing-xs);padding:var(--spacing-md);background:var(--surface-bg);border:2px solid var(--border-color);border-radius:var(--radius-md);cursor:pointer;transition:all var(--transition-fast);min-height:90px}.export-format-btn:hover{background:var(--elevated-bg);border-color:var(--border-light)}.export-format-btn.selected{background:var(--primary-color);border-color:var(--primary-color)}.export-format-btn.selected .export-format-label,.export-format-btn.selected .export-format-desc{color:#fff}.export-format-icon{font-size:32px;line-height:1}.export-format-label{font-weight:600;font-size:var(--font-size-md);color:var(--text-primary)}.export-format-desc{font-size:var(--font-size-xs);color:var(--text-muted)}.png-scale-options{display:flex;flex-direction:column;gap:var(--spacing-sm);padding:var(--spacing-md);background:var(--surface-bg);border:1px solid var(--border-color);border-radius:var(--radius-md)}.png-scale-buttons{display:flex;gap:var(--spacing-xs)}.png-scale-btn{flex:1;padding:var(--spacing-sm) var(--spacing-md);background:var(--panel-bg);border:1px solid var(--border-color);border-radius:var(--radius-sm);color:var(--text-secondary);font-weight:600;cursor:pointer;transition:all var(--transition-fast)}.png-scale-btn:hover{background:var(--elevated-bg);color:var(--text-primary)}.png-scale-btn.active{background:var(--primary-color);border-color:var(--primary-color);color:#fff}.export-info-small{font-size:var(--font-size-xs);color:var(--text-muted)}.export-info-small strong{color:var(--text-secondary)}.dialog-footer{display:flex;gap:var(--spacing-sm);padding:var(--spacing-lg);border-top:1px solid var(--border-color);background:var(--surface-bg);justify-content:flex-end}.dialog-btn{padding:var(--spacing-sm) var(--spacing-lg);border-radius:var(--radius-md);font-size:var(--font-size-md);font-weight:600;cursor:pointer;transition:all var(--transition-fast);border:none;min-width:80px}.dialog-btn-primary{background:var(--primary-color);color:#fff}.dialog-btn-primary:hover{background:var(--primary-hover);transform:translateY(-1px)}.dialog-btn-primary:active{background:var(--primary-active);transform:translateY(0)}.dialog-btn-secondary{background:var(--elevated-bg);color:var(--text-secondary);border:1px solid var(--border-color)}.dialog-btn-secondary:hover{background:var(--hover-bg);color:var(--text-primary)}.dialog-btn-secondary:active{background:var(--surface-bg)}.dialog-btn-danger{background:var(--danger-color);color:#fff}.dialog-btn-danger:hover{background:var(--danger-hover);transform:translateY(-1px)}.dialog-btn-danger:active{background:#c62828;transform:translateY(0)}@media(max-width:600px){.dialog-content{min-width:90vw;max-width:90vw}.dialog-footer{flex-direction:column-reverse}.dialog-btn{width:100%}}.tab-bar{background:var(--panel-bg);border-bottom:1px solid var(--border-color);display:flex;align-items:center;height:36px;overflow-x:auto;overflow-y:hidden}.tab-list{display:flex;flex:1;align-items:center;height:100%;overflow-x:auto;overflow-y:hidden;scrollbar-width:thin}.tab-list::-webkit-scrollbar{height:4px}.tab-list::-webkit-scrollbar-thumb{background:var(--border-color);border-radius:2px}.tab{display:flex;align-items:center;gap:8px;padding:8px 16px;background:var(--surface-bg);border-right:1px solid var(--border-color);cursor:pointer;-webkit-user-select:none;user-select:none;transition:background var(--transition-fast);min-width:120px;max-width:200px;height:100%;position:relative}.tab:hover{background:var(--elevated-bg)}.tab.active{background:var(--workspace-bg);border-bottom:2px solid var(--primary-color)}.tab-name{flex:1;font-size:var(--font-size-sm);font-weight:500;color:var(--text-secondary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.tab.active .tab-name{color:var(--text-primary)}.tab-dirty{color:var(--primary-color);font-size:14px;line-height:1}.tab-close{display:flex;align-items:center;justify-content:center;width:20px;height:20px;background:transparent;border:none;border-radius:var(--radius-sm);color:var(--text-muted);font-size:18px;line-height:1;cursor:pointer;padding:0;opacity:0;transition:all var(--transition-fast)}.tab:hover .tab-close{opacity:1}.tab-close:hover{background:var(--danger-color);color:#fff}.tab-new-btn{display:flex;align-items:center;justify-content:center;width:36px;height:36px;background:transparent;border:none;border-left:1px solid var(--border-color);color:var(--text-secondary);font-size:20px;cursor:pointer;transition:all var(--transition-fast);flex-shrink:0}.tab-new-btn:hover{background:var(--elevated-bg);color:var(--text-primary)}.tab-new-btn:active{background:var(--surface-bg)}.autosave-indicator{display:flex;align-items:center;gap:var(--spacing-sm);padding:4px 12px;background:var(--surface-bg);border:1px solid var(--border-color);border-radius:var(--radius-md);font-size:var(--font-size-xs);margin-left:auto;transition:all var(--transition-normal)}.autosave-status{display:flex;align-items:center;gap:6px;font-weight:600}.autosave-icon{font-size:14px;display:inline-block;transition:all var(--transition-fast)}.autosave-text{color:var(--text-secondary)}.autosave-time{color:var(--text-muted);font-size:var(--font-size-xs);margin-left:4px}.autosave-indicator.status-saved{border-color:var(--success-color)}.autosave-indicator.status-saved .autosave-icon,.autosave-indicator.status-saved .autosave-text{color:var(--success-color)}.autosave-indicator.status-saving{border-color:var(--primary-color)}.autosave-indicator.status-saving .autosave-icon{color:var(--primary-color);animation:spin 1s linear infinite}.autosave-indicator.status-saving .autosave-text{color:var(--primary-color)}.autosave-indicator.status-unsaved{border-color:var(--warning-color)}.autosave-indicator.status-unsaved .autosave-icon,.autosave-indicator.status-unsaved .autosave-text{color:var(--warning-color)}.autosave-indicator.status-error{border-color:var(--danger-color)}.autosave-indicator.status-error .autosave-icon,.autosave-indicator.status-error .autosave-text{color:var(--danger-color)}@keyframes spin{0%{transform:rotate(0)}to{transform:rotate(360deg)}}.zoom-controls{display:flex;align-items:center;gap:var(--spacing-xs)}.zoom-btn{display:flex;align-items:center;justify-content:center;width:28px;height:28px;background:var(--panel-bg);border:1px solid var(--border-color);border-radius:var(--radius-sm);color:var(--text-secondary);font-size:16px;font-weight:600;cursor:pointer;transition:all var(--transition-fast);line-height:1;padding:0}.zoom-btn:hover{background:var(--elevated-bg);border-color:var(--border-light);color:var(--text-primary)}.zoom-btn:active{background:var(--surface-bg);transform:scale(.95)}.zoom-select{min-width:80px;padding:4px 8px;background:var(--panel-bg);border:1px solid var(--border-color);border-radius:var(--radius-sm);color:var(--text-secondary);font-size:var(--font-size-sm);font-weight:600;cursor:pointer;transition:all var(--transition-fast)}.zoom-select:hover{background:var(--elevated-bg);border-color:var(--border-light)}.zoom-select:focus{outline:none;border-color:var(--primary-color)}.canvas-wrapper{transition:transform .2s ease-out;will-change:transform}.canvas-container{position:relative;overflow:hidden}.canvas-container.panning{cursor:grabbing!important}@media(max-width:1024px){:root{--toolbox-width: 70px;--properties-width: 240px}.color-grid{grid-template-columns:repeat(6,1fr)}}@media(max-width:768px){.app-container{flex-direction:column}.toolbox{width:100%;height:auto;border-right:none;border-bottom:1px solid var(--border-color)}.toolbox-content{display:flex;overflow-x:auto;padding:var(--spacing-sm)}.tool-btn{min-width:60px;flex-shrink:0}.properties-panel{width:100%;max-height:40vh;border-left:none;border-top:1px solid var(--border-color)}.menu-bar{flex-wrap:wrap;height:auto;min-height:var(--menu-bar-height)}.menu-section:after{display:none}.info-bar{flex-wrap:wrap;height:auto;min-height:var(--info-bar-height);gap:var(--spacing-md)}.canvas-container{padding:var(--spacing-md)}.export-panel{padding:var(--spacing-sm)}.color-grid{grid-template-columns:repeat(8,1fr)}}@media(max-width:480px){.menu-btn span{display:none}.menu-btn{padding:var(--spacing-sm)}.info-bar{font-size:var(--font-size-xs)}.info-value-small{display:none}.size-presets{grid-template-columns:repeat(4,1fr)}.color-grid{grid-template-columns:repeat(6,1fr);gap:2px}.export-content{max-height:60px}.export-code{font-size:10px}}@media(hover:none)and (pointer:coarse){.menu-btn,.tool-btn,.size-btn,.mode-btn,.preset-btn{min-height:44px;min-width:44px}.color-swatch{min-height:32px;min-width:32px}}</style>
</head>
<body>
    <div class="app-container">
        <!-- Left Toolbox -->
        <aside class="toolbox">
            <div class="toolbox-header">
                <h2>Tools</h2>
            </div>
            <div class="toolbox-content" id="toolbox">
                <!-- Tools generated dynamically -->
            </div>
        </aside>

        <!-- Center Canvas Area -->
        <main class="workspace">
            <!-- Top Menu Bar -->
            <div class="menu-bar">
                <div class="menu-section">
                    <button id="newBtn" class="menu-btn" title="New (Ctrl+N)">
                        <span class="material-symbols-outlined">description</span> New
                    </button>
                    <button id="saveBtn" class="menu-btn" title="Save (Ctrl+S)">
                        <span class="material-symbols-outlined">save</span> Save
                    </button>
                    <button id="loadBtn" class="menu-btn" title="Load (Ctrl+O)">
                        <span class="material-symbols-outlined">folder_open</span> Load
                    </button>
                </div>
                <div class="menu-section">
                    <button id="undoBtn" class="menu-btn" title="Undo (Ctrl+Z)" disabled>
                        <span class="material-symbols-outlined">undo</span> Undo
                    </button>
                    <button id="redoBtn" class="menu-btn" title="Redo (Ctrl+Y)" disabled>
                        <span class="material-symbols-outlined">redo</span> Redo
                    </button>
                </div>
                <div class="menu-section">
                    <button id="exportFileBtn" class="menu-btn" title="Export">
                        <span class="material-symbols-outlined">download</span> Export
                    </button>
                    <button id="importStringBtn" class="menu-btn" title="Import">
                        <span class="material-symbols-outlined">upload</span> Import
                    </button>
                </div>
                <div class="menu-section">
                    <button id="clearBtn" class="menu-btn menu-btn-danger" title="Clear">
                        <span class="material-symbols-outlined">delete</span> Clear
                    </button>
                </div>
            </div>

            <!-- Canvas Info Bar with Tool Options -->
            <div class="info-bar">
                <div class="info-group">
                    <span class="info-label">Tool:</span>
                    <span id="currentToolName" class="info-value">Brush</span>
                </div>

                <!-- Tool Options (shown dynamically) -->
                <div class="info-group" id="brushSizeOption" style="display: none;">
                    <span class="info-label">Size:</span>
                    <div class="tool-size-buttons">
                        <button class="tool-size-btn active" data-size="1">1</button>
                        <button class="tool-size-btn" data-size="2">2</button>
                        <button class="tool-size-btn" data-size="3">3</button>
                        <button class="tool-size-btn" data-size="5">5</button>
                    </div>
                </div>

                <div class="info-group" id="shapeModeOption" style="display: none;">
                    <span class="info-label">Mode:</span>
                    <div class="tool-mode-buttons">
                        <button class="tool-mode-btn active" data-mode="fill">Fill</button>
                        <button class="tool-mode-btn" data-mode="stroke">Stroke</button>
                    </div>
                </div>

                <div class="info-spacer"></div>

                <div class="info-group">
                    <span class="info-label">Size:</span>
                    <span id="canvasSizeDisplay" class="info-value">16×16</span>
                </div>
                <div class="info-group">
                    <span class="info-label">Color:</span>
                    <div id="currentColorDisplay" class="color-indicator"></div>
                    <span id="currentColorCode" class="info-value">1</span>
                </div>
            </div>

            <!-- Canvas Container -->
            <div class="canvas-container">
                <div class="canvas-wrapper">
                    <canvas id="pixelCanvas"></canvas>
                </div>
            </div>

            <!-- Live Export Preview -->
            <div class="export-panel">
                <div class="export-panel-header">
                    <h3>Export String</h3>
                    <button id="copyLiveStringBtn" class="icon-btn" title="Copy">
                        <span class="material-symbols-outlined">content_copy</span>
                    </button>
                </div>
                <div class="export-content">
                    <code id="liveExportString" class="export-code">16x16:0000...</code>
                </div>
                <div class="export-info">
                    <span><strong>Format:</strong> Base64 (64 colors)</span>
                    <span><strong>Length:</strong> <span id="stringLength">0</span> chars</span>
                </div>
            </div>
        </main>

        <!-- Right Properties Panel -->
        <aside class="properties-panel">
            <!-- Canvas Size -->
            <div class="panel-section">
                <h3 class="panel-title">Canvas Size</h3>
                <div class="size-presets">
                    <button class="preset-btn active" data-size="8">8×8</button>
                    <button class="preset-btn" data-size="16">16×16</button>
                    <button class="preset-btn" data-size="32">32×32</button>
                    <button class="preset-btn" data-size="64">64×64</button>
                </div>
                <div class="custom-size">
                    <div class="size-input-row">
                        <input type="number" id="canvasWidth" min="2" max="128" value="8" placeholder="W">
                        <span>×</span>
                        <input type="number" id="canvasHeight" min="2" max="128" value="8" placeholder="H">
                    </div>
                    <button id="resizeBtn" class="btn-primary">Apply</button>
                </div>
            </div>

            <!-- Color Palette -->
            <div class="panel-section">
                <h3 class="panel-title">Color Palette</h3>
                <div id="colorPalette" class="color-grid">
                    <!-- Generated dynamically -->
                </div>
            </div>
        </aside>
    </div>

    <!-- Import Modal -->
    <div class="modal" id="importModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Import from String</h2>
                <button id="closeImportModal" class="btn-close">&times;</button>
            </div>
            <div class="modal-body">
                <p>Paste your Base64 pixel art string (format: WxH:DATA)</p>
                <textarea id="importTextarea" rows="8" placeholder="16x16:123ABC..."></textarea>
            </div>
            <div class="modal-footer">
                <button id="cancelImportBtn" class="btn-secondary">Cancel</button>
                <button id="confirmImportBtn" class="btn-primary">Import</button>
            </div>
        </div>
    </div>

    <!-- File Selection Modal -->
    <div class="modal" id="fileModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Load File</h2>
                <button id="closeModal" class="btn-close">&times;</button>
            </div>
            <div class="modal-body">
                <div id="fileList"></div>
                <p id="noFilesMessage" style="display: none; text-align: center; color: #666;">
                    No saved files found.
                </p>
            </div>
        </div>
    </div>

    <!-- Main Application Entry Point (Bundled by Vite) -->
</body>
</html>
