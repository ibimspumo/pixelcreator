<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Inline.px - Ultra-Compact Pixel Art Editor</title>
    <link rel="icon" type="image/png" href="./favicon-BTGlOP9f.png">

    <!-- Material Symbols Font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <!-- Pixelify Sans Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pixelify+Sans:wght@400..700&display=swap" rel="stylesheet">

  <script type="module" crossorigin>(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))o(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function n(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(i){if(i.ep)return;i.ep=!0;const r=n(i);fetch(i.href,r)}})();const ce={DEBUG:0,INFO:1,WARN:2,ERROR:3};let mn=ce.INFO,pn=!0,Ee=[];const lo=100;function co(e){ce[e]!==void 0&&(mn=ce[e])}function uo(e){pn=e}function Je(e,t,n,o){if(e<mn)return;const i=new Date().toISOString(),r={timestamp:i,level:t,message:n,data:o};if(Ee.push(r),Ee.length>lo&&Ee.shift(),pn){const a=`[${i}] [${t}] ${n}`,l=t.toLowerCase();console[l]?console[l](a,o||""):console.log(a,o||"")}}const s={LOG_LEVELS:ce,setLevel:co,setConsoleEnabled:uo,debug:(e,t=null)=>Je(ce.DEBUG,"DEBUG",e,t),info:(e,t=null)=>Je(ce.INFO,"INFO",e,t),warn:(e,t=null)=>Je(ce.WARN,"WARN",e,t),error:(e,t=null)=>Je(ce.ERROR,"ERROR",e,t),getHistory:()=>[...Ee],clearHistory:()=>{Ee=[]},exportLogs:()=>Ee.map(e=>{let t=`[${e.timestamp}] [${e.level}] ${e.message}`;return e.data&&(t+=` | ${JSON.stringify(e.data)}`),t}).join(`
`)},F={};function vn(e,t){return F[e]||(F[e]=[]),F[e].push(t),s.debug?.(`EventBus: subscribed to "${e}"`),()=>Nt(e,t)}function fo(e,t){const n=(...o)=>{t(...o),Nt(e,n)};return vn(e,n)}function Nt(e,t){if(!F[e])return;const n=F[e].indexOf(t);n>-1&&(F[e].splice(n,1),s.debug?.(`EventBus: unsubscribed from "${e}"`)),F[e].length===0&&delete F[e]}function ho(e,t=null){if(!F[e]){s.debug?.(`EventBus: no listeners for "${e}"`);return}s.debug?.(`EventBus: emitting "${e}"`,t),[...F[e]].forEach(o=>{try{o(t,e)}catch(i){s.error?.(`EventBus: error in listener for "${e}"`,i)}})}const go={TOOL_CHANGED:"tool:changed",TOOL_OPTION_CHANGED:"tool:optionChanged",CANVAS_CHANGED:"canvas:changed",CANVAS_RESIZED:"canvas:resized",CANVAS_CLEARED:"canvas:cleared",SELECTION_CHANGED:"selection:changed",SELECTION_CLEARED:"selection:cleared",COLOR_CHANGED:"color:changed",HISTORY_STATE_ADDED:"history:stateAdded",UNDO_PERFORMED:"history:undo",REDO_PERFORMED:"history:redo",FILE_LOADED:"file:loaded",FILE_SAVED:"file:saved",FILE_EXPORTED:"file:exported",MODAL_OPENED:"ui:modalOpened",MODAL_CLOSED:"ui:modalClosed",APP_READY:"app:ready",APP_ERROR:"app:error"},C={on:vn,once:fo,off:Nt,emit:ho,listenerCount:e=>F[e]?F[e].length:0,getEvents:()=>Object.keys(F),clear:(e=null)=>{e?(delete F[e],s.debug?.(`EventBus: cleared listeners for "${e}"`)):(Object.keys(F).forEach(t=>delete F[t]),s.debug?.("EventBus: cleared all listeners"))},getStats:()=>{const e={totalEvents:Object.keys(F).length,totalListeners:0,events:{}};return Object.keys(F).forEach(t=>{const n=F[t].length;e.totalListeners+=n,e.events[t]=n}),e},Events:go},mo={base64Chars:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz+/",palette:[{index:0,char:"0",color:"transparent",name:"Transparent",category:"special"},{index:1,char:"1",color:"#000000",name:"Black",category:"basic"},{index:2,char:"2",color:"#FFFFFF",name:"White",category:"basic"},{index:3,char:"3",color:"#FF0000",name:"Red",category:"basic"},{index:4,char:"4",color:"#00FF00",name:"Green",category:"basic"},{index:5,char:"5",color:"#0000FF",name:"Blue",category:"basic"},{index:6,char:"6",color:"#FFFF00",name:"Yellow",category:"basic"},{index:7,char:"7",color:"#FF00FF",name:"Magenta",category:"basic"},{index:8,char:"8",color:"#00FFFF",name:"Cyan",category:"basic"},{index:9,char:"9",color:"#1A1A1A",name:"Dark Gray 1",category:"grayscale"},{index:10,char:"A",color:"#333333",name:"Dark Gray 2",category:"grayscale"},{index:11,char:"B",color:"#4D4D4D",name:"Dark Gray 3",category:"grayscale"},{index:12,char:"C",color:"#666666",name:"Gray 1",category:"grayscale"},{index:13,char:"D",color:"#808080",name:"Gray 2",category:"grayscale"},{index:14,char:"E",color:"#999999",name:"Gray 3",category:"grayscale"},{index:15,char:"F",color:"#B3B3B3",name:"Light Gray 1",category:"grayscale"},{index:16,char:"G",color:"#CCCCCC",name:"Light Gray 2",category:"grayscale"},{index:17,char:"H",color:"#8B0000",name:"Dark Red",category:"reds"},{index:18,char:"I",color:"#B22222",name:"Firebrick",category:"reds"},{index:19,char:"J",color:"#DC143C",name:"Crimson",category:"reds"},{index:20,char:"K",color:"#FF4500",name:"Orange Red",category:"reds"},{index:21,char:"L",color:"#FF6347",name:"Tomato",category:"reds"},{index:22,char:"M",color:"#FF7F50",name:"Coral",category:"reds"},{index:23,char:"N",color:"#FFA500",name:"Orange",category:"reds"},{index:24,char:"O",color:"#FFD700",name:"Gold",category:"reds"},{index:25,char:"P",color:"#006400",name:"Dark Green",category:"greens"},{index:26,char:"Q",color:"#008000",name:"Green",category:"greens"},{index:27,char:"R",color:"#228B22",name:"Forest Green",category:"greens"},{index:28,char:"S",color:"#32CD32",name:"Lime Green",category:"greens"},{index:29,char:"T",color:"#7FFF00",name:"Chartreuse",category:"greens"},{index:30,char:"U",color:"#90EE90",name:"Light Green",category:"greens"},{index:31,char:"V",color:"#98FB98",name:"Pale Green",category:"greens"},{index:32,char:"W",color:"#ADFF2F",name:"Yellow Green",category:"greens"},{index:33,char:"X",color:"#00008B",name:"Dark Blue",category:"blues"},{index:34,char:"Y",color:"#0000CD",name:"Medium Blue",category:"blues"},{index:35,char:"Z",color:"#1E90FF",name:"Dodger Blue",category:"blues"},{index:36,char:"a",color:"#4169E1",name:"Royal Blue",category:"blues"},{index:37,char:"b",color:"#6495ED",name:"Steel Blue",category:"blues"},{index:38,char:"c",color:"#87CEEB",name:"Sky Blue",category:"blues"},{index:39,char:"d",color:"#87CEFA",name:"Light Sky Blue",category:"blues"},{index:40,char:"e",color:"#B0E0E6",name:"Powder Blue",category:"blues"},{index:41,char:"f",color:"#4B0082",name:"Indigo",category:"purples"},{index:42,char:"g",color:"#6A5ACD",name:"Slate Blue",category:"purples"},{index:43,char:"h",color:"#7B68EE",name:"Medium Slate Blue",category:"purples"},{index:44,char:"i",color:"#9370DB",name:"Medium Purple",category:"purples"},{index:45,char:"j",color:"#BA55D3",name:"Orchid",category:"purples"},{index:46,char:"k",color:"#DA70D6",name:"Violet",category:"purples"},{index:47,char:"l",color:"#DDA0DD",name:"Plum",category:"purples"},{index:48,char:"m",color:"#EE82EE",name:"Pink Violet",category:"purples"},{index:49,char:"n",color:"#8B4513",name:"Saddle Brown",category:"browns"},{index:50,char:"o",color:"#A0522D",name:"Sienna",category:"browns"},{index:51,char:"p",color:"#D2691E",name:"Chocolate",category:"browns"},{index:52,char:"q",color:"#CD853F",name:"Peru",category:"browns"},{index:53,char:"r",color:"#F4A460",name:"Sandy Brown",category:"browns"},{index:54,char:"s",color:"#DEB887",name:"Burlywood",category:"browns"},{index:55,char:"t",color:"#D2B48C",name:"Tan",category:"browns"},{index:56,char:"u",color:"#BC8F8F",name:"Rosy Brown",category:"browns"},{index:57,char:"v",color:"#FFB6C1",name:"Light Pink",category:"pastels"},{index:58,char:"w",color:"#FFC0CB",name:"Pink",category:"pastels"},{index:59,char:"x",color:"#FFE4E1",name:"Misty Rose",category:"pastels"},{index:60,char:"y",color:"#F0E68C",name:"Khaki",category:"pastels"},{index:61,char:"z",color:"#E6E6FA",name:"Lavender",category:"pastels"},{index:62,char:"+",color:"#D8BFD8",name:"Thistle",category:"pastels"},{index:63,char:"/",color:"#FFDAB9",name:"Peach",category:"pastels"}]},po={canvas:{minSize:2,maxSize:128,defaultWidth:8,defaultHeight:8,minPixelSize:8,maxPixelSize:50,defaultPixelSize:30},history:{maxStates:50,debounceTime:500},autosave:{interval:3e4,debounceTime:1e3},tools:{brushSizes:[1,2,3,5],defaultBrushSize:1,maxBrushSize:5,shapeModes:["fill","stroke"],defaultShapeMode:"fill"},rle:{maxRunLength:99,countDigits:2},ui:{copyFeedbackDuration:1e3,windowResizeDebounce:250,animationDuration:200},validation:{fileNameMaxLength:100,fileNamePattern:"^[a-zA-Z0-9_\\-\\.]+$"}};function yn(e){const t=[];return!e.base64Chars||typeof e.base64Chars!="string"?t.push("Missing or invalid base64Chars"):e.base64Chars.length!==64&&t.push(`base64Chars must be 64 characters, got ${e.base64Chars.length}`),Array.isArray(e.palette)?e.palette.length!==64?t.push(`palette must have 64 colors, got ${e.palette.length}`):e.palette.forEach((n,o)=>{(typeof n.index!="number"||n.index!==o)&&t.push(`palette[${o}]: invalid or mismatched index`),(!n.char||typeof n.char!="string"||n.char.length!==1)&&t.push(`palette[${o}]: invalid char`),(!n.color||typeof n.color!="string")&&t.push(`palette[${o}]: invalid color`),(!n.name||typeof n.name!="string")&&t.push(`palette[${o}]: invalid name`),(!n.category||typeof n.category!="string")&&t.push(`palette[${o}]: invalid category`)}):t.push("palette must be an array"),t.length>0&&s.error?.("Colors config validation failed:",t),{valid:t.length===0,errors:t}}function bn(e){const t=[];if(!e.canvas||typeof e.canvas!="object")t.push("Missing or invalid canvas config");else{const n=e.canvas;(typeof n.minSize!="number"||n.minSize<1)&&t.push("canvas.minSize must be a positive number"),(typeof n.maxSize!="number"||n.maxSize<n.minSize)&&t.push("canvas.maxSize must be >= canvas.minSize"),typeof n.defaultWidth!="number"&&t.push("canvas.defaultWidth must be a number"),typeof n.defaultHeight!="number"&&t.push("canvas.defaultHeight must be a number"),(typeof n.minPixelSize!="number"||n.minPixelSize<1)&&t.push("canvas.minPixelSize must be a positive number"),(typeof n.maxPixelSize!="number"||n.maxPixelSize<n.minPixelSize)&&t.push("canvas.maxPixelSize must be >= canvas.minPixelSize"),typeof n.defaultPixelSize!="number"&&t.push("canvas.defaultPixelSize must be a number")}if(!e.history||typeof e.history!="object")t.push("Missing or invalid history config");else{const n=e.history;(typeof n.maxStates!="number"||n.maxStates<1)&&t.push("history.maxStates must be a positive number"),(typeof n.debounceTime!="number"||n.debounceTime<0)&&t.push("history.debounceTime must be a non-negative number")}if(!e.autosave||typeof e.autosave!="object")t.push("Missing or invalid autosave config");else{const n=e.autosave;(typeof n.interval!="number"||n.interval<1e3)&&t.push("autosave.interval must be >= 1000ms"),(typeof n.debounceTime!="number"||n.debounceTime<0)&&t.push("autosave.debounceTime must be a non-negative number")}return t.length>0&&s.error?.("Constants config validation failed:",t),{valid:t.length===0,errors:t}}function vo(e,t){if(!e||typeof e!="object")return{valid:!1,errors:["Config is null or not an object"]};switch(t){case"colors":return yn(e);case"constants":return bn(e);default:return{valid:!1,errors:[`Unknown config type: ${t}`]}}}const Cn={validateConfig:vo,validateColorsConfig:yn,validateConstantsConfig:bn},ve={},an=mo,sn=po;async function wn(e){if(ve[e])return s.debug?.(`Config loaded from cache: ${e}`),ve[e];try{const t=await fetch(e);if(!t.ok)throw new Error(`HTTP error ${t.status}: ${t.statusText}`);const n=await t.json();return ve[e]=n,s.info?.(`Config loaded: ${e}`),n}catch(t){throw s.error?.(`Failed to load config: ${e}`,t),t}}async function yo(){s.debug?.("Colors loaded from ES module (static)");const e=Cn.validateColorsConfig(an);if(!e.valid)throw s.error?.("Colors config validation failed:",e.errors),new Error(`Invalid colors config: ${e.errors.join(", ")}`);return an}async function bo(){s.debug?.("Constants loaded from ES module (static)");const e=Cn.validateConstantsConfig(sn);if(!e.valid)throw s.error?.("Constants config validation failed:",e.errors),new Error(`Invalid constants config: ${e.errors.join(", ")}`);return sn}function Co(e){return ve[e]||null}function xn(e=null){e?delete ve[e]:Object.keys(ve).forEach(t=>delete ve[t])}async function wo(e){return xn(e),wn(e)}const At={load:wn,loadColors:yo,loadConstants:bo,getCache:Co,clearCache:xn,reload:wo};let Te=null;function xo(e=null){Te=e}function Sn(e,t){const n=Te?.canvas?.minSize||2,o=Te?.canvas?.maxSize||128;return isNaN(e)||isNaN(t)?{valid:!1,error:"Width and height must be numbers"}:e<n||e>o?{valid:!1,error:`Width must be between ${n} and ${o}`}:t<n||t>o?{valid:!1,error:`Height must be between ${n} and ${o}`}:{valid:!0,error:null}}function So(e){if(!e||e.trim().length===0)return{valid:!1,error:"File name cannot be empty"};const t=Te?.validation?.fileNameMaxLength||100;if(e.length>t)return{valid:!1,error:`File name too long (max ${t} characters)`};const n=Te?.validation?.fileNamePattern||"^[a-zA-Z0-9_\\-\\.]+$";return new RegExp(n).test(e)?{valid:!0,error:null}:{valid:!1,error:"File name contains invalid characters"}}function Eo(e){if(!e||typeof e!="string")return{valid:!1,error:"Data string must be a non-empty string",info:null};const t=e.split(":");if(t.length<2)return{valid:!1,error:'Invalid format: must be "WxH:DATA" or "WxH:RLE:DATA"',info:null};const n=t[0].split("x");if(n.length!==2)return{valid:!1,error:'Invalid dimensions format: must be "WIDTHxHEIGHT"',info:null};const o=parseInt(n[0]),i=parseInt(n[1]),r=Sn(o,i);if(!r.valid)return{valid:!1,error:r.error,info:null};const a=t.length===3&&t[1]==="RLE",c=t[a?2:1];if(!c||c.length===0)return{valid:!1,error:"Data section is empty",info:null};if(!a){const u=o*i;if(c.length!==u)return{valid:!1,error:`Data length mismatch: expected ${u}, got ${c.length}`,info:null}}return{valid:!0,error:null,info:{width:o,height:i,isCompressed:a,dataLength:c.length}}}function Io(e){return e==="transparent"?!0:/^#[0-9A-Fa-f]{6}$/.test(e)}function Do(e){return Number.isInteger(e)&&e>=0&&e<=63}function To(e){return typeof e=="string"&&e.length===1&&"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz+/".includes(e)}function $o(e){return e.replace(/[^a-zA-Z0-9_\-\.]/g,"_").replace(/_{2,}/g,"_").substring(0,Te?.validation?.fileNameMaxLength||100)}function Lo(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}const Ue={init:xo,validateCanvasDimensions:Sn,validateFileName:So,validateDataString:Eo,validateHexColor:Io,validateColorIndex:Do,validateBase64Char:To,sanitizeFileName:$o,sanitizeInput:Lo};function Bo(e,t=1){if(e===0)return"0 Bytes";if(e===1)return"1 Byte";const n=1024,o=["Bytes","KB","MB","GB"],i=Math.floor(Math.log(e)/Math.log(n));return parseFloat((e/Math.pow(n,i)).toFixed(t))+" "+o[i]}function Mo(e){return e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}function Fo(e,t=1){return e.toFixed(t)+"%"}function En(e,t=!0){const n=e instanceof Date?e:new Date(e),o=n.getFullYear(),i=String(n.getMonth()+1).padStart(2,"0"),r=String(n.getDate()).padStart(2,"0");let a=`${o}-${i}-${r}`;if(t){const l=String(n.getHours()).padStart(2,"0"),c=String(n.getMinutes()).padStart(2,"0"),u=String(n.getSeconds()).padStart(2,"0");a+=` ${l}:${c}:${u}`}return a}function Oo(e){const t=e instanceof Date?e:new Date(e),o=new Date-t,i=Math.floor(o/1e3),r=Math.floor(i/60),a=Math.floor(r/60),l=Math.floor(a/24);return i<60?"just now":r<60?`${r} minute${r!==1?"s":""} ago`:a<24?`${a} hour${a!==1?"s":""} ago`:l<7?`${l} day${l!==1?"s":""} ago`:En(t,!1)}function In(e,t,n="..."){return e.length<=t?e:e.substring(0,t-n.length)+n}function zo(e,t=50){if(!e)return"";const n=e.split(":");if(n.length<2)return In(e,t);const o=n[0],i=n.length===3&&n[1]==="RLE",a=n[i?2:1],l=i?`${o}:RLE:`:`${o}:`,c=t-l.length-3;return a.length<=c?e:`${l}${a.substring(0,c)}...`}function Po(e,t,n=null){return n=n||t+"s",e===1?t:n}function No(e,t){return`${e}×${t}`}function Ao(e,t=2){return String(e).padStart(t,"0")}function Ro(e,t="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz+/"){return e<0||e>=t.length?"?":t[e]}const It={formatFileSize:Bo,formatNumber:Mo,formatPercentage:Fo,formatTimestamp:En,formatRelativeTime:Oo,truncate:In,formatDataString:zo,pluralize:Po,formatDimensions:No,padZero:Ao,formatColorCode:Ro};async function Dn(e){if(navigator.clipboard&&navigator.clipboard.writeText)try{return await navigator.clipboard.writeText(e),s.info?.("Text copied to clipboard (modern API)"),!0}catch(t){return s.warn?.("Modern clipboard API failed, trying fallback",t),ln(e)}return ln(e)}function ln(e){const t=document.createElement("textarea");t.value=e,t.style.position="fixed",t.style.left="-9999px",t.style.opacity="0",document.body.appendChild(t),t.select();let n=!1;try{n=document.execCommand("copy"),n&&s.info?.("Text copied to clipboard (fallback)")}catch(o){s.error?.("Fallback copy failed",o)}return document.body.removeChild(t),n}async function ko(){if(navigator.clipboard&&navigator.clipboard.readText)try{const e=await navigator.clipboard.readText();return s.info?.("Text pasted from clipboard"),e}catch(e){return s.warn?.("Clipboard read failed",e),null}return s.warn?.("Clipboard API not available"),null}function Tn(e,t=1e3){if(!e)return;const n=e.style.background,o=e.querySelector(".material-symbols-outlined"),i=o?o.textContent:null;e.style.background="var(--success-color, #4CAF50)",o&&(o.textContent="check"),setTimeout(()=>{e.style.background=n,o&&i&&(o.textContent=i)},t)}function Ho(){return!!(navigator.clipboard&&navigator.clipboard.writeText)}async function _o(e,t=null){const n=await Dn(e);return n&&t&&Tn(t),n}const $n={copyText:Dn,pasteText:ko,showCopyFeedback:Tn,isAvailable:Ho,copyWithFeedback:_o};function ot(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function Ln(e){const t={info:"info",success:"check_circle",warning:"warning",error:"error"};return t[e]||t.info}let W=null,Oe=null;function Go(){Yo()}function Yo(){W=document.createElement("div"),W.id="dialogContainer",W.className="dialog-overlay",W.style.display="none",document.body.appendChild(W),W.addEventListener("click",e=>{e.target===W&&ie()}),document.addEventListener("keydown",e=>{e.key==="Escape"&&Oe&&ie()})}function ut(e){const t=document.createElement("div");t.className=`dialog-content dialog-${e.type}`;const n=document.createElement("div");n.className="dialog-header",n.innerHTML=`
        <span class="material-symbols-outlined dialog-icon">${e.icon}</span>
        <h2 class="dialog-title">${ot(e.title)}</h2>
    `,t.appendChild(n);const o=document.createElement("div");if(o.className="dialog-body",e.message){const r=document.createElement("p");r.className="dialog-message",r.textContent=e.message,o.appendChild(r)}if(e.customContent){const r=document.createElement("div");r.innerHTML=e.customContent,o.appendChild(r)}if(e.input){const r=document.createElement("input");r.type=e.input.type,r.value=e.input.value,r.placeholder=e.input.placeholder,r.className="dialog-input",o.appendChild(r)}t.appendChild(o);const i=document.createElement("div");return i.className="dialog-footer",e.buttons.forEach(r=>{const a=document.createElement("button");a.className=`dialog-btn dialog-btn-${r.type}`,a.textContent=r.text,a.addEventListener("click",r.action),i.appendChild(a)}),t.appendChild(i),t}function dt(e){W.innerHTML="",W.appendChild(e),W.style.display="flex",Oe=e,setTimeout(()=>{e.classList.add("dialog-show")},10);const t=e.querySelector(".dialog-btn");t&&t.focus()}function ie(){Oe&&(Oe.classList.remove("dialog-show"),setTimeout(()=>{W.style.display="none",W.innerHTML="",Oe=null},200))}function Rt(e){const[t,n]=e.split(":");if(!n||n.length===0)return{compressed:e,original:e,savings:0,compressionRatio:1};let o="",i=1,r=n[0];for(let d=1;d<=n.length;d++)if(d<n.length&&n[d]===r&&i<99)i++;else{const h=i.toString().padStart(2,"0");o+=`${h}${r}`,d<n.length&&(r=n[d],i=1)}const a=`${t}:RLE:${o}`,l=e.length,c=a.length,u=((l-c)/l*100).toFixed(1),f=(c/l).toFixed(2);return{compressed:a,original:e,savings:parseFloat(u),compressionRatio:parseFloat(f),originalSize:l,compressedSize:c}}function Xo(e){const t=e.split(":");if(t.length===2)return e;if(t.length===3&&t[1]==="RLE"){const n=t[0],o=t[2];let i="",r=0;for(;r<o.length&&r+2<o.length;){const a=o.substring(r,r+2),l=parseInt(a),c=o[r+2];i+=c.repeat(l),r+=3}return`${n}:${i}`}return e}function Uo(e){const t=e.split(":");return t.length===3&&t[1]==="RLE"}function Bn(e){const t=Rt(e);return t.compressedSize<t.originalSize?{data:t.compressed,wasCompressed:!0,savings:t.savings,compressionRatio:t.compressionRatio,originalSize:t.originalSize,compressedSize:t.compressedSize}:{data:e,wasCompressed:!1,savings:0,compressionRatio:1,originalSize:e.length,compressedSize:e.length}}function qo(e){return Rt(e)}function Wo(e){return e.map(t=>Bn(t))}const k={compress:Rt,decompress:Xo,isCompressed:Uo,smartCompress:Bn,getStats:qo,compressBatch:Wo};function Vo(e){return new Promise(t=>{const n=k?k.getStats(e):null,i=ut({title:"Export Pixel Art",message:"Choose how you want to export your pixel art:",icon:"download",type:"info",customContent:jo(e,n,n!==null),buttons:[{text:"Cancel",type:"secondary",action:()=>{ie(),t(null)}}]});dt(i),ti(i,t)})}function jo(e,t,n){const o=Ko(e),i=n?Zo(e,t):"",r=Qo(),a=ei();return`
        <div class="export-options">
            ${o}
            ${i}
            ${r}
            ${a}
        </div>
    `}function Ko(e){return`
        <div class="export-preview">
            <div class="export-preview-header">
                <strong>Text Format Preview:</strong>
                <span class="export-preview-size">${e.length} chars</span>
            </div>
            <code class="export-code-preview">${ot(e.substring(0,100))}${e.length>100?"...":""}</code>
        </div>
    `}function Zo(e,t){const n=t.savings>0?"":"export-warning",o=t.savings>0?"Save":"Adds",i=t.savings>0?"Compresses repeated pixels for smaller file size. Recommended for sprites with large solid areas.":"Note: This sprite has few repeated pixels, so compression increases file size. Use only if needed for compatibility.";return`
        <div class="export-option-group">
            <label class="export-checkbox-label">
                <input type="checkbox" id="exportCompress" class="export-checkbox" ${t.savings>0?"checked":""} />
                <span>Use RLE Compression</span>
                <span class="export-savings ${n}">${o} ${Math.abs(t.savings)}% (${t.originalSize} → ${t.compressedSize} chars)</span>
            </label>
            <div class="export-option-info">
                ${i}
            </div>
            ${Jo(e,t)}
        </div>
    `}function Jo(e,t){return`
        <div class="compression-preview">
            <div class="compression-preview-section">
                <div class="compression-preview-label">
                    <strong>Before:</strong>
                    <span class="compression-preview-size">${t.originalSize} chars</span>
                </div>
                <code class="compression-preview-code">${ot(e.substring(0,80))}${e.length>80?"...":""}</code>
            </div>
            <div class="compression-preview-arrow">→</div>
            <div class="compression-preview-section">
                <div class="compression-preview-label">
                    <strong>After:</strong>
                    <span class="compression-preview-size compression-highlight">${t.compressedSize} chars</span>
                </div>
                <code class="compression-preview-code">${ot(t.compressed.substring(0,80))}${t.compressed.length>80?"...":""}</code>
            </div>
        </div>
    `}function Qo(){return`
        <div class="export-format-section">
            <strong>Export as:</strong>
            <div class="export-format-buttons">
                <button class="export-format-btn" data-format="copy-string">
                    <span class="material-symbols-outlined export-format-icon">content_copy</span>
                    <span class="export-format-label">Copy String</span>
                    <span class="export-format-desc">Copy to clipboard</span>
                </button>
                <button class="export-format-btn" data-format="download-txt">
                    <span class="material-symbols-outlined export-format-icon">description</span>
                    <span class="export-format-label">Download TXT</span>
                    <span class="export-format-desc">Save as text file</span>
                </button>
                <button class="export-format-btn" data-format="download-png">
                    <span class="material-symbols-outlined export-format-icon">image</span>
                    <span class="export-format-label">Download PNG</span>
                    <span class="export-format-desc">Save as image</span>
                </button>
            </div>
        </div>
    `}function ei(){return`
        <div id="pngScaleOptions" class="png-scale-options" style="display: none;">
            <strong>PNG Scale:</strong>
            <div class="png-scale-buttons">
                <button class="png-scale-btn active" data-scale="1">1×</button>
                <button class="png-scale-btn" data-scale="2">2×</button>
                <button class="png-scale-btn" data-scale="4">4×</button>
                <button class="png-scale-btn" data-scale="8">8×</button>
            </div>
        </div>
    `}function ti(e,t){let n=null,o=1;e.querySelectorAll(".export-format-btn").forEach(i=>{i.addEventListener("click",()=>{e.querySelectorAll(".export-format-btn").forEach(a=>a.classList.remove("selected")),i.classList.add("selected"),n=i.dataset.format;const r=e.querySelector("#pngScaleOptions");n==="download-png"?r.style.display="block":r.style.display="none",setTimeout(()=>{const a=e.querySelector("#exportCompress")?.checked||!1;ie(),t({format:n,compress:a,scale:o})},150)})}),e.querySelectorAll(".png-scale-btn").forEach(i=>{i.addEventListener("click",r=>{r.stopPropagation(),e.querySelectorAll(".png-scale-btn").forEach(a=>a.classList.remove("active")),i.classList.add("active"),o=parseInt(i.dataset.scale)})})}function ni(){Go(),s.info?.("Dialog system initialized")}function oi(e,t,n="info"){return new Promise(o=>{const i=ut({title:e,message:t,icon:Ln(n),type:n,buttons:[{text:"OK",type:"primary",action:()=>{ie(),o(!0)}}]});dt(i)})}function ii(e,t,n={}){return new Promise(o=>{const i=n.confirmText||"Confirm",r=n.cancelText||"Cancel",a=n.type||"warning",l=n.dangerous||!1,c=ut({title:e,message:t,icon:Ln(a),type:a,buttons:[{text:r,type:"secondary",action:()=>{ie(),o(!1)}},{text:i,type:l?"danger":"primary",action:()=>{ie(),o(!0)}}]});dt(c)})}function ri(e,t,n="",o={}){return new Promise(i=>{const r=o.placeholder||"",a=o.inputType||"text",l=ut({title:e,message:t,icon:"edit_note",type:"info",input:{type:a,value:n,placeholder:r},buttons:[{text:"Cancel",type:"secondary",action:()=>{ie(),i(null)}},{text:"OK",type:"primary",action:()=>{const c=l.querySelector(".dialog-input"),u=c?c.value:null;ie(),i(u)}}]});dt(l),setTimeout(()=>{const c=l.querySelector(".dialog-input");c&&(c.focus(),c.select(),c.addEventListener("keydown",u=>{if(u.key==="Enter"){const f=c.value;ie(),i(f)}}))},100)})}function ai(e){return Vo(e)}const z={init:ni,alert:oi,confirm:ii,prompt:ri,exportDialog:ai};function Qe(e,t,n){if(!n||n.length===0)return!1;const o=n.length,i=n[0].length;return e>=0&&e<i&&t>=0&&t<o}function si(e,t,n,o){const i=n.length,r=n[0].length;return e>=0&&e<r&&t>=0&&t<i&&n[t][e]!==o?(n[t][e]=o,!0):!1}function li(e,t,n){const o=n.length,i=n[0].length;return e>=0&&e<i&&t>=0&&t<o?n[t][e]:null}function cn(e){return e.map(t=>[...t])}function ci(e,t){if(t)for(let n=0;n<e.length;n++)for(let o=0;o<e[n].length;o++)e[n][o]=t[n][o]}function ui(e=16){const t={lastTime:0,delay:e};return{shouldThrottle(){const n=Date.now();return n-t.lastTime<t.delay?!0:(t.lastTime=n,!1)},reset(){t.lastTime=0}}}function di(e){return class extends e{constructor(...t){super(...t),this.selectionActive=!1,this.selectionBounds=null}respectsSelection(){return!0}isInSelection(t,n){if(!this.selectionActive||!this.selectionBounds)return!0;const{x1:o,y1:i,x2:r,y2:a}=this.selectionBounds;return t>=o&&t<=r&&n>=i&&n<=a}setSelection(t){this.selectionActive=!0,this.selectionBounds=t}clearSelection(){this.selectionActive=!1,this.selectionBounds=null}}}function fi(e){return class extends e{constructor(...t){super(...t),this.boundHandlers={}}addEventListener(t,n,o){const i=o.bind(this);t.addEventListener(n,i);const r=`${n}_${Date.now()}`;this.boundHandlers[r]={target:t,event:n,handler:i}}removeAllEventListeners(){Object.values(this.boundHandlers).forEach(({target:t,event:n,handler:o})=>{t.removeEventListener(n,o)}),this.boundHandlers={}}}}class kt{static CONFIG={id:"base-tool",name:"Base Tool",icon:"tool",shortcut:"",cursor:"default",hasSizeOption:!1,hasShapeOption:!1,description:"Base tool class",category:"other"};static DEFAULT_OPTIONS={brushSize:1,shapeMode:"fill",opacity:1,antiAlias:!1,snapToGrid:!1,constrainProportions:!1};constructor(){if(new.target===kt)throw new Error("BaseTool is abstract and cannot be instantiated directly");const t=this.constructor.CONFIG;if(!t||t.id==="base-tool")throw new Error(`${this.constructor.name} must override static CONFIG property`);this.isActive=!1,this.isDrawing=!1,this.options={...this.constructor.DEFAULT_OPTIONS},this.startX=0,this.startY=0,this.lastX=0,this.lastY=0,this.previewData=null,this.throttle=ui(16),this.onChangeCallback=null,this.onOptionChangeCallback=null,this.actionHistory=[],this.logger=s,this.logger.debug?.(`${this.constructor.CONFIG.name} tool created`)}init(){this.logger.debug?.(`${this.getName()} tool initialized`)}activate(){this.isActive=!0,this.logger.info?.(`${this.getName()} tool activated`)}deactivate(){this.isActive=!1,this.cancelDrawing(),this.logger.info?.(`${this.getName()} tool deactivated`)}destroy(){this.removeAllEventListeners(),this.previewData=null,this.logger.debug?.(`${this.getName()} tool destroyed`)}startDrawing(t,n,o,i={}){return this.isActive?Qe(t,n,o)?(this.isDrawing=!0,this.startX=t,this.startY=n,this.lastX=t,this.lastY=n,this.needsPreview()&&(this.previewData=cn(o)),this.onDrawStart(t,n,o,i)):(this.logger.warn?.(`Invalid coordinates: (${t}, ${n})`),!1):(this.logger.warn?.(`Cannot start drawing: ${this.getName()} is not active`),!1)}continueDrawing(t,n,o,i={}){return!this.isDrawing||!Qe(t,n,o)||this.throttle.shouldThrottle()?!1:(this.lastX=t,this.lastY=n,this.onDrawContinue(t,n,o,i))}endDrawing(t,n,o,i={}){if(!this.isDrawing)return!1;this.isDrawing=!1,Qe(t,n,o)||(t=this.lastX,n=this.lastY);const r=this.onDrawEnd(t,n,o,i);return this.previewData=null,this.throttle.reset(),r}cancelDrawing(){this.isDrawing&&(this.isDrawing=!1,this.previewData=null,this.onDrawCancel(),this.logger.debug?.(`${this.getName()} drawing cancelled`))}onDrawStart(t,n,o,i){throw new Error(`${this.constructor.name} must implement onDrawStart()`)}onDrawContinue(t,n,o,i){throw new Error(`${this.constructor.name} must implement onDrawContinue()`)}onDrawEnd(t,n,o,i){throw new Error(`${this.constructor.name} must implement onDrawEnd()`)}onDrawCancel(){}setOption(t,n){if(this.options.hasOwnProperty(t)){const o=this.options[t];this.options[t]=n,this.onOptionChanged(t,n,o),this.onOptionChangeCallback&&this.onOptionChangeCallback(t,n,o)}else this.logger.warn?.(`Unknown option: ${t}`)}getOption(t){return this.options[t]}getAllOptions(){return{...this.options}}resetOptions(){this.options={...this.constructor.DEFAULT_OPTIONS},this.onOptionsReset()}onOptionChanged(t,n,o){this.logger.debug?.(`${this.getName()} option changed: ${t} = ${n}`)}onOptionsReset(){}needsPreview(){return!1}validateCoordinates(t,n,o){return Qe(t,n,o)}clonePixelData(t){return cn(t)}restorePreviewData(t){ci(t,this.previewData)}setPixel(t,n,o,i){return si(t,n,o,i)}getPixel(t,n,o){return li(t,n,o)}getId(){return this.constructor.CONFIG.id}getName(){return this.constructor.CONFIG.name}getConfig(){return{...this.constructor.CONFIG}}getCursor(){return this.constructor.CONFIG.cursor}hasSizeOption(){return this.constructor.CONFIG.hasSizeOption}hasShapeOption(){return this.constructor.CONFIG.hasShapeOption}setChangeCallback(t){this.onChangeCallback=t}setOptionChangeCallback(t){this.onOptionChangeCallback=t}triggerChange(){this.onChangeCallback&&this.onChangeCallback()}}const te=fi(di(kt));let Q={brushSize:1,shapeMode:"fill",colorCode:1},Ae=null;function hi(e={},t=null){Q={...Q,...e},Ae=t,s.debug?.("ToolStateManager initialized")}function gi(e,t){if(!Q.hasOwnProperty(e)){s.warn?.(`Unknown tool option: ${e}`);return}const n=Q[e];Q[e]=t,s.debug?.(`Tool option changed: ${e} = ${t}`),Ae&&Ae(e,t,n)}function mi(e){return Q[e]}function pi(){return{...Q}}function vi(e){Object.keys(Q).forEach(t=>{e.setOption(t,Q[t])})}function yi(e,t,n){Q.hasOwnProperty(e)&&(Q[e]=t),Ae&&Ae(e,t,n)}let P=null;function Mn(e){P=e}function bi(e,t,n,o={}){if(!P)return s.warn?.("No tool selected for drawing"),!1;try{return P.startDrawing(e,t,n,o)}catch(i){return s.error?.("Error starting drawing",i),!1}}function Ci(e,t,n,o={}){if(!P)return!1;try{return P.continueDrawing(e,t,n,o)}catch(i){return s.error?.("Error continuing drawing",i),!1}}function wi(e,t,n,o={}){if(!P)return!1;try{return P.endDrawing(e,t,n,o)}catch(i){return s.error?.("Error ending drawing",i),!1}}function xi(){if(P)try{P.cancelDrawing()}catch(e){s.error?.("Error canceling drawing",e)}}function Si(e){P&&P.setSelection&&P.setSelection(e)}function Ei(){P&&P.clearSelection&&P.clearSelection()}function Ii(){return!P||!P.respectsSelection?!0:P.respectsSelection()}const X=new Map,$e=[];let V=null,Le=null,Dt=null;function Di(e={}){s.info?.("ToolRegistry initializing..."),e.onToolChange&&(Dt=e.onToolChange),hi(e.sharedOptions,e.onToolOptionChange),s.info?.("ToolRegistry initialized")}function Fn(e){try{if(!e||!e.CONFIG)return s.error?.("Invalid tool class: missing CONFIG",e),!1;const t=e.CONFIG,n=t.id;if(!n)return s.error?.("Tool class missing id in CONFIG",e),!1;if(X.has(n))return s.warn?.(`Tool "${n}" already registered, skipping`),!1;const o=new e;return o.setChangeCallback(()=>{s.debug?.(`Tool ${n} triggered change`)}),o.setOptionChangeCallback((i,r,a)=>{yi(i,r,a)}),o.init(),X.set(n,o),$e.push(n),s.info?.(`Tool registered: ${t.name} (${n})`),!0}catch(t){return s.error?.("Failed to register tool",t),!1}}function Ti(e){let t=0;return e.forEach(n=>{Fn(n)&&t++}),s.info?.(`Registered ${t} tools`),t}function $i(e){const t=X.get(e);if(!t)return s.warn?.(`Tool "${e}" not found`),!1;Le===e&&(t.deactivate(),V=null,Le=null,Mn(null)),t.destroy(),X.delete(e);const n=$e.indexOf(e);return n>-1&&$e.splice(n,1),s.info?.(`Tool unregistered: ${e}`),!0}function Li(e){const t=X.get(e);return t?(V&&V!==t&&V.deactivate(),V=t,Le=e,V.activate(),vi(V),Mn(V),Dt&&Dt(e,t),s.info?.(`Current tool set: ${e}`),!0):(s.warn?.(`Tool "${e}" not found`),!1)}function Bi(){return V}function Mi(){return Le}function Fi(e){return X.get(e)||null}function Oi(){return $e.map(e=>{const t=X.get(e);return t?t.getConfig():null}).filter(e=>e!==null)}function zi(e){const t=e.toUpperCase();for(const[n,o]of X)if(o.getConfig().shortcut===t)return o;return null}function Pi(e){return X.has(e)}function Ni(){return X.size}function Ai(){V&&V.deactivate(),X.forEach(e=>e.destroy()),X.clear(),$e.length=0,V=null,Le=null,s.info?.("All tools cleared")}function Ri(){return{totalTools:X.size,currentToolId:Le,toolIds:[...$e]}}const x={init:Di,registerTool:Fn,registerTools:Ti,unregisterTool:$i,setCurrentTool:Li,getCurrentTool:Bi,getCurrentToolId:Mi,getTool:Fi,getAllTools:Oi,getToolByShortcut:zi,hasTool:Pi,getToolCount:Ni,clearAll:Ai,getStats:Ri,setToolOption:gi,getToolOption:mi,getSharedOptions:pi,startDrawing:bi,continueDrawing:Ci,endDrawing:wi,cancelDrawing:xi,setSelection:Si,clearSelection:Ei,respectsSelection:Ii};let Re=null,we="",re=[],_=[],Tt={},ke=[],ye=1,$t=null,Ie=null;async function ki(e,t=null){try{s.info?.("ColorPalette initializing..."),$t=t,Re=await At.loadColors(),Ht();const n=document.getElementById(e);n?(_t(n),zn()):s.warn?.(`Container "${e}" not found`),s.info?.("ColorPalette initialized successfully")}catch(n){throw s.error?.("ColorPalette initialization failed",n),n}}function Ht(){we=Re.base64Chars,re=Re.palette,_=[],Tt={},ke=[],re.forEach(e=>{_[e.index]=e.color,Tt[e.char]=e.color,ke[e.index]=e.name}),s.debug?.(`Parsed ${re.length} colors from configuration`)}function _t(e){e.innerHTML="",re.forEach(t=>{const n=document.createElement("button");n.className="color-swatch",n.dataset.code=t.char,n.dataset.index=t.index,n.dataset.category=t.category,n.style.backgroundColor=t.color,n.title=`${t.name} (${t.char})`,t.index===ye&&n.classList.add("active"),n.addEventListener("click",()=>On(t.index)),e.appendChild(n)}),s.debug?.(`Rendered ${re.length} color swatches`)}function On(e){if(!Ue.validateColorIndex(e)){s.error?.(`Invalid color index: ${e}`);return}const t=ye;ye=e,document.querySelectorAll(".color-swatch").forEach(n=>{n.classList.toggle("active",parseInt(n.dataset.index)===e)}),zn(),$t&&$t(e,_[e]),C&&C.emit(C.Events.COLOR_CHANGED,{index:e,color:_[e],char:we[e],name:ke[e],oldIndex:t}),x&&x.setToolOption("colorCode",e),s.debug?.(`Color selected: ${ke[e]} (${e})`)}function zn(){const e=document.getElementById("currentColorDisplay"),t=document.getElementById("currentColorCode");e&&(e.style.backgroundColor=_[ye]),t&&(t.textContent=we[ye])}function Hi(e){return _[e]||_[0]}function _i(e){return Tt[e]||_[0]}function Gi(){return ye}function Yi(){return _[ye]}function Xi(e){return we[e]||"0"}function Ui(e){return we.indexOf(e)}function qi(){return[...re]}function Wi(e){return re.filter(t=>t.category===e)}function Vi(){const e=new Set;return re.forEach(t=>e.add(t.category)),Array.from(e)}function ji(e){const t=_[e];if(t==="transparent")return{r:0,g:0,b:0,a:0};const n=t.replace("#",""),o=parseInt(n.substring(0,2),16),i=parseInt(n.substring(2,4),16),r=parseInt(n.substring(4,6),16);return{r:o,g:i,b:r,a:255}}function Ki(e){return ke[e]||"Unknown"}function Zi(e){return re.find(t=>t.index===e)||null}function Ji(e,t){if(e>=0&&e<_.length){Ie||(Ie=[..._]),Ie[e]=t,_[e]=t;const n=document.querySelector(`.color-swatch[data-index="${e}"]`);n&&(n.style.backgroundColor=t),s.info?.(`Custom color set at index ${e}: ${t}`)}}function Qi(){if(Re){Ht();const e=document.querySelector(".color-grid");e&&_t(e),Ie=null,s.info?.("Palette reset to default")}}function er(){return{base64Chars:we,palette:re.map((e,t)=>({...e,color:Ie?Ie[t]:e.color}))}}function tr(e){try{Re=e,Ht();const t=document.querySelector(".color-grid");t&&_t(t),s.info?.("Custom palette imported")}catch(t){s.error?.("Failed to import custom palette",t)}}const U={init:ki,selectColor:On,getColor:Hi,getColorByChar:_i,getCurrentColorIndex:Gi,getCurrentColor:Yi,getBase64Char:Xi,getIndexFromChar:Ui,getAllColors:qi,getColorsByCategory:Wi,getCategories:Vi,indexToRGBA:ji,getColorName:Ki,getColorInfo:Zi,setCustomColor:Ji,resetToDefault:Qi,exportCustomPalette:er,importCustomPalette:tr,get BASE64_CHARS(){return we},get COLORS(){return _}};let B=16,M=16,G=[];function nr(e,t){B=e,M=t,ft(),s.debug?.(`PixelData initialized: ${B}×${M}`)}function ft(){G=[];for(let e=0;e<M;e++){G[e]=[];for(let t=0;t<B;t++)G[e][t]=0}}function or(){return G}function ir(e){return!e||e.length===0?(s.error?.("Invalid pixel data"),!1):(M=e.length,B=e[0].length,G=e.map(t=>[...t]),!0)}function rr(){return{width:B,height:M}}function ar(e,t){return e>=0&&e<B&&t>=0&&t<M?G[t][e]:null}function sr(e,t,n){return e>=0&&e<B&&t>=0&&t<M?(G[t][e]=n,!0):!1}function lr(e,t){const n=Ue.validateCanvasDimensions(e,t);if(!n.valid)return s.error?.("Invalid dimensions:",n.error),!1;const o=G,i=B,r=M;B=e,M=t,ft();for(let a=0;a<Math.min(r,M);a++)for(let l=0;l<Math.min(i,B);l++)G[a][l]=o[a][l];return s.info?.(`Pixel data resized: ${i}×${r} → ${B}×${M}`),!0}function cr(e=!1){let t="";for(let o=0;o<M;o++)for(let i=0;i<B;i++)t+=U.getBase64Char(G[o][i]);const n=`${B}x${M}:${t}`;return e&&k?k.smartCompress(n).data:n}function ur(e){try{const t=Ue.validateDataString(e);if(!t.valid)return{success:!1,error:t.error};let n=e;k&&k.isCompressed(e)&&(n=k.decompress(e),s.debug?.("Data decompressed"));const o=n.split(":"),i=o[0].split("x"),r=parseInt(i[0]),a=parseInt(i[1]),l=o[1];B=r,M=a,ft();let c=0;for(let u=0;u<M;u++)for(let f=0;f<B;f++){const d=l[c],h=U.getIndexFromChar(d);if(h===-1)return{success:!1,error:`Invalid character: ${d}`};G[u][f]=h,c++}return s.info?.(`Data imported: ${B}×${M}`),{success:!0,error:null}}catch(t){return s.error?.("Import failed",t),{success:!1,error:t.message}}}function dr(){return G.map(e=>[...e])}function fr(){for(let e=0;e<M;e++)for(let t=0;t<B;t++)if(G[e][t]!==0)return!0;return!1}function hr(){const e={};let t=0;for(let i=0;i<M;i++)for(let r=0;r<B;r++){const a=G[i][r];a===0?t++:e[a]=(e[a]||0)+1}const n=B*M,o=Object.keys(e).length;return{width:B,height:M,totalPixels:n,transparentPixels:t,usedColors:o,colorCounts:e,fillPercentage:((n-t)/n*100).toFixed(1)}}const E={init:nr,clear:ft,getData:or,setData:ir,getDimensions:rr,getPixel:ar,setPixel:sr,resize:lr,exportToString:cr,importFromString:ur,clone:dr,hasContent:fr,getStats:hr};let j=1,qe=0,We=0,Be=!1,Lt=0,Bt=0,T=null;const Gt=.1,Yt=10,it=.1;function gr(){T=document.querySelector(".canvas-container"),T&&(mr(),pr(),je(),s.info("Viewport initialized"))}function mr(){const e=document.querySelector(".info-bar");if(!e)return;const t=document.createElement("div");t.className="zoom-controls",t.innerHTML=`
        <div class="info-group">
            <button class="zoom-btn" id="zoomOutBtn" title="Zoom Out (-)">−</button>
            <select class="zoom-select" id="zoomSelect">
                <option value="0.25">25%</option>
                <option value="0.5">50%</option>
                <option value="1" selected>100%</option>
                <option value="2">200%</option>
                <option value="4">400%</option>
                <option value="fit">Fit</option>
            </select>
            <button class="zoom-btn" id="zoomInBtn" title="Zoom In (+)">+</button>
            <button class="zoom-btn" id="zoomResetBtn" title="Reset View (Ctrl+0)">⟲</button>
        </div>
    `;const n=e.querySelector(".info-spacer");n?e.insertBefore(t,n):e.appendChild(t),document.getElementById("zoomInBtn").addEventListener("click",Xt),document.getElementById("zoomOutBtn").addEventListener("click",Ut),document.getElementById("zoomResetBtn").addEventListener("click",qt),document.getElementById("zoomSelect").addEventListener("change",o=>{const i=o.target.value;i==="fit"?Wt():Ve(parseFloat(i))})}function pr(){T&&(T.addEventListener("wheel",vr,{passive:!1}),T.addEventListener("mousedown",yr),T.addEventListener("mousemove",br),T.addEventListener("mouseup",un),T.addEventListener("mouseleave",un),document.addEventListener("keydown",Cr))}function vr(e){if(!(e.ctrlKey||e.metaKey))return;e.preventDefault();const n=e.deltaY>0?-it:it,o=Math.max(Gt,Math.min(Yt,j+n));Ve(o)}function yr(e){const t=x&&x.getCurrentToolId()==="hand",n=e.buttons===1&&He,o=e.button===1;(t||n||o)&&(e.preventDefault(),Be=!0,Lt=e.clientX,Bt=e.clientY,T.classList.add("cursor-grabbing"))}function br(e){if(!Be)return;e.preventDefault();const t=e.clientX-Lt,n=e.clientY-Bt;qe+=t,We+=n,Lt=e.clientX,Bt=e.clientY,je()}function un(e){Be&&(Be=!1,T.classList.remove("cursor-grabbing"),x&&x.getCurrentToolId()==="hand"?T.classList.add("cursor-grab"):T.classList.remove("cursor-grab"))}let He=!1;function Cr(e){if(e.code==="Space"&&!e.repeat&&e.target.tagName!=="INPUT"&&e.target.tagName!=="TEXTAREA"&&(He=!0,T&&T.classList.add("cursor-grab")),!(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA")&&(e.ctrlKey||e.metaKey))switch(e.key){case"+":case"=":e.preventDefault(),Xt();break;case"-":case"_":e.preventDefault(),Ut();break;case"0":e.preventDefault(),qt();break}}document.addEventListener("keyup",e=>{e.code==="Space"&&(He=!1,T&&!Be&&(x&&x.getCurrentToolId()==="hand"||T.classList.remove("cursor-grab")))});window.addEventListener("blur",()=>{He&&(He=!1,T&&!Be&&(x&&x.getCurrentToolId()==="hand"||T.classList.remove("cursor-grab")),s.debug?.("Space key state reset due to window blur"))});function Xt(){const e=Math.min(Yt,j+it);Ve(e)}function Ut(){const e=Math.max(Gt,j-it);Ve(e)}function Ve(e){j=Math.max(Gt,Math.min(Yt,e)),je(),Vt()}function qt(){j=1,qe=0,We=0,je(),Vt()}function Wt(){if(!T)return;const e=document.getElementById("pixelCanvas");if(!e)return;const t=T.clientWidth-100,n=T.clientHeight-100,o=e.width,i=e.height,r=t/o,a=n/i;j=Math.min(r,a,1),qe=0,We=0,je(),Vt()}function je(){const e=document.querySelector(".canvas-wrapper");e&&(e.style.transform=`translate(${qe}px, ${We}px) scale(${j})`,e.style.transformOrigin="center center")}function Vt(){const e=document.getElementById("zoomSelect");if(!e)return;const t=Math.round(j*100),n=Array.from(e.options).find(o=>o.value!=="fit"&&Math.abs(parseFloat(o.value)-j)<.01);if(n)e.value=n.value;else{let o=e.querySelector('option[data-custom="true"]');o||(o=document.createElement("option"),o.dataset.custom="true",e.insertBefore(o,e.options[e.options.length-1])),o.value=j,o.textContent=`${t}%`,e.value=j}}function wr(){return j}function xr(){return{x:qe,y:We}}function Sr(){const e=document.getElementById("zoomSelect");e&&e.value==="fit"&&Wt()}const rt={init:gr,zoomIn:Xt,zoomOut:Ut,setZoom:Ve,resetView:qt,fitToScreen:Wt,getZoom:wr,getPan:xr,updateCanvasSize:Sr};let K=null,D=null,I=30,jt=!0,Pn=null;function Er(e,t=null){K=e,D=K.getContext("2d"),D.imageSmoothingEnabled=!1,Pn=t,s.debug?.("CanvasRenderer initialized")}function Nn(e,t){const n=Pn?.canvas?.defaultPixelSize||30,o=Math.max(e,t);return o>64?Math.max(8,Math.floor(n*(64/o))):n}function Ir(e,t,n=null){n!==null?I=n:I=Nn(e,t),K.width=e*I,K.height=t*I,D.imageSmoothingEnabled=!1,s.debug?.(`Canvas size updated: ${K.width}×${K.height} (pixel size: ${I})`)}function Dr(e){if(!e||e.length===0){s.warn?.("No pixel data to render");return}D.imageSmoothingEnabled=!1;const t=e.length,n=e[0].length;D.clearRect(0,0,K.width,K.height);for(let o=0;o<t;o++)for(let i=0;i<n;i++){const r=e[o][i];if(r===0)Tr(i,o);else{const a=U.getColor(r);D.fillStyle=a,D.fillRect(i*I,o*I,I,I)}}jt&&$r(n,t)}function Tr(e,t){const n=Math.max(2,Math.floor(I/4));for(let o=0;o<I;o+=n)for(let i=0;i<I;i+=n){const r=(Math.floor(i/n)+Math.floor(o/n))%2===0;D.fillStyle=r?"#2a2a2a":"#1a1a1a",D.fillRect(e*I+i,t*I+o,n,n)}}function $r(e,t){D.strokeStyle="#404040",D.lineWidth=1;for(let n=0;n<=e;n++)D.beginPath(),D.moveTo(n*I,0),D.lineTo(n*I,t*I),D.stroke();for(let n=0;n<=t;n++)D.beginPath(),D.moveTo(0,n*I),D.lineTo(e*I,n*I),D.stroke()}function Lr(){D.clearRect(0,0,K.width,K.height)}function Br(e){jt=e}function Mr(){return jt}function Fr(){return I}function Or(){return K}function zr(){return D}function Pr(e,t,n,o,i=1){const r=K.getBoundingClientRect(),a=e-r.left,l=t-r.top,c=r.width/n,u=Math.floor(a/c),f=Math.floor(l/c);return u>=0&&u<n&&f>=0&&f<o?{x:u,y:f}:null}function Nr(e,t,n=1){return{x:e*I*n,y:t*I*n}}const R={init:Er,calculatePixelSize:Nn,updateCanvasSize:Ir,render:Dr,clear:Lr,setGridVisible:Br,getGridVisible:Mr,getPixelSize:Fr,getCanvas:Or,getContext:zr,screenToPixelCoords:Pr,pixelToScreenCoords:Nr};let S=null,b=null,Z=null,ue=null;function Ar(e,t={}){Z=e,ue=t.renderer||R,Rr(),s.debug?.("SelectionOverlay initialized (stateless)")}function Rr(){S&&S.remove(),S=document.createElement("canvas"),S.className="selection-overlay";const e=Z.getBoundingClientRect();Object.assign(S.style,{position:"fixed",top:e.top+"px",left:e.left+"px",pointerEvents:"none",zIndex:"10"}),b=S.getContext("2d"),document.body.appendChild(S),Kt()}function Kt(){if(!S||!Z)return;const e=Z.getBoundingClientRect();S.width=e.width,S.height=e.height,S.style.width=e.width+"px",S.style.height=e.height+"px",S.style.top=e.top+"px",S.style.left=e.left+"px"}function kr(e,t=0){if(!S||!b||!ue)return;Kt(),An();const{bounds:n,previewBounds:o,movePreview:i}=e;if(i&&i.pixelData){Hr(i);const r={x1:i.x,y1:i.y,x2:i.x+i.pixelData[0].length-1,y2:i.y+i.pixelData.length-1};dn(r,t)}else n?dn(n,t):o&&_r(o)}function Hr(e){const{pixelData:t,x:n,y:o}=e,i=Z.getBoundingClientRect();S.getBoundingClientRect();const r=ue.getColors(),a=Z.width/ue.getPixelSize(),l=i.width/a;b.save();for(let c=0;c<t.length;c++)for(let u=0;u<t[c].length;u++){const f=t[c][u];f!==0&&(b.fillStyle=r[f],b.fillRect((n+u)*l,(o+c)*l,l,l))}b.restore()}function dn(e,t){const n=Z.getBoundingClientRect();S.getBoundingClientRect();const o=Z.width/ue.getPixelSize();Z.height/ue.getPixelSize();const i=n.width/o,r=e.x1*i,a=e.y1*i,l=(e.x2-e.x1+1)*i,c=(e.y2-e.y1+1)*i;b.save(),b.imageSmoothingEnabled=!1,b.strokeStyle="#FFFFFF",b.lineWidth=1,b.setLineDash([4,4]),b.lineDashOffset=t,b.strokeRect(r+.5,a+.5,l-1,c-1),b.strokeStyle="#000000",b.lineDashOffset=t+4,b.strokeRect(r+.5,a+.5,l-1,c-1),b.restore()}function _r(e){const t=Z.getBoundingClientRect();S.getBoundingClientRect();const n=Z.width/ue.getPixelSize();Z.height/ue.getPixelSize();const o=t.width/n,i=e.x1*o,r=e.y1*o,a=(e.x2-e.x1+1)*o,l=(e.y2-e.y1+1)*o;b.save(),b.imageSmoothingEnabled=!1,b.strokeStyle="rgba(0, 191, 255, 0.8)",b.lineWidth=1,b.setLineDash([3,3]),b.strokeRect(i+.5,r+.5,a-1,l-1),b.restore()}function An(){S&&b&&b.clearRect(0,0,S.width,S.height)}function Gr(){S&&(S.remove(),S=null,b=null),s.debug?.("SelectionOverlay destroyed")}const se={init:Ar,updateSize:Kt,render:kr,clear:An,destroy:Gr};let L=null,_e=null,ee=null,oe=null,be=null,Mt=null,at=null,tt=!1;function Yr(e,t={}){L=e,_e=t.renderer||R,ee=t.pixelData||E,oe=t.toolRegistry||x,be=t.colorPalette||U,Mt=t.viewport||rt,at=t.onChange||null,Xr(),s.debug?.("CanvasEvents initialized")}function Xr(){L.addEventListener("mousedown",Zt),L.addEventListener("mousemove",Jt),L.addEventListener("mouseup",Ge),L.addEventListener("mouseleave",Ge),L.addEventListener("touchstart",Rn,{passive:!1}),L.addEventListener("touchmove",kn,{passive:!1}),L.addEventListener("touchend",st),L.addEventListener("touchcancel",st),L.addEventListener("contextmenu",e=>e.preventDefault()),s.debug?.("Canvas event listeners registered")}function Zt(e){if(!oe||!ee)return;const t=Qt(e);if(!t)return;const n=ee.getData(),i={colorCode:be?be.getCurrentColorIndex():1,event:e};tt=!0,oe.startDrawing(t.x,t.y,n,i);const r=oe.getCurrentToolId();["brush","pencil","eraser"].includes(r)&&oe.continueDrawing(t.x,t.y,n,i)&&(en(),tn())}function Jt(e){if(!oe||!ee)return;const t=Qt(e);if(!t)return;const n=ee.getData(),i={colorCode:be?be.getCurrentColorIndex():1,event:e,onSelectionChange:Hn};oe.continueDrawing(t.x,t.y,n,i)&&(en(),tn())}function Ge(e){if(!tt||!oe||!ee){tt=!1;return}tt=!1;const t=Qt(e),n=ee.getData(),i={colorCode:be?be.getCurrentColorIndex():1,event:e,onSelectionChange:Hn};let r=!1;t?r=oe.endDrawing(t.x,t.y,n,i):r=oe.endDrawing(-1,-1,n,i),r&&(en(),tn())}function Rn(e){if(e.preventDefault(),e.touches.length===0)return;const t=e.touches[0],n=new MouseEvent("mousedown",{clientX:t.clientX,clientY:t.clientY,bubbles:!0});Zt(n)}function kn(e){if(e.preventDefault(),e.touches.length===0)return;const t=e.touches[0],n=new MouseEvent("mousemove",{clientX:t.clientX,clientY:t.clientY,bubbles:!0});Jt(n)}function st(e){e.preventDefault();const t=new MouseEvent("mouseup",{bubbles:!0});Ge(t)}function Qt(e){if(!_e||!ee)return null;const t=ee.getDimensions(),n=Mt?Mt.getZoom():1;return _e.screenToPixelCoords(e.clientX,e.clientY,t.width,t.height,n)}function Hn(e){C&&C.emit(C.Events.SELECTION_CHANGED,e)}function en(){_e&&ee&&_e.render(ee.getData())}function tn(){at&&at(),C&&C.emit(C.Events.CANVAS_CHANGED)}function Ur(e){at=e}function qr(){L&&(L.removeEventListener("mousedown",Zt),L.removeEventListener("mousemove",Jt),L.removeEventListener("mouseup",Ge),L.removeEventListener("mouseleave",Ge),L.removeEventListener("touchstart",Rn),L.removeEventListener("touchmove",kn),L.removeEventListener("touchend",st),L.removeEventListener("touchcancel",st),L.removeEventListener("contextmenu",e=>e.preventDefault()),s.debug?.("CanvasEvents destroyed"))}const lt={init:Yr,setChangeCallback:Ur,destroy:qr};let Fe=null,ct=null,fn=null,Me=null,ze=null,xt=0;async function Wr(e,t=16,n=16,o=null){try{if(s.info?.("PixelCanvas initializing..."),ct=o,Fe=document.getElementById(e),Me=x,!Fe)throw new Error(`Canvas element "${e}" not found`);if(fn=await At.loadConstants(),!E)throw new Error("PixelData module not available");if(E.init(t,n),!R)throw new Error("CanvasRenderer module not available");if(R.init(Fe,fn),R.updateCanvasSize(t,n),se&&se.init(Fe,{renderer:R}),!lt)throw new Error("CanvasEvents module not available");lt.init(Fe,{renderer:R,pixelData:E,toolRegistry:Me,onChange:gt}),ht(),Vr(),s.info?.(`PixelCanvas initialized: ${t}×${n}`),C&&C.emit(C.Events.CANVAS_RESIZED,{width:t,height:n})}catch(i){throw s.error?.("PixelCanvas initialization failed",i),i}}function Vr(){if(ze)return;function e(){if(R.render(E.getData()),se&&Me){xt=(xt+.25)%16;const t=Me.getCurrentTool(),n={bounds:null,previewBounds:null,movePreview:null};t&&(n.bounds=t.selectionActive?t.selectionBounds:null,t.constructor.CONFIG.id==="select"&&t.isDrawing&&(n.bounds=null,n.previewBounds={x1:Math.min(t.startX,t.lastX),y1:Math.min(t.startY,t.lastY),x2:Math.max(t.startX,t.lastX),y2:Math.max(t.startY,t.lastY)}),t.constructor.CONFIG.id==="move"&&t.isMoving&&(n.movePreview=t.getPreviewData(),n.bounds=null)),se.render(n,xt)}ze=requestAnimationFrame(e)}e(),s.info?.("PixelCanvas render loop started.")}function jr(){ze&&(cancelAnimationFrame(ze),ze=null,s.info?.("PixelCanvas render loop stopped."))}function Kr(){E&&(E.clear(),gt(),C&&C.emit(C.Events.CANVAS_CLEARED))}function Zr(){return E?E.getData().some(t=>t.some(n=>n!==0)):!1}function Jr(e,t){if(!E||!R)return!1;if(E.resize(e,t)){const n=R.getPixelSize();return R.updateCanvasSize(e,t,n),se&&se.updateSize(),ht(),gt(),C&&C.emit(C.Events.CANVAS_RESIZED,{width:e,height:t}),!0}return!1}function Qr(e=!1){return E?E.exportToString(e):""}function ea(e){if(!E||!R)return!1;const t=E.importFromString(e);if(t.success){const n=E.getDimensions(),o=R.getPixelSize();if(R.updateCanvasSize(n.width,n.height,o),se&&se.updateSize(),Me){const i=Me.getCurrentTool();i&&i.clearSelection()}return ht(),gt(),C&&C.emit(C.Events.FILE_LOADED,{width:n.width,height:n.height}),!0}else return window.Dialogs?window.Dialogs.alert("Import Failed",t.error,"error"):alert("Import failed: "+t.error),!1}function ht(){if(!E)return;const e=E.getDimensions(),t=document.getElementById("canvasSizeDisplay");t&&It?t.textContent=It.formatDimensions(e.width,e.height):t&&(t.textContent=`${e.width}×${e.height}`)}function gt(){ct&&ct(),ht()}function ta(){jr(),lt&&lt.destroy(),se&&se.destroy(),s.info?.("PixelCanvas destroyed")}function na(){return E?E.getData():[]}function oa(){return E?E.getDimensions():{width:0,height:0}}function ia(){return E?E.getStats():{}}function ra(e){ct=e,events&&events.setChangeCallback(e)}const w={init:Wr,clear:Kr,hasContent:Zr,resize:Jr,exportToString:Qr,importFromString:ea,getPixelData:na,getDimensions:oa,getStats:ia,setChangeCallback:ra,destroy:ta};let et=null,Ft=!1;function xe(){if(et!==null)return et;try{const e="__storage_test__";return localStorage.setItem(e,e),localStorage.removeItem(e),et=!0,!0}catch(e){return et=!1,s.warn?.("localStorage is not available",e),!1}}function nn(e){if(!xe())return null;try{return localStorage.getItem(e)}catch(t){return s.error?.("localStorage.getItem failed",t),null}}function _n(e,t){if(!xe())return!1;try{return localStorage.setItem(e,t),Ft=!1,!0}catch(n){return n.name==="QuotaExceededError"||n.code===22?(Ft=!0,s.error?.("localStorage quota exceeded",n)):s.error?.("localStorage.setItem failed",n),!1}}function aa(e){if(!xe())return!1;try{return localStorage.removeItem(e),!0}catch(t){return s.error?.("localStorage.removeItem failed",t),!1}}function sa(){if(!xe())return!1;try{return localStorage.clear(),!0}catch(e){return s.error?.("localStorage.clear failed",e),!1}}function la(){if(!xe())return[];try{const e=[];for(let t=0;t<localStorage.length;t++){const n=localStorage.key(t);n&&e.push(n)}return e}catch(e){return s.error?.("localStorage.keys failed",e),[]}}function ca(){return Ft}function ua(){if(!xe())return null;try{let e=0;for(let n=0;n<localStorage.length;n++){const o=localStorage.key(n);if(o){const i=localStorage.getItem(o);i&&(e+=o.length+i.length)}}const t=5*1024*1024;return{used:e,total:t,percentage:(e/t*100).toFixed(2),usedKB:(e/1024).toFixed(2),totalMB:(t/1024/1024).toFixed(2),available:t-e}}catch(e){return s.error?.("getStorageStats failed",e),null}}function da(e,t=null){const n=nn(e);if(!n)return t;try{return JSON.parse(n)}catch(o){return s.error?.("JSON parse failed",o),t}}function fa(e,t){try{const n=JSON.stringify(t);return _n(e,n)}catch(n){return s.error?.("JSON stringify failed",n),!1}}function ha(e){return nn(e)!==null}const Y={isStorageAvailable:xe,getItem:nn,setItem:_n,removeItem:aa,clear:sa,keys:la,isQuotaExceeded:ca,getStorageStats:ua,getJSON:da,setJSON:fa,hasKey:ha};let De=null,St=null,Ye=null,Xe=!1,mt=!0;const ga=3e4,ma=2e3;function pa(){va(),Gn(),s.info("Autosave initialized")}function va(){const e=document.querySelector(".menu-bar");if(!e)return;const t=document.createElement("div");t.id="autosaveIndicator",t.className="autosave-indicator",t.innerHTML=`
        <span class="autosave-status">
            <span class="autosave-icon">💾</span>
            <span class="autosave-text">Saved</span>
        </span>
        <span class="autosave-time"></span>
    `,e.appendChild(t)}function Gn(){De&&clearInterval(De),De=setInterval(()=>{Xe&&mt&&on()},ga)}function ya(){De&&(clearInterval(De),De=null)}function ba(){Xe=!0,nt("unsaved"),St&&clearTimeout(St),St=setTimeout(()=>{Xe&&mt&&on()},ma)}function on(){if(!mt)return;nt("saving");const e=q?q.getCurrentTab():null;if(!e)return;const t=w.exportToString();try{const n=`autosave_${e.id}`;Y.setItem(n,t),Y.setItem(`${n}_timestamp`,Date.now().toString()),Xe=!1,Ye=Date.now(),setTimeout(()=>{nt("saved")},500),s.info("Autosaved:",e.name)}catch(n){s.error("Autosave failed:",n),nt("error")}}function nt(e){const t=document.getElementById("autosaveIndicator");if(!t)return;const n=t.querySelector(".autosave-icon"),o=t.querySelector(".autosave-text"),i=t.querySelector(".autosave-time");switch(t.classList.remove("status-saved","status-saving","status-unsaved","status-error"),e){case"saved":t.classList.add("status-saved"),n.textContent="✓",o.textContent="Saved",Ye&&(i.textContent=Yn(Ye));break;case"saving":t.classList.add("status-saving"),n.textContent="⏳",o.textContent="Saving...";break;case"unsaved":t.classList.add("status-unsaved"),n.textContent="●",o.textContent="Unsaved";break;case"error":t.classList.add("status-error"),n.textContent="⚠️",o.textContent="Error";break}}function Yn(e){const t=Math.floor((Date.now()-e)/1e3);return t<60?"just now":t<3600?`${Math.floor(t/60)}m ago`:t<86400?`${Math.floor(t/3600)}h ago`:`${Math.floor(t/86400)}d ago`}function Ca(){setInterval(()=>{const t=document.getElementById("autosaveIndicator")?.querySelector(".autosave-time");t&&Ye&&!Xe&&(t.textContent=Yn(Ye))},3e4)}function wa(e){try{const t=`autosave_${e}`,n=Y.getItem(t),o=Y.getItem(`${t}_timestamp`);if(n&&o)return{data:n,timestamp:parseInt(o)}}catch(t){s.error("Failed to load autosave:",t)}return null}function xa(e){try{const t=`autosave_${e}`;Y.removeItem(t),Y.removeItem(`${t}_timestamp`)}catch(t){s.error("Failed to clear autosave:",t)}}function Sa(e){mt=e,e?Gn():ya()}function Ea(){on()}Ca();const de={init:pa,markDirty:ba,forceSave:Ea,loadAutosave:wa,clearAutosave:xa,setEnabled:Sa};let A=[],le=null,Pe=0;function Ia(e=!0){Da(),e&&Oa().length===0&&rn("Untitled-1",8,8),s.info("Tab Manager initialized")}function Da(){const e=document.querySelector(".workspace");if(!e)return;const t=e.querySelector(".menu-bar"),n=document.createElement("div");n.className="tab-bar",n.id="tabBar",n.innerHTML=`
        <div class="tab-list" id="tabList"></div>
        <button class="tab-new-btn" id="newTabBtn" title="New Document (Ctrl+N)">+</button>
    `,e.insertBefore(n,t.nextSibling),document.getElementById("newTabBtn").addEventListener("click",()=>{rn()})}function rn(e=null,t=8,n=8,o=null){Pe++;const i=`tab_${Date.now()}_${Pe}`,r=e||`Untitled-${Pe}`,a={id:i,name:r,width:t,height:n,data:o||Ta(t,n),isDirty:!1,created:Date.now(),modified:Date.now()};return A.push(a),Xn(a),Ke(i),a}function Ta(e,t){const n="0".repeat(e*t);return`${e}x${t}:${n}`}function Xn(e){const t=document.getElementById("tabList");if(!t)return;const n=document.createElement("div");n.className="tab",n.dataset.tabId=e.id,n.innerHTML=`
        <span class="tab-name">${e.name}</span>
        <span class="tab-dirty" style="display: none;">●</span>
        <button class="tab-close" title="Close">×</button>
    `,n.addEventListener("click",o=>{o.target.classList.contains("tab-close")||Ke(e.id)}),n.querySelector(".tab-close").addEventListener("click",o=>{o.stopPropagation(),Un(e.id)}),n.querySelector(".tab-name").addEventListener("dblclick",o=>{o.stopPropagation(),qn(e.id)}),t.appendChild(n)}function Ke(e){const t=A.find(n=>n.id===e);t&&(le&&$a(),le=e,document.querySelectorAll(".tab").forEach(n=>{n.classList.toggle("active",n.dataset.tabId===e)}),w&&w.importFromString(t.data),document.title=`${t.name} - Inline.px`,s.info("Switched to tab:",t.name))}function $a(){const e=A.find(t=>t.id===le);!e||!w||(e.data=w.exportToString(),e.modified=Date.now())}async function Un(e){const t=A.find(o=>o.id===e);if(!t)return;if(A.length===1){if(t.isDirty&&!await z.confirm("Unsaved Changes",`"${t.name}" has unsaved changes. Close anyway?`,{confirmText:"Close",cancelText:"Cancel",type:"warning",dangerous:!0}))return;A=[],le=null;const o=document.querySelector(`.tab[data-tab-id="${e}"]`);if(o&&o.remove(),typeof showWelcomeScreen=="function")showWelcomeScreen();else{const i=document.getElementById("welcomeScreen"),r=document.getElementById("canvasContainer");i&&(i.style.display="flex"),r&&(r.style.display="none")}s.info("Last tab closed, returning to welcome screen");return}if(t.isDirty&&!await z.confirm("Unsaved Changes",`"${t.name}" has unsaved changes. Close anyway?`,{confirmText:"Close",cancelText:"Cancel",type:"warning",dangerous:!0}))return;A=A.filter(o=>o.id!==e);const n=document.querySelector(`.tab[data-tab-id="${e}"]`);if(n&&n.remove(),le===e){const o=A[A.length-1];o&&Ke(o.id)}de&&de.clearAutosave(e),s.info("Closed tab:",t.name)}async function qn(e){const t=A.find(o=>o.id===e);if(!t)return;const n=await z.prompt("Rename Document","Enter a new name for this document:",t.name,{placeholder:"Document name"});n&&n.trim()&&(t.name=n.trim(),pt(t),le===e&&(document.title=`${t.name} - Inline.px`))}function pt(e){const t=document.querySelector(`.tab[data-tab-id="${e.id}"]`);if(!t)return;const n=t.querySelector(".tab-name"),o=t.querySelector(".tab-dirty");n&&(n.textContent=e.name),o&&(o.style.display=e.isDirty?"inline":"none")}function La(){const e=A.find(t=>t.id===le);e&&(e.isDirty=!0,e.modified=Date.now(),pt(e),de&&de.markDirty())}function Ba(){const e=A.find(t=>t.id===le);e&&(e.isDirty=!1,pt(e))}function Wn(){return A.find(e=>e.id===le)||null}function Ma(){return A}function Fa(e){const t=Wn();t&&(t.name=e,pt(t),document.title=`${t.name} - Inline.px`)}function Oa(){const e=[];try{if(!Y.isStorageAvailable())return s.warn?.("localStorage not available, cannot restore tabs"),e;const t=Y.keys();for(const n of t)if(n&&n.startsWith("autosave_tab_")&&!n.endsWith("_timestamp"))try{const o=n.replace("autosave_",""),i=de?de.loadAutosave(o):null;if(i&&i.data){const r=i.data.split(":");let a,l;r[1]==="RLE"?(a=r[0].split("x"),l=k.decompress(i.data)):(a=r[0].split("x"),l=i.data);const c=parseInt(a[0]),u=parseInt(a[1]);if(isNaN(c)||isNaN(u)||c<=0||u<=0){s.warn?.(`Invalid dimensions in autosave ${o}, skipping`);continue}Pe++;const f={id:o,name:`Restored-${Pe}`,width:c,height:u,data:l,isDirty:!1,created:i.timestamp,modified:i.timestamp};A.push(f),Xn(f),e.push(f)}}catch(o){s.warn?.("Failed to restore individual tab, skipping",o);continue}e.length>0&&(Ke(e[0].id),s.info?.(`Restored ${e.length} autosaved tab(s)`))}catch(t){s.error?.("Failed to restore autosaved tabs:",t)}return e}const q={init:Ia,createNewTab:rn,switchToTab:Ke,closeTab:Un,renameTab:qn,markCurrentTabDirty:La,markCurrentTabClean:Ba,getCurrentTab:Wn,getAllTabs:Ma,setCurrentTabName:Fa},Vn="pixelart_files";let Ce=null,pe=null,Se=null;function Ze(){return Y.getJSON(Vn,[])}async function jn(e){const t=Y.setJSON(Vn,e);return t||(s.error?.("Error saving to LocalStorage"),Y.isQuotaExceeded()?await z.alert("Storage Full","Storage quota exceeded. Please delete some files to free up space.","error"):Y.isStorageAvailable()?await z.alert("Save Failed","Failed to save file. Please try again.","error"):await z.alert("Storage Unavailable","LocalStorage is not available. Your browser may be in private mode.","error")),t}async function za(e,t=null){if(!t&&(t=await z.prompt("Save Pixel Art","Enter a name for your pixel art:",Ce||"untitled",{placeholder:"File name"}),!t))return!1;const n=e.split(":");if(n.length!==2)return await z.alert("Invalid Format","Invalid data format.","error"),!1;const o=n[0].split("x"),i=parseInt(o[0]),r=parseInt(o[1]),a=Ze(),l=a.findIndex(u=>u.name===t);if(l>=0&&!await z.confirm("Overwrite File",`A file named "${t}" already exists. Overwrite it?`,{confirmText:"Overwrite",cancelText:"Cancel",type:"warning"}))return!1;const c={id:l>=0?a[l].id:Aa(),name:t,data:e,timestamp:Date.now(),width:i,height:r};return l>=0?a[l]=c:a.push(c),jn(a)?(Ce=t,await z.alert("Saved!",`Saved as "${t}"`,"success"),!0):!1}function Pa(e){const n=Ze().find(o=>o.id===e);return n?(Ce=n.name,n):null}function Kn(e){const t=Ze(),n=t.filter(o=>o.id!==e);return n.length<t.length?jn(n):!1}function Na(e,t=null){t||(t=Ce||"pixelart"),t.endsWith(".txt")||(t+=".txt");const n=new Blob([e],{type:"text/plain"}),o=URL.createObjectURL(n),i=document.createElement("a");i.href=o,i.download=t,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(o)}function Aa(){return"file_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}function Ra(){return Ce}function ka(e){Ce=e}function Ha(){Ce=null}function Zn(e){return new Date(e).toLocaleString()}function _a(){return Y.getStorageStats()}function Ga(e){const t=document.getElementById("fileModal"),n=document.getElementById("fileList"),o=document.getElementById("noFilesMessage"),i=document.getElementById("closeModal");if(!t||!n){s.error?.("Modal elements not found");return}pe&&i.removeEventListener("click",pe),Se&&t.removeEventListener("click",Se);const r=Ze();n.innerHTML="",r.length===0?o.classList.remove("hidden"):(o.classList.add("hidden"),r.sort((a,l)=>l.timestamp-a.timestamp),r.forEach(a=>{const l=Ya(a,e);n.appendChild(l)})),t.classList.add("flex"),t.classList.remove("hidden"),pe=()=>{t.classList.add("hidden"),t.classList.remove("flex"),i.removeEventListener("click",pe),t.removeEventListener("click",Se),pe=null,Se=null},Se=a=>{a.target===t&&pe()},i.addEventListener("click",pe),t.addEventListener("click",Se)}function Ya(e,t){const n=document.createElement("div");n.className="file-item";const o=document.createElement("div");o.className="file-item-info";const i=document.createElement("div");i.className="file-item-name",i.textContent=e.name;const r=document.createElement("div");r.className="file-item-meta",r.textContent=`${e.width}x${e.height} • ${Zn(e.timestamp)}`,o.appendChild(i),o.appendChild(r);const a=document.createElement("div");a.className="file-item-actions";const l=document.createElement("button");l.className="btn btn-success",l.textContent="Load",l.addEventListener("click",()=>{const u=document.getElementById("fileModal");u.classList.add("hidden"),u.classList.remove("flex"),t(e)});const c=document.createElement("button");return c.className="btn btn-danger",c.textContent="Delete",c.addEventListener("click",async()=>{if(await z.confirm("Delete File",`Delete "${e.name}"? This cannot be undone.`,{confirmText:"Delete",cancelText:"Cancel",type:"error",dangerous:!0})&&Kn(e.id)){n.remove();const f=document.getElementById("fileList");if(f&&f.children.length===0){const d=document.getElementById("noFilesMessage");d&&d.classList.remove("hidden")}}}),a.appendChild(l),a.appendChild(c),n.appendChild(o),n.appendChild(a),n}const fe={save:za,load:Pa,deleteFile:Kn,getAllFiles:Ze,exportAsFile:Na,getCurrentFileName:Ra,setCurrentFileName:ka,clearCurrentFileName:Ha,formatDate:Zn,getStorageStats:_a,showLoadDialog:Ga};let ae=[],he=[];const Jn=50;let Ot=null;function Xa(e={}){e.onHistoryChange&&(Ot=e.onHistoryChange),s.info("History system initialized")}function Ua(e,t="Change"){e&&(ae.push({data:e,action:t,timestamp:Date.now()}),ae.length>Jn&&ae.shift(),he=[],vt())}function qa(e){if(ae.length===0)return s.debug("Nothing to undo"),null;e&&he.push({data:e,action:"Redo point",timestamp:Date.now()});const t=ae.pop();return vt(),s.info("Undo:",t.action),t.data}function Wa(e){if(he.length===0)return s.debug("Nothing to redo"),null;e&&ae.push({data:e,action:"Undo point",timestamp:Date.now()});const t=he.pop();return vt(),s.info("Redo:",t.action),t.data}function Va(){ae=[],he=[],vt(),s.info("History cleared")}function Qn(){return ae.length>0}function eo(){return he.length>0}function ja(){return{undoCount:ae.length,redoCount:he.length,maxHistory:Jn}}function vt(){Ot&&Ot({canUndo:Qn(),canRedo:eo(),undoCount:ae.length,redoCount:he.length})}const ge={init:Xa,pushState:Ua,undo:qa,redo:Wa,clear:Va,canUndo:Qn,canRedo:eo,getStats:ja};function Ka(e=1,t="pixelart.png"){if(!document.getElementById("pixelCanvas")){s.error("Canvas not found");return}const o=w.getDimensions(),i=w.getPixelData(),r=document.createElement("canvas");r.width=o.width*e,r.height=o.height*e;const a=r.getContext("2d");a.imageSmoothingEnabled=!1,a.imageSmoothingQuality="high";for(let l=0;l<o.height;l++)for(let c=0;c<o.width;c++){const u=i[l][c];if(u===0)continue;const f=U.getColor(u);a.fillStyle=f,a.fillRect(c*e,l*e,e,e)}r.toBlob(l=>{to(l,t)},"image/png")}function Za(e,t=1,n="pixelart.png"){let o=e;k&&k.isCompressed(e)&&(o=k.decompress(e));const[i,r]=o.split(":"),[a,l]=i.split("x").map(Number),c=document.createElement("canvas");c.width=a*t,c.height=l*t;const u=c.getContext("2d");u.imageSmoothingEnabled=!1;for(let f=0;f<l;f++)for(let d=0;d<a;d++){const h=f*a+d,g=r[h],p=U.getIndexFromChar(g);if(p===0)continue;const y=U.getColor(p);u.fillStyle=y,u.fillRect(d*t,f*t,t,t)}c.toBlob(f=>{to(f,n)},"image/png")}function Ja(e=1){const t=w.getDimensions(),n=w.getPixelData(),o=document.createElement("canvas");o.width=t.width*e,o.height=t.height*e;const i=o.getContext("2d");i.imageSmoothingEnabled=!1;for(let r=0;r<t.height;r++)for(let a=0;a<t.width;a++){const l=n[r][a];if(l===0)continue;const c=U.getColor(l);i.fillStyle=c,i.fillRect(a*e,r*e,e,e)}return o.toDataURL("image/png")}function to(e,t){const n=URL.createObjectURL(e),o=document.createElement("a");o.href=n,o.download=t,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(n)}async function Qa(e=1){try{const t=w.getDimensions(),n=w.getPixelData(),o=document.createElement("canvas");o.width=t.width*e,o.height=t.height*e;const i=o.getContext("2d");i.imageSmoothingEnabled=!1;for(let a=0;a<t.height;a++)for(let l=0;l<t.width;l++){const c=n[a][l];if(c===0)continue;const u=U.getColor(c);i.fillStyle=u,i.fillRect(l*e,a*e,e,e)}const r=await new Promise(a=>{o.toBlob(a,"image/png")});if(navigator.clipboard&&navigator.clipboard.write)return await navigator.clipboard.write([new ClipboardItem({"image/png":r})]),!0;throw new Error("Clipboard API not supported")}catch(t){return s.error("Failed to copy PNG to clipboard:",t),!1}}function es(){const e=w.getDimensions(),t=Math.max(e.width,e.height);return[{value:1,label:"1× (Original)",size:`${e.width}×${e.height}`},{value:2,label:"2× (Small)",size:`${e.width*2}×${e.height*2}`},{value:4,label:"4× (Medium)",size:`${e.width*4}×${e.height*4}`},{value:8,label:"8× (Large)",size:`${e.width*8}×${e.height*8}`}].filter(o=>t*o.value<=2048)}const ts={exportToPNG:Ka,exportDataStringToPNG:Za,getDataURL:Ja,copyToClipboard:Qa,getScaleOptions:es};let yt=null,O=null;function ns(){os(),is(),s.info?.("Context Menu system initialized")}function os(){O=document.createElement("div"),O.className="context-menu",O.id="contextMenu",O.style.display="none",document.body.appendChild(O)}function is(){document.addEventListener("click",e=>{O&&!O.contains(e.target)&&Ne()}),document.addEventListener("scroll",Ne,!0),document.addEventListener("keydown",e=>{e.key==="Escape"&&yt&&Ne()})}function rs(e,t,n,o={}){if(!O){s.warn?.("Context menu not initialized");return}const i=n.filter(r=>r.condition&&typeof r.condition=="function"?r.condition(o):!0);O.innerHTML="",i.forEach(r=>{const a=no(r,o);O.appendChild(a)}),O.style.left=`${e}px`,O.style.top=`${t}px`,O.style.display="block",ss(),yt={x:e,y:t,items:n,context:o}}function no(e,t){if(e.separator){const i=document.createElement("div");return i.className="context-menu-separator",i}const n=document.createElement("div");if(n.className="context-menu-item",e.disabled&&n.classList.add("disabled"),e.danger&&n.classList.add("danger"),e.icon){const i=document.createElement("span");i.className="material-symbols-outlined context-menu-icon",i.textContent=e.icon,n.appendChild(i)}const o=document.createElement("span");if(o.className="context-menu-label",o.textContent=e.label,n.appendChild(o),e.shortcut){const i=document.createElement("span");i.className="context-menu-shortcut",i.textContent=e.shortcut,n.appendChild(i)}if(e.submenu&&e.submenu.length>0){const i=document.createElement("span");i.className="material-symbols-outlined context-menu-arrow",i.textContent="chevron_right",n.appendChild(i)}return!e.disabled&&e.action&&n.addEventListener("click",i=>{i.stopPropagation(),e.action(t),Ne()}),e.submenu&&e.submenu.length>0&&n.addEventListener("mouseenter",i=>{as(n,e.submenu,t)}),n}function as(e,t,n){document.querySelectorAll(".context-submenu").forEach(a=>a.remove());const o=document.createElement("div");o.className="context-menu context-submenu",t.forEach(a=>{const l=no(a,n);o.appendChild(l)});const i=e.getBoundingClientRect();o.style.left=`${i.right}px`,o.style.top=`${i.top}px`,o.style.display="block",document.body.appendChild(o);const r=o.getBoundingClientRect();r.right>window.innerWidth&&(o.style.left=`${i.left-r.width}px`),r.bottom>window.innerHeight&&(o.style.top=`${window.innerHeight-r.height-10}px`)}function ss(){const e=O.getBoundingClientRect();e.right>window.innerWidth&&(O.style.left=`${window.innerWidth-e.width-10}px`),e.bottom>window.innerHeight&&(O.style.top=`${window.innerHeight-e.height-10}px`)}function Ne(){O&&(O.style.display="none",O.innerHTML=""),document.querySelectorAll(".context-submenu").forEach(e=>e.remove()),yt=null}function ls(){return yt!==null}function cs(e){return[{id:"undo",label:"Undo",icon:"undo",shortcut:"Ctrl+Z",action:()=>console.log("Undo"),condition:t=>t.canUndo},{id:"redo",label:"Redo",icon:"redo",shortcut:"Ctrl+Y",action:()=>console.log("Redo"),condition:t=>t.canRedo},{separator:!0},{id:"cut",label:"Cut",icon:"content_cut",shortcut:"Ctrl+X",action:()=>console.log("Cut"),condition:t=>t.hasSelection},{id:"copy",label:"Copy",icon:"content_copy",shortcut:"Ctrl+C",action:()=>console.log("Copy"),condition:t=>t.hasSelection},{id:"paste",label:"Paste",icon:"content_paste",shortcut:"Ctrl+V",action:()=>console.log("Paste"),condition:t=>t.hasClipboard},{separator:!0},{id:"select-all",label:"Select All",icon:"select_all",shortcut:"Ctrl+A",action:()=>console.log("Select All")},{id:"deselect",label:"Deselect",icon:"deselect",action:()=>console.log("Deselect"),condition:t=>t.hasSelection},{separator:!0},{id:"clear",label:"Clear Canvas",icon:"delete",action:()=>console.log("Clear"),danger:!0}]}function us(e){return[{id:"copy-color",label:"Copy Color Code",icon:"content_copy",action:()=>console.log("Copy color:",e.color)},{id:"copy-hex",label:"Copy Hex Value",icon:"tag",action:()=>console.log("Copy hex:",e.hex)},{separator:!0},{id:"set-primary",label:"Set as Primary",icon:"palette",action:()=>console.log("Set primary")},{id:"set-secondary",label:"Set as Secondary",icon:"palette",action:()=>console.log("Set secondary")}]}function ds(e){return[{id:"rename",label:"Rename",icon:"edit",action:()=>console.log("Rename tab")},{id:"duplicate",label:"Duplicate",icon:"content_copy",action:()=>console.log("Duplicate tab")},{separator:!0},{id:"close",label:"Close",icon:"close",shortcut:"Ctrl+W",action:()=>console.log("Close tab")},{id:"close-others",label:"Close Others",icon:"close",action:()=>console.log("Close others"),condition:t=>t.hasMultipleTabs},{id:"close-all",label:"Close All",icon:"close",action:()=>console.log("Close all"),danger:!0}]}function fs(e){return[{id:"open",label:"Open",icon:"folder_open",action:()=>console.log("Open file:",e.fileName)},{id:"rename",label:"Rename",icon:"edit",action:()=>console.log("Rename file")},{separator:!0},{id:"export",label:"Export",icon:"download",submenu:[{id:"export-txt",label:"As Text File",icon:"description",action:()=>console.log("Export TXT")},{id:"export-png",label:"As PNG Image",icon:"image",action:()=>console.log("Export PNG")}]},{id:"duplicate",label:"Duplicate",icon:"content_copy",action:()=>console.log("Duplicate file")},{separator:!0},{id:"delete",label:"Delete",icon:"delete",action:()=>console.log("Delete file"),danger:!0}]}const ne={init:ns,show:rs,hide:Ne,isVisible:ls,getCanvasMenuItems:cs,getPaletteMenuItems:us,getTabMenuItems:ds,getFileMenuItems:fs};class hs extends te{static CONFIG={id:"brush",name:"Brush",icon:"brush",shortcut:"B",cursor:"crosshair",hasSizeOption:!0,hasShapeOption:!1,description:"Variable size painting brush",category:"drawing"};onDrawStart(t,n,o,i){return this.drawBrush(t,n,o,i)}onDrawContinue(t,n,o,i){return this.drawBrush(t,n,o,i)}onDrawEnd(t,n,o,i){return this.drawBrush(t,n,o,i)}drawBrush(t,n,o,i){const r=o.length,a=o[0].length,l=i.brushSize||this.getOption("brushSize")||1,c=i.colorCode||0;let u=!1;const f=Math.floor(l/2);for(let d=-f;d<=f;d++)for(let h=-f;h<=f;h++){const g=t+h,p=n+d,y=h*h+d*d,m=f*f+f;if(y<=m&&g>=0&&g<a&&p>=0&&p<r){if(this.respectsSelection()&&!this.isInSelection(g,p))continue;o[p][g]!==c&&(o[p][g]=c,u=!0)}}return u}}class gs extends te{static CONFIG={id:"pencil",name:"Pencil",icon:"edit",shortcut:"P",cursor:"crosshair",hasSizeOption:!1,hasShapeOption:!1,description:"1px precise drawing",category:"drawing"};onDrawStart(t,n,o,i){return this.setPixelIfValid(t,n,o,i.colorCode)}onDrawContinue(t,n,o,i){return this.setPixelIfValid(t,n,o,i.colorCode)}onDrawEnd(t,n,o,i){return this.setPixelIfValid(t,n,o,i.colorCode)}setPixelIfValid(t,n,o,i){return this.respectsSelection()&&!this.isInSelection(t,n)?!1:this.setPixel(t,n,o,i)}}class ms extends te{static CONFIG={id:"eraser",name:"Eraser",icon:"ink_eraser",shortcut:"E",cursor:"crosshair",hasSizeOption:!0,hasShapeOption:!1,description:"Erase to transparent",category:"drawing"};onDrawStart(t,n,o,i){return this.erase(t,n,o,i)}onDrawContinue(t,n,o,i){return this.erase(t,n,o,i)}onDrawEnd(t,n,o,i){return this.erase(t,n,o,i)}erase(t,n,o,i){const r=o.length,a=o[0].length,l=i.brushSize||this.getOption("brushSize")||1;let c=!1;const u=Math.floor(l/2);for(let f=-u;f<=u;f++)for(let d=-u;d<=u;d++){const h=t+d,g=n+f,p=d*d+f*f,y=u*u+u;if(p<=y&&h>=0&&h<a&&g>=0&&g<r){if(this.respectsSelection()&&!this.isInSelection(h,g))continue;o[g][h]!==0&&(o[g][h]=0,c=!0)}}return c}}class ps extends te{static CONFIG={id:"line",name:"Line",icon:"show_chart",shortcut:"L",cursor:"crosshair",hasSizeOption:!0,hasShapeOption:!1,description:"Draw straight lines",category:"shape"};needsPreview(){return!0}onDrawStart(t,n,o,i){return!1}onDrawContinue(t,n,o,i){return this.restorePreviewData(o),this.drawLine(this.startX,this.startY,t,n,o,i)}onDrawEnd(t,n,o,i){return this.restorePreviewData(o),this.drawLine(this.startX,this.startY,t,n,o,i)}drawLine(t,n,o,i,r,a){const l=r.length,c=r[0].length,u=a.colorCode||0,f=a.brushSize||1;let d=!1;const h=Math.abs(o-t),g=Math.abs(i-n),p=t<o?1:-1,y=n<i?1:-1;let m=h-g,v=t,$=n;for(;f>1?d=this.drawBrushAt(v,$,r,u,f)||d:v>=0&&v<c&&$>=0&&$<l&&(this.respectsSelection()&&!this.isInSelection(v,$)||r[$][v]!==u&&(r[$][v]=u,d=!0)),!(v===o&&$===i);){const J=2*m;J>-g&&(m-=g,v+=p),J<h&&(m+=h,$+=y)}return d}drawBrushAt(t,n,o,i,r){const a=o.length,l=o[0].length;let c=!1;const u=Math.floor(r/2);for(let f=-u;f<=u;f++)for(let d=-u;d<=u;d++){const h=t+d,g=n+f,p=d*d+f*f,y=u*u+u;if(p<=y&&h>=0&&h<l&&g>=0&&g<a){if(this.respectsSelection()&&!this.isInSelection(h,g))continue;o[g][h]!==i&&(o[g][h]=i,c=!0)}}return c}}class vs extends te{static CONFIG={id:"rectangle",name:"Rectangle",icon:"rectangle",shortcut:"R",cursor:"crosshair",hasSizeOption:!1,hasShapeOption:!0,description:"Draw rectangles",category:"shape"};needsPreview(){return!0}onDrawStart(t,n,o,i){return!1}onDrawContinue(t,n,o,i){return this.restorePreviewData(o),this.drawRectangle(this.startX,this.startY,t,n,o,i)}onDrawEnd(t,n,o,i){return this.restorePreviewData(o),this.drawRectangle(this.startX,this.startY,t,n,o,i)}drawRectangle(t,n,o,i,r,a){const l=r.length,c=r[0].length,u=a.colorCode||0,f=a.shapeMode||this.getOption("shapeMode")||"fill";let d=!1;const h=Math.max(0,Math.min(t,o)),g=Math.min(c-1,Math.max(t,o)),p=Math.max(0,Math.min(n,i)),y=Math.min(l-1,Math.max(n,i));if(f==="fill")for(let m=p;m<=y;m++)for(let v=h;v<=g;v++)this.respectsSelection()&&!this.isInSelection(v,m)||r[m][v]!==u&&(r[m][v]=u,d=!0);else{for(let m=h;m<=g;m++)this.isInSelection(m,p)&&r[p][m]!==u&&(r[p][m]=u,d=!0),this.isInSelection(m,y)&&r[y][m]!==u&&(r[y][m]=u,d=!0);for(let m=p;m<=y;m++)this.isInSelection(h,m)&&r[m][h]!==u&&(r[m][h]=u,d=!0),this.isInSelection(g,m)&&r[m][g]!==u&&(r[m][g]=u,d=!0)}return d}}class ys extends te{static CONFIG={id:"ellipse",name:"Ellipse",icon:"circle",shortcut:"O",cursor:"crosshair",hasSizeOption:!1,hasShapeOption:!0,description:"Draw circles/ellipses",category:"shape"};needsPreview(){return!0}onDrawStart(t,n,o,i){return!1}onDrawContinue(t,n,o,i){return this.restorePreviewData(o),this.drawEllipse(this.startX,this.startY,t,n,o,i)}onDrawEnd(t,n,o,i){return this.restorePreviewData(o),this.drawEllipse(this.startX,this.startY,t,n,o,i)}drawEllipse(t,n,o,i,r,a){const l=r.length,c=r[0].length,u=a.colorCode||0,f=a.shapeMode||this.getOption("shapeMode")||"fill";let d=!1;const h=Math.floor((t+o)/2),g=Math.floor((n+i)/2),p=Math.abs(o-t)/2,y=Math.abs(i-n)/2;if(f==="fill")for(let m=Math.floor(g-y);m<=Math.ceil(g+y);m++)for(let v=Math.floor(h-p);v<=Math.ceil(h+p);v++){if(v<0||v>=c||m<0||m>=l)continue;const $=(v-h)/p,J=(m-g)/y;if($*$+J*J<=1){if(this.respectsSelection()&&!this.isInSelection(v,m))continue;r[m][v]!==u&&(r[m][v]=u,d=!0)}}else for(let m=0;m<360;m+=1){const v=m*Math.PI/180,$=Math.round(h+p*Math.cos(v)),J=Math.round(g+y*Math.sin(v));if($>=0&&$<c&&J>=0&&J<l){if(this.respectsSelection()&&!this.isInSelection($,J))continue;r[J][$]!==u&&(r[J][$]=u,d=!0)}}return d}}class bs extends te{static CONFIG={id:"fill",name:"Fill",icon:"format_color_fill",shortcut:"F",cursor:"crosshair",hasSizeOption:!1,hasShapeOption:!1,description:"Flood fill",category:"drawing"};onDrawStart(t,n,o,i){return!1}onDrawContinue(t,n,o,i){return!1}onDrawEnd(t,n,o,i){return this.floodFill(t,n,o,i)}floodFill(t,n,o,i){const r=o.length,a=o[0].length,l=i.colorCode||0;if(t<0||t>=a||n<0||n>=r)return!1;if(this.respectsSelection()&&!this.isInSelection(t,n))return this.logger.warn?.("Fill tool: clicked outside selection"),!1;const c=o[n][t];if(c===l)return!1;const u=[[t,n]],f=new Set;let d=!1;for(;u.length>0;){const[h,g]=u.pop(),p=`${h},${g}`;f.has(p)||h<0||h>=a||g<0||g>=r||o[g][h]===c&&(this.respectsSelection()&&!this.isInSelection(h,g)||(o[g][h]=l,f.add(p),d=!0,u.push([h+1,g]),u.push([h-1,g]),u.push([h,g+1]),u.push([h,g-1])))}return d}}class Cs extends te{static CONFIG={id:"select",name:"Select",icon:"select_all",shortcut:"M",cursor:"crosshair",hasSizeOption:!1,hasShapeOption:!1,description:"Rectangular selection",category:"selection"};respectsSelection(){return!1}onDrawStart(t,n,o,i){const r=o[0].length,a=o.length,l=Math.max(0,Math.min(t,r-1)),c=Math.max(0,Math.min(n,a-1));return this.startX=l,this.startY=c,this.lastX=l,this.lastY=c,!1}onDrawContinue(t,n,o,i){const r=o[0].length,a=o.length,l=Math.max(0,Math.min(t,r-1)),c=Math.max(0,Math.min(n,a-1));return this.lastX=l,this.lastY=c,!1}onDrawEnd(t,n,o,i){const r=o[0].length,a=o.length,l=Math.max(0,Math.min(t,r-1)),c=Math.max(0,Math.min(n,a-1)),u={x1:Math.min(this.startX,l),y1:Math.min(this.startY,c),x2:Math.max(this.startX,l),y2:Math.max(this.startY,c)};return this.setSelection(u),i.onSelectionChange&&i.onSelectionChange(u),!1}getSelectionData(){return this.isDrawing?{active:!0,isDrawing:!0,x1:Math.min(this.startX,this.lastX),y1:Math.min(this.startY,this.lastY),x2:Math.max(this.startX,this.lastX),y2:Math.max(this.startY,this.lastY)}:this.selectionActive&&this.selectionBounds?{active:!0,isDrawing:!1,...this.selectionBounds}:null}getSelectedPixels(t){if(!this.selectionActive||!this.selectionBounds)return null;const{x1:n,y1:o,x2:i,y2:r}=this.selectionBounds,a=[];for(let l=o;l<=r;l++){const c=[];for(let u=n;u<=i;u++)l>=0&&l<t.length&&u>=0&&u<t[0].length?c.push(t[l][u]):c.push(0);a.push(c)}return a}}class ws extends te{static CONFIG={id:"magicWand",name:"Magic Wand",icon:"auto_fix_high",shortcut:"W",cursor:"crosshair",hasSizeOption:!1,hasShapeOption:!1,description:"Select by color",category:"selection"};respectsSelection(){return!1}onDrawStart(t,n,o,i){return!1}onDrawContinue(t,n,o,i){return!1}onDrawEnd(t,n,o,i){return this.selectByColor(t,n,o,i)}selectByColor(t,n,o,i){const r=o.length,a=o[0].length;if(t<0||t>=a||n<0||n>=r)return!1;const l=o[n][t],c=[],u=[[t,n]],f=new Set;for(;u.length>0;){const[m,v]=u.pop(),$=`${m},${v}`;f.has($)||m<0||m>=a||v<0||v>=r||o[v][m]===l&&(f.add($),c.push([m,v]),u.push([m+1,v]),u.push([m-1,v]),u.push([m,v+1]),u.push([m,v-1]))}if(c.length===0)return this.clearSelection(),!1;let d=a,h=r,g=0,p=0;c.forEach(([m,v])=>{d=Math.min(d,m),h=Math.min(h,v),g=Math.max(g,m),p=Math.max(p,v)});const y={x1:d,y1:h,x2:g,y2:p};return this.setSelection(y),i.onSelectionChange&&i.onSelectionChange(y),this.logger.info?.(`Magic wand selected ${c.length} pixels`),!1}}class xs extends te{static CONFIG={id:"move",name:"Move",icon:"open_with",shortcut:"V",cursor:"move",hasSizeOption:!1,hasShapeOption:!1,description:"Move selected content",category:"navigation"};constructor(){super(),this.isMoving=!1,this.selectionData=null,this.originalSelectionBounds=null,this.currentOffset={x:0,y:0}}needsPreview(){return!0}getPreviewData(){return!this.isMoving||!this.selectionData?null:{pixelData:this.selectionData,x:this.originalSelectionBounds.x1+this.currentOffset.x,y:this.originalSelectionBounds.y1+this.currentOffset.y}}onDrawStart(t,n,o,i){if(!this.selectionActive||!this.selectionBounds)return this.logger.info?.("MoveTool: No selection active, nothing to move."),!1;this.isMoving=!0,this.originalSelectionBounds={...this.selectionBounds},this.currentOffset={x:0,y:0};const{x1:r,y1:a,x2:l,y2:c}=this.originalSelectionBounds,u=l-r+1,f=c-a+1;this.selectionData=[];for(let d=0;d<f;d++){this.selectionData[d]=[];for(let h=0;h<u;h++)this.selectionData[d][h]=o[a+d][r+h]}for(let d=a;d<=c;d++)for(let h=r;h<=l;h++)o[d][h]=0;return!0}onDrawContinue(t,n,o,i){return this.isMoving&&(this.currentOffset.x=t-this.startX,this.currentOffset.y=n-this.startY),!1}onDrawEnd(t,n,o,i){if(!this.isMoving)return!1;const r=this.originalSelectionBounds.x1+this.currentOffset.x,a=this.originalSelectionBounds.y1+this.currentOffset.y,l=this.selectionData.length,c=this.selectionData[0].length,u=o.length,f=o[0].length;for(let h=0;h<l;h++)for(let g=0;g<c;g++){const p=r+g,y=a+h;p>=0&&p<f&&y>=0&&y<u&&this.selectionData[h][g]!==0&&(o[y][p]=this.selectionData[h][g])}const d={x1:r,y1:a,x2:r+c-1,y2:a+l-1};return this.setSelection(d),C.emit(C.Events.SELECTION_CHANGED,{bounds:d}),this.resetState(),!0}onDrawCancel(){if(this.isMoving){const{x1:t,y1:n}=this.originalSelectionBounds,o=this.selectionData.length,i=this.selectionData[0].length;for(let r=0;r<o;r++)for(let a=0;a<i;a++)n+r>=0&&n+r<this.pixelData.length&&t+a>=0&&t+a<this.pixelData[0].length&&(this.pixelData[n+r][t+a]=this.selectionData[r][a])}this.resetState()}resetState(){this.isMoving=!1,this.selectionData=null,this.originalSelectionBounds=null,this.currentOffset={x:0,y:0}}}class Ss extends te{static CONFIG={id:"hand",name:"Hand",icon:"pan_tool",shortcut:"H",cursor:"grab",hasSizeOption:!1,hasShapeOption:!1,description:"Pan canvas",category:"navigation"};constructor(){super(),this.viewportModule=null}init(){super.init()}activate(){super.activate(),this.updateCursor("grab")}respectsSelection(){return!1}onDrawStart(t,n,o,i){return this.updateCursor("grabbing"),this.viewportModule&&this.viewportModule.startPan&&this.viewportModule.startPan(t,n),!1}onDrawContinue(t,n,o,i){return this.viewportModule&&this.viewportModule.continuePan&&this.viewportModule.continuePan(t,n),!1}onDrawEnd(t,n,o,i){return this.updateCursor("grab"),this.viewportModule&&this.viewportModule.endPan&&this.viewportModule.endPan(),!1}onDrawCancel(){this.updateCursor("grab")}updateCursor(t){const n=document.querySelector(".canvas-container");n&&(n.style.cursor=t)}getCursor(){return this.isDrawing?"grabbing":"grab"}}let hn=!1,H=null,gn=null;async function Es(){if(hn){s.warn("Application already initialized.");return}try{s.info("Inline.px initializing..."),H=await At.loadConstants(),Ue.init(H),await Is(),Ts(),Os(),zs(),hn=!0,s.info("Inline.px ready!"),C.emit("app:ready")}catch(e){s.error("Application initialization failed",e),C.emit("app:error",e),alert(`Critical error during initialization: ${e.message}. The app may not function correctly.`)}}async function Is(){z.init(),await U.init("colorPalette",As);const{defaultWidth:e,defaultHeight:t}=H.canvas;await w.init("pixelCanvas",e,t,Rs),await Ds(),q.init(!1),de.init(),rt.init(),ge.init({onHistoryChange:ks}),ne.init(),s.info("Core systems initialized")}async function Ds(){const e=[hs,gs,ms,ps,vs,ys,bs,Cs,ws,xs,Ss];x.init({onToolChange:Ps,onToolOptionChange:Ns,sharedOptions:{brushSize:H.tools.defaultBrushSize,shapeMode:H.tools.defaultShapeMode,colorCode:1}});const t=x.registerTools(e);s.info(`Registered ${t} tools`),x.setCurrentTool("brush")}function Ts(){$s(),Ls(),Bs(),Ms(),Fs(),me(),bt()}function $s(){const e=document.getElementById("toolbox");if(!e)return;e.innerHTML="",x.getAllTools().forEach(n=>{const o=document.createElement("button");o.className="tool-btn",o.dataset.tool=n.id,o.title=`${n.name} (${n.shortcut})`,n.id===x.getCurrentToolId()&&o.classList.add("active"),o.innerHTML=`<span class="material-symbols-outlined tool-icon">${n.icon}</span><span class="tool-label">${n.name}</span><span class="tool-shortcut">${n.shortcut}</span>`,o.addEventListener("click",()=>x.setCurrentTool(n.id)),e.appendChild(o)}),s.debug("Toolbox setup complete")}function Ls(){N("newBtn",oo),N("saveBtn",io),N("loadBtn",ro),N("undoBtn",so),N("redoBtn",Pt),N("exportFileBtn",Ws),N("importStringBtn",Vs),N("clearBtn",js),N("copyLiveStringBtn",Ks)}function Bs(){document.querySelectorAll(".tool-size-btn").forEach(e=>{e.addEventListener("click",()=>{const t=parseInt(e.dataset.size);x.setToolOption("brushSize",t),document.querySelectorAll(".tool-size-btn").forEach(n=>n.classList.remove("active")),e.classList.add("active")})}),document.querySelectorAll(".tool-mode-btn").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.mode;x.setToolOption("shapeMode",t),document.querySelectorAll(".tool-mode-btn").forEach(n=>n.classList.remove("active")),e.classList.add("active")})}),document.querySelectorAll(".preset-btn").forEach(e=>{e.addEventListener("click",()=>{const t=parseInt(e.dataset.size);document.getElementById("canvasWidth").value=t,document.getElementById("canvasHeight").value=t,Et()})}),N("resizeBtn",Et),["canvasWidth","canvasHeight"].forEach(e=>{const t=document.getElementById(e);t&&(t.addEventListener("keypress",n=>n.key==="Enter"&&Et()),t.addEventListener("input",bt))}),N("gridToggleBtn",ao)}function Ms(){N("welcomeNewBtn",_s),N("welcomeLoadBtn",Ys),N("closeNewFileModal",zt),N("cancelNewFileBtn",zt),N("confirmNewFileBtn",Gs),N("closeModal",()=>{document.getElementById("fileModal").style.display="none"}),document.querySelectorAll(".preset-btn-modal").forEach(e=>{e.addEventListener("click",()=>{const t=parseInt(e.dataset.size);document.getElementById("newFileWidth").value=t,document.getElementById("newFileHeight").value=t,document.querySelectorAll(".preset-btn-modal").forEach(n=>n.classList.remove("active")),e.classList.add("active")})}),["newFileWidth","newFileHeight"].forEach(e=>{const t=document.getElementById(e);t&&t.addEventListener("input",()=>{const n=parseInt(document.getElementById("newFileWidth").value),o=parseInt(document.getElementById("newFileHeight").value);document.querySelectorAll(".preset-btn-modal").forEach(i=>{const r=parseInt(i.dataset.size);i.classList.toggle("active",n===r&&o===r)})})}),s.debug("Welcome screen setup complete")}function Fs(){document.addEventListener("contextmenu",e=>{if(e.preventDefault(),s.info?.("Context menu triggered at:",e.clientX,e.clientY),e.target.closest("#canvasContainer")){const r={canUndo:ge?.canUndo()||!1,canRedo:ge?.canRedo()||!1,hasSelection:!1,hasClipboard:!1};ne.show(e.clientX,e.clientY,ne.getCanvasMenuItems(r),r);return}const n=e.target.closest(".color-swatch");if(n){const r=parseInt(n.dataset.index),a=U.getColor(r),l={colorIndex:r,color:n.dataset.char||"0",hex:a||"#000000"};ne.show(e.clientX,e.clientY,ne.getPaletteMenuItems(l),l);return}const o=e.target.closest(".tab");if(o){const r=o.dataset.tabId,a=q?.getAllTabs()||[],l={tabId:r,hasMultipleTabs:a.length>1};ne.show(e.clientX,e.clientY,ne.getTabMenuItems(l),l);return}const i=e.target.closest(".file-grid-item");if(i){s.info?.("File item detected:",i);const a={fileName:i.querySelector(".file-grid-name")?.textContent||"Unknown",fileElement:i};ne.show(e.clientX,e.clientY,ne.getFileMenuItems(a),a);return}s.info?.("No specific target, showing generic menu"),ne.show(e.clientX,e.clientY,[{id:"about",label:"About Inline.px",icon:"info",action:()=>console.log("About")}],{})}),s.debug("Context menus setup complete")}function Os(){document.addEventListener("keydown",e=>{if(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA")return;const t=e.key.toLowerCase();if(e.key==="Escape"){e.preventDefault(),x.clearSelection();return}if(t==="g"&&!e.ctrlKey&&!e.metaKey&&!e.shiftKey&&!e.altKey){e.preventDefault(),ao();return}if(x&&/^[a-z]$/.test(t)){const n=x.getToolByShortcut(t.toUpperCase());if(n){e.preventDefault(),x.setCurrentTool(n.getId());return}}if(e.ctrlKey||e.metaKey){const n={z:so,y:Pt,n:oo,s:io,o:ro};n[t]&&(e.preventDefault(),t==="z"&&e.shiftKey?Pt():n[t]())}})}function zs(){C.on(C.Events.FILE_LOADED,()=>{wt(),me()})}function Ps(e,t){document.querySelectorAll(".tool-btn").forEach(i=>i.classList.toggle("active",i.dataset.tool===e)),document.getElementById("currentToolName").textContent=t.name,document.querySelector(".canvas-container").style.cursor=t.cursor;const n=document.getElementById("brushSizeOption"),o=document.getElementById("shapeModeOption");n.classList.toggle("hidden",!t.hasSizeOption),o.classList.toggle("hidden",!t.hasShapeOption),s.debug(`Tool changed to: ${t.name}`)}function Ns(e,t){s.debug(`Tool option changed: ${e} = ${t}`)}function As(e,t){document.getElementById("currentColorDisplay").style.backgroundColor=t,x.setToolOption("colorCode",e)}function Rs(){me(),q.markCurrentTabDirty(),clearTimeout(gn),gn=setTimeout(()=>{const e=w.exportToString();ge.pushState(e,"Paint")},H.history.debounceTime)}function ks({canUndo:e,canRedo:t,undoCount:n,redoCount:o}){const i=document.getElementById("undoBtn"),r=document.getElementById("redoBtn");i.disabled=!e,i.title=e?`Undo (${n} available)`:"Undo",r.disabled=!t,r.title=t?`Redo (${o} available)`:"Redo"}function me(){const e=w.exportToString();document.getElementById("liveExportString").textContent=It.formatDataString(e,50),document.getElementById("stringLength").textContent=e.length}function bt(){const e=parseInt(document.getElementById("canvasWidth")?.value),t=parseInt(document.getElementById("canvasHeight")?.value);document.querySelectorAll(".preset-btn").forEach(n=>{n.classList.toggle("active",e===parseInt(n.dataset.size)&&t===parseInt(n.dataset.size))})}function Hs(){document.getElementById("welcomeScreen").style.display="flex",document.getElementById("canvasContainer").style.display="none"}window.showWelcomeScreen=Hs;function Ct(){document.getElementById("welcomeScreen").style.display="none",document.getElementById("canvasContainer").style.display="flex"}function _s(){const e=document.getElementById("newFileModal");e.style.display="flex",document.getElementById("newFileName").value="",document.getElementById("newFileWidth").value="8",document.getElementById("newFileHeight").value="8",document.querySelectorAll(".preset-btn-modal").forEach(t=>{t.classList.toggle("active",t.dataset.size==="8")}),setTimeout(()=>document.getElementById("newFileName").focus(),100)}function zt(){document.getElementById("newFileModal").style.display="none"}function Gs(){const e=document.getElementById("newFileName").value.trim()||"Untitled",t=parseInt(document.getElementById("newFileWidth").value),n=parseInt(document.getElementById("newFileHeight").value);if(t<H.canvas.minSize||t>H.canvas.maxSize||n<H.canvas.minSize||n>H.canvas.maxSize){alert(`Canvas size must be between ${H.canvas.minSize}×${H.canvas.minSize} and ${H.canvas.maxSize}×${H.canvas.maxSize}`);return}zt(),Ct(),q.createNewTab(e,t,n),s.info(`Created new file: ${e} (${t}×${n})`)}async function Ys(){const e=fe.getAllFiles();if(e.length===0){await z.alert("No Files","No saved files found. Create a new file to get started.","info");return}const t=document.getElementById("fileModal"),n=document.getElementById("fileList"),o=document.getElementById("noFilesMessage");n.innerHTML="",e.forEach(i=>{const r=Xs(i);r.addEventListener("click",()=>{qs(i),t.style.display="none"}),n.appendChild(r)}),o.style.display=e.length===0?"block":"none",t.style.display="flex"}function Xs(e){const t=document.createElement("div");t.className="file-grid-item";const o=Us(e.data).toDataURL("image/png"),r=new Date(e.timestamp).toLocaleDateString(),a=e.width&&e.height?`${e.width}×${e.height}`:"Unknown";return t.innerHTML=`
        <div class="file-grid-preview">
            <img src="${o}" alt="${e.name}" />
        </div>
        <div class="file-grid-details">
            <div class="file-grid-name">${e.name}</div>
            <div class="file-grid-meta">
                <span class="file-grid-info">${a}</span>
                <span class="file-grid-date">${r}</span>
            </div>
        </div>
    `,t}function Us(e){const t=document.createElement("canvas"),n=t.getContext("2d");try{let o=e;k&&k.isCompressed(e)&&(o=k.decompress(e),s.debug?.("Preview: Decompressed data"));const i=o.match(/^(\d+)x(\d+):(.+)$/);if(!i)return s.warn?.("Preview: Invalid data format:",o.substring(0,50)),t.width=64,t.height=64,n.fillStyle="#333",n.fillRect(0,0,64,64),t;const r=parseInt(i[1]),a=parseInt(i[2]),l=i[3];s.debug?.(`Preview: Rendering ${r}×${a}, data length: ${l.length}`);const c=Math.min(64/r,64/a);t.width=Math.floor(r*c),t.height=Math.floor(a*c),n.imageSmoothingEnabled=!1;let u=0;for(let f=0;f<a;f++)for(let d=0;d<r;d++){const h=f*r+d;if(h<l.length){const g=l[h],p=U.getIndexFromChar(g);if(p===0)continue;const y=U.getColor(p);y&&(n.fillStyle=y,n.fillRect(d*c,f*c,c,c),u++)}}s.debug?.(`Preview: Drew ${u} pixels`)}catch(o){s.error?.("Preview generation failed:",o),t.width=64,t.height=64,n.fillStyle="#f00",n.fillRect(0,0,64,64)}return t}function qs(e){Ct();const t=e.data.match(/^(\d+)x(\d+):/),n=t?parseInt(t[1]):16,o=t?parseInt(t[2]):16;q.createNewTab(e.name,n,o,e.data),fe.setCurrentFileName(e.name),q.markCurrentTabClean(),s.info(`Loaded file: ${e.name}`)}function oo(){Ct(),q.createNewTab()}async function io(){let e=q.getCurrentTab()?.name||fe.getCurrentFileName();const t=w.exportToString();await fe.save(t,e)&&(s.info("Saved successfully"),q.markCurrentTabClean(),de.forceSave())}function ro(){fe.showLoadDialog(e=>{w.importFromString(e.data)&&(Ct(),q.setCurrentTabName(e.name),fe.setCurrentFileName(e.name),q.markCurrentTabClean(),wt(),me())})}async function Ws(){let e=w.exportToString();const t=fe.getCurrentFileName()||"pixelart",n=await z.exportDialog(e);if(n)switch(n.compress&&(e=k.smartCompress(e).data),n.format){case"copy-string":await $n.copyWithFeedback(e),await z.alert("Copied!","Pixel art string copied to clipboard.","success");break;case"download-txt":fe.exportAsFile(e,t);break;case"download-png":{const o=t.replace(/\.txt$/,"")+".png";ts.exportToPNG(n.scale,o),await z.alert("PNG Exported!",`Exported as ${o} at ${n.scale}× scale.`,"success");break}}}function Vs(){const e=document.getElementById("importModal"),t=document.getElementById("importTextarea");e&&t&&(t.value="",e.classList.add("flex"),e.classList.remove("hidden"),t.focus())}async function js(){await z.confirm("Clear Canvas","Are you sure you want to clear the canvas? This cannot be undone.",{confirmText:"Clear",type:"warning",dangerous:!0})&&(w.clear(),me())}async function Ks(){const e=w.exportToString(),t=document.getElementById("copyLiveStringBtn");await $n.copyWithFeedback(e,t)}function ao(){const t=!R.getGridVisible();R.setGridVisible(t);const n=document.getElementById("gridToggleBtn");if(n){const o=n.querySelector(".material-symbols-outlined");o&&(o.textContent=t?"grid_on":"grid_off")}s.info?.(`Grid ${t?"enabled":"disabled"}`)}async function Et(){const e=parseInt(document.getElementById("canvasWidth")?.value),t=parseInt(document.getElementById("canvasHeight")?.value),n=Ue.validateCanvasDimensions(e,t);if(!n.valid){await z.alert("Invalid Size",n.error,"warning");return}w.hasContent()&&!await z.confirm("Resize Canvas","Resizing may crop or add empty space to your artwork. Continue?",{confirmText:"Resize",type:"warning"})||w.resize(e,t)&&(me(),bt(),rt&&rt.updateCanvasSize())}function so(){if(!ge.canUndo())return s.debug("Nothing to undo");const e=w.exportToString(),t=ge.undo(e);t&&(w.importFromString(t),wt(),me(),s.info("Undo performed"))}function Pt(){if(!ge.canRedo())return s.debug("Nothing to redo");const e=w.exportToString(),t=ge.redo(e);t&&(w.importFromString(t),wt(),me(),s.info("Redo performed"))}function wt(){const{width:e,height:t}=w.getDimensions();document.getElementById("canvasWidth").value=e,document.getElementById("canvasHeight").value=t,bt()}function N(e,t){const n=document.getElementById(e);n&&n.addEventListener("click",t)}Es();</script>
  <style rel="stylesheet" crossorigin>:root{--primary-color: #0088cc;--primary-hover: #00a0ee;--primary-active: #00b8ff;--secondary-color: #0066ff;--secondary-hover: #0052cc;--accent-cyan: #00d9ff;--accent-cyan-bright: #00ffff;--accent-blue: #0052cc;--danger-color: #ff4466;--danger-hover: #ee3355;--success-color: #00d9ff;--warning-color: #ffaa00;--info-color: #0088cc;--app-bg: #0a0e1a;--workspace-bg: #121829;--panel-bg: #1a2035;--surface-bg: #202840;--elevated-bg: #283050;--hover-bg: #303860;--border-color: #2a3555;--border-light: #354066;--border-dark: #1a2035;--border-accent: var(--accent-cyan);--text-primary: #ffffff;--text-secondary: #b0b0b0;--text-muted: #808080;--text-disabled: #606060;--shadow-sm: 0 1px 3px rgba(0, 0, 0, .5);--shadow-md: 0 2px 6px rgba(0, 0, 0, .6);--shadow-lg: 0 4px 12px rgba(0, 0, 0, .7);--shadow-xl: 0 8px 24px rgba(0, 0, 0, .8);--shadow-cyan: 0 0 20px rgba(0, 217, 255, .3);--shadow-blue: 0 0 20px rgba(0, 102, 255, .3);--spacing-xs: 4px;--spacing-sm: 8px;--spacing-md: 12px;--spacing-lg: 16px;--spacing-xl: 24px;--spacing-2xl: 32px;--spacing-3xl: 48px;--radius-sm: 3px;--radius-md: 4px;--radius-lg: 6px;--radius-xl: 8px;--toolbox-width: 80px;--properties-width: 280px;--menu-bar-height: 48px;--info-bar-height: 36px;--font-family: "Pixelify Sans", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Inter", sans-serif;--font-mono: "SF Mono", "Monaco", "Cascadia Code", "Courier New", monospace;--font-size-xs: 10px;--font-size-sm: 11px;--font-size-base: 12px;--font-size-md: 13px;--font-size-lg: 14px;--font-size-xl: 16px;--font-size-2xl: 18px;--transition-fast: .1s ease;--transition-normal: .2s ease;--transition-slow: .3s ease;--z-base: 1;--z-dropdown: 100;--z-sticky: 200;--z-modal-backdrop: 900;--z-modal: 1000;--z-tooltip: 1100}*{margin:0;padding:0;box-sizing:border-box}html{font-size:16px}body{font-family:var(--font-family);font-size:var(--font-size-base);background:var(--app-bg);color:var(--text-primary);line-height:1.5;overflow:hidden;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}button{font-family:inherit;cursor:pointer;border:none;background:none;color:inherit;font-size:inherit}input,textarea,select{font-family:inherit;font-size:inherit;color:inherit}h1,h2,h3,h4,h5,h6{font-weight:600;line-height:1.2}code{font-family:var(--font-mono)}::-webkit-scrollbar{width:10px;height:10px}::-webkit-scrollbar-track{background:var(--surface-bg)}::-webkit-scrollbar-thumb{background:var(--border-color);border-radius:var(--radius-sm)}::-webkit-scrollbar-thumb:hover{background:var(--border-light)}::selection{background:var(--primary-color);color:#fff}.hidden{display:none!important}.visible{display:block!important}.flex{display:flex!important}.inline{display:inline!important}.inline-block{display:inline-block!important}.cursor-default{cursor:default!important}.cursor-pointer{cursor:pointer!important}.cursor-grab{cursor:grab!important}.cursor-grabbing{cursor:grabbing!important}.cursor-move{cursor:move!important}.cursor-crosshair{cursor:crosshair!important}.cursor-text{cursor:text!important}.cursor-not-allowed{cursor:not-allowed!important}.opacity-0{opacity:0!important}.opacity-50{opacity:.5!important}.opacity-100{opacity:1!important}.transform-none{transform:none!important}.pointer-events-none{pointer-events:none!important}.pointer-events-auto{pointer-events:auto!important}.overflow-hidden{overflow:hidden!important}.overflow-auto{overflow:auto!important}.overflow-scroll{overflow:scroll!important}.relative{position:relative!important}.absolute{position:absolute!important}.fixed{position:fixed!important}.sticky{position:sticky!important}.z-0{z-index:0!important}.z-10{z-index:10!important}.z-20{z-index:20!important}.z-30{z-index:30!important}.z-40{z-index:40!important}.z-50{z-index:50!important}.w-full{width:100%!important}.h-full{height:100%!important}.w-auto{width:auto!important}.h-auto{height:auto!important}.text-left{text-align:left!important}.text-center{text-align:center!important}.text-right{text-align:right!important}.visible{visibility:visible!important}.invisible{visibility:hidden!important}.material-symbols-outlined{font-family:Material Symbols Outlined;font-weight:400;font-style:normal;font-size:24px;line-height:1;letter-spacing:normal;text-transform:none;display:inline-block;white-space:nowrap;word-wrap:normal;direction:ltr;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;text-rendering:optimizeLegibility;font-feature-settings:"liga"}.tool-icon.material-symbols-outlined{font-size:28px}.menu-btn .material-symbols-outlined{font-size:20px;vertical-align:middle}.dialog-icon.material-symbols-outlined,.export-format-icon.material-symbols-outlined{font-size:32px}.icon-btn .material-symbols-outlined{font-size:18px}.material-symbols-outlined.icon-primary{color:var(--primary-color)}.material-symbols-outlined.icon-success{color:var(--success-color)}.material-symbols-outlined.icon-warning{color:var(--warning-color)}.material-symbols-outlined.icon-danger{color:var(--danger-color)}.material-symbols-outlined.icon-muted{color:var(--text-muted)}.app-container{display:flex;height:100vh;width:100vw;background:var(--app-bg)}.workspace{flex:1;display:flex;flex-direction:column;background:var(--workspace-bg);overflow:hidden}.menu-bar{height:var(--menu-bar-height);background:var(--panel-bg);border-bottom:1px solid var(--border-color);display:flex;align-items:center;padding:0 var(--spacing-md);gap:var(--spacing-md)}.menu-section{display:flex;gap:var(--spacing-xs);align-items:center}.menu-section:not(:last-child):after{content:"";width:1px;height:20px;background:var(--border-color);margin-left:var(--spacing-md)}.info-bar{min-height:var(--info-bar-height);background:var(--surface-bg);border-bottom:1px solid var(--border-color);display:flex;align-items:center;padding:var(--spacing-sm) var(--spacing-md);gap:var(--spacing-lg);font-size:var(--font-size-sm);flex-wrap:wrap}.info-group{display:flex;align-items:center;gap:var(--spacing-sm)}.info-spacer{flex:1;min-width:20px}.info-label{color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px;font-size:var(--font-size-xs);font-weight:600}.info-value{color:var(--text-primary);font-weight:500}.info-value-small{color:var(--text-secondary);font-size:var(--font-size-xs)}.color-indicator{width:20px;height:20px;border:2px solid var(--border-color);border-radius:var(--radius-sm)}.tool-size-buttons,.tool-mode-buttons{display:flex;gap:4px}.tool-size-btn,.tool-mode-btn{padding:3px 8px;background:var(--panel-bg);border:1px solid var(--border-color);border-radius:var(--radius-sm);font-size:var(--font-size-xs);font-weight:600;color:var(--text-secondary);cursor:pointer;transition:all var(--transition-fast);min-width:24px;text-align:center}.tool-size-btn:hover,.tool-mode-btn:hover{background:var(--elevated-bg);border-color:var(--border-light);color:var(--text-primary)}.tool-size-btn.active,.tool-mode-btn.active{background:var(--primary-color);border-color:var(--primary-color);color:#fff}.tool-mode-btn{padding:3px 12px}.canvas-container{flex:1;display:flex;align-items:center;justify-content:center;overflow:auto;padding:var(--spacing-xl);background:var(--workspace-bg)}.canvas-wrapper{display:inline-block;background:var(--surface-bg);padding:var(--spacing-lg);border-radius:var(--radius-lg);box-shadow:var(--shadow-xl);border:1px solid var(--border-color)}#pixelCanvas{display:block;border:2px solid var(--border-light);cursor:crosshair;image-rendering:pixelated;image-rendering:crisp-edges}.export-panel{background:var(--panel-bg);border-top:1px solid var(--border-color);padding:var(--spacing-md)}.export-panel-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--spacing-sm)}.export-panel-header h3{font-size:var(--font-size-md);font-weight:600;color:var(--text-secondary)}.export-content{background:var(--surface-bg);border:1px solid var(--border-color);border-radius:var(--radius-md);padding:var(--spacing-md);margin-bottom:var(--spacing-sm);overflow-x:auto;max-height:80px}.export-code{font-family:var(--font-mono);font-size:var(--font-size-sm);color:var(--primary-color);word-break:break-all;display:block;line-height:1.6}.export-info{display:flex;gap:var(--spacing-xl);font-size:var(--font-size-xs);color:var(--text-muted)}.export-info strong{color:var(--text-secondary)}.toolbox{width:var(--toolbox-width);background:var(--panel-bg);border-right:1px solid var(--border-color);display:flex;flex-direction:column;overflow-y:auto;flex-shrink:0}.toolbox-header{padding:var(--spacing-md);border-bottom:1px solid var(--border-color);background:var(--elevated-bg);flex-shrink:0}.toolbox-header h2{font-size:var(--font-size-sm);font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--text-muted);text-align:center}.toolbox-content{padding:var(--spacing-sm);display:flex;flex-direction:column;gap:var(--spacing-xs);flex:1}.tool-btn{width:100%;aspect-ratio:1;background:var(--surface-bg);border:1px solid var(--border-color);border-radius:var(--radius-md);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;cursor:pointer;transition:all var(--transition-fast);position:relative;padding:var(--spacing-xs)}.tool-btn:hover{background:var(--hover-bg);border-color:var(--border-light);transform:translateY(-1px)}.tool-btn:active{transform:translateY(0)}.tool-btn.active{background:var(--primary-color);border-color:var(--primary-color);color:#fff}.tool-btn.active:hover{background:var(--primary-hover)}.tool-icon{font-size:clamp(20px,4vw,28px);line-height:1;display:block;flex-shrink:0}.tool-label{font-size:clamp(8px,1.2vw,11px);font-weight:600;text-align:center;line-height:1.1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;width:100%}.tool-shortcut{position:absolute;bottom:3%;right:5%;font-size:clamp(7px,1vw,9px);opacity:.5;font-weight:700;line-height:1}.tool-btn.active .tool-shortcut{opacity:.9}.properties-panel{width:var(--properties-width);background:var(--panel-bg);border-left:1px solid var(--border-color);display:flex;flex-direction:column;overflow-y:auto}.panel-section{border-bottom:1px solid var(--border-color);padding:var(--spacing-md)}.panel-title{font-size:var(--font-size-sm);font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--text-muted);margin-bottom:var(--spacing-md)}.tool-options{display:flex;flex-direction:column;gap:var(--spacing-lg)}.option-group{display:flex;flex-direction:column;gap:var(--spacing-sm)}.option-group label{font-size:var(--font-size-sm);color:var(--text-secondary);font-weight:500}.size-buttons{display:grid;grid-template-columns:repeat(4,1fr);gap:var(--spacing-xs)}.size-btn{padding:var(--spacing-sm);background:var(--surface-bg);border:1px solid var(--border-color);border-radius:var(--radius-md);font-size:var(--font-size-xs);font-weight:600;transition:all var(--transition-fast)}.size-btn:hover{background:var(--hover-bg);border-color:var(--border-light)}.size-btn.active{background:var(--primary-color);border-color:var(--primary-color);color:#fff}.mode-buttons{display:grid;grid-template-columns:1fr 1fr;gap:var(--spacing-xs)}.mode-btn{padding:var(--spacing-sm);background:var(--surface-bg);border:1px solid var(--border-color);border-radius:var(--radius-md);font-size:var(--font-size-sm);font-weight:500;transition:all var(--transition-fast)}.mode-btn:hover{background:var(--hover-bg);border-color:var(--border-light)}.mode-btn.active{background:var(--primary-color);border-color:var(--primary-color);color:#fff}.size-presets{display:grid;grid-template-columns:repeat(2,1fr);gap:var(--spacing-xs);margin-bottom:var(--spacing-md)}.preset-btn{padding:var(--spacing-sm);background:var(--surface-bg);border:1px solid var(--border-color);border-radius:var(--radius-md);font-size:var(--font-size-sm);font-weight:600;transition:all var(--transition-fast)}.preset-btn:hover{background:var(--hover-bg);border-color:var(--border-light)}.preset-btn.active{background:var(--primary-color);border-color:var(--primary-color);color:#fff}.custom-size{display:flex;flex-direction:column;gap:var(--spacing-sm)}.size-input-row{display:flex;align-items:center;gap:var(--spacing-xs)}.size-input-row input{flex:1;padding:var(--spacing-sm);background:var(--surface-bg);border:1px solid var(--border-color);border-radius:var(--radius-md);text-align:center;font-weight:600}.size-input-row input:focus{outline:none;border-color:var(--primary-color)}.size-input-row span{color:var(--text-muted);font-weight:600}.color-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:3px}.color-swatch{aspect-ratio:1;border:2px solid var(--border-color);border-radius:var(--radius-sm);cursor:pointer;transition:all var(--transition-fast);position:relative}.color-swatch:hover{transform:scale(1.15);border-color:var(--border-light);box-shadow:var(--shadow-md);z-index:10}.color-swatch.active{border-color:gold;box-shadow:0 0 8px #ffd70099;transform:scale(1.1);z-index:10}.color-swatch[data-code="0"]{background:repeating-conic-gradient(#666 0% 25%,#444 0% 50%) 50% / 6px 6px}.menu-btn{padding:var(--spacing-sm) var(--spacing-md);background:var(--surface-bg);border:1px solid transparent;border-radius:var(--radius-md);font-size:var(--font-size-sm);font-weight:500;display:flex;align-items:center;gap:var(--spacing-xs);transition:all var(--transition-fast)}.menu-btn:hover{background:var(--hover-bg);border-color:var(--border-color)}.menu-btn:active{transform:scale(.98)}.menu-btn span{font-size:16px}.menu-btn-danger{color:var(--danger-color)}.menu-btn-danger:hover{background:#f443361a;border-color:var(--danger-color)}.btn-primary{width:100%;padding:var(--spacing-sm) var(--spacing-md);background:var(--primary-color);border:1px solid var(--primary-color);border-radius:var(--radius-md);font-size:var(--font-size-sm);font-weight:600;color:#fff;transition:all var(--transition-fast)}.btn-primary:hover{background:var(--primary-hover);border-color:var(--primary-hover)}.btn-primary:active{transform:scale(.98)}.btn-secondary{padding:var(--spacing-sm) var(--spacing-lg);background:var(--surface-bg);border:1px solid var(--border-color);border-radius:var(--radius-md);font-size:var(--font-size-sm);font-weight:500;transition:all var(--transition-fast)}.btn-secondary:hover{background:var(--hover-bg);border-color:var(--border-light)}.icon-btn{padding:var(--spacing-xs);background:var(--surface-bg);border:1px solid var(--border-color);border-radius:var(--radius-md);font-size:16px;transition:all var(--transition-fast)}.icon-btn:hover{background:var(--hover-bg);border-color:var(--primary-color);transform:scale(1.05)}.btn-close{width:32px;height:32px;background:transparent;border:none;border-radius:var(--radius-md);font-size:24px;color:var(--text-secondary);display:flex;align-items:center;justify-content:center;transition:all var(--transition-fast)}.btn-close:hover{background:var(--surface-bg);color:var(--text-primary)}.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:#000000d9;display:flex;justify-content:center;align-items:center;z-index:var(--z-modal);-webkit-backdrop-filter:blur(4px);backdrop-filter:blur(4px)}.modal-content{background:var(--panel-bg);border:1px solid var(--border-color);border-radius:var(--radius-xl);max-width:600px;width:90%;max-height:80vh;display:flex;flex-direction:column;box-shadow:var(--shadow-xl)}.modal-header{display:flex;justify-content:space-between;align-items:center;padding:var(--spacing-lg);border-bottom:1px solid var(--border-color)}.modal-header h2{font-size:var(--font-size-xl);font-weight:600}.modal-body{padding:var(--spacing-lg);overflow-y:auto;flex:1}.modal-body p{margin-bottom:var(--spacing-md);color:var(--text-secondary);font-size:var(--font-size-sm)}.modal-body textarea{width:100%;padding:var(--spacing-md);background:var(--surface-bg);border:1px solid var(--border-color);border-radius:var(--radius-md);font-family:var(--font-mono);font-size:var(--font-size-sm);resize:vertical;min-height:120px}.modal-body textarea:focus{outline:none;border-color:var(--primary-color)}.modal-footer{padding:var(--spacing-lg);border-top:1px solid var(--border-color);display:flex;justify-content:flex-end;gap:var(--spacing-sm)}#fileList{display:flex;flex-direction:column;gap:var(--spacing-sm)}.file-item{display:flex;justify-content:space-between;align-items:center;padding:var(--spacing-md);background:var(--surface-bg);border:1px solid var(--border-color);border-radius:var(--radius-md);transition:all var(--transition-fast)}.file-item:hover{border-color:var(--primary-color);background:var(--hover-bg)}.file-item-info{flex:1}.file-item-name{font-weight:600;margin-bottom:var(--spacing-xs)}.file-item-meta{font-size:var(--font-size-xs);color:var(--text-secondary)}.file-item-actions{display:flex;gap:var(--spacing-xs)}.file-item-actions .btn-secondary,.file-item-actions .btn-primary{padding:var(--spacing-xs) var(--spacing-md);font-size:var(--font-size-xs)}.dialog-overlay{position:fixed;inset:0;background:#000000bf;-webkit-backdrop-filter:blur(4px);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;z-index:var(--z-modal);animation:fadeIn .2s ease}.dialog-content{background:var(--panel-bg);border:1px solid var(--border-color);border-radius:var(--radius-lg);box-shadow:var(--shadow-xl);min-width:400px;max-width:600px;max-height:80vh;overflow:hidden;display:flex;flex-direction:column;opacity:0;transform:scale(.9) translateY(-20px);transition:all .2s ease}.dialog-content.dialog-show{opacity:1;transform:scale(1) translateY(0)}.dialog-content.dialog-info .dialog-icon{color:var(--info-color)}.dialog-content.dialog-success .dialog-icon{color:var(--success-color)}.dialog-content.dialog-warning .dialog-icon{color:var(--warning-color)}.dialog-content.dialog-error .dialog-icon{color:var(--danger-color)}.dialog-header{display:flex;align-items:center;gap:var(--spacing-md);padding:var(--spacing-lg);border-bottom:1px solid var(--border-color)}.dialog-icon{font-size:32px;line-height:1}.dialog-title{font-size:var(--font-size-xl);font-weight:600;color:var(--text-primary);margin:0}.dialog-body{padding:var(--spacing-xl);overflow-y:auto}.dialog-message{color:var(--text-secondary);font-size:var(--font-size-md);line-height:1.6;margin:0 0 var(--spacing-md) 0}.dialog-input{width:100%;padding:var(--spacing-md);background:var(--surface-bg);border:1px solid var(--border-color);border-radius:var(--radius-md);color:var(--text-primary);font-size:var(--font-size-md);font-family:var(--font-family);margin-top:var(--spacing-md);transition:all var(--transition-fast)}.dialog-input:focus{outline:none;border-color:var(--primary-color);background:var(--elevated-bg)}.export-options{display:flex;flex-direction:column;gap:var(--spacing-lg)}.export-preview{background:var(--surface-bg);border:1px solid var(--border-color);border-radius:var(--radius-md);padding:var(--spacing-md)}.export-preview-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--spacing-sm);font-size:var(--font-size-sm)}.export-preview-size{color:var(--text-muted);font-weight:400}.export-code-preview{display:block;font-family:var(--font-mono);font-size:var(--font-size-sm);color:var(--primary-color);word-break:break-all;line-height:1.6;max-height:60px;overflow-y:auto}.export-option-group{background:var(--surface-bg);border:1px solid var(--border-color);border-radius:var(--radius-md);padding:var(--spacing-md)}.export-checkbox-label{display:flex;align-items:center;gap:var(--spacing-sm);cursor:pointer;font-size:var(--font-size-md);color:var(--text-primary)}.export-checkbox{width:18px;height:18px;cursor:pointer}.export-savings{margin-left:auto;color:var(--success-color);font-weight:600;font-size:var(--font-size-sm)}.export-savings.export-warning{color:#e2a04a}.export-option-info{margin-top:var(--spacing-sm);margin-left:26px;font-size:var(--font-size-xs);color:var(--text-muted);line-height:1.5}.compression-preview{display:grid;grid-template-columns:1fr auto 1fr;gap:var(--spacing-md);margin-top:var(--spacing-md);padding-top:var(--spacing-md);border-top:1px solid var(--border-color)}.compression-preview-section{display:flex;flex-direction:column;gap:var(--spacing-xs);min-width:0}.compression-preview-label{display:flex;justify-content:space-between;align-items:center;font-size:var(--font-size-xs)}.compression-preview-size{color:var(--text-muted);font-weight:400}.compression-highlight{color:var(--success-color);font-weight:600}.compression-preview-code{display:block;font-family:var(--font-mono);font-size:var(--font-size-xs);color:var(--text-secondary);background:var(--panel-bg);padding:var(--spacing-xs) var(--spacing-sm);border-radius:var(--radius-sm);word-break:break-all;line-height:1.5;max-height:60px;overflow-y:auto}.compression-preview-arrow{display:flex;align-items:center;justify-content:center;font-size:var(--font-size-xl);color:var(--success-color);font-weight:700}.export-format-section{display:flex;flex-direction:column;gap:var(--spacing-sm)}.export-format-buttons{display:grid;grid-template-columns:repeat(3,1fr);gap:var(--spacing-sm)}.export-format-btn{display:flex;flex-direction:column;align-items:center;gap:var(--spacing-xs);padding:var(--spacing-md);background:var(--surface-bg);border:2px solid var(--border-color);border-radius:var(--radius-md);cursor:pointer;transition:all var(--transition-fast);min-height:90px}.export-format-btn:hover{background:var(--elevated-bg);border-color:var(--border-light)}.export-format-btn.selected{background:var(--primary-color);border-color:var(--primary-color)}.export-format-btn.selected .export-format-label,.export-format-btn.selected .export-format-desc{color:#fff}.export-format-icon{font-size:32px;line-height:1}.export-format-label{font-weight:600;font-size:var(--font-size-md);color:var(--text-primary)}.export-format-desc{font-size:var(--font-size-xs);color:var(--text-muted)}.png-scale-options{display:flex;flex-direction:column;gap:var(--spacing-sm);padding:var(--spacing-md);background:var(--surface-bg);border:1px solid var(--border-color);border-radius:var(--radius-md)}.png-scale-buttons{display:flex;gap:var(--spacing-xs)}.png-scale-btn{flex:1;padding:var(--spacing-sm) var(--spacing-md);background:var(--panel-bg);border:1px solid var(--border-color);border-radius:var(--radius-sm);color:var(--text-secondary);font-weight:600;cursor:pointer;transition:all var(--transition-fast)}.png-scale-btn:hover{background:var(--elevated-bg);color:var(--text-primary)}.png-scale-btn.active{background:var(--primary-color);border-color:var(--primary-color);color:#fff}.export-info-small{font-size:var(--font-size-xs);color:var(--text-muted)}.export-info-small strong{color:var(--text-secondary)}.dialog-footer{display:flex;gap:var(--spacing-sm);padding:var(--spacing-lg);border-top:1px solid var(--border-color);background:var(--surface-bg);justify-content:flex-end}.dialog-btn{padding:var(--spacing-sm) var(--spacing-lg);border-radius:var(--radius-md);font-size:var(--font-size-md);font-weight:600;cursor:pointer;transition:all var(--transition-fast);border:none;min-width:80px}.dialog-btn-primary{background:var(--primary-color);color:#fff}.dialog-btn-primary:hover{background:var(--primary-hover);transform:translateY(-1px)}.dialog-btn-primary:active{background:var(--primary-active);transform:translateY(0)}.dialog-btn-secondary{background:var(--elevated-bg);color:var(--text-secondary);border:1px solid var(--border-color)}.dialog-btn-secondary:hover{background:var(--hover-bg);color:var(--text-primary)}.dialog-btn-secondary:active{background:var(--surface-bg)}.dialog-btn-danger{background:var(--danger-color);color:#fff}.dialog-btn-danger:hover{background:var(--danger-hover);transform:translateY(-1px)}.dialog-btn-danger:active{background:#c62828;transform:translateY(0)}@media(max-width:600px){.dialog-content{min-width:90vw;max-width:90vw}.dialog-footer{flex-direction:column-reverse}.dialog-btn{width:100%}}.tab-bar{background:var(--panel-bg);border-bottom:1px solid var(--border-color);display:flex;align-items:center;height:36px;overflow-x:auto;overflow-y:hidden}.tab-list{display:flex;flex:1;align-items:center;height:100%;overflow-x:auto;overflow-y:hidden;scrollbar-width:thin}.tab-list::-webkit-scrollbar{height:4px}.tab-list::-webkit-scrollbar-thumb{background:var(--border-color);border-radius:2px}.tab{display:flex;align-items:center;gap:8px;padding:8px 16px;background:var(--surface-bg);border-right:1px solid var(--border-color);cursor:pointer;-webkit-user-select:none;user-select:none;transition:background var(--transition-fast);min-width:120px;max-width:200px;height:100%;position:relative}.tab:hover{background:var(--elevated-bg)}.tab.active{background:var(--workspace-bg);border-bottom:2px solid var(--primary-color)}.tab-name{flex:1;font-size:var(--font-size-sm);font-weight:500;color:var(--text-secondary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.tab.active .tab-name{color:var(--text-primary)}.tab-dirty{color:var(--primary-color);font-size:14px;line-height:1}.tab-close{display:flex;align-items:center;justify-content:center;width:20px;height:20px;background:transparent;border:none;border-radius:var(--radius-sm);color:var(--text-muted);font-size:18px;line-height:1;cursor:pointer;padding:0;opacity:0;transition:all var(--transition-fast)}.tab:hover .tab-close{opacity:1}.tab-close:hover{background:var(--danger-color);color:#fff}.tab-new-btn{display:flex;align-items:center;justify-content:center;width:36px;height:36px;background:transparent;border:none;border-left:1px solid var(--border-color);color:var(--text-secondary);font-size:20px;cursor:pointer;transition:all var(--transition-fast);flex-shrink:0}.tab-new-btn:hover{background:var(--elevated-bg);color:var(--text-primary)}.tab-new-btn:active{background:var(--surface-bg)}.autosave-indicator{display:flex;align-items:center;gap:var(--spacing-sm);padding:4px 12px;background:var(--surface-bg);border:1px solid var(--border-color);border-radius:var(--radius-md);font-size:var(--font-size-xs);margin-left:auto;transition:all var(--transition-normal)}.autosave-status{display:flex;align-items:center;gap:6px;font-weight:600}.autosave-icon{font-size:14px;display:inline-block;transition:all var(--transition-fast)}.autosave-text{color:var(--text-secondary)}.autosave-time{color:var(--text-muted);font-size:var(--font-size-xs);margin-left:4px}.autosave-indicator.status-saved{border-color:var(--success-color)}.autosave-indicator.status-saved .autosave-icon,.autosave-indicator.status-saved .autosave-text{color:var(--success-color)}.autosave-indicator.status-saving{border-color:var(--primary-color)}.autosave-indicator.status-saving .autosave-icon{color:var(--primary-color);animation:spin 1s linear infinite}.autosave-indicator.status-saving .autosave-text{color:var(--primary-color)}.autosave-indicator.status-unsaved{border-color:var(--warning-color)}.autosave-indicator.status-unsaved .autosave-icon,.autosave-indicator.status-unsaved .autosave-text{color:var(--warning-color)}.autosave-indicator.status-error{border-color:var(--danger-color)}.autosave-indicator.status-error .autosave-icon,.autosave-indicator.status-error .autosave-text{color:var(--danger-color)}@keyframes spin{0%{transform:rotate(0)}to{transform:rotate(360deg)}}.zoom-controls{display:flex;align-items:center;gap:var(--spacing-xs)}.zoom-btn{display:flex;align-items:center;justify-content:center;width:28px;height:28px;background:var(--panel-bg);border:1px solid var(--border-color);border-radius:var(--radius-sm);color:var(--text-secondary);font-size:16px;font-weight:600;cursor:pointer;transition:all var(--transition-fast);line-height:1;padding:0}.zoom-btn:hover{background:var(--elevated-bg);border-color:var(--border-light);color:var(--text-primary)}.zoom-btn:active{background:var(--surface-bg);transform:scale(.95)}.zoom-select{min-width:80px;padding:4px 8px;background:var(--panel-bg);border:1px solid var(--border-color);border-radius:var(--radius-sm);color:var(--text-secondary);font-size:var(--font-size-sm);font-weight:600;cursor:pointer;transition:all var(--transition-fast)}.zoom-select:hover{background:var(--elevated-bg);border-color:var(--border-light)}.zoom-select:focus{outline:none;border-color:var(--primary-color)}.canvas-wrapper{transition:transform .2s ease-out;will-change:transform}.canvas-container{position:relative;overflow:hidden}.canvas-container.panning{cursor:grabbing!important}.welcome-screen{display:flex;align-items:center;justify-content:center;width:100%;height:100%;background:linear-gradient(135deg,#0a0e1a,#121829);animation:fadeIn .3s ease-in}@keyframes fadeIn{0%{opacity:0}to{opacity:1}}.welcome-content{max-width:600px;width:90%;text-align:center}.welcome-header{margin-bottom:60px}.welcome-title{font-family:Pixelify Sans,monospace;font-size:56px;font-weight:700;color:#fff;margin:0 0 10px;text-shadow:0 2px 10px rgba(0,0,0,.3)}.welcome-subtitle{font-size:16px;color:#aaa;margin:0;font-weight:400}.welcome-actions{display:flex;flex-direction:column;gap:20px;margin-bottom:50px}.welcome-section{width:100%}.welcome-divider{position:relative;text-align:center;color:#666;font-size:14px;margin:10px 0}.welcome-divider:before,.welcome-divider:after{content:"";position:absolute;top:50%;width:40%;height:1px;background:#444}.welcome-divider:before{left:0}.welcome-divider:after{right:0}.welcome-divider span{background:linear-gradient(135deg,#0a0e1a,#121829);padding:0 15px}.welcome-btn{display:flex;flex-direction:column;align-items:center;justify-content:center;width:100%;padding:30px 40px;border:2px solid transparent;border-radius:12px;background:#1a2035;color:#fff;font-family:inherit;cursor:pointer;transition:all .2s ease}.welcome-btn:hover{background:#202840;border-color:#00d9ff;transform:translateY(-2px);box-shadow:0 4px 12px #00d9ff4d}.welcome-btn-primary{background:linear-gradient(135deg,#08c,#06f);border-color:#00d9ff;box-shadow:0 0 20px #00d9ff4d}.welcome-btn-primary:hover{background:linear-gradient(135deg,#00a0ee,#0080ff);border-color:#0ff;box-shadow:0 6px 20px #00d9ff80}.welcome-btn-icon{font-size:48px;margin-bottom:10px}.welcome-btn-label{font-size:20px;font-weight:600;margin-bottom:5px}.welcome-btn-desc{font-size:14px;color:#aaa}.welcome-btn-primary .welcome-btn-desc{color:#fffc}.welcome-recent{margin-top:40px;padding-top:30px;border-top:1px solid #444}.welcome-recent-title{font-size:14px;font-weight:600;color:#888;text-transform:uppercase;letter-spacing:1px;margin:0 0 20px}.welcome-recent-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:15px}.welcome-recent-item{display:flex;flex-direction:column;align-items:center;padding:15px;background:#2a2a2a;border:1px solid #333;border-radius:8px;cursor:pointer;transition:all .2s ease}.welcome-recent-item:hover{background:#202840;border-color:#00d9ff;transform:translateY(-2px)}.welcome-recent-preview{width:80px;height:80px;background:#1a1a1a;border:1px solid #444;border-radius:4px;margin-bottom:10px;display:flex;align-items:center;justify-content:center;overflow:hidden}.welcome-recent-preview canvas{image-rendering:pixelated;image-rendering:-moz-crisp-edges;image-rendering:crisp-edges}.welcome-recent-name{font-size:12px;color:#fff;font-weight:500;margin-bottom:4px;text-overflow:ellipsis;overflow:hidden;white-space:nowrap;max-width:100%}.welcome-recent-info{font-size:11px;color:#888}.new-file-form{display:flex;flex-direction:column;gap:20px}.form-group{display:flex;flex-direction:column;gap:8px}.form-group label{font-size:14px;font-weight:600;color:#fff}.form-input{padding:10px 12px;background:#2a2a2a;border:1px solid #444;border-radius:6px;color:#fff;font-family:inherit;font-size:14px;transition:border-color .2s ease}.form-input:focus{outline:none;border-color:#00d9ff;box-shadow:0 0 0 3px #00d9ff1a}.form-row{display:grid;grid-template-columns:1fr 1fr;gap:15px}.size-presets-modal{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}.preset-btn-modal{padding:10px;background:#2a2a2a;border:1px solid #444;border-radius:6px;color:#fff;font-family:inherit;font-size:14px;font-weight:500;cursor:pointer;transition:all .2s ease}.preset-btn-modal:hover{background:#202840;border-color:#00d9ff}.preset-btn-modal.active{background:linear-gradient(135deg,#08c,#06f);border-color:#00d9ff;color:#fff;box-shadow:0 0 10px #00d9ff4d}.file-grid{display:flex;flex-direction:column;gap:8px;max-height:500px;overflow-y:auto}.file-grid-item{display:flex;flex-direction:row;align-items:center;gap:15px;padding:12px 15px;background:#2a2a2a;border:2px solid #333;border-radius:8px;cursor:pointer;transition:all .2s ease}.file-grid-item:hover{background:#202840;border-color:#00d9ff}.file-grid-preview{width:64px;height:64px;min-width:64px;background:#1a1a1a;border:1px solid #444;border-radius:4px;display:flex;align-items:center;justify-content:center;overflow:hidden}.file-grid-preview img,.file-grid-preview canvas{image-rendering:pixelated;image-rendering:-moz-crisp-edges;image-rendering:crisp-edges;max-width:100%;max-height:100%}.file-grid-details{flex:1;min-width:0;display:flex;flex-direction:column;gap:4px}.file-grid-name{font-size:15px;font-weight:600;color:#fff;text-overflow:ellipsis;overflow:hidden;white-space:nowrap}.file-grid-meta{display:flex;gap:15px;font-size:13px;color:#888}.file-grid-info{font-size:13px;color:#888}.file-grid-date{font-size:13px;color:#666}.modal-content-large{max-width:700px;width:90%}@media(max-width:768px){.welcome-title{font-size:40px}.welcome-btn{padding:25px 30px}.welcome-btn-icon{font-size:40px}.welcome-btn-label{font-size:18px}.file-grid{grid-template-columns:repeat(auto-fill,minmax(150px,1fr))}.size-presets-modal{grid-template-columns:repeat(2,1fr)}.form-row{grid-template-columns:1fr}}.context-menu{position:fixed;z-index:var(--z-tooltip);background:var(--elevated-bg);border:1px solid var(--border-accent);border-radius:var(--radius-lg);box-shadow:var(--shadow-xl),var(--shadow-cyan);min-width:200px;max-width:300px;padding:var(--spacing-xs) 0;-webkit-backdrop-filter:blur(10px);backdrop-filter:blur(10px);animation:contextMenuFadeIn .15s ease}@keyframes contextMenuFadeIn{0%{opacity:0;transform:scale(.95) translateY(-5px)}to{opacity:1;transform:scale(1) translateY(0)}}.context-submenu{animation:contextSubmenuSlide .15s ease}@keyframes contextSubmenuSlide{0%{opacity:0;transform:translate(-10px)}to{opacity:1;transform:translate(0)}}.context-menu-item{display:flex;align-items:center;gap:var(--spacing-md);padding:var(--spacing-sm) var(--spacing-md);cursor:pointer;transition:background var(--transition-fast);-webkit-user-select:none;user-select:none;font-size:var(--font-size-base);color:var(--text-primary);position:relative}.context-menu-item:hover:not(.disabled){background:var(--hover-bg)}.context-menu-item.disabled{opacity:.4;cursor:not-allowed}.context-menu-item.danger{color:var(--danger-color)}.context-menu-item.danger:hover:not(.disabled){background:#ff44661a}.context-menu-icon{font-size:18px;width:18px;height:18px;display:flex;align-items:center;justify-content:center;flex-shrink:0;color:var(--accent-cyan)}.context-menu-item.danger .context-menu-icon{color:var(--danger-color)}.context-menu-item.disabled .context-menu-icon{color:var(--text-disabled)}.context-menu-label{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.context-menu-shortcut{font-size:var(--font-size-xs);color:var(--text-muted);font-family:var(--font-mono);background:var(--surface-bg);padding:2px 6px;border-radius:var(--radius-sm);border:1px solid var(--border-color);margin-left:auto}.context-menu-arrow{font-size:16px;color:var(--text-muted);margin-left:auto}.context-menu-separator{height:1px;background:var(--border-color);margin:var(--spacing-xs) var(--spacing-sm)}.context-menu-item:hover:not(.disabled) .context-menu-icon{color:var(--accent-cyan-bright)}.context-menu-item.danger:hover:not(.disabled) .context-menu-icon{color:var(--danger-hover)}.context-menu-item:focus{outline:none;background:var(--hover-bg)}.context-submenu{margin-left:2px}@media(max-width:768px){.context-menu{min-width:180px;font-size:var(--font-size-sm)}.context-menu-item{padding:var(--spacing-xs) var(--spacing-sm)}.context-menu-shortcut{display:none}}@media(max-width:1024px){:root{--toolbox-width: 70px;--properties-width: 240px}.color-grid{grid-template-columns:repeat(6,1fr)}}@media(max-width:768px){.app-container{flex-direction:column}.toolbox{width:100%;height:auto;border-right:none;border-bottom:1px solid var(--border-color)}.toolbox-content{display:flex;overflow-x:auto;padding:var(--spacing-sm)}.tool-btn{min-width:60px;flex-shrink:0}.properties-panel{width:100%;max-height:40vh;border-left:none;border-top:1px solid var(--border-color)}.menu-bar{flex-wrap:wrap;height:auto;min-height:var(--menu-bar-height)}.menu-section:after{display:none}.info-bar{flex-wrap:wrap;height:auto;min-height:var(--info-bar-height);gap:var(--spacing-md)}.canvas-container{padding:var(--spacing-md)}.export-panel{padding:var(--spacing-sm)}.color-grid{grid-template-columns:repeat(8,1fr)}}@media(max-width:480px){.menu-btn span{display:none}.menu-btn{padding:var(--spacing-sm)}.info-bar{font-size:var(--font-size-xs)}.info-value-small{display:none}.size-presets{grid-template-columns:repeat(4,1fr)}.color-grid{grid-template-columns:repeat(6,1fr);gap:2px}.export-content{max-height:60px}.export-code{font-size:10px}}@media(hover:none)and (pointer:coarse){.menu-btn,.tool-btn,.size-btn,.mode-btn,.preset-btn{min-height:44px;min-width:44px}.color-swatch{min-height:32px;min-width:32px}}</style>
</head>
<body>
    <div class="app-container">
        <!-- Left Toolbox -->
        <aside class="toolbox">
            <div class="toolbox-header">
                <h2>Tools</h2>
            </div>
            <div class="toolbox-content" id="toolbox">
                <!-- Tools generated dynamically -->
            </div>
        </aside>

        <!-- Center Canvas Area -->
        <main class="workspace">
            <!-- Top Menu Bar -->
            <div class="menu-bar">
                <div class="menu-section">
                    <button id="newBtn" class="menu-btn" title="New (Ctrl+N)">
                        <span class="material-symbols-outlined">description</span> New
                    </button>
                    <button id="saveBtn" class="menu-btn" title="Save (Ctrl+S)">
                        <span class="material-symbols-outlined">save</span> Save
                    </button>
                    <button id="loadBtn" class="menu-btn" title="Load (Ctrl+O)">
                        <span class="material-symbols-outlined">folder_open</span> Load
                    </button>
                </div>
                <div class="menu-section">
                    <button id="undoBtn" class="menu-btn" title="Undo (Ctrl+Z)" disabled>
                        <span class="material-symbols-outlined">undo</span> Undo
                    </button>
                    <button id="redoBtn" class="menu-btn" title="Redo (Ctrl+Y)" disabled>
                        <span class="material-symbols-outlined">redo</span> Redo
                    </button>
                </div>
                <div class="menu-section">
                    <button id="exportFileBtn" class="menu-btn" title="Export">
                        <span class="material-symbols-outlined">download</span> Export
                    </button>
                    <button id="importStringBtn" class="menu-btn" title="Import">
                        <span class="material-symbols-outlined">upload</span> Import
                    </button>
                </div>
                <div class="menu-section">
                    <button id="clearBtn" class="menu-btn menu-btn-danger" title="Clear">
                        <span class="material-symbols-outlined">delete</span> Clear
                    </button>
                </div>
            </div>

            <!-- Canvas Info Bar with Tool Options -->
            <div class="info-bar">
                <div class="info-group">
                    <span class="info-label">Tool:</span>
                    <span id="currentToolName" class="info-value">Brush</span>
                </div>

                <!-- Tool Options (shown dynamically) -->
                <div class="info-group" id="brushSizeOption" style="display: none;">
                    <span class="info-label">Size:</span>
                    <div class="tool-size-buttons">
                        <button class="tool-size-btn active" data-size="1">1</button>
                        <button class="tool-size-btn" data-size="2">2</button>
                        <button class="tool-size-btn" data-size="3">3</button>
                        <button class="tool-size-btn" data-size="5">5</button>
                    </div>
                </div>

                <div class="info-group" id="shapeModeOption" style="display: none;">
                    <span class="info-label">Mode:</span>
                    <div class="tool-mode-buttons">
                        <button class="tool-mode-btn active" data-mode="fill">Fill</button>
                        <button class="tool-mode-btn" data-mode="stroke">Stroke</button>
                    </div>
                </div>

                <div class="info-spacer"></div>

                <!-- Grid Toggle -->
                <div class="info-group">
                    <button id="gridToggleBtn" class="icon-btn" title="Toggle Grid (G)">
                        <span class="material-symbols-outlined">grid_on</span>
                    </button>
                </div>

                <div class="info-group">
                    <span class="info-label">Size:</span>
                    <span id="canvasSizeDisplay" class="info-value">16×16</span>
                </div>
                <div class="info-group">
                    <span class="info-label">Color:</span>
                    <div id="currentColorDisplay" class="color-indicator"></div>
                    <span id="currentColorCode" class="info-value">1</span>
                </div>
            </div>

            <!-- Welcome Screen (shown on startup) -->
            <div id="welcomeScreen" class="welcome-screen">
                <div class="welcome-content">
                    <div class="welcome-header">
                        <h1 class="welcome-title">Inline.px</h1>
                        <p class="welcome-subtitle">Ultra-Compact Pixel Art Editor</p>
                    </div>

                    <div class="welcome-actions">
                        <div class="welcome-section">
                            <button id="welcomeNewBtn" class="welcome-btn welcome-btn-primary">
                                <span class="material-symbols-outlined welcome-btn-icon">add_circle</span>
                                <span class="welcome-btn-label">Create New</span>
                                <span class="welcome-btn-desc">Start with a blank canvas</span>
                            </button>
                        </div>

                        <div class="welcome-divider">
                            <span>or</span>
                        </div>

                        <div class="welcome-section">
                            <button id="welcomeLoadBtn" class="welcome-btn welcome-btn-secondary">
                                <span class="material-symbols-outlined welcome-btn-icon">folder_open</span>
                                <span class="welcome-btn-label">Open File</span>
                                <span class="welcome-btn-desc">Load from saved files</span>
                            </button>
                        </div>
                    </div>

                    <div class="welcome-recent" id="welcomeRecentFiles" style="display: none;">
                        <h3 class="welcome-recent-title">Recent Files</h3>
                        <div class="welcome-recent-list" id="welcomeRecentList">
                            <!-- Recent files populated dynamically -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Canvas Container -->
            <div class="canvas-container" id="canvasContainer" style="display: none;">
                <div class="canvas-wrapper">
                    <canvas id="pixelCanvas"></canvas>
                </div>
            </div>

            <!-- Live Export Preview -->
            <div class="export-panel">
                <div class="export-panel-header">
                    <h3>Export String</h3>
                    <button id="copyLiveStringBtn" class="icon-btn" title="Copy">
                        <span class="material-symbols-outlined">content_copy</span>
                    </button>
                </div>
                <div class="export-content">
                    <code id="liveExportString" class="export-code">16x16:0000...</code>
                </div>
                <div class="export-info">
                    <span><strong>Format:</strong> Base64 (64 colors)</span>
                    <span><strong>Length:</strong> <span id="stringLength">0</span> chars</span>
                </div>
            </div>
        </main>

        <!-- Right Properties Panel -->
        <aside class="properties-panel">
            <!-- Canvas Size -->
            <div class="panel-section">
                <h3 class="panel-title">Canvas Size</h3>
                <div class="size-presets">
                    <button class="preset-btn active" data-size="8">8×8</button>
                    <button class="preset-btn" data-size="16">16×16</button>
                    <button class="preset-btn" data-size="32">32×32</button>
                    <button class="preset-btn" data-size="64">64×64</button>
                </div>
                <div class="custom-size">
                    <div class="size-input-row">
                        <input type="number" id="canvasWidth" min="2" max="128" value="8" placeholder="W">
                        <span>×</span>
                        <input type="number" id="canvasHeight" min="2" max="128" value="8" placeholder="H">
                    </div>
                    <button id="resizeBtn" class="btn-primary">Apply</button>
                </div>
            </div>

            <!-- Color Palette -->
            <div class="panel-section">
                <h3 class="panel-title">Color Palette</h3>
                <div id="colorPalette" class="color-grid">
                    <!-- Generated dynamically -->
                </div>
            </div>
        </aside>
    </div>

    <!-- Import Modal -->
    <div class="modal" id="importModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Import from String</h2>
                <button id="closeImportModal" class="btn-close">&times;</button>
            </div>
            <div class="modal-body">
                <p>Paste your Base64 pixel art string (format: WxH:DATA)</p>
                <textarea id="importTextarea" rows="8" placeholder="16x16:123ABC..."></textarea>
            </div>
            <div class="modal-footer">
                <button id="cancelImportBtn" class="btn-secondary">Cancel</button>
                <button id="confirmImportBtn" class="btn-primary">Import</button>
            </div>
        </div>
    </div>

    <!-- New File Modal -->
    <div class="modal" id="newFileModal" style="display: none;">
        <div class="modal-content modal-content-large">
            <div class="modal-header">
                <h2>Create New File</h2>
                <button id="closeNewFileModal" class="btn-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="new-file-form">
                    <div class="form-group">
                        <label for="newFileName">Name</label>
                        <input type="text" id="newFileName" placeholder="Untitled" class="form-input">
                    </div>

                    <div class="form-group">
                        <label>Canvas Size</label>
                        <div class="size-presets-modal">
                            <button class="preset-btn-modal active" data-size="8">8×8</button>
                            <button class="preset-btn-modal" data-size="16">16×16</button>
                            <button class="preset-btn-modal" data-size="32">32×32</button>
                            <button class="preset-btn-modal" data-size="64">64×64</button>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="newFileWidth">Width</label>
                            <input type="number" id="newFileWidth" min="2" max="128" value="8" class="form-input">
                        </div>
                        <div class="form-group">
                            <label for="newFileHeight">Height</label>
                            <input type="number" id="newFileHeight" min="2" max="128" value="8" class="form-input">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancelNewFileBtn" class="btn-secondary">Cancel</button>
                <button id="confirmNewFileBtn" class="btn-primary">Create</button>
            </div>
        </div>
    </div>

    <!-- File Selection Modal -->
    <div class="modal" id="fileModal" style="display: none;">
        <div class="modal-content modal-content-large">
            <div class="modal-header">
                <h2>Open File</h2>
                <button id="closeModal" class="btn-close">&times;</button>
            </div>
            <div class="modal-body">
                <div id="fileList" class="file-grid"></div>
                <p id="noFilesMessage" style="display: none; text-align: center; color: #666; padding: 40px;">
                    No saved files found.
                </p>
            </div>
        </div>
    </div>

    <!-- Main Application Entry Point (Bundled by Vite) -->
</body>
</html>
