<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Inline.px - Ultra-Compact Pixel Art Editor</title>
    <link rel="icon" type="image/png" href="./favicon-BTGlOP9f.png">

    <!-- Material Symbols Font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <!-- Pixelify Sans Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pixelify+Sans:wght@400..700&display=swap" rel="stylesheet">

  <script type="module" crossorigin>(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function n(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerPolicy&&(i.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?i.credentials="include":r.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(r){if(r.ep)return;r.ep=!0;const i=n(r);fetch(r.href,i)}})();const re={DEBUG:0,INFO:1,WARN:2,ERROR:3};let on=re.INFO,rn=!0,pe=[];const Vn=100;function jn(e){re[e]!==void 0&&(on=re[e])}function Kn(e){rn=e}function Ve(e,t,n,o){if(e<on)return;const r=new Date().toISOString(),i={timestamp:r,level:t,message:n,data:o};if(pe.push(i),pe.length>Vn&&pe.shift(),rn){const a=`[${r}] [${t}] ${n}`,l=t.toLowerCase();console[l]?console[l](a,o||""):console.log(a,o||"")}}const s={LOG_LEVELS:re,setLevel:jn,setConsoleEnabled:Kn,debug:(e,t=null)=>Ve(re.DEBUG,"DEBUG",e,t),info:(e,t=null)=>Ve(re.INFO,"INFO",e,t),warn:(e,t=null)=>Ve(re.WARN,"WARN",e,t),error:(e,t=null)=>Ve(re.ERROR,"ERROR",e,t),getHistory:()=>[...pe],clearHistory:()=>{pe=[]},exportLogs:()=>pe.map(e=>{let t=`[${e.timestamp}] [${e.level}] ${e.message}`;return e.data&&(t+=` | ${JSON.stringify(e.data)}`),t}).join(`
`)},L={};function an(e,t){return L[e]||(L[e]=[]),L[e].push(t),s.debug?.(`EventBus: subscribed to "${e}"`),()=>$t(e,t)}function Zn(e,t){const n=(...o)=>{t(...o),$t(e,n)};return an(e,n)}function $t(e,t){if(!L[e])return;const n=L[e].indexOf(t);n>-1&&(L[e].splice(n,1),s.debug?.(`EventBus: unsubscribed from "${e}"`)),L[e].length===0&&delete L[e]}function Jn(e,t=null){if(!L[e]){s.debug?.(`EventBus: no listeners for "${e}"`);return}s.debug?.(`EventBus: emitting "${e}"`,t),[...L[e]].forEach(o=>{try{o(t,e)}catch(r){s.error?.(`EventBus: error in listener for "${e}"`,r)}})}const Qn={TOOL_CHANGED:"tool:changed",TOOL_OPTION_CHANGED:"tool:optionChanged",CANVAS_CHANGED:"canvas:changed",CANVAS_RESIZED:"canvas:resized",CANVAS_CLEARED:"canvas:cleared",SELECTION_CHANGED:"selection:changed",SELECTION_CLEARED:"selection:cleared",COLOR_CHANGED:"color:changed",HISTORY_STATE_ADDED:"history:stateAdded",UNDO_PERFORMED:"history:undo",REDO_PERFORMED:"history:redo",FILE_LOADED:"file:loaded",FILE_SAVED:"file:saved",FILE_EXPORTED:"file:exported",MODAL_OPENED:"ui:modalOpened",MODAL_CLOSED:"ui:modalClosed",APP_READY:"app:ready",APP_ERROR:"app:error"},x={on:an,once:Zn,off:$t,emit:Jn,listenerCount:e=>L[e]?L[e].length:0,getEvents:()=>Object.keys(L),clear:(e=null)=>{e?(delete L[e],s.debug?.(`EventBus: cleared listeners for "${e}"`)):(Object.keys(L).forEach(t=>delete L[t]),s.debug?.("EventBus: cleared all listeners"))},getStats:()=>{const e={totalEvents:Object.keys(L).length,totalListeners:0,events:{}};return Object.keys(L).forEach(t=>{const n=L[t].length;e.totalListeners+=n,e.events[t]=n}),e},Events:Qn},eo={base64Chars:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz+/",palette:[{index:0,char:"0",color:"transparent",name:"Transparent",category:"special"},{index:1,char:"1",color:"#000000",name:"Black",category:"basic"},{index:2,char:"2",color:"#FFFFFF",name:"White",category:"basic"},{index:3,char:"3",color:"#FF0000",name:"Red",category:"basic"},{index:4,char:"4",color:"#00FF00",name:"Green",category:"basic"},{index:5,char:"5",color:"#0000FF",name:"Blue",category:"basic"},{index:6,char:"6",color:"#FFFF00",name:"Yellow",category:"basic"},{index:7,char:"7",color:"#FF00FF",name:"Magenta",category:"basic"},{index:8,char:"8",color:"#00FFFF",name:"Cyan",category:"basic"},{index:9,char:"9",color:"#1A1A1A",name:"Dark Gray 1",category:"grayscale"},{index:10,char:"A",color:"#333333",name:"Dark Gray 2",category:"grayscale"},{index:11,char:"B",color:"#4D4D4D",name:"Dark Gray 3",category:"grayscale"},{index:12,char:"C",color:"#666666",name:"Gray 1",category:"grayscale"},{index:13,char:"D",color:"#808080",name:"Gray 2",category:"grayscale"},{index:14,char:"E",color:"#999999",name:"Gray 3",category:"grayscale"},{index:15,char:"F",color:"#B3B3B3",name:"Light Gray 1",category:"grayscale"},{index:16,char:"G",color:"#CCCCCC",name:"Light Gray 2",category:"grayscale"},{index:17,char:"H",color:"#8B0000",name:"Dark Red",category:"reds"},{index:18,char:"I",color:"#B22222",name:"Firebrick",category:"reds"},{index:19,char:"J",color:"#DC143C",name:"Crimson",category:"reds"},{index:20,char:"K",color:"#FF4500",name:"Orange Red",category:"reds"},{index:21,char:"L",color:"#FF6347",name:"Tomato",category:"reds"},{index:22,char:"M",color:"#FF7F50",name:"Coral",category:"reds"},{index:23,char:"N",color:"#FFA500",name:"Orange",category:"reds"},{index:24,char:"O",color:"#FFD700",name:"Gold",category:"reds"},{index:25,char:"P",color:"#006400",name:"Dark Green",category:"greens"},{index:26,char:"Q",color:"#008000",name:"Green",category:"greens"},{index:27,char:"R",color:"#228B22",name:"Forest Green",category:"greens"},{index:28,char:"S",color:"#32CD32",name:"Lime Green",category:"greens"},{index:29,char:"T",color:"#7FFF00",name:"Chartreuse",category:"greens"},{index:30,char:"U",color:"#90EE90",name:"Light Green",category:"greens"},{index:31,char:"V",color:"#98FB98",name:"Pale Green",category:"greens"},{index:32,char:"W",color:"#ADFF2F",name:"Yellow Green",category:"greens"},{index:33,char:"X",color:"#00008B",name:"Dark Blue",category:"blues"},{index:34,char:"Y",color:"#0000CD",name:"Medium Blue",category:"blues"},{index:35,char:"Z",color:"#1E90FF",name:"Dodger Blue",category:"blues"},{index:36,char:"a",color:"#4169E1",name:"Royal Blue",category:"blues"},{index:37,char:"b",color:"#6495ED",name:"Steel Blue",category:"blues"},{index:38,char:"c",color:"#87CEEB",name:"Sky Blue",category:"blues"},{index:39,char:"d",color:"#87CEFA",name:"Light Sky Blue",category:"blues"},{index:40,char:"e",color:"#B0E0E6",name:"Powder Blue",category:"blues"},{index:41,char:"f",color:"#4B0082",name:"Indigo",category:"purples"},{index:42,char:"g",color:"#6A5ACD",name:"Slate Blue",category:"purples"},{index:43,char:"h",color:"#7B68EE",name:"Medium Slate Blue",category:"purples"},{index:44,char:"i",color:"#9370DB",name:"Medium Purple",category:"purples"},{index:45,char:"j",color:"#BA55D3",name:"Orchid",category:"purples"},{index:46,char:"k",color:"#DA70D6",name:"Violet",category:"purples"},{index:47,char:"l",color:"#DDA0DD",name:"Plum",category:"purples"},{index:48,char:"m",color:"#EE82EE",name:"Pink Violet",category:"purples"},{index:49,char:"n",color:"#8B4513",name:"Saddle Brown",category:"browns"},{index:50,char:"o",color:"#A0522D",name:"Sienna",category:"browns"},{index:51,char:"p",color:"#D2691E",name:"Chocolate",category:"browns"},{index:52,char:"q",color:"#CD853F",name:"Peru",category:"browns"},{index:53,char:"r",color:"#F4A460",name:"Sandy Brown",category:"browns"},{index:54,char:"s",color:"#DEB887",name:"Burlywood",category:"browns"},{index:55,char:"t",color:"#D2B48C",name:"Tan",category:"browns"},{index:56,char:"u",color:"#BC8F8F",name:"Rosy Brown",category:"browns"},{index:57,char:"v",color:"#FFB6C1",name:"Light Pink",category:"pastels"},{index:58,char:"w",color:"#FFC0CB",name:"Pink",category:"pastels"},{index:59,char:"x",color:"#FFE4E1",name:"Misty Rose",category:"pastels"},{index:60,char:"y",color:"#F0E68C",name:"Khaki",category:"pastels"},{index:61,char:"z",color:"#E6E6FA",name:"Lavender",category:"pastels"},{index:62,char:"+",color:"#D8BFD8",name:"Thistle",category:"pastels"},{index:63,char:"/",color:"#FFDAB9",name:"Peach",category:"pastels"}]},to={canvas:{minSize:2,maxSize:128,defaultWidth:16,defaultHeight:16,minPixelSize:8,maxPixelSize:50,defaultPixelSize:30},history:{maxStates:50,debounceTime:500},autosave:{interval:3e4,debounceTime:1e3},tools:{brushSizes:[1,2,3,5],defaultBrushSize:1,maxBrushSize:5,shapeModes:["fill","stroke"],defaultShapeMode:"fill"},rle:{maxRunLength:99,countDigits:2},ui:{copyFeedbackDuration:1e3,windowResizeDebounce:250,animationDuration:200},validation:{fileNameMaxLength:100,fileNamePattern:"^[a-zA-Z0-9_\\-\\.]+$"}},ce={},no=eo,oo=to;async function sn(e){if(ce[e])return s.debug?.(`Config loaded from cache: ${e}`),ce[e];try{const t=await fetch(e);if(!t.ok)throw new Error(`HTTP error ${t.status}: ${t.statusText}`);const n=await t.json();return ce[e]=n,s.info?.(`Config loaded: ${e}`),n}catch(t){throw s.error?.(`Failed to load config: ${e}`,t),t}}async function ro(){return s.debug?.("Colors loaded from ES module (static)"),no}async function io(){return s.debug?.("Constants loaded from ES module (static)"),oo}function ao(e){return ce[e]||null}function ln(e=null){e?delete ce[e]:Object.keys(ce).forEach(t=>delete ce[t])}async function so(e){return ln(e),sn(e)}const Ot={load:sn,loadColors:ro,loadConstants:io,getCache:ao,clearCache:ln,reload:so};let Ce=null;function lo(e=null){Ce=e}function cn(e,t){const n=Ce?.canvas?.minSize||2,o=Ce?.canvas?.maxSize||128;return isNaN(e)||isNaN(t)?{valid:!1,error:"Width and height must be numbers"}:e<n||e>o?{valid:!1,error:`Width must be between ${n} and ${o}`}:t<n||t>o?{valid:!1,error:`Height must be between ${n} and ${o}`}:{valid:!0,error:null}}function co(e){if(!e||e.trim().length===0)return{valid:!1,error:"File name cannot be empty"};const t=Ce?.validation?.fileNameMaxLength||100;if(e.length>t)return{valid:!1,error:`File name too long (max ${t} characters)`};const n=Ce?.validation?.fileNamePattern||"^[a-zA-Z0-9_\\-\\.]+$";return new RegExp(n).test(e)?{valid:!0,error:null}:{valid:!1,error:"File name contains invalid characters"}}function uo(e){if(!e||typeof e!="string")return{valid:!1,error:"Data string must be a non-empty string",info:null};const t=e.split(":");if(t.length<2)return{valid:!1,error:'Invalid format: must be "WxH:DATA" or "WxH:RLE:DATA"',info:null};const n=t[0].split("x");if(n.length!==2)return{valid:!1,error:'Invalid dimensions format: must be "WIDTHxHEIGHT"',info:null};const o=parseInt(n[0]),r=parseInt(n[1]),i=cn(o,r);if(!i.valid)return{valid:!1,error:i.error,info:null};const a=t.length===3&&t[1]==="RLE",c=t[a?2:1];if(!c||c.length===0)return{valid:!1,error:"Data section is empty",info:null};if(!a){const u=o*r;if(c.length!==u)return{valid:!1,error:`Data length mismatch: expected ${u}, got ${c.length}`,info:null}}return{valid:!0,error:null,info:{width:o,height:r,isCompressed:a,dataLength:c.length}}}function fo(e){return e==="transparent"?!0:/^#[0-9A-Fa-f]{6}$/.test(e)}function ho(e){return Number.isInteger(e)&&e>=0&&e<=63}function go(e){return typeof e=="string"&&e.length===1&&"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz+/".includes(e)}function mo(e){return e.replace(/[^a-zA-Z0-9_\-\.]/g,"_").replace(/_{2,}/g,"_").substring(0,Ce?.validation?.fileNameMaxLength||100)}function po(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}const _e={init:lo,validateCanvasDimensions:cn,validateFileName:co,validateDataString:uo,validateHexColor:fo,validateColorIndex:ho,validateBase64Char:go,sanitizeFileName:mo,sanitizeInput:po};function vo(e,t=1){if(e===0)return"0 Bytes";if(e===1)return"1 Byte";const n=1024,o=["Bytes","KB","MB","GB"],r=Math.floor(Math.log(e)/Math.log(n));return parseFloat((e/Math.pow(n,r)).toFixed(t))+" "+o[r]}function yo(e){return e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}function Co(e,t=1){return e.toFixed(t)+"%"}function un(e,t=!0){const n=e instanceof Date?e:new Date(e),o=n.getFullYear(),r=String(n.getMonth()+1).padStart(2,"0"),i=String(n.getDate()).padStart(2,"0");let a=`${o}-${r}-${i}`;if(t){const l=String(n.getHours()).padStart(2,"0"),c=String(n.getMinutes()).padStart(2,"0"),u=String(n.getSeconds()).padStart(2,"0");a+=` ${l}:${c}:${u}`}return a}function So(e){const t=e instanceof Date?e:new Date(e),o=new Date-t,r=Math.floor(o/1e3),i=Math.floor(r/60),a=Math.floor(i/60),l=Math.floor(a/24);return r<60?"just now":i<60?`${i} minute${i!==1?"s":""} ago`:a<24?`${a} hour${a!==1?"s":""} ago`:l<7?`${l} day${l!==1?"s":""} ago`:un(t,!1)}function dn(e,t,n="..."){return e.length<=t?e:e.substring(0,t-n.length)+n}function wo(e,t=50){if(!e)return"";const n=e.split(":");if(n.length<2)return dn(e,t);const o=n[0],r=n.length===3&&n[1]==="RLE",a=n[r?2:1],l=r?`${o}:RLE:`:`${o}:`,c=t-l.length-3;return a.length<=c?e:`${l}${a.substring(0,c)}...`}function xo(e,t,n=null){return n=n||t+"s",e===1?t:n}function bo(e,t){return`${e}×${t}`}function Eo(e,t=2){return String(e).padStart(t,"0")}function Do(e,t="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz+/"){return e<0||e>=t.length?"?":t[e]}const yt={formatFileSize:vo,formatNumber:yo,formatPercentage:Co,formatTimestamp:un,formatRelativeTime:So,truncate:dn,formatDataString:wo,pluralize:xo,formatDimensions:bo,padZero:Eo,formatColorCode:Do};async function fn(e){if(navigator.clipboard&&navigator.clipboard.writeText)try{return await navigator.clipboard.writeText(e),s.info?.("Text copied to clipboard (modern API)"),!0}catch(t){return s.warn?.("Modern clipboard API failed, trying fallback",t),Kt(e)}return Kt(e)}function Kt(e){const t=document.createElement("textarea");t.value=e,t.style.position="fixed",t.style.left="-9999px",t.style.opacity="0",document.body.appendChild(t),t.select();let n=!1;try{n=document.execCommand("copy"),n&&s.info?.("Text copied to clipboard (fallback)")}catch(o){s.error?.("Fallback copy failed",o)}return document.body.removeChild(t),n}async function To(){if(navigator.clipboard&&navigator.clipboard.readText)try{const e=await navigator.clipboard.readText();return s.info?.("Text pasted from clipboard"),e}catch(e){return s.warn?.("Clipboard read failed",e),null}return s.warn?.("Clipboard API not available"),null}function hn(e,t=1e3){if(!e)return;const n=e.style.background,o=e.querySelector(".material-symbols-outlined"),r=o?o.textContent:null;e.style.background="var(--success-color, #4CAF50)",o&&(o.textContent="check"),setTimeout(()=>{e.style.background=n,o&&r&&(o.textContent=r)},t)}function Io(){return!!(navigator.clipboard&&navigator.clipboard.writeText)}async function $o(e,t=null){const n=await fn(e);return n&&t&&hn(t),n}const gn={copyText:fn,pasteText:To,showCopyFeedback:hn,isAvailable:Io,copyWithFeedback:$o};function et(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function mn(e){const t={info:"info",success:"check_circle",warning:"warning",error:"error"};return t[e]||t.info}let G=null,Le=null;function Oo(){Lo()}function Lo(){G=document.createElement("div"),G.id="dialogContainer",G.className="dialog-overlay",G.style.display="none",document.body.appendChild(G),G.addEventListener("click",e=>{e.target===G&&Q()}),document.addEventListener("keydown",e=>{e.key==="Escape"&&Le&&Q()})}function st(e){const t=document.createElement("div");t.className=`dialog-content dialog-${e.type}`;const n=document.createElement("div");n.className="dialog-header",n.innerHTML=`
        <span class="material-symbols-outlined dialog-icon">${e.icon}</span>
        <h2 class="dialog-title">${et(e.title)}</h2>
    `,t.appendChild(n);const o=document.createElement("div");if(o.className="dialog-body",e.message){const i=document.createElement("p");i.className="dialog-message",i.textContent=e.message,o.appendChild(i)}if(e.customContent){const i=document.createElement("div");i.innerHTML=e.customContent,o.appendChild(i)}if(e.input){const i=document.createElement("input");i.type=e.input.type,i.value=e.input.value,i.placeholder=e.input.placeholder,i.className="dialog-input",o.appendChild(i)}t.appendChild(o);const r=document.createElement("div");return r.className="dialog-footer",e.buttons.forEach(i=>{const a=document.createElement("button");a.className=`dialog-btn dialog-btn-${i.type}`,a.textContent=i.text,a.addEventListener("click",i.action),r.appendChild(a)}),t.appendChild(r),t}function lt(e){G.innerHTML="",G.appendChild(e),G.style.display="flex",Le=e,setTimeout(()=>{e.classList.add("dialog-show")},10);const t=e.querySelector(".dialog-btn");t&&t.focus()}function Q(){Le&&(Le.classList.remove("dialog-show"),setTimeout(()=>{G.style.display="none",G.innerHTML="",Le=null},200))}function Lt(e){const[t,n]=e.split(":");if(!n||n.length===0)return{compressed:e,original:e,savings:0,compressionRatio:1};let o="",r=1,i=n[0];for(let d=1;d<=n.length;d++)if(d<n.length&&n[d]===i&&r<99)r++;else{const f=r.toString().padStart(2,"0");o+=`${f}${i}`,d<n.length&&(i=n[d],r=1)}const a=`${t}:RLE:${o}`,l=e.length,c=a.length,u=((l-c)/l*100).toFixed(1),h=(c/l).toFixed(2);return{compressed:a,original:e,savings:parseFloat(u),compressionRatio:parseFloat(h),originalSize:l,compressedSize:c}}function Bo(e){const t=e.split(":");if(t.length===2)return e;if(t.length===3&&t[1]==="RLE"){const n=t[0],o=t[2];let r="",i=0;for(;i<o.length&&i+2<o.length;){const a=o.substring(i,i+2),l=parseInt(a),c=o[i+2];r+=c.repeat(l),i+=3}return`${n}:${r}`}return e}function Fo(e){const t=e.split(":");return t.length===3&&t[1]==="RLE"}function pn(e){const t=Lt(e);return t.compressedSize<t.originalSize?{data:t.compressed,wasCompressed:!0,savings:t.savings,compressionRatio:t.compressionRatio,originalSize:t.originalSize,compressedSize:t.compressedSize}:{data:e,wasCompressed:!1,savings:0,compressionRatio:1,originalSize:e.length,compressedSize:e.length}}function Mo(e){return Lt(e)}function zo(e){return e.map(t=>pn(t))}const W={compress:Lt,decompress:Bo,isCompressed:Fo,smartCompress:pn,getStats:Mo,compressBatch:zo};function Po(e){return new Promise(t=>{const n=W?W.getStats(e):null,r=st({title:"Export Pixel Art",message:"Choose how you want to export your pixel art:",icon:"download",type:"info",customContent:Ao(e,n,n!==null),buttons:[{text:"Cancel",type:"secondary",action:()=>{Q(),t(null)}}]});lt(r),Go(r,t)})}function Ao(e,t,n){const o=No(e),r=n?ko(e,t):"",i=Ho(),a=_o();return`
        <div class="export-options">
            ${o}
            ${r}
            ${i}
            ${a}
        </div>
    `}function No(e){return`
        <div class="export-preview">
            <div class="export-preview-header">
                <strong>Text Format Preview:</strong>
                <span class="export-preview-size">${e.length} chars</span>
            </div>
            <code class="export-code-preview">${et(e.substring(0,100))}${e.length>100?"...":""}</code>
        </div>
    `}function ko(e,t){const n=t.savings>0?"":"export-warning",o=t.savings>0?"Save":"Adds",r=t.savings>0?"Compresses repeated pixels for smaller file size. Recommended for sprites with large solid areas.":"Note: This sprite has few repeated pixels, so compression increases file size. Use only if needed for compatibility.";return`
        <div class="export-option-group">
            <label class="export-checkbox-label">
                <input type="checkbox" id="exportCompress" class="export-checkbox" ${t.savings>0?"checked":""} />
                <span>Use RLE Compression</span>
                <span class="export-savings ${n}">${o} ${Math.abs(t.savings)}% (${t.originalSize} → ${t.compressedSize} chars)</span>
            </label>
            <div class="export-option-info">
                ${r}
            </div>
            ${Ro(e,t)}
        </div>
    `}function Ro(e,t){return`
        <div class="compression-preview">
            <div class="compression-preview-section">
                <div class="compression-preview-label">
                    <strong>Before:</strong>
                    <span class="compression-preview-size">${t.originalSize} chars</span>
                </div>
                <code class="compression-preview-code">${et(e.substring(0,80))}${e.length>80?"...":""}</code>
            </div>
            <div class="compression-preview-arrow">→</div>
            <div class="compression-preview-section">
                <div class="compression-preview-label">
                    <strong>After:</strong>
                    <span class="compression-preview-size compression-highlight">${t.compressedSize} chars</span>
                </div>
                <code class="compression-preview-code">${et(t.compressed.substring(0,80))}${t.compressed.length>80?"...":""}</code>
            </div>
        </div>
    `}function Ho(){return`
        <div class="export-format-section">
            <strong>Export as:</strong>
            <div class="export-format-buttons">
                <button class="export-format-btn" data-format="copy-string">
                    <span class="material-symbols-outlined export-format-icon">content_copy</span>
                    <span class="export-format-label">Copy String</span>
                    <span class="export-format-desc">Copy to clipboard</span>
                </button>
                <button class="export-format-btn" data-format="download-txt">
                    <span class="material-symbols-outlined export-format-icon">description</span>
                    <span class="export-format-label">Download TXT</span>
                    <span class="export-format-desc">Save as text file</span>
                </button>
                <button class="export-format-btn" data-format="download-png">
                    <span class="material-symbols-outlined export-format-icon">image</span>
                    <span class="export-format-label">Download PNG</span>
                    <span class="export-format-desc">Save as image</span>
                </button>
            </div>
        </div>
    `}function _o(){return`
        <div id="pngScaleOptions" class="png-scale-options" style="display: none;">
            <strong>PNG Scale:</strong>
            <div class="png-scale-buttons">
                <button class="png-scale-btn active" data-scale="1">1×</button>
                <button class="png-scale-btn" data-scale="2">2×</button>
                <button class="png-scale-btn" data-scale="4">4×</button>
                <button class="png-scale-btn" data-scale="8">8×</button>
            </div>
        </div>
    `}function Go(e,t){let n=null,o=1;e.querySelectorAll(".export-format-btn").forEach(r=>{r.addEventListener("click",()=>{e.querySelectorAll(".export-format-btn").forEach(a=>a.classList.remove("selected")),r.classList.add("selected"),n=r.dataset.format;const i=e.querySelector("#pngScaleOptions");n==="download-png"?i.style.display="block":i.style.display="none",setTimeout(()=>{const a=e.querySelector("#exportCompress")?.checked||!1;Q(),t({format:n,compress:a,scale:o})},150)})}),e.querySelectorAll(".png-scale-btn").forEach(r=>{r.addEventListener("click",i=>{i.stopPropagation(),e.querySelectorAll(".png-scale-btn").forEach(a=>a.classList.remove("active")),r.classList.add("active"),o=parseInt(r.dataset.scale)})})}function Uo(){Oo(),s.info?.("Dialog system initialized")}function Yo(e,t,n="info"){return new Promise(o=>{const r=st({title:e,message:t,icon:mn(n),type:n,buttons:[{text:"OK",type:"primary",action:()=>{Q(),o(!0)}}]});lt(r)})}function qo(e,t,n={}){return new Promise(o=>{const r=n.confirmText||"Confirm",i=n.cancelText||"Cancel",a=n.type||"warning",l=n.dangerous||!1,c=st({title:e,message:t,icon:mn(a),type:a,buttons:[{text:i,type:"secondary",action:()=>{Q(),o(!1)}},{text:r,type:l?"danger":"primary",action:()=>{Q(),o(!0)}}]});lt(c)})}function Xo(e,t,n="",o={}){return new Promise(r=>{const i=o.placeholder||"",a=o.inputType||"text",l=st({title:e,message:t,icon:"edit_note",type:"info",input:{type:a,value:n,placeholder:i},buttons:[{text:"Cancel",type:"secondary",action:()=>{Q(),r(null)}},{text:"OK",type:"primary",action:()=>{const c=l.querySelector(".dialog-input"),u=c?c.value:null;Q(),r(u)}}]});lt(l),setTimeout(()=>{const c=l.querySelector(".dialog-input");c&&(c.focus(),c.select(),c.addEventListener("keydown",u=>{if(u.key==="Enter"){const h=c.value;Q(),r(h)}}))},100)})}function Wo(e){return Po(e)}const M={init:Uo,alert:Yo,confirm:qo,prompt:Xo,exportDialog:Wo};function je(e,t,n){if(!n||n.length===0)return!1;const o=n.length,r=n[0].length;return e>=0&&e<r&&t>=0&&t<o}function Vo(e,t,n,o){const r=n.length,i=n[0].length;return e>=0&&e<i&&t>=0&&t<r&&n[t][e]!==o?(n[t][e]=o,!0):!1}function jo(e,t,n){const o=n.length,r=n[0].length;return e>=0&&e<r&&t>=0&&t<o?n[t][e]:null}function Zt(e){return e.map(t=>[...t])}function Ko(e,t){if(t)for(let n=0;n<e.length;n++)for(let o=0;o<e[n].length;o++)e[n][o]=t[n][o]}function Zo(e=16){const t={lastTime:0,delay:e};return{shouldThrottle(){const n=Date.now();return n-t.lastTime<t.delay?!0:(t.lastTime=n,!1)},reset(){t.lastTime=0}}}function Jo(e){return class extends e{constructor(...t){super(...t),this.selectionActive=!1,this.selectionBounds=null}respectsSelection(){return!0}isInSelection(t,n){if(!this.selectionActive||!this.selectionBounds)return!0;const{x1:o,y1:r,x2:i,y2:a}=this.selectionBounds;return t>=o&&t<=i&&n>=r&&n<=a}setSelection(t){this.selectionActive=!0,this.selectionBounds=t}clearSelection(){this.selectionActive=!1,this.selectionBounds=null}}}function Qo(e){return class extends e{constructor(...t){super(...t),this.boundHandlers={}}addEventListener(t,n,o){const r=o.bind(this);t.addEventListener(n,r);const i=`${n}_${Date.now()}`;this.boundHandlers[i]={target:t,event:n,handler:r}}removeAllEventListeners(){Object.values(this.boundHandlers).forEach(({target:t,event:n,handler:o})=>{t.removeEventListener(n,o)}),this.boundHandlers={}}}}class Bt{static CONFIG={id:"base-tool",name:"Base Tool",icon:"tool",shortcut:"",cursor:"default",hasSizeOption:!1,hasShapeOption:!1,description:"Base tool class",category:"other"};static DEFAULT_OPTIONS={brushSize:1,shapeMode:"fill",opacity:1,antiAlias:!1,snapToGrid:!1,constrainProportions:!1};constructor(){if(new.target===Bt)throw new Error("BaseTool is abstract and cannot be instantiated directly");const t=this.constructor.CONFIG;if(!t||t.id==="base-tool")throw new Error(`${this.constructor.name} must override static CONFIG property`);this.isActive=!1,this.isDrawing=!1,this.options={...this.constructor.DEFAULT_OPTIONS},this.startX=0,this.startY=0,this.lastX=0,this.lastY=0,this.previewData=null,this.throttle=Zo(16),this.onChangeCallback=null,this.onOptionChangeCallback=null,this.actionHistory=[],this.logger=s,this.logger.debug?.(`${this.constructor.CONFIG.name} tool created`)}init(){this.logger.debug?.(`${this.getName()} tool initialized`)}activate(){this.isActive=!0,this.logger.info?.(`${this.getName()} tool activated`)}deactivate(){this.isActive=!1,this.cancelDrawing(),this.logger.info?.(`${this.getName()} tool deactivated`)}destroy(){this.removeAllEventListeners(),this.previewData=null,this.logger.debug?.(`${this.getName()} tool destroyed`)}startDrawing(t,n,o,r={}){return this.isActive?je(t,n,o)?(this.isDrawing=!0,this.startX=t,this.startY=n,this.lastX=t,this.lastY=n,this.needsPreview()&&(this.previewData=Zt(o)),this.onDrawStart(t,n,o,r)):(this.logger.warn?.(`Invalid coordinates: (${t}, ${n})`),!1):(this.logger.warn?.(`Cannot start drawing: ${this.getName()} is not active`),!1)}continueDrawing(t,n,o,r={}){return!this.isDrawing||!je(t,n,o)||this.throttle.shouldThrottle()?!1:(this.lastX=t,this.lastY=n,this.onDrawContinue(t,n,o,r))}endDrawing(t,n,o,r={}){if(!this.isDrawing)return!1;this.isDrawing=!1,je(t,n,o)||(t=this.lastX,n=this.lastY);const i=this.onDrawEnd(t,n,o,r);return this.previewData=null,this.throttle.reset(),i}cancelDrawing(){this.isDrawing&&(this.isDrawing=!1,this.previewData=null,this.onDrawCancel(),this.logger.debug?.(`${this.getName()} drawing cancelled`))}onDrawStart(t,n,o,r){throw new Error(`${this.constructor.name} must implement onDrawStart()`)}onDrawContinue(t,n,o,r){throw new Error(`${this.constructor.name} must implement onDrawContinue()`)}onDrawEnd(t,n,o,r){throw new Error(`${this.constructor.name} must implement onDrawEnd()`)}onDrawCancel(){}setOption(t,n){if(this.options.hasOwnProperty(t)){const o=this.options[t];this.options[t]=n,this.onOptionChanged(t,n,o),this.onOptionChangeCallback&&this.onOptionChangeCallback(t,n,o)}else this.logger.warn?.(`Unknown option: ${t}`)}getOption(t){return this.options[t]}getAllOptions(){return{...this.options}}resetOptions(){this.options={...this.constructor.DEFAULT_OPTIONS},this.onOptionsReset()}onOptionChanged(t,n,o){this.logger.debug?.(`${this.getName()} option changed: ${t} = ${n}`)}onOptionsReset(){}needsPreview(){return!1}validateCoordinates(t,n,o){return je(t,n,o)}clonePixelData(t){return Zt(t)}restorePreviewData(t){Ko(t,this.previewData)}setPixel(t,n,o,r){return Vo(t,n,o,r)}getPixel(t,n,o){return jo(t,n,o)}getId(){return this.constructor.CONFIG.id}getName(){return this.constructor.CONFIG.name}getConfig(){return{...this.constructor.CONFIG}}getCursor(){return this.constructor.CONFIG.cursor}hasSizeOption(){return this.constructor.CONFIG.hasSizeOption}hasShapeOption(){return this.constructor.CONFIG.hasShapeOption}setChangeCallback(t){this.onChangeCallback=t}setOptionChangeCallback(t){this.onOptionChangeCallback=t}triggerChange(){this.onChangeCallback&&this.onChangeCallback()}}const Z=Qo(Jo(Bt));let j={brushSize:1,shapeMode:"fill",colorCode:1},Me=null;function er(e={},t=null){j={...j,...e},Me=t,s.debug?.("ToolStateManager initialized")}function tr(e,t){if(!j.hasOwnProperty(e)){s.warn?.(`Unknown tool option: ${e}`);return}const n=j[e];j[e]=t,s.debug?.(`Tool option changed: ${e} = ${t}`),Me&&Me(e,t,n)}function nr(e){return j[e]}function or(){return{...j}}function rr(e){Object.keys(j).forEach(t=>{e.setOption(t,j[t])})}function ir(e,t,n){j.hasOwnProperty(e)&&(j[e]=t),Me&&Me(e,t,n)}let z=null;function vn(e){z=e}function ar(e,t,n,o={}){if(!z)return s.warn?.("No tool selected for drawing"),!1;try{return z.startDrawing(e,t,n,o)}catch(r){return s.error?.("Error starting drawing",r),!1}}function sr(e,t,n,o={}){if(!z)return!1;try{return z.continueDrawing(e,t,n,o)}catch(r){return s.error?.("Error continuing drawing",r),!1}}function lr(e,t,n,o={}){if(!z)return!1;try{return z.endDrawing(e,t,n,o)}catch(r){return s.error?.("Error ending drawing",r),!1}}function cr(){if(z)try{z.cancelDrawing()}catch(e){s.error?.("Error canceling drawing",e)}}function ur(e){z&&z.setSelection&&z.setSelection(e)}function dr(){z&&z.clearSelection&&z.clearSelection()}function fr(){return!z||!z.respectsSelection?!0:z.respectsSelection()}const _=new Map,Se=[];let U=null,we=null,Ct=null;function hr(e={}){s.info?.("ToolRegistry initializing..."),e.onToolChange&&(Ct=e.onToolChange),er(e.sharedOptions,e.onToolOptionChange),s.info?.("ToolRegistry initialized")}function yn(e){try{if(!e||!e.CONFIG)return s.error?.("Invalid tool class: missing CONFIG",e),!1;const t=e.CONFIG,n=t.id;if(!n)return s.error?.("Tool class missing id in CONFIG",e),!1;if(_.has(n))return s.warn?.(`Tool "${n}" already registered, skipping`),!1;const o=new e;return o.setChangeCallback(()=>{s.debug?.(`Tool ${n} triggered change`)}),o.setOptionChangeCallback((r,i,a)=>{ir(r,i,a)}),o.init(),_.set(n,o),Se.push(n),s.info?.(`Tool registered: ${t.name} (${n})`),!0}catch(t){return s.error?.("Failed to register tool",t),!1}}function gr(e){let t=0;return e.forEach(n=>{yn(n)&&t++}),s.info?.(`Registered ${t} tools`),t}function mr(e){const t=_.get(e);if(!t)return s.warn?.(`Tool "${e}" not found`),!1;we===e&&(t.deactivate(),U=null,we=null,vn(null)),t.destroy(),_.delete(e);const n=Se.indexOf(e);return n>-1&&Se.splice(n,1),s.info?.(`Tool unregistered: ${e}`),!0}function pr(e){const t=_.get(e);return t?(U&&U!==t&&U.deactivate(),U=t,we=e,U.activate(),rr(U),vn(U),Ct&&Ct(e,t),s.info?.(`Current tool set: ${e}`),!0):(s.warn?.(`Tool "${e}" not found`),!1)}function vr(){return U}function yr(){return we}function Cr(e){return _.get(e)||null}function Sr(){return Se.map(e=>{const t=_.get(e);return t?t.getConfig():null}).filter(e=>e!==null)}function wr(e){const t=e.toUpperCase();for(const[n,o]of _)if(o.getConfig().shortcut===t)return o;return null}function xr(e){return _.has(e)}function br(){return _.size}function Er(){U&&U.deactivate(),_.forEach(e=>e.destroy()),_.clear(),Se.length=0,U=null,we=null,s.info?.("All tools cleared")}function Dr(){return{totalTools:_.size,currentToolId:we,toolIds:[...Se]}}const w={init:hr,registerTool:yn,registerTools:gr,unregisterTool:mr,setCurrentTool:pr,getCurrentTool:vr,getCurrentToolId:yr,getTool:Cr,getAllTools:Sr,getToolByShortcut:wr,hasTool:xr,getToolCount:br,clearAll:Er,getStats:Dr,setToolOption:tr,getToolOption:nr,getSharedOptions:or,startDrawing:ar,continueDrawing:sr,endDrawing:lr,cancelDrawing:cr,setSelection:ur,clearSelection:dr,respectsSelection:fr};let ze=null,he="",ee=[],N=[],St={},Pe=[],ue=1,wt=null,ve=null;async function Tr(e,t=null){try{s.info?.("ColorPalette initializing..."),wt=t,ze=await Ot.loadColors(),Ft();const n=document.getElementById(e);n?(Mt(n),Sn()):s.warn?.(`Container "${e}" not found`),s.info?.("ColorPalette initialized successfully")}catch(n){throw s.error?.("ColorPalette initialization failed",n),n}}function Ft(){he=ze.base64Chars,ee=ze.palette,N=[],St={},Pe=[],ee.forEach(e=>{N[e.index]=e.color,St[e.char]=e.color,Pe[e.index]=e.name}),s.debug?.(`Parsed ${ee.length} colors from configuration`)}function Mt(e){e.innerHTML="",ee.forEach(t=>{const n=document.createElement("button");n.className="color-swatch",n.dataset.code=t.char,n.dataset.index=t.index,n.dataset.category=t.category,n.style.backgroundColor=t.color,n.title=`${t.name} (${t.char})`,t.index===ue&&n.classList.add("active"),n.addEventListener("click",()=>Cn(t.index)),e.appendChild(n)}),s.debug?.(`Rendered ${ee.length} color swatches`)}function Cn(e){if(!_e.validateColorIndex(e)){s.error?.(`Invalid color index: ${e}`);return}const t=ue;ue=e,document.querySelectorAll(".color-swatch").forEach(n=>{n.classList.toggle("active",parseInt(n.dataset.index)===e)}),Sn(),wt&&wt(e,N[e]),x&&x.emit(x.Events.COLOR_CHANGED,{index:e,color:N[e],char:he[e],name:Pe[e],oldIndex:t}),w&&w.setToolOption("colorCode",e),s.debug?.(`Color selected: ${Pe[e]} (${e})`)}function Sn(){const e=document.getElementById("currentColorDisplay"),t=document.getElementById("currentColorCode");e&&(e.style.backgroundColor=N[ue]),t&&(t.textContent=he[ue])}function Ir(e){return N[e]||N[0]}function $r(e){return St[e]||N[0]}function Or(){return ue}function Lr(){return N[ue]}function Br(e){return he[e]||"0"}function Fr(e){return he.indexOf(e)}function Mr(){return[...ee]}function zr(e){return ee.filter(t=>t.category===e)}function Pr(){const e=new Set;return ee.forEach(t=>e.add(t.category)),Array.from(e)}function Ar(e){const t=N[e];if(t==="transparent")return{r:0,g:0,b:0,a:0};const n=t.replace("#",""),o=parseInt(n.substring(0,2),16),r=parseInt(n.substring(2,4),16),i=parseInt(n.substring(4,6),16);return{r:o,g:r,b:i,a:255}}function Nr(e){return Pe[e]||"Unknown"}function kr(e){return ee.find(t=>t.index===e)||null}function Rr(e,t){if(e>=0&&e<N.length){ve||(ve=[...N]),ve[e]=t,N[e]=t;const n=document.querySelector(`.color-swatch[data-index="${e}"]`);n&&(n.style.backgroundColor=t),s.info?.(`Custom color set at index ${e}: ${t}`)}}function Hr(){if(ze){Ft();const e=document.querySelector(".color-grid");e&&Mt(e),ve=null,s.info?.("Palette reset to default")}}function _r(){return{base64Chars:he,palette:ee.map((e,t)=>({...e,color:ve?ve[t]:e.color}))}}function Gr(e){try{ze=e,Ft();const t=document.querySelector(".color-grid");t&&Mt(t),s.info?.("Custom palette imported")}catch(t){s.error?.("Failed to import custom palette",t)}}const ne={init:Tr,selectColor:Cn,getColor:Ir,getColorByChar:$r,getCurrentColorIndex:Or,getCurrentColor:Lr,getBase64Char:Br,getIndexFromChar:Fr,getAllColors:Mr,getColorsByCategory:zr,getCategories:Pr,indexToRGBA:Ar,getColorName:Nr,getColorInfo:kr,setCustomColor:Rr,resetToDefault:Hr,exportCustomPalette:_r,importCustomPalette:Gr,get BASE64_CHARS(){return he},get COLORS(){return N}};let $=16,O=16,k=[];function Ur(e,t){$=e,O=t,ct(),s.debug?.(`PixelData initialized: ${$}×${O}`)}function ct(){k=[];for(let e=0;e<O;e++){k[e]=[];for(let t=0;t<$;t++)k[e][t]=0}}function Yr(){return k}function qr(e){return!e||e.length===0?(s.error?.("Invalid pixel data"),!1):(O=e.length,$=e[0].length,k=e.map(t=>[...t]),!0)}function Xr(){return{width:$,height:O}}function Wr(e,t){return e>=0&&e<$&&t>=0&&t<O?k[t][e]:null}function Vr(e,t,n){return e>=0&&e<$&&t>=0&&t<O?(k[t][e]=n,!0):!1}function jr(e,t){const n=_e.validateCanvasDimensions(e,t);if(!n.valid)return s.error?.("Invalid dimensions:",n.error),!1;const o=k,r=$,i=O;$=e,O=t,ct();for(let a=0;a<Math.min(i,O);a++)for(let l=0;l<Math.min(r,$);l++)k[a][l]=o[a][l];return s.info?.(`Pixel data resized: ${r}×${i} → ${$}×${O}`),!0}function Kr(e=!1){let t="";for(let o=0;o<O;o++)for(let r=0;r<$;r++)t+=ne.getBase64Char(k[o][r]);const n=`${$}x${O}:${t}`;return e&&W?W.smartCompress(n).data:n}function Zr(e){try{const t=_e.validateDataString(e);if(!t.valid)return{success:!1,error:t.error};let n=e;W&&W.isCompressed(e)&&(n=W.decompress(e),s.debug?.("Data decompressed"));const o=n.split(":"),r=o[0].split("x"),i=parseInt(r[0]),a=parseInt(r[1]),l=o[1];$=i,O=a,ct();let c=0;for(let u=0;u<O;u++)for(let h=0;h<$;h++){const d=l[c],f=ne.getIndexFromChar(d);if(f===-1)return{success:!1,error:`Invalid character: ${d}`};k[u][h]=f,c++}return s.info?.(`Data imported: ${$}×${O}`),{success:!0,error:null}}catch(t){return s.error?.("Import failed",t),{success:!1,error:t.message}}}function Jr(){return k.map(e=>[...e])}function Qr(){for(let e=0;e<O;e++)for(let t=0;t<$;t++)if(k[e][t]!==0)return!0;return!1}function ei(){const e={};let t=0;for(let r=0;r<O;r++)for(let i=0;i<$;i++){const a=k[r][i];a===0?t++:e[a]=(e[a]||0)+1}const n=$*O,o=Object.keys(e).length;return{width:$,height:O,totalPixels:n,transparentPixels:t,usedColors:o,colorCounts:e,fillPercentage:((n-t)/n*100).toFixed(1)}}const b={init:Ur,clear:ct,getData:Yr,setData:qr,getDimensions:Xr,getPixel:Wr,setPixel:Vr,resize:jr,exportToString:Kr,importFromString:Zr,clone:Jr,hasContent:Qr,getStats:ei};let R=null,T=null,S=30,wn=!0,Ze=null;function ti(e,t=null){R=e,T=R.getContext("2d"),T.imageSmoothingEnabled=!1,Ze=t,s.debug?.("CanvasRenderer initialized")}function xn(e,t){const n=R.parentElement;if(!n)return Ze?.canvas?.defaultPixelSize||30;const o=Math.min(n.clientWidth-40,800),r=Math.min(window.innerHeight*.5,800),i=Math.floor(o/e),a=Math.floor(r/t),l=Ze?.canvas?.minPixelSize||8,c=Ze?.canvas?.maxPixelSize||50;return Math.max(l,Math.min(i,a,c))}function ni(e,t,n=null){n!==null?S=n:S=xn(e,t),R.width=e*S,R.height=t*S,T.imageSmoothingEnabled=!1,s.debug?.(`Canvas size updated: ${R.width}×${R.height} (pixel size: ${S})`)}function oi(e){if(!e||e.length===0){s.warn?.("No pixel data to render");return}const t=e.length,n=e[0].length;T.clearRect(0,0,R.width,R.height);for(let o=0;o<t;o++)for(let r=0;r<n;r++){const i=e[o][r];if(i===0)ri(r,o);else{const a=ne.getColor(i);T.fillStyle=a,T.fillRect(r*S,o*S,S,S)}}wn&&ii(n,t)}function ri(e,t){const n=Math.max(2,Math.floor(S/4));for(let o=0;o<S;o+=n)for(let r=0;r<S;r+=n){const i=(Math.floor(r/n)+Math.floor(o/n))%2===0;T.fillStyle=i?"#2a2a2a":"#1a1a1a",T.fillRect(e*S+r,t*S+o,n,n)}}function ii(e,t){T.strokeStyle="#404040",T.lineWidth=1;for(let n=0;n<=e;n++)T.beginPath(),T.moveTo(n*S,0),T.lineTo(n*S,t*S),T.stroke();for(let n=0;n<=t;n++)T.beginPath(),T.moveTo(0,n*S),T.lineTo(e*S,n*S),T.stroke()}function ai(){T.clearRect(0,0,R.width,R.height)}function si(e){wn=e}function li(){return S}function ci(){return R}function ui(){return T}function di(e,t,n,o,r=1){const i=R.getBoundingClientRect(),a=Math.floor((e-i.left)/(S*r)),l=Math.floor((t-i.top)/(S*r));return a>=0&&a<n&&l>=0&&l<o?{x:a,y:l}:null}function fi(e,t,n=1){return{x:e*S*n,y:t*S*n}}const Y={init:ti,calculatePixelSize:xn,updateCanvasSize:ni,render:oi,clear:ai,setGridVisible:si,getPixelSize:li,getCanvas:ci,getContext:ui,screenToPixelCoords:di,pixelToScreenCoords:fi};let F=null,B=null,le=null,xe=null;function hi(e,t={}){le=e,xe=t.renderer||Y,gi(),s.debug?.("SelectionOverlay initialized (stateless)")}function gi(){F&&F.remove(),F=document.createElement("canvas"),F.className="selection-overlay",Object.assign(F.style,{position:"absolute",top:"0",left:"0",pointerEvents:"none",zIndex:"10"}),B=F.getContext("2d"),le.parentElement.appendChild(F),bn()}function bn(){!F||!le||(F.width=le.width,F.height=le.height,Object.assign(F.style,{width:le.style.width,height:le.style.height}))}function mi(e,t=0){if(!F||!B||!xe)return;En();const{bounds:n,previewBounds:o,movePreview:r}=e;if(r&&r.pixelData){pi(r);const i={x1:r.x,y1:r.y,x2:r.x+r.pixelData[0].length-1,y2:r.y+r.pixelData.length-1};Jt(i,t)}else n?Jt(n,t):o&&vi(o)}function pi(e){const{pixelData:t,x:n,y:o}=e,r=xe.getPixelSize(),i=xe.getColors();for(let a=0;a<t.length;a++)for(let l=0;l<t[a].length;l++){const c=t[a][l];c!==0&&(B.fillStyle=i[c],B.fillRect(Math.floor((n+l)*r),Math.floor((o+a)*r),r,r))}}function Jt(e,t){const n=xe.getPixelSize(),o={x:Math.floor(e.x1*n),y:Math.floor(e.y1*n),w:Math.floor((e.x2-e.x1+1)*n),h:Math.floor((e.y2-e.y1+1)*n)};B.strokeStyle="#FFFFFF",B.lineWidth=1,B.setLineDash([4,4]),B.lineDashOffset=t,B.strokeRect(o.x-1,o.y-1,o.w+2,o.h+2),B.strokeStyle="#000000",B.lineDashOffset=t+4,B.strokeRect(o.x-1,o.y-1,o.w+2,o.h+2)}function vi(e){const t=xe.getPixelSize(),n={x:Math.floor(e.x1*t),y:Math.floor(e.y1*t),w:Math.floor((e.x2-e.x1+1)*t),h:Math.floor((e.y2-e.y1+1)*t)};B.strokeStyle="rgba(0, 191, 255, 0.8)",B.lineWidth=1,B.setLineDash([3,3]),B.strokeRect(n.x,n.y,n.w,n.h)}function En(){F&&B&&B.clearRect(0,0,F.width,F.height)}function yi(){F&&(F.remove(),F=null,B=null),s.debug?.("SelectionOverlay destroyed")}const P={init:hi,updateSize:bn,render:mi,clear:En,destroy:yi};let q=1,Ge=0,Ue=0,be=!1,xt=0,bt=0,E=null;const zt=.1,Pt=10,tt=.1;function Ci(){E=document.querySelector(".canvas-container"),E&&(Si(),wi(),qe(),s.info("Viewport initialized"))}function Si(){const e=document.querySelector(".info-bar");if(!e)return;const t=document.createElement("div");t.className="zoom-controls",t.innerHTML=`
        <div class="info-group">
            <button class="zoom-btn" id="zoomOutBtn" title="Zoom Out (-)">−</button>
            <select class="zoom-select" id="zoomSelect">
                <option value="0.25">25%</option>
                <option value="0.5">50%</option>
                <option value="1" selected>100%</option>
                <option value="2">200%</option>
                <option value="4">400%</option>
                <option value="fit">Fit</option>
            </select>
            <button class="zoom-btn" id="zoomInBtn" title="Zoom In (+)">+</button>
            <button class="zoom-btn" id="zoomResetBtn" title="Reset View (Ctrl+0)">⟲</button>
        </div>
    `;const n=e.querySelector(".info-spacer");n?e.insertBefore(t,n):e.appendChild(t),document.getElementById("zoomInBtn").addEventListener("click",At),document.getElementById("zoomOutBtn").addEventListener("click",Nt),document.getElementById("zoomResetBtn").addEventListener("click",kt),document.getElementById("zoomSelect").addEventListener("change",o=>{const r=o.target.value;r==="fit"?Rt():Ye(parseFloat(r))})}function wi(){E&&(E.addEventListener("wheel",xi,{passive:!1}),E.addEventListener("mousedown",bi),E.addEventListener("mousemove",Ei),E.addEventListener("mouseup",Qt),E.addEventListener("mouseleave",Qt),document.addEventListener("keydown",Di))}function xi(e){if(!(e.ctrlKey||e.metaKey))return;e.preventDefault();const n=e.deltaY>0?-tt:tt,o=Math.max(zt,Math.min(Pt,q+n));Ye(o)}function bi(e){const t=w&&w.getCurrentToolId()==="hand",n=e.buttons===1&&Ae,o=e.button===1;(t||n||o)&&(e.preventDefault(),be=!0,xt=e.clientX,bt=e.clientY,E.classList.add("cursor-grabbing"))}function Ei(e){if(!be)return;e.preventDefault();const t=e.clientX-xt,n=e.clientY-bt;Ge+=t,Ue+=n,xt=e.clientX,bt=e.clientY,qe()}function Qt(e){be&&(be=!1,E.classList.remove("cursor-grabbing"),w&&w.getCurrentToolId()==="hand"?E.classList.add("cursor-grab"):E.classList.remove("cursor-grab"))}let Ae=!1;function Di(e){if(e.code==="Space"&&!e.repeat&&e.target.tagName!=="INPUT"&&e.target.tagName!=="TEXTAREA"&&(Ae=!0,E&&E.classList.add("cursor-grab")),!(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA")&&(e.ctrlKey||e.metaKey))switch(e.key){case"+":case"=":e.preventDefault(),At();break;case"-":case"_":e.preventDefault(),Nt();break;case"0":e.preventDefault(),kt();break}}document.addEventListener("keyup",e=>{e.code==="Space"&&(Ae=!1,E&&!be&&(w&&w.getCurrentToolId()==="hand"||E.classList.remove("cursor-grab")))});window.addEventListener("blur",()=>{Ae&&(Ae=!1,E&&!be&&(w&&w.getCurrentToolId()==="hand"||E.classList.remove("cursor-grab")),s.debug?.("Space key state reset due to window blur"))});function At(){const e=Math.min(Pt,q+tt);Ye(e)}function Nt(){const e=Math.max(zt,q-tt);Ye(e)}function Ye(e){q=Math.max(zt,Math.min(Pt,e)),qe(),Ht()}function kt(){q=1,Ge=0,Ue=0,qe(),Ht()}function Rt(){if(!E)return;const e=document.getElementById("pixelCanvas");if(!e)return;const t=E.clientWidth-100,n=E.clientHeight-100,o=e.width,r=e.height,i=t/o,a=n/r;q=Math.min(i,a,1),Ge=0,Ue=0,qe(),Ht()}function qe(){const e=document.querySelector(".canvas-wrapper");e&&(e.style.transform=`translate(${Ge}px, ${Ue}px) scale(${q})`,e.style.transformOrigin="center center")}function Ht(){const e=document.getElementById("zoomSelect");if(!e)return;const t=Math.round(q*100),n=Array.from(e.options).find(o=>o.value!=="fit"&&Math.abs(parseFloat(o.value)-q)<.01);if(n)e.value=n.value;else{let o=e.querySelector('option[data-custom="true"]');o||(o=document.createElement("option"),o.dataset.custom="true",e.insertBefore(o,e.options[e.options.length-1])),o.value=q,o.textContent=`${t}%`,e.value=q}}function Ti(){return q}function Ii(){return{x:Ge,y:Ue}}function $i(){const e=document.getElementById("zoomSelect");e&&e.value==="fit"&&Rt()}const nt={init:Ci,zoomIn:At,zoomOut:Nt,setZoom:Ye,resetView:kt,fitToScreen:Rt,getZoom:Ti,getPan:Ii,updateCanvasSize:$i};let I=null,Ne=null,K=null,X=null,de=null,Et=null,ot=null,Je=!1;function Oi(e,t={}){I=e,Ne=t.renderer||Y,K=t.pixelData||b,X=t.toolRegistry||w,de=t.colorPalette||ne,Et=t.viewport||nt,ot=t.onChange||null,Li(),s.debug?.("CanvasEvents initialized")}function Li(){I.addEventListener("mousedown",_t),I.addEventListener("mousemove",Gt),I.addEventListener("mouseup",ke),I.addEventListener("mouseleave",ke),I.addEventListener("touchstart",Dn,{passive:!1}),I.addEventListener("touchmove",Tn,{passive:!1}),I.addEventListener("touchend",rt),I.addEventListener("touchcancel",rt),I.addEventListener("contextmenu",e=>e.preventDefault()),s.debug?.("Canvas event listeners registered")}function _t(e){if(!X||!K)return;const t=Ut(e);if(!t)return;const n=K.getData(),r={colorCode:de?de.getCurrentColorIndex():1,event:e};Je=!0,X.startDrawing(t.x,t.y,n,r);const i=X.getCurrentToolId();["brush","pencil","eraser"].includes(i)&&X.continueDrawing(t.x,t.y,n,r)&&(Yt(),qt())}function Gt(e){if(!X||!K)return;const t=Ut(e);if(!t)return;const n=K.getData(),r={colorCode:de?de.getCurrentColorIndex():1,event:e,onSelectionChange:In};X.continueDrawing(t.x,t.y,n,r)&&(Yt(),qt()),X.getCurrentToolId()==="select"&&P&&P.renderPreview(t.x,t.y)}function ke(e){if(!Je||!X||!K){Je=!1;return}Je=!1;const t=Ut(e),n=K.getData(),r={colorCode:de?de.getCurrentColorIndex():1,event:e,onSelectionChange:In};let i=!1;t?i=X.endDrawing(t.x,t.y,n,r):i=X.endDrawing(-1,-1,n,r),i&&(Yt(),qt()),X.getCurrentToolId()==="select"&&P&&P.renderPreview()}function Dn(e){if(e.preventDefault(),e.touches.length===0)return;const t=e.touches[0],n=new MouseEvent("mousedown",{clientX:t.clientX,clientY:t.clientY,bubbles:!0});_t(n)}function Tn(e){if(e.preventDefault(),e.touches.length===0)return;const t=e.touches[0],n=new MouseEvent("mousemove",{clientX:t.clientX,clientY:t.clientY,bubbles:!0});Gt(n)}function rt(e){e.preventDefault();const t=new MouseEvent("mouseup",{bubbles:!0});ke(t)}function Ut(e){if(!Ne||!K)return null;const t=K.getDimensions(),n=Et?Et.getZoom():1;return Ne.screenToPixelCoords(e.clientX,e.clientY,t.width,t.height,n)}function In(e){P&&(P.setSelection(e),P.renderPreview()),x&&x.emit(x.Events.SELECTION_CHANGED,e)}function Yt(){Ne&&K&&Ne.render(K.getData())}function qt(){ot&&ot(),x&&x.emit(x.Events.CANVAS_CHANGED)}function Bi(e){ot=e}function Fi(){I&&(I.removeEventListener("mousedown",_t),I.removeEventListener("mousemove",Gt),I.removeEventListener("mouseup",ke),I.removeEventListener("mouseleave",ke),I.removeEventListener("touchstart",Dn),I.removeEventListener("touchmove",Tn),I.removeEventListener("touchend",rt),I.removeEventListener("touchcancel",rt),I.removeEventListener("contextmenu",e=>e.preventDefault()),s.debug?.("CanvasEvents destroyed"))}const it={init:Oi,setChangeCallback:Bi,destroy:Fi};let Oe=null,at=null,en=null,Ee=null,Be=null,mt=0;async function Mi(e,t=16,n=16,o=null){try{if(s.info?.("PixelCanvas initializing..."),at=o,Oe=document.getElementById(e),Ee=w,!Oe)throw new Error(`Canvas element "${e}" not found`);if(en=await Ot.loadConstants(),!b)throw new Error("PixelData module not available");if(b.init(t,n),!Y)throw new Error("CanvasRenderer module not available");if(Y.init(Oe,en),Y.updateCanvasSize(t,n),P&&P.init(Oe,{renderer:Y}),!it)throw new Error("CanvasEvents module not available");it.init(Oe,{renderer:Y,pixelData:b,toolRegistry:Ee,onChange:dt}),ut(),zi(),s.info?.(`PixelCanvas initialized: ${t}×${n}`),x&&x.emit(x.Events.CANVAS_RESIZED,{width:t,height:n})}catch(r){throw s.error?.("PixelCanvas initialization failed",r),r}}function zi(){if(Be)return;function e(){if(Y.render(b.getData()),P&&Ee){mt=(mt+.25)%16;const t=Ee.getCurrentTool(),n={bounds:null,previewBounds:null,movePreview:null};t&&(n.bounds=t.selectionActive?t.selectionBounds:null,t.constructor.CONFIG.id==="select"&&t.isDrawing&&(n.bounds=null,n.previewBounds={x1:Math.min(t.startX,t.lastX),y1:Math.min(t.startY,t.lastY),x2:Math.max(t.startX,t.lastX),y2:Math.max(t.startY,t.lastY)}),t.constructor.CONFIG.id==="move"&&t.isMoving&&(n.movePreview=t.getPreviewData(),n.bounds=null)),P.render(n,mt)}Be=requestAnimationFrame(e)}e(),s.info?.("PixelCanvas render loop started.")}function Pi(){Be&&(cancelAnimationFrame(Be),Be=null,s.info?.("PixelCanvas render loop stopped."))}function Ai(){b&&(b.clear(),dt(),x&&x.emit(x.Events.CANVAS_CLEARED))}function Ni(e,t){return!b||!Y?!1:b.resize(e,t)?(Y.updateCanvasSize(e,t),P&&P.updateSize(),ut(),dt(),x&&x.emit(x.Events.CANVAS_RESIZED,{width:e,height:t}),!0):!1}function ki(e=!1){return b?b.exportToString(e):""}function Ri(e){if(!b||!Y)return!1;const t=b.importFromString(e);if(t.success){const n=b.getDimensions();if(Y.updateCanvasSize(n.width,n.height),P&&P.updateSize(),Ee){const o=Ee.getCurrentTool();o&&o.clearSelection()}return ut(),dt(),x&&x.emit(x.Events.FILE_LOADED,{width:n.width,height:n.height}),!0}else return window.Dialogs?window.Dialogs.alert("Import Failed",t.error,"error"):alert("Import failed: "+t.error),!1}function ut(){if(!b)return;const e=b.getDimensions(),t=document.getElementById("canvasSizeDisplay");t&&yt?t.textContent=yt.formatDimensions(e.width,e.height):t&&(t.textContent=`${e.width}×${e.height}`)}function dt(){at&&at(),ut()}function Hi(){Pi(),it&&it.destroy(),P&&P.destroy(),s.info?.("PixelCanvas destroyed")}function _i(){return b?b.getData():[]}function Gi(){return b?b.getDimensions():{width:0,height:0}}function Ui(){return b?b.getStats():{}}function Yi(e){at=e,events&&events.setChangeCallback(e)}const C={init:Mi,clear:Ai,resize:Ni,exportToString:ki,importFromString:Ri,getPixelData:_i,getDimensions:Gi,getStats:Ui,setChangeCallback:Yi,destroy:Hi};let Ke=null,Dt=!1;function ge(){if(Ke!==null)return Ke;try{const e="__storage_test__";return localStorage.setItem(e,e),localStorage.removeItem(e),Ke=!0,!0}catch(e){return Ke=!1,s.warn?.("localStorage is not available",e),!1}}function Xt(e){if(!ge())return null;try{return localStorage.getItem(e)}catch(t){return s.error?.("localStorage.getItem failed",t),null}}function $n(e,t){if(!ge())return!1;try{return localStorage.setItem(e,t),Dt=!1,!0}catch(n){return n.name==="QuotaExceededError"||n.code===22?(Dt=!0,s.error?.("localStorage quota exceeded",n)):s.error?.("localStorage.setItem failed",n),!1}}function qi(e){if(!ge())return!1;try{return localStorage.removeItem(e),!0}catch(t){return s.error?.("localStorage.removeItem failed",t),!1}}function Xi(){if(!ge())return!1;try{return localStorage.clear(),!0}catch(e){return s.error?.("localStorage.clear failed",e),!1}}function Wi(){if(!ge())return[];try{const e=[];for(let t=0;t<localStorage.length;t++){const n=localStorage.key(t);n&&e.push(n)}return e}catch(e){return s.error?.("localStorage.keys failed",e),[]}}function Vi(){return Dt}function ji(){if(!ge())return null;try{let e=0;for(let n=0;n<localStorage.length;n++){const o=localStorage.key(n);if(o){const r=localStorage.getItem(o);r&&(e+=o.length+r.length)}}const t=5*1024*1024;return{used:e,total:t,percentage:(e/t*100).toFixed(2),usedKB:(e/1024).toFixed(2),totalMB:(t/1024/1024).toFixed(2),available:t-e}}catch(e){return s.error?.("getStorageStats failed",e),null}}function Ki(e,t=null){const n=Xt(e);if(!n)return t;try{return JSON.parse(n)}catch(o){return s.error?.("JSON parse failed",o),t}}function Zi(e,t){try{const n=JSON.stringify(t);return $n(e,n)}catch(n){return s.error?.("JSON stringify failed",n),!1}}function Ji(e){return Xt(e)!==null}const H={isStorageAvailable:ge,getItem:Xt,setItem:$n,removeItem:qi,clear:Xi,keys:Wi,isQuotaExceeded:Vi,getStorageStats:ji,getJSON:Ki,setJSON:Zi,hasKey:Ji};let ye=null,pt=null,Re=null,He=!1,ft=!0;const Qi=3e4,ea=2e3;function ta(){na(),On(),s.info("Autosave initialized")}function na(){const e=document.querySelector(".menu-bar");if(!e)return;const t=document.createElement("div");t.id="autosaveIndicator",t.className="autosave-indicator",t.innerHTML=`
        <span class="autosave-status">
            <span class="autosave-icon">💾</span>
            <span class="autosave-text">Saved</span>
        </span>
        <span class="autosave-time"></span>
    `,e.appendChild(t)}function On(){ye&&clearInterval(ye),ye=setInterval(()=>{He&&ft&&Wt()},Qi)}function oa(){ye&&(clearInterval(ye),ye=null)}function ra(){He=!0,Qe("unsaved"),pt&&clearTimeout(pt),pt=setTimeout(()=>{He&&ft&&Wt()},ea)}function Wt(){if(!ft)return;Qe("saving");const e=oe?oe.getCurrentTab():null;if(!e)return;const t=C.exportToString();try{const n=`autosave_${e.id}`;H.setItem(n,t),H.setItem(`${n}_timestamp`,Date.now().toString()),He=!1,Re=Date.now(),setTimeout(()=>{Qe("saved")},500),s.info("Autosaved:",e.name)}catch(n){s.error("Autosave failed:",n),Qe("error")}}function Qe(e){const t=document.getElementById("autosaveIndicator");if(!t)return;const n=t.querySelector(".autosave-icon"),o=t.querySelector(".autosave-text"),r=t.querySelector(".autosave-time");switch(t.classList.remove("status-saved","status-saving","status-unsaved","status-error"),e){case"saved":t.classList.add("status-saved"),n.textContent="✓",o.textContent="Saved",Re&&(r.textContent=Ln(Re));break;case"saving":t.classList.add("status-saving"),n.textContent="⏳",o.textContent="Saving...";break;case"unsaved":t.classList.add("status-unsaved"),n.textContent="●",o.textContent="Unsaved";break;case"error":t.classList.add("status-error"),n.textContent="⚠️",o.textContent="Error";break}}function Ln(e){const t=Math.floor((Date.now()-e)/1e3);return t<60?"just now":t<3600?`${Math.floor(t/60)}m ago`:t<86400?`${Math.floor(t/3600)}h ago`:`${Math.floor(t/86400)}d ago`}function ia(){setInterval(()=>{const t=document.getElementById("autosaveIndicator")?.querySelector(".autosave-time");t&&Re&&!He&&(t.textContent=Ln(Re))},3e4)}function aa(e){try{const t=`autosave_${e}`,n=H.getItem(t),o=H.getItem(`${t}_timestamp`);if(n&&o)return{data:n,timestamp:parseInt(o)}}catch(t){s.error("Failed to load autosave:",t)}return null}function sa(e){try{const t=`autosave_${e}`;H.removeItem(t),H.removeItem(`${t}_timestamp`)}catch(t){s.error("Failed to clear autosave:",t)}}function la(e){ft=e,e?On():oa()}function ca(){Wt()}ia();const ie={init:ta,markDirty:ra,forceSave:ca,loadAutosave:aa,clearAutosave:sa,setEnabled:la};let A=[],ae=null,Fe=0;function ua(){da(),va().length===0&&Vt("Untitled-1",16,16),s.info("Tab Manager initialized")}function da(){const e=document.querySelector(".workspace");if(!e)return;const t=e.querySelector(".menu-bar"),n=document.createElement("div");n.className="tab-bar",n.id="tabBar",n.innerHTML=`
        <div class="tab-list" id="tabList"></div>
        <button class="tab-new-btn" id="newTabBtn" title="New Document (Ctrl+N)">+</button>
    `,e.insertBefore(n,t.nextSibling),document.getElementById("newTabBtn").addEventListener("click",()=>{Vt()})}function Vt(e=null,t=16,n=16,o=null){Fe++;const r=`tab_${Date.now()}_${Fe}`,i=e||`Untitled-${Fe}`,a={id:r,name:i,width:t,height:n,data:o||Bn(t,n),isDirty:!1,created:Date.now(),modified:Date.now()};return A.push(a),Fn(a),De(r),a}function Bn(e,t){const n="0".repeat(e*t);return`${e}x${t}:${n}`}function Fn(e){const t=document.getElementById("tabList");if(!t)return;const n=document.createElement("div");n.className="tab",n.dataset.tabId=e.id,n.innerHTML=`
        <span class="tab-name">${e.name}</span>
        <span class="tab-dirty" style="display: none;">●</span>
        <button class="tab-close" title="Close">×</button>
    `,n.addEventListener("click",o=>{o.target.classList.contains("tab-close")||De(e.id)}),n.querySelector(".tab-close").addEventListener("click",o=>{o.stopPropagation(),Mn(e.id)}),n.querySelector(".tab-name").addEventListener("dblclick",o=>{o.stopPropagation(),zn(e.id)}),t.appendChild(n)}function De(e){const t=A.find(n=>n.id===e);t&&(ae&&fa(),ae=e,document.querySelectorAll(".tab").forEach(n=>{n.classList.toggle("active",n.dataset.tabId===e)}),C&&C.importFromString(t.data),document.title=`${t.name} - Inline.px`,s.info("Switched to tab:",t.name))}function fa(){const e=A.find(t=>t.id===ae);!e||!C||(e.data=C.exportToString(),e.modified=Date.now())}async function Mn(e){const t=A.find(o=>o.id===e);if(!t)return;if(A.length===1){await M.confirm("Close Document","Close this document and create a new one?",{confirmText:"Close & New",cancelText:"Cancel",type:"info"})&&(t.data=Bn(16,16),t.name="Untitled-1",t.isDirty=!1,Xe(t),De(t.id),C&&C.importFromString(t.data));return}if(t.isDirty&&!await M.confirm("Unsaved Changes",`"${t.name}" has unsaved changes. Close anyway?`,{confirmText:"Close",cancelText:"Cancel",type:"warning",dangerous:!0}))return;A=A.filter(o=>o.id!==e);const n=document.querySelector(`.tab[data-tab-id="${e}"]`);if(n&&n.remove(),ae===e){const o=A[A.length-1];o&&De(o.id)}ie&&ie.clearAutosave(e),s.info("Closed tab:",t.name)}async function zn(e){const t=A.find(o=>o.id===e);if(!t)return;const n=await M.prompt("Rename Document","Enter a new name for this document:",t.name,{placeholder:"Document name"});n&&n.trim()&&(t.name=n.trim(),Xe(t),ae===e&&(document.title=`${t.name} - Inline.px`))}function Xe(e){const t=document.querySelector(`.tab[data-tab-id="${e.id}"]`);if(!t)return;const n=t.querySelector(".tab-name"),o=t.querySelector(".tab-dirty");n&&(n.textContent=e.name),o&&(o.style.display=e.isDirty?"inline":"none")}function ha(){const e=A.find(t=>t.id===ae);e&&(e.isDirty=!0,e.modified=Date.now(),Xe(e),ie&&ie.markDirty())}function ga(){const e=A.find(t=>t.id===ae);e&&(e.isDirty=!1,Xe(e))}function Pn(){return A.find(e=>e.id===ae)||null}function ma(){return A}function pa(e){const t=Pn();t&&(t.name=e,Xe(t),document.title=`${t.name} - Inline.px`)}function va(){const e=[];try{if(!H.isStorageAvailable())return s.warn?.("localStorage not available, cannot restore tabs"),e;const t=H.keys();for(const n of t)if(n&&n.startsWith("autosave_tab_")&&!n.endsWith("_timestamp"))try{const o=n.replace("autosave_",""),r=ie?ie.loadAutosave(o):null;if(r&&r.data){const i=r.data.split(":");let a,l;i[1]==="RLE"?(a=i[0].split("x"),l=W.decompress(r.data)):(a=i[0].split("x"),l=r.data);const c=parseInt(a[0]),u=parseInt(a[1]);if(isNaN(c)||isNaN(u)||c<=0||u<=0){s.warn?.(`Invalid dimensions in autosave ${o}, skipping`);continue}Fe++;const h={id:o,name:`Restored-${Fe}`,width:c,height:u,data:l,isDirty:!1,created:r.timestamp,modified:r.timestamp};A.push(h),Fn(h),e.push(h)}}catch(o){s.warn?.("Failed to restore individual tab, skipping",o);continue}e.length>0&&(De(e[0].id),s.info?.(`Restored ${e.length} autosaved tab(s)`))}catch(t){s.error?.("Failed to restore autosaved tabs:",t)}return e}const oe={init:ua,createNewTab:Vt,switchToTab:De,closeTab:Mn,renameTab:zn,markCurrentTabDirty:ha,markCurrentTabClean:ga,getCurrentTab:Pn,getAllTabs:ma,setCurrentTabName:pa},An="pixelart_files";let fe=null;function We(){return H.getJSON(An,[])}async function Nn(e){const t=H.setJSON(An,e);return t||(s.error?.("Error saving to LocalStorage"),H.isQuotaExceeded()?await M.alert("Storage Full","Storage quota exceeded. Please delete some files to free up space.","error"):H.isStorageAvailable()?await M.alert("Save Failed","Failed to save file. Please try again.","error"):await M.alert("Storage Unavailable","LocalStorage is not available. Your browser may be in private mode.","error")),t}async function ya(e,t=null){if(!t&&(t=await M.prompt("Save Pixel Art","Enter a name for your pixel art:",fe||"untitled",{placeholder:"File name"}),!t))return!1;const n=e.split(":");if(n.length!==2)return await M.alert("Invalid Format","Invalid data format.","error"),!1;const o=n[0].split("x"),r=parseInt(o[0]),i=parseInt(o[1]),a=We(),l=a.findIndex(u=>u.name===t);if(l>=0&&!await M.confirm("Overwrite File",`A file named "${t}" already exists. Overwrite it?`,{confirmText:"Overwrite",cancelText:"Cancel",type:"warning"}))return!1;const c={id:l>=0?a[l].id:wa(),name:t,data:e,timestamp:Date.now(),width:r,height:i};return l>=0?a[l]=c:a.push(c),Nn(a)?(fe=t,await M.alert("Saved!",`Saved as "${t}"`,"success"),!0):!1}function Ca(e){const n=We().find(o=>o.id===e);return n?(fe=n.name,n):null}function kn(e){const t=We(),n=t.filter(o=>o.id!==e);return n.length<t.length?Nn(n):!1}function Sa(e,t=null){t||(t=fe||"pixelart"),t.endsWith(".txt")||(t+=".txt");const n=new Blob([e],{type:"text/plain"}),o=URL.createObjectURL(n),r=document.createElement("a");r.href=o,r.download=t,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(o)}function wa(){return"file_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}function xa(){return fe}function ba(e){fe=e}function Ea(){fe=null}function Rn(e){return new Date(e).toLocaleString()}function Da(){return H.getStorageStats()}function Ta(e){const t=document.getElementById("fileModal"),n=document.getElementById("fileList"),o=document.getElementById("noFilesMessage"),r=document.getElementById("closeModal");if(!t||!n){s.error("Modal elements not found");return}const i=We();n.innerHTML="",i.length===0?o.classList.remove("hidden"):(o.classList.add("hidden"),i.sort((c,u)=>u.timestamp-c.timestamp),i.forEach(c=>{const u=Ia(c,e);n.appendChild(u)})),t.classList.add("flex"),t.classList.remove("hidden");const a=()=>{t.classList.add("hidden"),t.classList.remove("flex"),r.removeEventListener("click",a),t.removeEventListener("click",l)},l=c=>{c.target===t&&a()};r.addEventListener("click",a),t.addEventListener("click",l)}function Ia(e,t){const n=document.createElement("div");n.className="file-item";const o=document.createElement("div");o.className="file-item-info";const r=document.createElement("div");r.className="file-item-name",r.textContent=e.name;const i=document.createElement("div");i.className="file-item-meta",i.textContent=`${e.width}x${e.height} • ${Rn(e.timestamp)}`,o.appendChild(r),o.appendChild(i);const a=document.createElement("div");a.className="file-item-actions";const l=document.createElement("button");l.className="btn btn-success",l.textContent="Load",l.addEventListener("click",()=>{const u=document.getElementById("fileModal");u.classList.add("hidden"),u.classList.remove("flex"),t(e)});const c=document.createElement("button");return c.className="btn btn-danger",c.textContent="Delete",c.addEventListener("click",async()=>{if(await M.confirm("Delete File",`Delete "${e.name}"? This cannot be undone.`,{confirmText:"Delete",cancelText:"Cancel",type:"error",dangerous:!0})&&kn(e.id)){n.remove();const h=document.getElementById("fileList");if(h&&h.children.length===0){const d=document.getElementById("noFilesMessage");d&&d.classList.remove("hidden")}}}),a.appendChild(l),a.appendChild(c),n.appendChild(o),n.appendChild(a),n}const Te={save:ya,load:Ca,deleteFile:kn,getAllFiles:We,exportAsFile:Sa,getCurrentFileName:xa,setCurrentFileName:ba,clearCurrentFileName:Ea,formatDate:Rn,getStorageStats:Da,showLoadDialog:Ta};let te=[],se=[];const Hn=50;let Tt=null;function $a(e={}){e.onHistoryChange&&(Tt=e.onHistoryChange),s.info("History system initialized")}function Oa(e,t="Change"){e&&(te.push({data:e,action:t,timestamp:Date.now()}),te.length>Hn&&te.shift(),se=[],ht())}function La(e){if(te.length===0)return s.debug("Nothing to undo"),null;e&&se.push({data:e,action:"Redo point",timestamp:Date.now()});const t=te.pop();return ht(),s.info("Undo:",t.action),t.data}function Ba(e){if(se.length===0)return s.debug("Nothing to redo"),null;e&&te.push({data:e,action:"Undo point",timestamp:Date.now()});const t=se.pop();return ht(),s.info("Redo:",t.action),t.data}function Fa(){te=[],se=[],ht(),s.info("History cleared")}function _n(){return te.length>0}function Gn(){return se.length>0}function Ma(){return{undoCount:te.length,redoCount:se.length,maxHistory:Hn}}function ht(){Tt&&Tt({canUndo:_n(),canRedo:Gn(),undoCount:te.length,redoCount:se.length})}const Ie={init:$a,pushState:Oa,undo:La,redo:Ba,clear:Fa,canUndo:_n,canRedo:Gn,getStats:Ma};function za(e=1,t="pixelart.png"){if(!document.getElementById("pixelCanvas")){s.error("Canvas not found");return}const o=C.getDimensions(),r=C.getPixelData(),i=document.createElement("canvas");i.width=o.width*e,i.height=o.height*e;const a=i.getContext("2d");a.imageSmoothingEnabled=!1,a.imageSmoothingQuality="high";for(let l=0;l<o.height;l++)for(let c=0;c<o.width;c++){const u=r[l][c];if(u===0)continue;const h=ne.getColor(u);a.fillStyle=h,a.fillRect(c*e,l*e,e,e)}i.toBlob(l=>{Un(l,t)},"image/png")}function Pa(e,t=1,n="pixelart.png"){let o=e;W&&W.isCompressed(e)&&(o=W.decompress(e));const[r,i]=o.split(":"),[a,l]=r.split("x").map(Number),c=document.createElement("canvas");c.width=a*t,c.height=l*t;const u=c.getContext("2d");u.imageSmoothingEnabled=!1;for(let h=0;h<l;h++)for(let d=0;d<a;d++){const f=h*a+d,m=i[f],p=ne.getIndexFromChar(m);if(p===0)continue;const y=ne.getColor(p);u.fillStyle=y,u.fillRect(d*t,h*t,t,t)}c.toBlob(h=>{Un(h,n)},"image/png")}function Aa(e=1){const t=C.getDimensions(),n=C.getPixelData(),o=document.createElement("canvas");o.width=t.width*e,o.height=t.height*e;const r=o.getContext("2d");r.imageSmoothingEnabled=!1;for(let i=0;i<t.height;i++)for(let a=0;a<t.width;a++){const l=n[i][a];if(l===0)continue;const c=ne.getColor(l);r.fillStyle=c,r.fillRect(a*e,i*e,e,e)}return o.toDataURL("image/png")}function Un(e,t){const n=URL.createObjectURL(e),o=document.createElement("a");o.href=n,o.download=t,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(n)}async function Na(e=1){try{const t=C.getDimensions(),n=C.getPixelData(),o=document.createElement("canvas");o.width=t.width*e,o.height=t.height*e;const r=o.getContext("2d");r.imageSmoothingEnabled=!1;for(let a=0;a<t.height;a++)for(let l=0;l<t.width;l++){const c=n[a][l];if(c===0)continue;const u=ne.getColor(c);r.fillStyle=u,r.fillRect(l*e,a*e,e,e)}const i=await new Promise(a=>{o.toBlob(a,"image/png")});if(navigator.clipboard&&navigator.clipboard.write)return await navigator.clipboard.write([new ClipboardItem({"image/png":i})]),!0;throw new Error("Clipboard API not supported")}catch(t){return s.error("Failed to copy PNG to clipboard:",t),!1}}function ka(){const e=C.getDimensions(),t=Math.max(e.width,e.height);return[{value:1,label:"1× (Original)",size:`${e.width}×${e.height}`},{value:2,label:"2× (Small)",size:`${e.width*2}×${e.height*2}`},{value:4,label:"4× (Medium)",size:`${e.width*4}×${e.height*4}`},{value:8,label:"8× (Large)",size:`${e.width*8}×${e.height*8}`}].filter(o=>t*o.value<=2048)}const Ra={exportToPNG:za,exportDataStringToPNG:Pa,getDataURL:Aa,copyToClipboard:Na,getScaleOptions:ka};class Ha extends Z{static CONFIG={id:"brush",name:"Brush",icon:"brush",shortcut:"B",cursor:"crosshair",hasSizeOption:!0,hasShapeOption:!1,description:"Variable size painting brush",category:"drawing"};onDrawStart(t,n,o,r){return this.drawBrush(t,n,o,r)}onDrawContinue(t,n,o,r){return this.drawBrush(t,n,o,r)}onDrawEnd(t,n,o,r){return this.drawBrush(t,n,o,r)}drawBrush(t,n,o,r){const i=o.length,a=o[0].length,l=r.brushSize||this.getOption("brushSize")||1,c=r.colorCode||0;let u=!1;const h=Math.floor(l/2);for(let d=-h;d<=h;d++)for(let f=-h;f<=h;f++){const m=t+f,p=n+d,y=f*f+d*d,g=h*h+h;if(y<=g&&m>=0&&m<a&&p>=0&&p<i){if(this.respectsSelection()&&!this.isInSelection(m,p))continue;o[p][m]!==c&&(o[p][m]=c,u=!0)}}return u}}class _a extends Z{static CONFIG={id:"pencil",name:"Pencil",icon:"edit",shortcut:"P",cursor:"crosshair",hasSizeOption:!1,hasShapeOption:!1,description:"1px precise drawing",category:"drawing"};onDrawStart(t,n,o,r){return this.setPixelIfValid(t,n,o,r.colorCode)}onDrawContinue(t,n,o,r){return this.setPixelIfValid(t,n,o,r.colorCode)}onDrawEnd(t,n,o,r){return this.setPixelIfValid(t,n,o,r.colorCode)}setPixelIfValid(t,n,o,r){return this.respectsSelection()&&!this.isInSelection(t,n)?!1:this.setPixel(t,n,o,r)}}class Ga extends Z{static CONFIG={id:"eraser",name:"Eraser",icon:"ink_eraser",shortcut:"E",cursor:"crosshair",hasSizeOption:!0,hasShapeOption:!1,description:"Erase to transparent",category:"drawing"};onDrawStart(t,n,o,r){return this.erase(t,n,o,r)}onDrawContinue(t,n,o,r){return this.erase(t,n,o,r)}onDrawEnd(t,n,o,r){return this.erase(t,n,o,r)}erase(t,n,o,r){const i=o.length,a=o[0].length,l=r.brushSize||this.getOption("brushSize")||1;let c=!1;const u=Math.floor(l/2);for(let h=-u;h<=u;h++)for(let d=-u;d<=u;d++){const f=t+d,m=n+h,p=d*d+h*h,y=u*u+u;if(p<=y&&f>=0&&f<a&&m>=0&&m<i){if(this.respectsSelection()&&!this.isInSelection(f,m))continue;o[m][f]!==0&&(o[m][f]=0,c=!0)}}return c}}class Ua extends Z{static CONFIG={id:"line",name:"Line",icon:"show_chart",shortcut:"L",cursor:"crosshair",hasSizeOption:!0,hasShapeOption:!1,description:"Draw straight lines",category:"shape"};needsPreview(){return!0}onDrawStart(t,n,o,r){return!1}onDrawContinue(t,n,o,r){return this.restorePreviewData(o),this.drawLine(this.startX,this.startY,t,n,o,r)}onDrawEnd(t,n,o,r){return this.restorePreviewData(o),this.drawLine(this.startX,this.startY,t,n,o,r)}drawLine(t,n,o,r,i,a){const l=i.length,c=i[0].length,u=a.colorCode||0,h=a.brushSize||1;let d=!1;const f=Math.abs(o-t),m=Math.abs(r-n),p=t<o?1:-1,y=n<r?1:-1;let g=f-m,v=t,D=n;for(;h>1?d=this.drawBrushAt(v,D,i,u,h)||d:v>=0&&v<c&&D>=0&&D<l&&(this.respectsSelection()&&!this.isInSelection(v,D)||i[D][v]!==u&&(i[D][v]=u,d=!0)),!(v===o&&D===r);){const V=2*g;V>-m&&(g-=m,v+=p),V<f&&(g+=f,D+=y)}return d}drawBrushAt(t,n,o,r,i){const a=o.length,l=o[0].length;let c=!1;const u=Math.floor(i/2);for(let h=-u;h<=u;h++)for(let d=-u;d<=u;d++){const f=t+d,m=n+h,p=d*d+h*h,y=u*u+u;if(p<=y&&f>=0&&f<l&&m>=0&&m<a){if(this.respectsSelection()&&!this.isInSelection(f,m))continue;o[m][f]!==r&&(o[m][f]=r,c=!0)}}return c}}class Ya extends Z{static CONFIG={id:"rectangle",name:"Rectangle",icon:"rectangle",shortcut:"R",cursor:"crosshair",hasSizeOption:!1,hasShapeOption:!0,description:"Draw rectangles",category:"shape"};needsPreview(){return!0}onDrawStart(t,n,o,r){return!1}onDrawContinue(t,n,o,r){return this.restorePreviewData(o),this.drawRectangle(this.startX,this.startY,t,n,o,r)}onDrawEnd(t,n,o,r){return this.restorePreviewData(o),this.drawRectangle(this.startX,this.startY,t,n,o,r)}drawRectangle(t,n,o,r,i,a){const l=i.length,c=i[0].length,u=a.colorCode||0,h=a.shapeMode||this.getOption("shapeMode")||"fill";let d=!1;const f=Math.max(0,Math.min(t,o)),m=Math.min(c-1,Math.max(t,o)),p=Math.max(0,Math.min(n,r)),y=Math.min(l-1,Math.max(n,r));if(h==="fill")for(let g=p;g<=y;g++)for(let v=f;v<=m;v++)this.respectsSelection()&&!this.isInSelection(v,g)||i[g][v]!==u&&(i[g][v]=u,d=!0);else{for(let g=f;g<=m;g++)this.isInSelection(g,p)&&i[p][g]!==u&&(i[p][g]=u,d=!0),this.isInSelection(g,y)&&i[y][g]!==u&&(i[y][g]=u,d=!0);for(let g=p;g<=y;g++)this.isInSelection(f,g)&&i[g][f]!==u&&(i[g][f]=u,d=!0),this.isInSelection(m,g)&&i[g][m]!==u&&(i[g][m]=u,d=!0)}return d}}class qa extends Z{static CONFIG={id:"ellipse",name:"Ellipse",icon:"circle",shortcut:"O",cursor:"crosshair",hasSizeOption:!1,hasShapeOption:!0,description:"Draw circles/ellipses",category:"shape"};needsPreview(){return!0}onDrawStart(t,n,o,r){return!1}onDrawContinue(t,n,o,r){return this.restorePreviewData(o),this.drawEllipse(this.startX,this.startY,t,n,o,r)}onDrawEnd(t,n,o,r){return this.restorePreviewData(o),this.drawEllipse(this.startX,this.startY,t,n,o,r)}drawEllipse(t,n,o,r,i,a){const l=i.length,c=i[0].length,u=a.colorCode||0,h=a.shapeMode||this.getOption("shapeMode")||"fill";let d=!1;const f=Math.floor((t+o)/2),m=Math.floor((n+r)/2),p=Math.abs(o-t)/2,y=Math.abs(r-n)/2;if(h==="fill")for(let g=Math.floor(m-y);g<=Math.ceil(m+y);g++)for(let v=Math.floor(f-p);v<=Math.ceil(f+p);v++){if(v<0||v>=c||g<0||g>=l)continue;const D=(v-f)/p,V=(g-m)/y;if(D*D+V*V<=1){if(this.respectsSelection()&&!this.isInSelection(v,g))continue;i[g][v]!==u&&(i[g][v]=u,d=!0)}}else for(let g=0;g<360;g+=1){const v=g*Math.PI/180,D=Math.round(f+p*Math.cos(v)),V=Math.round(m+y*Math.sin(v));if(D>=0&&D<c&&V>=0&&V<l){if(this.respectsSelection()&&!this.isInSelection(D,V))continue;i[V][D]!==u&&(i[V][D]=u,d=!0)}}return d}}class Xa extends Z{static CONFIG={id:"fill",name:"Fill",icon:"format_color_fill",shortcut:"F",cursor:"crosshair",hasSizeOption:!1,hasShapeOption:!1,description:"Flood fill",category:"drawing"};onDrawStart(t,n,o,r){return!1}onDrawContinue(t,n,o,r){return!1}onDrawEnd(t,n,o,r){return this.floodFill(t,n,o,r)}floodFill(t,n,o,r){const i=o.length,a=o[0].length,l=r.colorCode||0;if(t<0||t>=a||n<0||n>=i)return!1;if(this.respectsSelection()&&!this.isInSelection(t,n))return this.logger.warn?.("Fill tool: clicked outside selection"),!1;const c=o[n][t];if(c===l)return!1;const u=[[t,n]],h=new Set;let d=!1,f=0;const m=a*i;for(;u.length>0&&f<m;){f++;const[p,y]=u.pop(),g=`${p},${y}`;h.has(g)||p<0||p>=a||y<0||y>=i||o[y][p]===c&&(this.respectsSelection()&&!this.isInSelection(p,y)||(o[y][p]=l,h.add(g),d=!0,u.push([p+1,y]),u.push([p-1,y]),u.push([p,y+1]),u.push([p,y-1])))}return f>=m&&this.logger.warn?.("Flood fill reached iteration limit"),d}}class Wa extends Z{static CONFIG={id:"select",name:"Select",icon:"select_all",shortcut:"M",cursor:"crosshair",hasSizeOption:!1,hasShapeOption:!1,description:"Rectangular selection",category:"selection"};constructor(){super(),this.tempSelection=null}respectsSelection(){return!1}onDrawStart(t,n,o,r){return this.tempSelection={x1:t,y1:n,x2:t,y2:n},!1}onDrawContinue(t,n,o,r){return this.tempSelection&&(this.tempSelection.x2=t,this.tempSelection.y2=n),!1}onDrawEnd(t,n,o,r){if(this.tempSelection){const i={x1:Math.min(this.tempSelection.x1,t),y1:Math.min(this.tempSelection.y1,n),x2:Math.max(this.tempSelection.x1,t),y2:Math.max(this.tempSelection.y1,n)};this.setSelection(i),this.tempSelection=null,r.onSelectionChange&&r.onSelectionChange(i)}return!1}onDrawCancel(){this.tempSelection=null}getSelectionData(){if(this.tempSelection){const t=Math.min(this.tempSelection.x1,this.tempSelection.x2),n=Math.min(this.tempSelection.y1,this.tempSelection.y2),o=Math.max(this.tempSelection.x1,this.tempSelection.x2),r=Math.max(this.tempSelection.y1,this.tempSelection.y2);return{active:!0,isDrawing:!0,x1:t,y1:n,x2:o,y2:r}}else if(this.selectionActive&&this.selectionBounds)return{active:!0,isDrawing:!1,...this.selectionBounds};return null}getSelectedPixels(t){if(!this.selectionActive||!this.selectionBounds)return null;const{x1:n,y1:o,x2:r,y2:i}=this.selectionBounds,a=[];for(let l=o;l<=i;l++){const c=[];for(let u=n;u<=r;u++)l>=0&&l<t.length&&u>=0&&u<t[0].length?c.push(t[l][u]):c.push(0);a.push(c)}return a}}class Va extends Z{static CONFIG={id:"magicWand",name:"Magic Wand",icon:"auto_fix_high",shortcut:"W",cursor:"crosshair",hasSizeOption:!1,hasShapeOption:!1,description:"Select by color",category:"selection"};respectsSelection(){return!1}onDrawStart(t,n,o,r){return!1}onDrawContinue(t,n,o,r){return!1}onDrawEnd(t,n,o,r){return this.selectByColor(t,n,o,r)}selectByColor(t,n,o,r){const i=o.length,a=o[0].length;if(t<0||t>=a||n<0||n>=i)return!1;const l=o[n][t],c=[],u=[[t,n]],h=new Set;for(;u.length>0;){const[g,v]=u.pop(),D=`${g},${v}`;h.has(D)||g<0||g>=a||v<0||v>=i||o[v][g]===l&&(h.add(D),c.push([g,v]),u.push([g+1,v]),u.push([g-1,v]),u.push([g,v+1]),u.push([g,v-1]))}if(c.length===0)return this.clearSelection(),!1;let d=a,f=i,m=0,p=0;c.forEach(([g,v])=>{d=Math.min(d,g),f=Math.min(f,v),m=Math.max(m,g),p=Math.max(p,v)});const y={x1:d,y1:f,x2:m,y2:p};return this.setSelection(y),r.onSelectionChange&&r.onSelectionChange(y),this.logger.info?.(`Magic wand selected ${c.length} pixels`),!1}}class ja extends Z{static CONFIG={id:"move",name:"Move",icon:"open_with",shortcut:"V",cursor:"move",hasSizeOption:!1,hasShapeOption:!1,description:"Move selected content",category:"navigation"};constructor(){super(),this.isMoving=!1,this.selectionData=null,this.originalSelectionBounds=null,this.currentOffset={x:0,y:0}}needsPreview(){return!0}getPreviewData(){return!this.isMoving||!this.selectionData?null:{pixelData:this.selectionData,x:this.originalSelectionBounds.x1+this.currentOffset.x,y:this.originalSelectionBounds.y1+this.currentOffset.y}}onDrawStart(t,n,o,r){if(!this.selectionActive||!this.selectionBounds)return this.logger.info?.("MoveTool: No selection active, nothing to move."),!1;this.isMoving=!0,this.originalSelectionBounds={...this.selectionBounds},this.currentOffset={x:0,y:0};const{x1:i,y1:a,x2:l,y2:c}=this.originalSelectionBounds,u=l-i+1,h=c-a+1;this.selectionData=[];for(let d=0;d<h;d++){this.selectionData[d]=[];for(let f=0;f<u;f++)this.selectionData[d][f]=o[a+d][i+f]}for(let d=a;d<=c;d++)for(let f=i;f<=l;f++)o[d][f]=0;return!0}onDrawContinue(t,n,o,r){return this.isMoving&&(this.currentOffset.x=t-this.startX,this.currentOffset.y=n-this.startY),!1}onDrawEnd(t,n,o,r){if(!this.isMoving)return!1;const i=this.originalSelectionBounds.x1+this.currentOffset.x,a=this.originalSelectionBounds.y1+this.currentOffset.y,l=this.selectionData.length,c=this.selectionData[0].length,u=o.length,h=o[0].length;for(let f=0;f<l;f++)for(let m=0;m<c;m++){const p=i+m,y=a+f;p>=0&&p<h&&y>=0&&y<u&&this.selectionData[f][m]!==0&&(o[y][p]=this.selectionData[f][m])}const d={x1:i,y1:a,x2:i+c-1,y2:a+l-1};return this.setSelection(d),x.emit(x.Events.SELECTION_CHANGED,{bounds:d}),this.resetState(),!0}onDrawCancel(){if(this.isMoving){const{x1:t,y1:n}=this.originalSelectionBounds,o=this.selectionData.length,r=this.selectionData[0].length;for(let i=0;i<o;i++)for(let a=0;a<r;a++)n+i>=0&&n+i<this.pixelData.length&&t+a>=0&&t+a<this.pixelData[0].length&&(this.pixelData[n+i][t+a]=this.selectionData[i][a])}this.resetState()}resetState(){this.isMoving=!1,this.selectionData=null,this.originalSelectionBounds=null,this.currentOffset={x:0,y:0}}}class Ka extends Z{static CONFIG={id:"hand",name:"Hand",icon:"pan_tool",shortcut:"H",cursor:"grab",hasSizeOption:!1,hasShapeOption:!1,description:"Pan canvas",category:"navigation"};constructor(){super(),this.viewportModule=null}init(){super.init()}activate(){super.activate(),this.updateCursor("grab")}respectsSelection(){return!1}onDrawStart(t,n,o,r){return this.updateCursor("grabbing"),this.viewportModule&&this.viewportModule.startPan&&this.viewportModule.startPan(t,n),!1}onDrawContinue(t,n,o,r){return this.viewportModule&&this.viewportModule.continuePan&&this.viewportModule.continuePan(t,n),!1}onDrawEnd(t,n,o,r){return this.updateCursor("grab"),this.viewportModule&&this.viewportModule.endPan&&this.viewportModule.endPan(),!1}onDrawCancel(){this.updateCursor("grab")}updateCursor(t){const n=document.querySelector(".canvas-container");n&&(n.style.cursor=t)}getCursor(){return this.isDrawing?"grabbing":"grab"}}let tn=!1,$e=null,nn=null;async function Za(){if(tn){s.warn("Application already initialized.");return}try{s.info("Inline.px initializing..."),$e=await Ot.loadConstants(),_e.init($e),await Ja(),es(),rs(),tn=!0,s.info("Inline.px ready!"),x.emit("app:ready")}catch(e){s.error("Application initialization failed",e),x.emit("app:error",e),alert(`Critical error during initialization: ${e.message}. The app may not function correctly.`)}}async function Ja(){M.init(),await ne.init("colorPalette",ss);const{defaultWidth:e,defaultHeight:t}=$e.canvas;await C.init("pixelCanvas",e,t,ls),await Qa(),oe.init(),ie.init(),nt.init(),Ie.init({onHistoryChange:cs}),s.info("Core systems initialized")}async function Qa(){const e=[Ha,_a,Ga,Ua,Ya,qa,Xa,Wa,Va,ja,Ka];w.init({onToolChange:is,onToolOptionChange:as,sharedOptions:{brushSize:$e.tools.defaultBrushSize,shapeMode:$e.tools.defaultShapeMode,colorCode:1}});const t=w.registerTools(e);s.info(`Registered ${t} tools`),w.setCurrentTool("brush")}function es(){ts(),ns(),os(),me(),gt()}function ts(){const e=document.getElementById("toolbox");if(!e)return;e.innerHTML="",w.getAllTools().forEach(n=>{const o=document.createElement("button");o.className="tool-btn",o.dataset.tool=n.id,o.title=`${n.name} (${n.shortcut})`,n.id===w.getCurrentToolId()&&o.classList.add("active"),o.innerHTML=`<span class="material-symbols-outlined tool-icon">${n.icon}</span><span class="tool-label">${n.name}</span><span class="tool-shortcut">${n.shortcut}</span>`,o.addEventListener("click",()=>w.setCurrentTool(n.id)),e.appendChild(o)}),s.debug("Toolbox setup complete")}function ns(){J("newBtn",Yn),J("saveBtn",qn),J("loadBtn",Xn),J("undoBtn",Wn),J("redoBtn",It),J("exportFileBtn",us),J("importStringBtn",ds),J("clearBtn",fs),J("copyLiveStringBtn",hs)}function os(){document.querySelectorAll(".tool-size-btn").forEach(e=>{e.addEventListener("click",()=>{const t=parseInt(e.dataset.size);w.setToolOption("brushSize",t),document.querySelectorAll(".tool-size-btn").forEach(n=>n.classList.remove("active")),e.classList.add("active")})}),document.querySelectorAll(".tool-mode-btn").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.mode;w.setToolOption("shapeMode",t),document.querySelectorAll(".tool-mode-btn").forEach(n=>n.classList.remove("active")),e.classList.add("active")})}),document.querySelectorAll(".preset-btn").forEach(e=>{e.addEventListener("click",()=>{const t=parseInt(e.dataset.size);document.getElementById("canvasWidth").value=t,document.getElementById("canvasHeight").value=t,vt()})}),J("resizeBtn",vt),["canvasWidth","canvasHeight"].forEach(e=>{const t=document.getElementById(e);t&&(t.addEventListener("keypress",n=>n.key==="Enter"&&vt()),t.addEventListener("input",gt))})}function rs(){document.addEventListener("keydown",e=>{if(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA")return;const t=e.key.toLowerCase();if(e.key==="Escape"){e.preventDefault(),w.clearSelection();return}if(w&&/^[a-z]$/.test(t)){const n=w.getToolByShortcut(t.toUpperCase());if(n){e.preventDefault(),w.setCurrentTool(n.getId());return}}if(e.ctrlKey||e.metaKey){const n={z:Wn,y:It,n:Yn,s:qn,o:Xn};n[t]&&(e.preventDefault(),t==="z"&&e.shiftKey?It():n[t]())}})}function is(e,t){document.querySelectorAll(".tool-btn").forEach(n=>n.classList.toggle("active",n.dataset.tool===e)),document.getElementById("currentToolName").textContent=t.name,document.querySelector(".canvas-container").style.cursor=t.cursor,document.getElementById("brushSizeOption").style.display=t.hasSizeOption?"flex":"none",document.getElementById("shapeModeOption").style.display=t.hasShapeOption?"flex":"none",s.debug(`Tool changed to: ${t.name}`)}function as(e,t){s.debug(`Tool option changed: ${e} = ${t}`)}function ss(e,t){document.getElementById("currentColorDisplay").style.backgroundColor=t,w.setToolOption("colorCode",e)}function ls(){me(),oe.markCurrentTabDirty(),clearTimeout(nn),nn=setTimeout(()=>{const e=C.exportToString();Ie.pushState(e,"Paint")},$e.history.debounceTime)}function cs({canUndo:e,canRedo:t,undoCount:n,redoCount:o}){const r=document.getElementById("undoBtn"),i=document.getElementById("redoBtn");r.disabled=!e,r.title=e?`Undo (${n} available)`:"Undo",i.disabled=!t,i.title=t?`Redo (${o} available)`:"Redo"}function me(){const e=C.exportToString();document.getElementById("liveExportString").textContent=yt.formatDataString(e,50),document.getElementById("stringLength").textContent=e.length}function gt(){const e=parseInt(document.getElementById("canvasWidth")?.value),t=parseInt(document.getElementById("canvasHeight")?.value);document.querySelectorAll(".preset-btn").forEach(n=>{n.classList.toggle("active",e===parseInt(n.dataset.size)&&t===parseInt(n.dataset.size))})}function Yn(){oe.createNewTab()}async function qn(){let e=oe.getCurrentTab()?.name||Te.getCurrentFileName();const t=C.exportToString();await Te.save(t,e)&&(s.info("Saved successfully"),oe.markCurrentTabClean(),ie.forceSave())}function Xn(){Te.showLoadDialog(e=>{C.importFromString(e.data)&&(oe.setCurrentTabName(e.name),Te.setCurrentFileName(e.name),oe.markCurrentTabClean(),jt(),me())})}async function us(){let e=C.exportToString();const t=Te.getCurrentFileName()||"pixelart",n=await M.exportDialog(e);if(n)switch(n.compress&&(e=W.smartCompress(e).data),n.format){case"copy-string":await gn.copyWithFeedback(e),await M.alert("Copied!","Pixel art string copied to clipboard.","success");break;case"download-txt":Te.exportAsFile(e,t);break;case"download-png":{const o=t.replace(/\.txt$/,"")+".png";Ra.exportToPNG(n.scale,o),await M.alert("PNG Exported!",`Exported as ${o} at ${n.scale}× scale.`,"success");break}}}function ds(){const e=document.getElementById("importModal"),t=document.getElementById("importTextarea");e&&t&&(t.value="",e.style.display="flex",t.focus())}async function fs(){await M.confirm("Clear Canvas","Are you sure you want to clear the canvas? This cannot be undone.",{confirmText:"Clear",type:"warning",dangerous:!0})&&(C.clear(),me())}async function hs(){const e=C.exportToString(),t=document.getElementById("copyLiveStringBtn");await gn.copyWithFeedback(e,t)}async function vt(){const e=parseInt(document.getElementById("canvasWidth")?.value),t=parseInt(document.getElementById("canvasHeight")?.value),n=_e.validateCanvasDimensions(e,t);if(!n.valid){await M.alert("Invalid Size",n.error,"warning");return}C.hasContent()&&!await M.confirm("Resize Canvas","Resizing may crop or add empty space to your artwork. Continue?",{confirmText:"Resize",type:"warning"})||C.resize(e,t)&&(me(),gt(),nt&&nt.updateCanvasSize())}function Wn(){if(!Ie.canUndo())return s.debug("Nothing to undo");const e=C.exportToString(),t=Ie.undo(e);t&&(C.importFromString(t),jt(),me(),s.info("Undo performed"))}function It(){if(!Ie.canRedo())return s.debug("Nothing to redo");const e=C.exportToString(),t=Ie.redo(e);t&&(C.importFromString(t),jt(),me(),s.info("Redo performed"))}function jt(){const{width:e,height:t}=C.getDimensions();document.getElementById("canvasWidth").value=e,document.getElementById("canvasHeight").value=t,gt()}function J(e,t){const n=document.getElementById(e);n&&n.addEventListener("click",t)}Za();</script>
  <style rel="stylesheet" crossorigin>:root{--primary-color: #4CAF50;--primary-hover: #45a049;--primary-active: #3d8b40;--secondary-color: #2196F3;--secondary-hover: #1976D2;--danger-color: #f44336;--danger-hover: #da190b;--success-color: #4CAF50;--warning-color: #FFC107;--info-color: #2196F3;--app-bg: #0d0d0d;--workspace-bg: #1a1a1a;--panel-bg: #252525;--surface-bg: #2a2a2a;--elevated-bg: #333333;--hover-bg: #3a3a3a;--border-color: #404040;--border-light: #4a4a4a;--border-dark: #2a2a2a;--border-accent: #555555;--text-primary: #ffffff;--text-secondary: #b0b0b0;--text-muted: #808080;--text-disabled: #606060;--shadow-sm: 0 1px 3px rgba(0, 0, 0, .5);--shadow-md: 0 2px 6px rgba(0, 0, 0, .6);--shadow-lg: 0 4px 12px rgba(0, 0, 0, .7);--shadow-xl: 0 8px 24px rgba(0, 0, 0, .8);--spacing-xs: 4px;--spacing-sm: 8px;--spacing-md: 12px;--spacing-lg: 16px;--spacing-xl: 24px;--spacing-2xl: 32px;--spacing-3xl: 48px;--radius-sm: 3px;--radius-md: 4px;--radius-lg: 6px;--radius-xl: 8px;--toolbox-width: 80px;--properties-width: 280px;--menu-bar-height: 48px;--info-bar-height: 36px;--font-family: "Pixelify Sans", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Inter", sans-serif;--font-mono: "SF Mono", "Monaco", "Cascadia Code", "Courier New", monospace;--font-size-xs: 10px;--font-size-sm: 11px;--font-size-base: 12px;--font-size-md: 13px;--font-size-lg: 14px;--font-size-xl: 16px;--font-size-2xl: 18px;--transition-fast: .1s ease;--transition-normal: .2s ease;--transition-slow: .3s ease;--z-base: 1;--z-dropdown: 100;--z-sticky: 200;--z-modal-backdrop: 900;--z-modal: 1000;--z-tooltip: 1100}*{margin:0;padding:0;box-sizing:border-box}html{font-size:16px}body{font-family:var(--font-family);font-size:var(--font-size-base);background:var(--app-bg);color:var(--text-primary);line-height:1.5;overflow:hidden;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}button{font-family:inherit;cursor:pointer;border:none;background:none;color:inherit;font-size:inherit}input,textarea,select{font-family:inherit;font-size:inherit;color:inherit}h1,h2,h3,h4,h5,h6{font-weight:600;line-height:1.2}code{font-family:var(--font-mono)}::-webkit-scrollbar{width:10px;height:10px}::-webkit-scrollbar-track{background:var(--surface-bg)}::-webkit-scrollbar-thumb{background:var(--border-color);border-radius:var(--radius-sm)}::-webkit-scrollbar-thumb:hover{background:var(--border-light)}::selection{background:var(--primary-color);color:#fff}.hidden{display:none!important}.visible{display:block!important}.flex{display:flex!important}.inline{display:inline!important}.inline-block{display:inline-block!important}.cursor-default{cursor:default!important}.cursor-pointer{cursor:pointer!important}.cursor-grab{cursor:grab!important}.cursor-grabbing{cursor:grabbing!important}.cursor-move{cursor:move!important}.cursor-crosshair{cursor:crosshair!important}.cursor-text{cursor:text!important}.cursor-not-allowed{cursor:not-allowed!important}.opacity-0{opacity:0!important}.opacity-50{opacity:.5!important}.opacity-100{opacity:1!important}.transform-none{transform:none!important}.pointer-events-none{pointer-events:none!important}.pointer-events-auto{pointer-events:auto!important}.overflow-hidden{overflow:hidden!important}.overflow-auto{overflow:auto!important}.overflow-scroll{overflow:scroll!important}.relative{position:relative!important}.absolute{position:absolute!important}.fixed{position:fixed!important}.sticky{position:sticky!important}.z-0{z-index:0!important}.z-10{z-index:10!important}.z-20{z-index:20!important}.z-30{z-index:30!important}.z-40{z-index:40!important}.z-50{z-index:50!important}.w-full{width:100%!important}.h-full{height:100%!important}.w-auto{width:auto!important}.h-auto{height:auto!important}.text-left{text-align:left!important}.text-center{text-align:center!important}.text-right{text-align:right!important}.visible{visibility:visible!important}.invisible{visibility:hidden!important}.material-symbols-outlined{font-family:Material Symbols Outlined;font-weight:400;font-style:normal;font-size:24px;line-height:1;letter-spacing:normal;text-transform:none;display:inline-block;white-space:nowrap;word-wrap:normal;direction:ltr;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;text-rendering:optimizeLegibility;font-feature-settings:"liga"}.tool-icon.material-symbols-outlined{font-size:28px}.menu-btn .material-symbols-outlined{font-size:20px;vertical-align:middle}.dialog-icon.material-symbols-outlined,.export-format-icon.material-symbols-outlined{font-size:32px}.icon-btn .material-symbols-outlined{font-size:18px}.material-symbols-outlined.icon-primary{color:var(--primary-color)}.material-symbols-outlined.icon-success{color:var(--success-color)}.material-symbols-outlined.icon-warning{color:var(--warning-color)}.material-symbols-outlined.icon-danger{color:var(--danger-color)}.material-symbols-outlined.icon-muted{color:var(--text-muted)}.app-container{display:flex;height:100vh;width:100vw;background:var(--app-bg)}.workspace{flex:1;display:flex;flex-direction:column;background:var(--workspace-bg);overflow:hidden}.menu-bar{height:var(--menu-bar-height);background:var(--panel-bg);border-bottom:1px solid var(--border-color);display:flex;align-items:center;padding:0 var(--spacing-md);gap:var(--spacing-md)}.menu-section{display:flex;gap:var(--spacing-xs);align-items:center}.menu-section:not(:last-child):after{content:"";width:1px;height:20px;background:var(--border-color);margin-left:var(--spacing-md)}.info-bar{min-height:var(--info-bar-height);background:var(--surface-bg);border-bottom:1px solid var(--border-color);display:flex;align-items:center;padding:var(--spacing-sm) var(--spacing-md);gap:var(--spacing-lg);font-size:var(--font-size-sm);flex-wrap:wrap}.info-group{display:flex;align-items:center;gap:var(--spacing-sm)}.info-spacer{flex:1;min-width:20px}.info-label{color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px;font-size:var(--font-size-xs);font-weight:600}.info-value{color:var(--text-primary);font-weight:500}.info-value-small{color:var(--text-secondary);font-size:var(--font-size-xs)}.color-indicator{width:20px;height:20px;border:2px solid var(--border-color);border-radius:var(--radius-sm)}.tool-size-buttons,.tool-mode-buttons{display:flex;gap:4px}.tool-size-btn,.tool-mode-btn{padding:3px 8px;background:var(--panel-bg);border:1px solid var(--border-color);border-radius:var(--radius-sm);font-size:var(--font-size-xs);font-weight:600;color:var(--text-secondary);cursor:pointer;transition:all var(--transition-fast);min-width:24px;text-align:center}.tool-size-btn:hover,.tool-mode-btn:hover{background:var(--elevated-bg);border-color:var(--border-light);color:var(--text-primary)}.tool-size-btn.active,.tool-mode-btn.active{background:var(--primary-color);border-color:var(--primary-color);color:#fff}.tool-mode-btn{padding:3px 12px}.canvas-container{flex:1;display:flex;align-items:center;justify-content:center;overflow:auto;padding:var(--spacing-xl);background:var(--workspace-bg)}.canvas-wrapper{display:inline-block;background:var(--surface-bg);padding:var(--spacing-lg);border-radius:var(--radius-lg);box-shadow:var(--shadow-xl);border:1px solid var(--border-color)}#pixelCanvas{display:block;border:2px solid var(--border-light);cursor:crosshair;image-rendering:pixelated;image-rendering:crisp-edges}.export-panel{background:var(--panel-bg);border-top:1px solid var(--border-color);padding:var(--spacing-md)}.export-panel-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--spacing-sm)}.export-panel-header h3{font-size:var(--font-size-md);font-weight:600;color:var(--text-secondary)}.export-content{background:var(--surface-bg);border:1px solid var(--border-color);border-radius:var(--radius-md);padding:var(--spacing-md);margin-bottom:var(--spacing-sm);overflow-x:auto;max-height:80px}.export-code{font-family:var(--font-mono);font-size:var(--font-size-sm);color:var(--primary-color);word-break:break-all;display:block;line-height:1.6}.export-info{display:flex;gap:var(--spacing-xl);font-size:var(--font-size-xs);color:var(--text-muted)}.export-info strong{color:var(--text-secondary)}.toolbox{width:var(--toolbox-width);background:var(--panel-bg);border-right:1px solid var(--border-color);display:flex;flex-direction:column;overflow-y:auto;flex-shrink:0}.toolbox-header{padding:var(--spacing-md);border-bottom:1px solid var(--border-color);background:var(--elevated-bg);flex-shrink:0}.toolbox-header h2{font-size:var(--font-size-sm);font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--text-muted);text-align:center}.toolbox-content{padding:var(--spacing-sm);display:flex;flex-direction:column;gap:var(--spacing-xs);flex:1}.tool-btn{width:100%;aspect-ratio:1;background:var(--surface-bg);border:1px solid var(--border-color);border-radius:var(--radius-md);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;cursor:pointer;transition:all var(--transition-fast);position:relative;padding:var(--spacing-xs)}.tool-btn:hover{background:var(--hover-bg);border-color:var(--border-light);transform:translateY(-1px)}.tool-btn:active{transform:translateY(0)}.tool-btn.active{background:var(--primary-color);border-color:var(--primary-color);color:#fff}.tool-btn.active:hover{background:var(--primary-hover)}.tool-icon{font-size:clamp(20px,4vw,28px);line-height:1;display:block;flex-shrink:0}.tool-label{font-size:clamp(8px,1.2vw,11px);font-weight:600;text-align:center;line-height:1.1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;width:100%}.tool-shortcut{position:absolute;bottom:3%;right:5%;font-size:clamp(7px,1vw,9px);opacity:.5;font-weight:700;line-height:1}.tool-btn.active .tool-shortcut{opacity:.9}.properties-panel{width:var(--properties-width);background:var(--panel-bg);border-left:1px solid var(--border-color);display:flex;flex-direction:column;overflow-y:auto}.panel-section{border-bottom:1px solid var(--border-color);padding:var(--spacing-md)}.panel-title{font-size:var(--font-size-sm);font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--text-muted);margin-bottom:var(--spacing-md)}.tool-options{display:flex;flex-direction:column;gap:var(--spacing-lg)}.option-group{display:flex;flex-direction:column;gap:var(--spacing-sm)}.option-group label{font-size:var(--font-size-sm);color:var(--text-secondary);font-weight:500}.size-buttons{display:grid;grid-template-columns:repeat(4,1fr);gap:var(--spacing-xs)}.size-btn{padding:var(--spacing-sm);background:var(--surface-bg);border:1px solid var(--border-color);border-radius:var(--radius-md);font-size:var(--font-size-xs);font-weight:600;transition:all var(--transition-fast)}.size-btn:hover{background:var(--hover-bg);border-color:var(--border-light)}.size-btn.active{background:var(--primary-color);border-color:var(--primary-color);color:#fff}.mode-buttons{display:grid;grid-template-columns:1fr 1fr;gap:var(--spacing-xs)}.mode-btn{padding:var(--spacing-sm);background:var(--surface-bg);border:1px solid var(--border-color);border-radius:var(--radius-md);font-size:var(--font-size-sm);font-weight:500;transition:all var(--transition-fast)}.mode-btn:hover{background:var(--hover-bg);border-color:var(--border-light)}.mode-btn.active{background:var(--primary-color);border-color:var(--primary-color);color:#fff}.size-presets{display:grid;grid-template-columns:repeat(2,1fr);gap:var(--spacing-xs);margin-bottom:var(--spacing-md)}.preset-btn{padding:var(--spacing-sm);background:var(--surface-bg);border:1px solid var(--border-color);border-radius:var(--radius-md);font-size:var(--font-size-sm);font-weight:600;transition:all var(--transition-fast)}.preset-btn:hover{background:var(--hover-bg);border-color:var(--border-light)}.preset-btn.active{background:var(--primary-color);border-color:var(--primary-color);color:#fff}.custom-size{display:flex;flex-direction:column;gap:var(--spacing-sm)}.size-input-row{display:flex;align-items:center;gap:var(--spacing-xs)}.size-input-row input{flex:1;padding:var(--spacing-sm);background:var(--surface-bg);border:1px solid var(--border-color);border-radius:var(--radius-md);text-align:center;font-weight:600}.size-input-row input:focus{outline:none;border-color:var(--primary-color)}.size-input-row span{color:var(--text-muted);font-weight:600}.color-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:3px}.color-swatch{aspect-ratio:1;border:2px solid var(--border-color);border-radius:var(--radius-sm);cursor:pointer;transition:all var(--transition-fast);position:relative}.color-swatch:hover{transform:scale(1.15);border-color:var(--border-light);box-shadow:var(--shadow-md);z-index:10}.color-swatch.active{border-color:gold;box-shadow:0 0 8px #ffd70099;transform:scale(1.1);z-index:10}.color-swatch[data-code="0"]{background:repeating-conic-gradient(#666 0% 25%,#444 0% 50%) 50% / 6px 6px}.menu-btn{padding:var(--spacing-sm) var(--spacing-md);background:var(--surface-bg);border:1px solid transparent;border-radius:var(--radius-md);font-size:var(--font-size-sm);font-weight:500;display:flex;align-items:center;gap:var(--spacing-xs);transition:all var(--transition-fast)}.menu-btn:hover{background:var(--hover-bg);border-color:var(--border-color)}.menu-btn:active{transform:scale(.98)}.menu-btn span{font-size:16px}.menu-btn-danger{color:var(--danger-color)}.menu-btn-danger:hover{background:#f443361a;border-color:var(--danger-color)}.btn-primary{width:100%;padding:var(--spacing-sm) var(--spacing-md);background:var(--primary-color);border:1px solid var(--primary-color);border-radius:var(--radius-md);font-size:var(--font-size-sm);font-weight:600;color:#fff;transition:all var(--transition-fast)}.btn-primary:hover{background:var(--primary-hover);border-color:var(--primary-hover)}.btn-primary:active{transform:scale(.98)}.btn-secondary{padding:var(--spacing-sm) var(--spacing-lg);background:var(--surface-bg);border:1px solid var(--border-color);border-radius:var(--radius-md);font-size:var(--font-size-sm);font-weight:500;transition:all var(--transition-fast)}.btn-secondary:hover{background:var(--hover-bg);border-color:var(--border-light)}.icon-btn{padding:var(--spacing-xs);background:var(--surface-bg);border:1px solid var(--border-color);border-radius:var(--radius-md);font-size:16px;transition:all var(--transition-fast)}.icon-btn:hover{background:var(--hover-bg);border-color:var(--primary-color);transform:scale(1.05)}.btn-close{width:32px;height:32px;background:transparent;border:none;border-radius:var(--radius-md);font-size:24px;color:var(--text-secondary);display:flex;align-items:center;justify-content:center;transition:all var(--transition-fast)}.btn-close:hover{background:var(--surface-bg);color:var(--text-primary)}.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:#000000d9;display:flex;justify-content:center;align-items:center;z-index:var(--z-modal);-webkit-backdrop-filter:blur(4px);backdrop-filter:blur(4px)}.modal-content{background:var(--panel-bg);border:1px solid var(--border-color);border-radius:var(--radius-xl);max-width:600px;width:90%;max-height:80vh;display:flex;flex-direction:column;box-shadow:var(--shadow-xl)}.modal-header{display:flex;justify-content:space-between;align-items:center;padding:var(--spacing-lg);border-bottom:1px solid var(--border-color)}.modal-header h2{font-size:var(--font-size-xl);font-weight:600}.modal-body{padding:var(--spacing-lg);overflow-y:auto;flex:1}.modal-body p{margin-bottom:var(--spacing-md);color:var(--text-secondary);font-size:var(--font-size-sm)}.modal-body textarea{width:100%;padding:var(--spacing-md);background:var(--surface-bg);border:1px solid var(--border-color);border-radius:var(--radius-md);font-family:var(--font-mono);font-size:var(--font-size-sm);resize:vertical;min-height:120px}.modal-body textarea:focus{outline:none;border-color:var(--primary-color)}.modal-footer{padding:var(--spacing-lg);border-top:1px solid var(--border-color);display:flex;justify-content:flex-end;gap:var(--spacing-sm)}#fileList{display:flex;flex-direction:column;gap:var(--spacing-sm)}.file-item{display:flex;justify-content:space-between;align-items:center;padding:var(--spacing-md);background:var(--surface-bg);border:1px solid var(--border-color);border-radius:var(--radius-md);transition:all var(--transition-fast)}.file-item:hover{border-color:var(--primary-color);background:var(--hover-bg)}.file-item-info{flex:1}.file-item-name{font-weight:600;margin-bottom:var(--spacing-xs)}.file-item-meta{font-size:var(--font-size-xs);color:var(--text-secondary)}.file-item-actions{display:flex;gap:var(--spacing-xs)}.file-item-actions .btn-secondary,.file-item-actions .btn-primary{padding:var(--spacing-xs) var(--spacing-md);font-size:var(--font-size-xs)}.dialog-overlay{position:fixed;inset:0;background:#000000bf;-webkit-backdrop-filter:blur(4px);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;z-index:var(--z-modal);animation:fadeIn .2s ease}@keyframes fadeIn{0%{opacity:0}to{opacity:1}}.dialog-content{background:var(--panel-bg);border:1px solid var(--border-color);border-radius:var(--radius-lg);box-shadow:var(--shadow-xl);min-width:400px;max-width:600px;max-height:80vh;overflow:hidden;display:flex;flex-direction:column;opacity:0;transform:scale(.9) translateY(-20px);transition:all .2s ease}.dialog-content.dialog-show{opacity:1;transform:scale(1) translateY(0)}.dialog-content.dialog-info .dialog-icon{color:var(--info-color)}.dialog-content.dialog-success .dialog-icon{color:var(--success-color)}.dialog-content.dialog-warning .dialog-icon{color:var(--warning-color)}.dialog-content.dialog-error .dialog-icon{color:var(--danger-color)}.dialog-header{display:flex;align-items:center;gap:var(--spacing-md);padding:var(--spacing-lg);border-bottom:1px solid var(--border-color)}.dialog-icon{font-size:32px;line-height:1}.dialog-title{font-size:var(--font-size-xl);font-weight:600;color:var(--text-primary);margin:0}.dialog-body{padding:var(--spacing-xl);overflow-y:auto}.dialog-message{color:var(--text-secondary);font-size:var(--font-size-md);line-height:1.6;margin:0 0 var(--spacing-md) 0}.dialog-input{width:100%;padding:var(--spacing-md);background:var(--surface-bg);border:1px solid var(--border-color);border-radius:var(--radius-md);color:var(--text-primary);font-size:var(--font-size-md);font-family:var(--font-family);margin-top:var(--spacing-md);transition:all var(--transition-fast)}.dialog-input:focus{outline:none;border-color:var(--primary-color);background:var(--elevated-bg)}.export-options{display:flex;flex-direction:column;gap:var(--spacing-lg)}.export-preview{background:var(--surface-bg);border:1px solid var(--border-color);border-radius:var(--radius-md);padding:var(--spacing-md)}.export-preview-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--spacing-sm);font-size:var(--font-size-sm)}.export-preview-size{color:var(--text-muted);font-weight:400}.export-code-preview{display:block;font-family:var(--font-mono);font-size:var(--font-size-sm);color:var(--primary-color);word-break:break-all;line-height:1.6;max-height:60px;overflow-y:auto}.export-option-group{background:var(--surface-bg);border:1px solid var(--border-color);border-radius:var(--radius-md);padding:var(--spacing-md)}.export-checkbox-label{display:flex;align-items:center;gap:var(--spacing-sm);cursor:pointer;font-size:var(--font-size-md);color:var(--text-primary)}.export-checkbox{width:18px;height:18px;cursor:pointer}.export-savings{margin-left:auto;color:var(--success-color);font-weight:600;font-size:var(--font-size-sm)}.export-savings.export-warning{color:#e2a04a}.export-option-info{margin-top:var(--spacing-sm);margin-left:26px;font-size:var(--font-size-xs);color:var(--text-muted);line-height:1.5}.compression-preview{display:grid;grid-template-columns:1fr auto 1fr;gap:var(--spacing-md);margin-top:var(--spacing-md);padding-top:var(--spacing-md);border-top:1px solid var(--border-color)}.compression-preview-section{display:flex;flex-direction:column;gap:var(--spacing-xs);min-width:0}.compression-preview-label{display:flex;justify-content:space-between;align-items:center;font-size:var(--font-size-xs)}.compression-preview-size{color:var(--text-muted);font-weight:400}.compression-highlight{color:var(--success-color);font-weight:600}.compression-preview-code{display:block;font-family:var(--font-mono);font-size:var(--font-size-xs);color:var(--text-secondary);background:var(--panel-bg);padding:var(--spacing-xs) var(--spacing-sm);border-radius:var(--radius-sm);word-break:break-all;line-height:1.5;max-height:60px;overflow-y:auto}.compression-preview-arrow{display:flex;align-items:center;justify-content:center;font-size:var(--font-size-xl);color:var(--success-color);font-weight:700}.export-format-section{display:flex;flex-direction:column;gap:var(--spacing-sm)}.export-format-buttons{display:grid;grid-template-columns:repeat(3,1fr);gap:var(--spacing-sm)}.export-format-btn{display:flex;flex-direction:column;align-items:center;gap:var(--spacing-xs);padding:var(--spacing-md);background:var(--surface-bg);border:2px solid var(--border-color);border-radius:var(--radius-md);cursor:pointer;transition:all var(--transition-fast);min-height:90px}.export-format-btn:hover{background:var(--elevated-bg);border-color:var(--border-light)}.export-format-btn.selected{background:var(--primary-color);border-color:var(--primary-color)}.export-format-btn.selected .export-format-label,.export-format-btn.selected .export-format-desc{color:#fff}.export-format-icon{font-size:32px;line-height:1}.export-format-label{font-weight:600;font-size:var(--font-size-md);color:var(--text-primary)}.export-format-desc{font-size:var(--font-size-xs);color:var(--text-muted)}.png-scale-options{display:flex;flex-direction:column;gap:var(--spacing-sm);padding:var(--spacing-md);background:var(--surface-bg);border:1px solid var(--border-color);border-radius:var(--radius-md)}.png-scale-buttons{display:flex;gap:var(--spacing-xs)}.png-scale-btn{flex:1;padding:var(--spacing-sm) var(--spacing-md);background:var(--panel-bg);border:1px solid var(--border-color);border-radius:var(--radius-sm);color:var(--text-secondary);font-weight:600;cursor:pointer;transition:all var(--transition-fast)}.png-scale-btn:hover{background:var(--elevated-bg);color:var(--text-primary)}.png-scale-btn.active{background:var(--primary-color);border-color:var(--primary-color);color:#fff}.export-info-small{font-size:var(--font-size-xs);color:var(--text-muted)}.export-info-small strong{color:var(--text-secondary)}.dialog-footer{display:flex;gap:var(--spacing-sm);padding:var(--spacing-lg);border-top:1px solid var(--border-color);background:var(--surface-bg);justify-content:flex-end}.dialog-btn{padding:var(--spacing-sm) var(--spacing-lg);border-radius:var(--radius-md);font-size:var(--font-size-md);font-weight:600;cursor:pointer;transition:all var(--transition-fast);border:none;min-width:80px}.dialog-btn-primary{background:var(--primary-color);color:#fff}.dialog-btn-primary:hover{background:var(--primary-hover);transform:translateY(-1px)}.dialog-btn-primary:active{background:var(--primary-active);transform:translateY(0)}.dialog-btn-secondary{background:var(--elevated-bg);color:var(--text-secondary);border:1px solid var(--border-color)}.dialog-btn-secondary:hover{background:var(--hover-bg);color:var(--text-primary)}.dialog-btn-secondary:active{background:var(--surface-bg)}.dialog-btn-danger{background:var(--danger-color);color:#fff}.dialog-btn-danger:hover{background:var(--danger-hover);transform:translateY(-1px)}.dialog-btn-danger:active{background:#c62828;transform:translateY(0)}@media(max-width:600px){.dialog-content{min-width:90vw;max-width:90vw}.dialog-footer{flex-direction:column-reverse}.dialog-btn{width:100%}}.tab-bar{background:var(--panel-bg);border-bottom:1px solid var(--border-color);display:flex;align-items:center;height:36px;overflow-x:auto;overflow-y:hidden}.tab-list{display:flex;flex:1;align-items:center;height:100%;overflow-x:auto;overflow-y:hidden;scrollbar-width:thin}.tab-list::-webkit-scrollbar{height:4px}.tab-list::-webkit-scrollbar-thumb{background:var(--border-color);border-radius:2px}.tab{display:flex;align-items:center;gap:8px;padding:8px 16px;background:var(--surface-bg);border-right:1px solid var(--border-color);cursor:pointer;-webkit-user-select:none;user-select:none;transition:background var(--transition-fast);min-width:120px;max-width:200px;height:100%;position:relative}.tab:hover{background:var(--elevated-bg)}.tab.active{background:var(--workspace-bg);border-bottom:2px solid var(--primary-color)}.tab-name{flex:1;font-size:var(--font-size-sm);font-weight:500;color:var(--text-secondary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.tab.active .tab-name{color:var(--text-primary)}.tab-dirty{color:var(--primary-color);font-size:14px;line-height:1}.tab-close{display:flex;align-items:center;justify-content:center;width:20px;height:20px;background:transparent;border:none;border-radius:var(--radius-sm);color:var(--text-muted);font-size:18px;line-height:1;cursor:pointer;padding:0;opacity:0;transition:all var(--transition-fast)}.tab:hover .tab-close{opacity:1}.tab-close:hover{background:var(--danger-color);color:#fff}.tab-new-btn{display:flex;align-items:center;justify-content:center;width:36px;height:36px;background:transparent;border:none;border-left:1px solid var(--border-color);color:var(--text-secondary);font-size:20px;cursor:pointer;transition:all var(--transition-fast);flex-shrink:0}.tab-new-btn:hover{background:var(--elevated-bg);color:var(--text-primary)}.tab-new-btn:active{background:var(--surface-bg)}.autosave-indicator{display:flex;align-items:center;gap:var(--spacing-sm);padding:4px 12px;background:var(--surface-bg);border:1px solid var(--border-color);border-radius:var(--radius-md);font-size:var(--font-size-xs);margin-left:auto;transition:all var(--transition-normal)}.autosave-status{display:flex;align-items:center;gap:6px;font-weight:600}.autosave-icon{font-size:14px;display:inline-block;transition:all var(--transition-fast)}.autosave-text{color:var(--text-secondary)}.autosave-time{color:var(--text-muted);font-size:var(--font-size-xs);margin-left:4px}.autosave-indicator.status-saved{border-color:var(--success-color)}.autosave-indicator.status-saved .autosave-icon,.autosave-indicator.status-saved .autosave-text{color:var(--success-color)}.autosave-indicator.status-saving{border-color:var(--primary-color)}.autosave-indicator.status-saving .autosave-icon{color:var(--primary-color);animation:spin 1s linear infinite}.autosave-indicator.status-saving .autosave-text{color:var(--primary-color)}.autosave-indicator.status-unsaved{border-color:var(--warning-color)}.autosave-indicator.status-unsaved .autosave-icon,.autosave-indicator.status-unsaved .autosave-text{color:var(--warning-color)}.autosave-indicator.status-error{border-color:var(--danger-color)}.autosave-indicator.status-error .autosave-icon,.autosave-indicator.status-error .autosave-text{color:var(--danger-color)}@keyframes spin{0%{transform:rotate(0)}to{transform:rotate(360deg)}}.zoom-controls{display:flex;align-items:center;gap:var(--spacing-xs)}.zoom-btn{display:flex;align-items:center;justify-content:center;width:28px;height:28px;background:var(--panel-bg);border:1px solid var(--border-color);border-radius:var(--radius-sm);color:var(--text-secondary);font-size:16px;font-weight:600;cursor:pointer;transition:all var(--transition-fast);line-height:1;padding:0}.zoom-btn:hover{background:var(--elevated-bg);border-color:var(--border-light);color:var(--text-primary)}.zoom-btn:active{background:var(--surface-bg);transform:scale(.95)}.zoom-select{min-width:80px;padding:4px 8px;background:var(--panel-bg);border:1px solid var(--border-color);border-radius:var(--radius-sm);color:var(--text-secondary);font-size:var(--font-size-sm);font-weight:600;cursor:pointer;transition:all var(--transition-fast)}.zoom-select:hover{background:var(--elevated-bg);border-color:var(--border-light)}.zoom-select:focus{outline:none;border-color:var(--primary-color)}.canvas-wrapper{transition:transform .2s ease-out;will-change:transform}.canvas-container{position:relative;overflow:hidden}.canvas-container.panning{cursor:grabbing!important}@media(max-width:1024px){:root{--toolbox-width: 70px;--properties-width: 240px}.color-grid{grid-template-columns:repeat(6,1fr)}}@media(max-width:768px){.app-container{flex-direction:column}.toolbox{width:100%;height:auto;border-right:none;border-bottom:1px solid var(--border-color)}.toolbox-content{display:flex;overflow-x:auto;padding:var(--spacing-sm)}.tool-btn{min-width:60px;flex-shrink:0}.properties-panel{width:100%;max-height:40vh;border-left:none;border-top:1px solid var(--border-color)}.menu-bar{flex-wrap:wrap;height:auto;min-height:var(--menu-bar-height)}.menu-section:after{display:none}.info-bar{flex-wrap:wrap;height:auto;min-height:var(--info-bar-height);gap:var(--spacing-md)}.canvas-container{padding:var(--spacing-md)}.export-panel{padding:var(--spacing-sm)}.color-grid{grid-template-columns:repeat(8,1fr)}}@media(max-width:480px){.menu-btn span{display:none}.menu-btn{padding:var(--spacing-sm)}.info-bar{font-size:var(--font-size-xs)}.info-value-small{display:none}.size-presets{grid-template-columns:repeat(4,1fr)}.color-grid{grid-template-columns:repeat(6,1fr);gap:2px}.export-content{max-height:60px}.export-code{font-size:10px}}@media(hover:none)and (pointer:coarse){.menu-btn,.tool-btn,.size-btn,.mode-btn,.preset-btn{min-height:44px;min-width:44px}.color-swatch{min-height:32px;min-width:32px}}</style>
</head>
<body>
    <div class="app-container">
        <!-- Left Toolbox -->
        <aside class="toolbox">
            <div class="toolbox-header">
                <h2>Tools</h2>
            </div>
            <div class="toolbox-content" id="toolbox">
                <!-- Tools generated dynamically -->
            </div>
        </aside>

        <!-- Center Canvas Area -->
        <main class="workspace">
            <!-- Top Menu Bar -->
            <div class="menu-bar">
                <div class="menu-section">
                    <button id="newBtn" class="menu-btn" title="New (Ctrl+N)">
                        <span class="material-symbols-outlined">description</span> New
                    </button>
                    <button id="saveBtn" class="menu-btn" title="Save (Ctrl+S)">
                        <span class="material-symbols-outlined">save</span> Save
                    </button>
                    <button id="loadBtn" class="menu-btn" title="Load (Ctrl+O)">
                        <span class="material-symbols-outlined">folder_open</span> Load
                    </button>
                </div>
                <div class="menu-section">
                    <button id="undoBtn" class="menu-btn" title="Undo (Ctrl+Z)" disabled>
                        <span class="material-symbols-outlined">undo</span> Undo
                    </button>
                    <button id="redoBtn" class="menu-btn" title="Redo (Ctrl+Y)" disabled>
                        <span class="material-symbols-outlined">redo</span> Redo
                    </button>
                </div>
                <div class="menu-section">
                    <button id="exportFileBtn" class="menu-btn" title="Export">
                        <span class="material-symbols-outlined">download</span> Export
                    </button>
                    <button id="importStringBtn" class="menu-btn" title="Import">
                        <span class="material-symbols-outlined">upload</span> Import
                    </button>
                </div>
                <div class="menu-section">
                    <button id="clearBtn" class="menu-btn menu-btn-danger" title="Clear">
                        <span class="material-symbols-outlined">delete</span> Clear
                    </button>
                </div>
            </div>

            <!-- Canvas Info Bar with Tool Options -->
            <div class="info-bar">
                <div class="info-group">
                    <span class="info-label">Tool:</span>
                    <span id="currentToolName" class="info-value">Brush</span>
                </div>

                <!-- Tool Options (shown dynamically) -->
                <div class="info-group" id="brushSizeOption" style="display: none;">
                    <span class="info-label">Size:</span>
                    <div class="tool-size-buttons">
                        <button class="tool-size-btn active" data-size="1">1</button>
                        <button class="tool-size-btn" data-size="2">2</button>
                        <button class="tool-size-btn" data-size="3">3</button>
                        <button class="tool-size-btn" data-size="5">5</button>
                    </div>
                </div>

                <div class="info-group" id="shapeModeOption" style="display: none;">
                    <span class="info-label">Mode:</span>
                    <div class="tool-mode-buttons">
                        <button class="tool-mode-btn active" data-mode="fill">Fill</button>
                        <button class="tool-mode-btn" data-mode="stroke">Stroke</button>
                    </div>
                </div>

                <div class="info-spacer"></div>

                <div class="info-group">
                    <span class="info-label">Size:</span>
                    <span id="canvasSizeDisplay" class="info-value">16×16</span>
                </div>
                <div class="info-group">
                    <span class="info-label">Color:</span>
                    <div id="currentColorDisplay" class="color-indicator"></div>
                    <span id="currentColorCode" class="info-value">1</span>
                </div>
            </div>

            <!-- Canvas Container -->
            <div class="canvas-container">
                <div class="canvas-wrapper">
                    <canvas id="pixelCanvas"></canvas>
                </div>
            </div>

            <!-- Live Export Preview -->
            <div class="export-panel">
                <div class="export-panel-header">
                    <h3>Export String</h3>
                    <button id="copyLiveStringBtn" class="icon-btn" title="Copy">
                        <span class="material-symbols-outlined">content_copy</span>
                    </button>
                </div>
                <div class="export-content">
                    <code id="liveExportString" class="export-code">16x16:0000...</code>
                </div>
                <div class="export-info">
                    <span><strong>Format:</strong> Base64 (64 colors)</span>
                    <span><strong>Length:</strong> <span id="stringLength">0</span> chars</span>
                </div>
            </div>
        </main>

        <!-- Right Properties Panel -->
        <aside class="properties-panel">
            <!-- Canvas Size -->
            <div class="panel-section">
                <h3 class="panel-title">Canvas Size</h3>
                <div class="size-presets">
                    <button class="preset-btn" data-size="8">8×8</button>
                    <button class="preset-btn active" data-size="16">16×16</button>
                    <button class="preset-btn" data-size="32">32×32</button>
                    <button class="preset-btn" data-size="64">64×64</button>
                </div>
                <div class="custom-size">
                    <div class="size-input-row">
                        <input type="number" id="canvasWidth" min="2" max="128" value="16" placeholder="W">
                        <span>×</span>
                        <input type="number" id="canvasHeight" min="2" max="128" value="16" placeholder="H">
                    </div>
                    <button id="resizeBtn" class="btn-primary">Apply</button>
                </div>
            </div>

            <!-- Color Palette -->
            <div class="panel-section">
                <h3 class="panel-title">Color Palette</h3>
                <div id="colorPalette" class="color-grid">
                    <!-- Generated dynamically -->
                </div>
            </div>
        </aside>
    </div>

    <!-- Import Modal -->
    <div class="modal" id="importModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Import from String</h2>
                <button id="closeImportModal" class="btn-close">&times;</button>
            </div>
            <div class="modal-body">
                <p>Paste your Base64 pixel art string (format: WxH:DATA)</p>
                <textarea id="importTextarea" rows="8" placeholder="16x16:123ABC..."></textarea>
            </div>
            <div class="modal-footer">
                <button id="cancelImportBtn" class="btn-secondary">Cancel</button>
                <button id="confirmImportBtn" class="btn-primary">Import</button>
            </div>
        </div>
    </div>

    <!-- File Selection Modal -->
    <div class="modal" id="fileModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Load File</h2>
                <button id="closeModal" class="btn-close">&times;</button>
            </div>
            <div class="modal-body">
                <div id="fileList"></div>
                <p id="noFilesMessage" style="display: none; text-align: center; color: #666;">
                    No saved files found.
                </p>
            </div>
        </div>
    </div>

    <!-- Main Application Entry Point (Bundled by Vite) -->
</body>
</html>
